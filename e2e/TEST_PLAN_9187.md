# Веб‑приложение (порт 9187) — Комплексный план тестирования (Playwright Planner)

## Обзор приложения

SPA на Vue 3 (Element Plus, Pinia) с роутингом:
- Главная (`/`) — лендинг с переходами на авторизацию/регистрацию
- Аутентификация: `/login`, `/register`
- Рабочая зона:
  - Список участников: `/participants`
  - Деталка участника: `/participants/:id` — отчёты, метрики, расчёт пригодности, финальный отчёт (JSON/HTML)
- Админ:
  - Пользователи: `/admin/users` — модерация (одобрение)
  - Весовые таблицы: `/admin/weights` — загрузка/список/активация

Глобальные правила:
- Базовый URL API: `/api`
- Гварды маршрутизатора:
  - `requiresAuth`: неавторизованных перенаправляет на `/login`
  - `requiresAdmin`: пользователей без роли ADMIN уводит на `/participants`
  - Авторизованных не пускает на `/login`, `/register`, `/`

Предпосылки для сценариев:
- Тестовые пользователи:
  - ADMIN (одобрен, роль ADMIN)
  - USER_ACTIVE (одобрен, обычный пользователь)
  - USER_PENDING (зарегистрирован, не одобрен)
- Тестовый участник с `participant_id`
- Тестовая `weight_table` для подходящей проф. области
- Тестовый DOCX‑файл отчёта для загрузки

Формат шагов: нумерованные операции и ожидаемые результаты. Сценарии независимы и могут выполняться в любом порядке (при необходимости предусмотреть предусловия).

---

## Сценарии

### 1. Лендинг — навигация к авторизации и регистрации
Предусловия: неавторизован
1. Перейти на `/`
2. Нажать «Войти в систему»
3. Вернуться назад; нажать «Зарегистрироваться»
Ожидаемо:
- П.1: Отображается лендинг
- П.2: Переход на `/login`
- П.3: Переход на `/register`

### 2. Регистрация — успешная
Предусловия: неавторизован, новый email
1. Открыть `/register`
2. Заполнить email, пароль
3. Отправить форму
Ожидаемо:
- Успешное подтверждение регистрации (UI уведомление/редирект по реализации)
- Пользователь в состоянии PENDING (до одобрения админом)

### 3. Регистрация — валидации формы
Предусловия: неавторизован
1. Открыть `/register`
2. Отправить пустую форму
3. Ввести некорректный email
Ожидаемо:
- П.2: Появляются ошибки обязательных полей
- П.3: Ошибка формата email

### 4. Логин — успешный (ACTIVE пользователь)
Предусловия: USER_ACTIVE одобрен
1. Открыть `/login`
2. Ввести валидные email/пароль USER_ACTIVE
3. Отправить форму
Ожидаемо:
- Успешный вход
- Редирект на `/participants`

### 5. Логин — ошибка (неверный пароль)
Предусловия: известная пара email/пароль
1. Открыть `/login`
2. Ввести верный email и неверный пароль
3. Отправить
Ожидаемо:
- Сообщение об ошибке авторизации
- Остаёмся на странице логина

### 6. Доступ к защищённым маршрутам без авторизации
Предусловия: неавторизован
1. Перейти на `/participants`
2. Перейти на `/participants/any-id`
3. Перейти на `/admin/weights`
Ожидаемо:
- Во всех случаях редирект на `/login?redirect=...`

### 7. Гвард активности — PENDING пользователь
Предусловия: USER_PENDING (не одобрен админом), выполнен вход
1. Перейти на `/participants`
Ожидаемо:
- Редирект на `/login?message=pending`

### 8. Гвард админ‑прав — доступ к админ‑разделу
Предусловия: USER_ACTIVE без роли ADMIN
1. Перейти на `/admin/weights`
Ожидаемо:
- Редирект на `/participants`

### 9. Список участников — базовый рендер и пагинация/поиск
Предусловия: авторизован USER_ACTIVE
1. Открыть `/participants`
2. Убедиться, что таблица/список рендерится
3. Ввести поисковый запрос (часть ФИО)
4. Проверить обновление списка
5. Переключить страницу (если доступно)
Ожидаемо:
- П.2: Видны строки/пагинация
- П.4: Применён фильтр
- П.5: Изменяется содержимое согласно странице

### 10. Деталка участника — загрузка отчёта DOCX
Предусловия: USER_ACTIVE, существует `participant_id`, доступен тестовый DOCX
1. Открыть `/participants/{participant_id}`
2. Открыть диалог «Загрузить отчёт»
3. Выбрать тип отчёта, прикрепить DOCX
4. Отправить
Ожидаемо:
- Успешное сообщение
- В списке отчётов — новый элемент со статусом UPLOADED

### 11. Деталка участника — запуск извлечения метрик
Предусловия: как в сценарии 10, отчёт загружен
1. Нажать «Извлечь метрики» у нужного отчёта
2. Обновить список отчётов
Ожидаемо:
- Появляется статус в процессе/EXTRACTED по завершении (в тестовом окружении — синхронно/через автorefresh)
- Ошибки — отображаются уведомлением

### 12. Деталка участника — просмотр и обновление метрик
Предусловия: есть извлечённые метрики
1. Прокрутить до секции метрик
2. Проверить, что значения в диапазоне 1..10 и формат RU
3. Изменить одно значение и сохранить
Ожидаемо:
- Метрики видимы; значения валидируются
- После сохранения отображается обновлённое значение

### 13. Расчёт пригодности — успешный
Предусловия: активная весовая таблица для выбранной проф. области, есть валидные метрики
1. В секции расчётов выбрать проф. область
2. Нажать «Рассчитать пригодность»
Ожидаемо:
- Появляется результат с процентом/оценкой
- Отображаются рекомендации
- В истории расчётов появляется новая запись

### 14. Финальный отчёт — просмотр JSON
Предусловия: есть результат расчёта с `prof_activity_code`
1. Нажать «Просмотреть JSON»
Ожидаемо:
- Открывается новая вкладка с JSON
- Формат соответствует ожидаемой схеме финального отчёта

### 15. Финальный отчёт — скачивание HTML
Предусловия: как в сценарии 14
1. Нажать «Скачать HTML»
Ожидаемо:
- Скачивается HTML‑файл `final_report_{code}_{date}.html`
- Файл содержит корректную разметку отчёта

### 16. Админ — просмотр ожидающих одобрения пользователей
Предусловия: ADMIN
1. Открыть `/admin/users`
2. Найти пользователя со статусом PENDING
Ожидаемо:
- Список содержит ожидающих
- Доступно действие одобрения

### 17. Админ — одобрение пользователя
Предусловия: ADMIN, есть PENDING пользователь
1. На `/admin/users` нажать «Одобрить» у нужного пользователя
Ожидаемо:
- Статус меняется на ACTIVE
- Пользователь может входить и проходить гварды

### 18. Админ — загрузка весовой таблицы
Предусловия: ADMIN, корректный JSON нагрузки для весов
1. Открыть `/admin/weights`
2. Нажать «Загрузить»
3. Ввести `prof_activity_code`, `version`, `weights[]` (код метрики, вес)
4. Подтвердить
Ожидаемо:
- Таблица появляется в списке с корректной суммой весов (=1.0)

### 19. Админ — активация весовой таблицы
Предусловия: ADMIN, в списке есть неактивная таблица
1. На `/admin/weights` нажать «Активировать» у выбранной таблицы
Ожидаемо:
- Таблица помечается активной
- Расчёты используют обновлённые веса

### 20. 401 перехватчик — редирект при истекшей сессии
Предусловия: авторизован, затем программно/через API истекает сессия
1. Инициировать запрос к API (любая защищённая операция)
Ожидаемо:
- При 401 фронт выполняет редирект на `/login`

### 21. SPA fallback и статика
1. Перейти на произвольные клиентские роуты: `/participants`, `/participants/{id}`, `/admin/weights` с обновлением страницы (F5)
2. Проверить загрузку `/assets/theme-tokens.css`
Ожидаемо:
- FastAPI отдаёт `index.html` (SPA fallback)
- Статические ассеты отдаются без ошибок

---

## Примечания по данным/фикстурам
- Для E2E рекомендуется поднимать окружение: PostgreSQL, Redis, API на 9187, Vite dev‑сервер или прод‑билд через FastAPI
- Для тестов, зависящих от извлечения метрик/LLM, в profile `test/ci` включён режим без внешней сети, Celery в eager‑режиме, ответы Gemini мокируются

## Критерии успешности
- Все защищённые экраны корректно проверяют авторизацию/роль/активность
- Критические пользовательские пути (загрузка отчёта → извлечение → расчёт → финальный отчёт) выполняются без ошибок
- Админ‑операции (одобрение, веса) доступны только ADMIN и отражаются на пользовательских сценариях


