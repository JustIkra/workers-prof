# Код: AI-08 — Обновить JSON‑схему в промпте Gemini Vision

## Цель
- Обновить промпт для Vision‑извлечения так, чтобы ответ строго соответствовал JSON‑схеме и требованиям локали RU (запятая как десятичный разделитель), см. `.memory-base/Tech details/infrastructure/extraction-pipeline.md`.

## Текущее место изменения
- `api-gateway/app/services/vision_extraction.py:1` — `VISION_PROMPT` и логика парсинга JSON (responseMimeType=`application/json`).

## Новые требования к промпту
- Возвращать ТОЛЬКО JSON без лишнего текста.
- Схема ответа:
  ```json
  { "values": ["6,4", "7,6", "4,4"] }
  ```
- Каждое значение соответствует регулярке `^(?:10|[1-9])([,.][0-9])?$` и диапазону 1..10.
- Игнорировать: осевые подписи (1..10), легенды, «НИЗКАЯ/ВЫСОКАЯ», «ЗОНЫ ИНТЕРПРЕТАЦИИ», а также символы `++`, `+`, `−`, `--`, `%`, `±`.
- Для барчартов: числа брать из ярлыков на барах; для таблиц — из ячеек значений.

## Acceptance Criteria
- Промпт обновлён в `VISION_PROMPT`; в тексте явно прописан формат RU‑десятичной запятой и строгий JSON без обрамляющего текста.
- Юнит‑тесты подтверждают, что:
  - Парсер корректно обрабатывает как запятую, так и точку (нормализация к точке в коде уже есть).
  - Ответы вне диапазона/схемы отклоняются с `InvalidResponseError`.
- Логи не содержат ПДн; в случае неоднозначности инициируется ручная валидация (не молчаливо подставляется значение).

## Подзадачи
1) Обновить `VISION_PROMPT` с примером ответа только в JSON.
2) Перепроверить регулярку и нормализацию значений (запятая → точка) в `VisionMetricExtractor`.
3) Дополнить/исправить тесты в `api-gateway/tests/` для валидации новой формулировки промпта.

## Ссылки
- Пайплайн извлечения: `.memory-base/Tech details/infrastructure/extraction-pipeline.md`
- Vision сервис и парсер: `api-gateway/app/services/vision_extraction.py`
