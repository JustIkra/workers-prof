ID: AI-09
Title: Не отображаются рекомендации на основе ИИ в итоговом отчёте
Type: bug
Priority: P1
Status: Open
Owner: backend+frontend
Created: 2025-11-12

Кратко
— В истории оценок пригодности и карточке итогового отчёта отсутствует блок с рекомендациями ИИ; пользователю показываются только проценты и списки «Сильные стороны / Зоны развития».

Контекст
— После релиза AI-08 (улучшенный пайплайн рекомендаций) в итоговом HTML/JSON отчёте ожидается вывод персонализированных рекомендаций ИИ.
— На скриншотах от 12.11.2025 видно, что в карточке «Разработчик 37.7%» блок рекомендаций отсутствует, вместо него дублируются те же метрики в сильных и слабых сторонах.
— Пользователь загружал отчёт, прошёл полный процесс извлечения (метрики в базе присутствуют, веса применены), но рекомендаций нет.

Проблема
1. Frontend (Vue):
   - Компонент итогового отчёта (`FinalReportHighlights`/`FinalReportRecommendations`) не отображает секцию рекомендаций, даже когда backend возвращает массив `recommendations`.
   - Возможно, поле не приходит из API или фильтруется из-за отсутствия ключа/флага.
2. Backend (FastAPI):
   - Метод `ScoringService.generate_final_report` может не заполнять `recommendations`, если `AI_RECOMMENDATIONS_ENABLED=0` или генерация дала пустой ответ без fallback.
   - Есть подозрение, что при ошибке генерации результат молча очищается и фронт получает пустой список.

Гипотезы
- ENV-переменная `AI_RECOMMENDATIONS_ENABLED` выключена в dev/prod-контурах (значение `0`).
- Celery-таск генерации рекомендаций завершился с ошибкой, но сервис не прокинул её в API (проверить логи `scoring_service`).
- В JSON/HTML отчёте поле `recommendations` присутствует, но фронт компонент ожидает другое имя (`aiRecommendations`), из-за чего ничего не рендерится.
- Падение схемы в Pydantic: если рекомендация не проходит валидацию (`text` пустой/слишком длинный), запись отбрасывается.

Зона изменений
- Backend:
  - Проверить `ScoringService.generate_final_report` и связанные Celery-пайплайны на предмет условий, при которых `recommendations` очищается.
  - Убедиться, что при ошибке генерации устанавливается `recommendations_error` или иной флаг для UI.
  - Добавить тест, гарантирующий, что при успешной генерации данные попадают в ответ `/api/participants/{id}/final-report`.
- Frontend:
  - Проверить сторы и компоненты, где парсится ответ `finalReport` (Pinia `reportsStore`, компонент `HistoryTimeline`).
  - Убедиться, что поле рекомендаций пробрасывается и визуализируется (например, карточки или список пунктов).
  - Добавить UI-индикатор «Рекомендации временно недоступны», если backend вернул пустой список с ошибкой.

Тестирование
- Backend (pytest):
  - Тест на `ScoringService.generate_final_report`: при наличии рекомендаций в `ScoringResult` API возвращает их в JSON и HTML.
  - Тест на обработку ошибки генерации: если Celery вернул ошибку, API выставляет флаг `recommendations_error`.
- Frontend (Vitest/Playwright):
  - Юнит-тест компонента: при переданном массиве рекомендаций список рендерится.
  - E2E: сценарий «Просмотр истории отчётов» отображает блок «Рекомендации» с текстом из API.

Критерии приёмки
- Если backend возвращает не пустой массив `recommendations`, UI отображает блок «Рекомендации» с соответствующим содержимым.
- При отсутствии рекомендаций по причине ошибки пользователь видит явное сообщение, а не пустую карточку.
- JSON и HTML версии отчёта содержат одинаковый набор рекомендаций.
- Логи содержат информацию об ошибках генерации, а не молчаливое игнорирование.

Связанные объекты
- Backend: `app/services/scoring.py`, `app/services/recommendations.py`, `app/routers/scoring.py`
- Frontend: `frontend/src/views/ParticipantReportHistory.vue`, `frontend/src/components/reports/FinalReportRecommendations.vue`
- ENV: `AI_RECOMMENDATIONS_ENABLED`, `AI_VISION_FALLBACK_ENABLED`
- Тикеты: AI-07, AI-08

Артефакты
- Скриншот: 2025-11-12 `history-empty-recommendations.png` (прикреплён в сообщении пользователя)
- Логи: запросить из `api-gateway/app/logs/scoring-2025-11-12.log` (пока не проверены)

Оценка
- Анализ + фиксы backend/frontend + тесты: 1–2 дня (в зависимости от причины).


