ID: BUG-006
Title: Ошибка удаления отчёта — отсутствует backend-эндпоинт DELETE /api/reports/{id}
Type: bug
Priority: P2
Status: Open
Owner: backend
Created: 2025-11-11

Кратко
— При попытке удалить отчёт из карточки участника показывается уведомление «Ошибка удаления отчёта». Удаление не происходит.

Контекст/наблюдения
— Во фронтенде (`frontend/src/views/ParticipantDetailView.vue`) вызывается `reportsApi.delete(report.id)`, что делает HTTP DELETE на `/api/reports/{id}`.  
— В бэкенде роутера удаления отчёта нет: в `api-gateway/app/routers/reports.py` реализованы GET (скачать), POST (загрузка, извлечение), но отсутствует `@router.delete("/reports/{report_id}")`.  
— В логах UI виден общий тост об ошибке удаления. На стороне API запрос завершается 404 Not Found.

Окружение
— macOS 15 (Darwin 25.0.0), локальная среда разработки.  
— FastAPI на 9187, SPA в production-режиме через StaticFiles.

Шаги воспроизведения
1) Открыть карточку участника с загруженными отчётами.  
2) В блоке «Действия» нажать на красную кнопку удаления рядом с любым отчётом.  
3) Подтвердить удаление (если есть подтверждение).  
4) Получить уведомление «Ошибка удаления отчёта».

Фактический результат
— Уведомление об ошибке, отчёт остаётся в списке. В DevTools DELETE /api/reports/{id} -> 404.

Ожидаемый результат
— Отчёт и связанные сущности/файлы удаляются без ошибок, список обновляется (элемент исчезает).

Предполагаемая причина
— Несоответствие контрактов: фронтенд ожидает `DELETE /api/reports/{id}`, а на бэкенде этот маршрут не реализован.

Затронутые места
— Backend: `api-gateway/app/routers/reports.py`, `app/services/report.py`, `app/repositories/*` (каскадное удаление).  
— Frontend: `frontend/src/views/ParticipantDetailView.vue` (обработка успешного/ошибочного удаления).

Критерии приёмки
— Реализован эндпоинт `DELETE /api/reports/{report_id}` (аутентифицированный пользователь).  
— Поведение: удаляет запись `report`, связанные `report_image` и их файлы на диске/S3; удаляет `extracted_metric`, связанные с отчётом.  
— Возвращает 204 No Content при успехе. На повторное удаление того же id — 404.  
— Обновлены/добавлены тесты в `api-gateway/tests/` (минимум: happy path, 404 для несуществующего, 401 без аутентификации).  
— Фронтенд после успешного ответа обновляет список без перезагрузки страницы и показывает зелёный тост.

Технические заметки
— В `app/repositories/report_image.py` уже есть `delete_by_report_id(report_id: uuid.UUID) -> int` — использовать для каскада по изображениям.  
— Добавить сервисный метод `ReportService.delete_report(report_id)` с транзакцией:  
  • удалить метрики `extracted_metric` по `report_id`;  
  • удалить `report_image` и физические файлы (учесть `settings.file_storage`, base path);  
  • удалить сам `report` и связанный `file_ref` при отсутствии других ссылок;  
  • безопасно обрабатывать отсутствие файла на диске.  
— Роут: `@router.delete("/reports/{report_id}", status_code=204)` с проверкой авторизации.  
— Обновить E2E сценарий удаления в `e2e/` при наличии, либо добавить unit/интеграционные тесты.

Связанные артефакты/скриншоты
— Скриншот из UI с баннером «Ошибка удаления отчёта» приложен в обсуждении задачи.

Risks
— Ошибочное удаление связанных данных; необходимость аккуратного каскада и файловых операций.  
— Согласование хранения в LOCAL/MINIO.

Next actions
— Реализовать DELETE-эндпоинт и сервис каскадного удаления; покрыть тестами; обновить фронтенд-обработку результата.


