ID: BUG-01
Title: Статус "Метрики извлечены" устанавливается, но метрики участника не обновляются
Type: bug
Priority: P1
Status: Open
Owner: backend
Created: 2025-11-11

Кратко
— При завершении извлечения метрик из отчёта статус обновляется на "EXTRACTED" (отображается как "Метрики извлечены"), но метрики участника в таблице `participant_metric` могут не обновиться из-за ошибок, которые перехватываются и не прокидываются дальше.

Контекст
— После реализации S2-08 (персональное хранилище метрик участника) метрики должны сохраняться в `participant_metric` через upsert. Однако в коде есть несколько мест, где ошибки при сохранении метрик перехватываются и логируются, но не влияют на финальный статус отчёта. В результате пользователь видит статус "Метрики извлечены", но метрики участника остаются старыми или отсутствуют.

Проблема
1. В `app/tasks/extraction.py` (строки 244-256):
   - Исключения при извлечении метрик ловятся в try-except
   - Ошибка логируется, но выполнение продолжается
   - Статус отчёта всё равно обновляется на "EXTRACTED" (строка 259)

2. В `app/services/metric_extraction.py` (строки 415-423):
   - Ошибки при сохранении отдельной метрики (включая upsert в `participant_metric`) ловятся внутри цикла
   - Ошибка добавляется в список `errors`, но не прерывает процесс
   - Метрика не сохраняется, но счётчик `metrics_saved` не увеличивается

3. Результат:
   - Статус отчёта = "EXTRACTED" (успех)
   - `participant_metric` не обновлён (частично или полностью)
   - Пользователь видит "Метрики извлечены", но метрики участника не изменились

Ожидаемое поведение
— Если при сохранении метрик в `participant_metric` произошла ошибка:
  - Либо статус отчёта должен остаться "PROCESSING" или перейти в "ERROR"
  - Либо должна быть явная индикация частичного успеха (например, "EXTRACTED_WITH_ERRORS")
  - Пользователь должен видеть, что метрики не обновлены

Зона изменений
- Backend (Celery task):
  - В `app/tasks/extraction.py`: проверять результат сохранения метрик перед обновлением статуса
  - Если `metrics_saved == 0` и были ошибки — не устанавливать статус "EXTRACTED"
  - Добавить поле `extract_warnings` в модель `Report` для хранения предупреждений (опционально)

- Backend (Service):
  - В `app/services/metric_extraction.py`: улучшить обработку ошибок при upsert
  - Прокидывать критические ошибки (например, проблемы с БД) наверх
  - Различать некритические ошибки (например, одна метрика не распознана) и критические (например, транзакция не прошла)

- Логирование:
  - Добавить явные логи о том, что метрики не были сохранены в `participant_metric`
  - Логировать количество успешно сохранённых vs. общее количество извлечённых

Тестирование
- Backend (pytest):
  - Симуляция ошибки при upsert в `participant_metric` → статус отчёта НЕ должен быть "EXTRACTED"
  - Симуляция частичного успеха (одна метрика сохранена, другая упала) → проверить поведение статуса
  - Проверка, что при успешном сохранении всех метрик статус корректно обновляется

Критерии приёмки
- Если при сохранении метрик в `participant_metric` произошла критическая ошибка (БД, транзакция) — статус отчёта НЕ должен быть "EXTRACTED"
- Если все метрики успешно сохранены — статус "EXTRACTED" устанавливается корректно
- В логах явно видно, сколько метрик сохранено в `participant_metric` vs. сколько извлечено
- UI показывает корректный статус, соответствующий реальному состоянию метрик участника

Подсказки по реализации
- Проверять `metrics_result.get("metrics_saved", 0) > 0` перед установкой статуса "EXTRACTED"
- Если `metrics_saved == 0` и есть ошибки — установить статус "ERROR" или "PROCESSING" с `extract_error`
- Рассмотреть транзакционность: если upsert в `participant_metric` должен быть атомарным с обновлением статуса, использовать одну транзакцию
- В `MetricExtractionService` различать типы ошибок: транзакционные (критические) vs. валидационные (некритические)

Связанные объекты
- Модель: `app/db/models.py::Report` (статус, `extracted_at`, `extract_error`)
- Задача: `app/tasks/extraction.py::extract_images_from_report`
- Сервис: `app/services/metric_extraction.py::MetricExtractionService`
- Репозиторий: `app/repositories/participant_metric.py::ParticipantMetricRepository`
- Тикет: S2-08 (персональное хранилище метрик участника)

Оценка
- Backend исправление + тесты: 3–4 ч

