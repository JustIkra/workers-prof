Код: AI-06 — Улучшение обработки ошибок Gemini API

Цель
- Добавить 30-секундный таймаут после ошибки "too many requests" (429), убрать ограничения на попытки использования ключей, игнорировать 429/503 ошибки сервиса (не связанные с ключами).

Описание
- Улучшить обработку ошибок Gemini API для более устойчивой работы при проблемах на стороне сервиса. После получения 429 ошибки добавлять фиксированный 30-секундный таймаут перед следующей попыткой. Убрать ограничения на количество попыток использования ключей в пуле. Различать ошибки, связанные с ключами (квоты, лимиты ключа) и ошибки самого сервиса (временная недоступность, перегрузка), и не применять circuit breaker для сервисных ошибок 429/503.

Шаги

1. **Добавить 30-секундный таймаут после 429 ошибки**
   - В `app/clients/pool_client.py` в методе `_execute_with_pool` при обработке `GeminiRateLimitError`:
     - Добавить ожидание 30 секунд перед попыткой следующего ключа
     - Использовать `asyncio.sleep(30)` вместо немедленного переключения
     - Логировать таймаут для мониторинга

2. **Убрать ограничения на попытки использования ключей**
   - В `app/clients/pool_client.py` в методе `_execute_with_pool`:
     - Убрать или значительно увеличить `max_attempts = len(self._pool._keys) * 2`
     - Изменить логику на бесконечные попытки (с защитой от бесконечного цикла через таймауты)
     - Или установить очень большое значение (например, 1000) для практических целей

3. **Различать ошибки ключей и ошибки сервиса**
   - В `app/clients/gemini.py` в `HttpxTransport.request`:
     - При получении 429/503 ошибки анализировать тело ответа или заголовки
     - Определять, связана ли ошибка с квотой ключа или с проблемами сервиса
     - Создать новый тип исключения `GeminiServiceError` для сервисных ошибок
     - Или добавить флаг в существующие исключения для различения типов ошибок

4. **Не применять circuit breaker для сервисных ошибок**
   - В `app/clients/pool_client.py`:
     - При обработке сервисных ошибок (429/503, не связанные с ключами) не вызывать `record_rate_limit` или `record_failure`
   - В `app/clients/key_pool.py`:
     - Добавить метод `record_service_error` который не влияет на circuit breaker
     - Или модифицировать `record_failure` чтобы принимать флаг "service_error" и игнорировать для circuit breaker

5. **Обновить логику retry в GeminiClient**
   - В `app/clients/gemini.py` в методе `_request_with_retry`:
     - Для сервисных ошибок 429/503 использовать фиксированный таймаут 30 секунд
     - Не применять exponential backoff для сервисных ошибок

Тестирование (обязательно)

- **Unit тесты**:
  - Тест 30-секундного таймаута после 429 ошибки
  - Тест бесконечных попыток (с моком таймаута)
  - Тест различения ошибок ключа и сервиса
  - Тест отсутствия влияния сервисных ошибок на circuit breaker

- **Интеграционные тесты**:
  - Симуляция 429 ошибки сервиса → проверка таймаута и продолжения работы
  - Симуляция 503 ошибки → проверка игнорирования circuit breaker
  - Симуляция множественных ошибок → проверка устойчивости пула ключей

- **E2E тесты**:
  - Проверка работы системы при временной недоступности Gemini API
  - Проверка восстановления после сервисных ошибок

AC (Критерии приемки)

- ✅ После получения 429 ошибки от Gemini API система ждет 30 секунд перед следующей попыткой
- ✅ Нет ограничений на количество попыток использования ключей (или очень высокий лимит)
- ✅ Ошибки 429/503, связанные с сервисом (не с ключами), не влияют на circuit breaker
- ✅ Система различает ошибки ключей и ошибки сервиса
- ✅ При сервисных ошибках система продолжает попытки без блокировки ключей
- ✅ Все тесты проходят успешно
- ✅ Логирование отражает тип ошибки (ключ vs сервис) и таймауты

Зависимости

- ✅ AI-01 (Gemini клиент)
- ✅ AI-02 (keys pool и rate limiting)

Файлы для изменения

**Backend**:
- `api-gateway/app/clients/gemini.py` — добавить различение типов ошибок, обновить retry логику
- `api-gateway/app/clients/pool_client.py` — добавить 30-секундный таймаут, убрать ограничения на попытки
- `api-gateway/app/clients/key_pool.py` — добавить метод для сервисных ошибок без влияния на circuit breaker
- `api-gateway/app/clients/exceptions.py` — возможно добавить новый тип исключения для сервисных ошибок
- `api-gateway/tests/test_gemini_client.py` — добавить тесты для новых сценариев
- `api-gateway/tests/test_pool_client.py` — добавить тесты для таймаутов и бесконечных попыток

Примечания

- 30-секундный таймаут выбран как баланс между быстрым восстановлением и снижением нагрузки на сервис
- Различение ошибок ключей и сервиса может потребовать анализа тела ответа или заголовков от Gemini API
- При отсутствии явных признаков в ответе API можно использовать эвристику: если все ключи получают 429/503 одновременно, это скорее всего проблема сервиса
- Circuit breaker должен продолжать работать для ошибок, связанных с конкретными ключами (квоты, невалидные ключи)


