ID: AI-07
Title: Обновление способа извлечения метрик на улучшенный промпт из extract_improved_prompt.py
Type: enhancement
Priority: P2
Status: Open
Owner: backend
Created: 2025-01-27

### Заголовок
Обновление способа извлечения метрик на улучшенный промпт из extract_improved_prompt.py

### Контекст и мотивация
В проекте существует два подхода к извлечению метрик из изображений:

1. **Старый подход** (`VisionMetricExtractor` в `app/services/vision_extraction.py`):
   - Извлекает только числовые значения без меток
   - Использует простой промпт без примеров
   - Возвращает формат `{"values": ["6.4", "7.6", ...]}`
   - Использует `GeminiClient` (одиночный ключ API)
   - Не обрабатывает пары противоположностей
   - Не выполняет предобработку изображений (прозрачный фон)

2. **Новый улучшенный подход** (`extract_improved_prompt.py` и `MetricExtractionService`):
   - Извлекает пары (название метрики, значение)
   - Использует улучшенный промпт с явными примерами и инструкциями
   - Возвращает формат `{"metrics": [{"label": "...", "value": "..."}]}`
   - Использует `GeminiPoolClient` (ротация ключей API, лучшая обработка rate limits)
   - Корректно обрабатывает пары противоположностей (извлекает обе стороны)
   - Выполняет предобработку изображений (конвертация прозрачного фона в белый)
   - Имеет улучшенную обработку ошибок с экспоненциальным backoff

**Проблема:** Старый `VisionMetricExtractor` всё ещё используется в тестах и демо-скриптах, что создаёт несогласованность в подходе к извлечению метрик.

### Требование (одно предложение)
Заменить использование `VisionMetricExtractor` на улучшенный подход из `extract_improved_prompt.py` во всех местах кодовой базы, обеспечив единообразие извлечения метрик.

### Термины и определения
- **Улучшенный промпт** — промпт `IMPROVED_VISION_PROMPT` из `extract_improved_prompt.py`, который извлекает пары метка-значение с явными примерами и инструкциями.
- **Пары противоположностей** — метрики, представленные как пары противоположных характеристик (например, "ЗАМКНУТОСТЬ 8.4 ОБЩИТЕЛЬНОСТЬ"), которые должны извлекаться как две отдельные метрики.

### Объём работ (Scope)

#### Backend:
1. **Обновить `VisionMetricExtractor`** (`app/services/vision_extraction.py`):
   - Заменить промпт на `IMPROVED_VISION_PROMPT` из `extract_improved_prompt.py`
   - Изменить формат ответа с `{"values": [...]}` на `{"metrics": [{"label": "...", "value": "..."}]}`
   - Добавить предобработку изображений (метод `_preprocess_image` из `metric_extraction.py`)
   - Переключиться на `GeminiPoolClient` вместо `GeminiClient` для ротации ключей API
   - Добавить обработку пар противоположностей
   - Обновить метод `extract_metrics_from_image` для возврата меток вместе со значениями
   - Добавить экспоненциальный backoff для обработки 503 ошибок

2. **Обновить тесты** (`tests/test_vision_integration.py`):
   - Адаптировать тесты под новый формат ответа (метки + значения)
   - Обновить моки для нового формата JSON
   - Добавить тесты для обработки пар противоположностей
   - Добавить тесты для предобработки изображений

3. **Обновить демо-скрипт** (`test_ai04_demo.py`):
   - Переключиться на использование обновлённого `VisionMetricExtractor`
   - Адаптировать под новый формат ответа

4. **Унификация кода**:
   - Убедиться, что `MetricExtractionService` и `VisionMetricExtractor` используют одинаковый промпт
   - Вынести общий промпт в константу или конфигурацию
   - Убедиться, что предобработка изображений идентична в обоих сервисах

### Вне объёма (Non-goals)
- Изменение формата хранения метрик в БД (это уже сделано в S2-08)
- Изменение API endpoints (они уже используют `MetricExtractionService`)
- Удаление `VisionMetricExtractor` (он может использоваться в других местах, где нужен только извлечение без сохранения в БД)

### Изменения в коде

#### 1. `app/services/vision_extraction.py`:
- Заменить `VISION_PROMPT` на `IMPROVED_VISION_PROMPT`
- Изменить `__init__` для использования `GeminiPoolClient`
- Добавить метод `_preprocess_image` (скопировать из `metric_extraction.py`)
- Обновить `extract_metrics_from_image` для возврата меток
- Добавить метод `_extract_metrics_with_retry` с экспоненциальным backoff
- Обновить `_extract_and_filter_values` для парсинга нового формата `{"metrics": [...]}`
- Обновить `ExtractedMetric` dataclass для включения метки (опционально)

#### 2. `tests/test_vision_integration.py`:
- Обновить моки для формата `{"metrics": [{"label": "...", "value": "..."}]}`
- Добавить тесты для пар противоположностей
- Добавить тесты для предобработки изображений
- Обновить assertions для проверки меток

#### 3. `test_ai04_demo.py`:
- Обновить для работы с новым форматом ответа
- Добавить вывод меток вместе со значениями

### Обратная совместимость
- Если `VisionMetricExtractor` используется в других местах, где ожидается только список значений, нужно:
  - Либо добавить опциональный параметр для возврата только значений
  - Либо обновить все места использования
  - Либо создать адаптер для обратной совместимости

### Тестирование
- **Backend (pytest)**:
  - Обновить существующие тесты `test_vision_integration.py` под новый формат
  - Добавить тесты для пар противоположностей
  - Добавить тесты для предобработки изображений (прозрачный фон → белый)
  - Тесты для экспоненциального backoff при 503 ошибках
  - Тесты для ротации ключей API через `GeminiPoolClient`
  
- **Интеграционные тесты**:
  - Проверить, что обновлённый `VisionMetricExtractor` работает с реальными изображениями
  - Сравнить качество извлечения до и после обновления

### Критерии приёмки
- Все тесты проходят с обновлённым `VisionMetricExtractor`
- `VisionMetricExtractor` использует тот же промпт, что и `MetricExtractionService`
- `VisionMetricExtractor` корректно извлекает пары противоположностей (обе стороны)
- Предобработка изображений работает корректно (прозрачный фон → белый)
- Используется `GeminiPoolClient` для ротации ключей API
- Экспоненциальный backoff работает при 503 ошибках
- Демо-скрипт `test_ai04_demo.py` работает с обновлённым форматом
- Нет регрессий в существующей функциональности

### Риски и открытые вопросы
- **Обратная совместимость**: Если `VisionMetricExtractor` используется в других местах, где ожидается только список значений, нужно решить, как обрабатывать метки.
- **Производительность**: `GeminiPoolClient` может иметь другую производительность по сравнению с `GeminiClient` — нужно проверить.
- **Формат ответа**: Нужно решить, должен ли `VisionMetricExtractor` возвращать только значения (для обратной совместимости) или метки + значения (для единообразия).

### План реализации (шаги высокого уровня)
1. Изучить все места использования `VisionMetricExtractor`
2. Вынести общий промпт `IMPROVED_VISION_PROMPT` в константу или конфигурацию
3. Обновить `VisionMetricExtractor`:
   - Заменить промпт
   - Переключиться на `GeminiPoolClient`
   - Добавить предобработку изображений
   - Обновить парсинг ответа
   - Добавить обработку пар противоположностей
4. Обновить тесты под новый формат
5. Обновить демо-скрипт
6. Провести интеграционное тестирование
7. Проверить обратную совместимость

### Связанные объекты
- Файл: `app/services/vision_extraction.py` — старый экстрактор
- Файл: `app/cli/extract_improved_prompt.py` — источник улучшенного промпта
- Файл: `app/services/metric_extraction.py` — новый сервис, использующий улучшенный промпт
- Файл: `tests/test_vision_integration.py` — тесты для обновления
- Файл: `test_ai04_demo.py` — демо-скрипт для обновления

### Оценка
- Backend обновление: 4–6 ч
- Обновление тестов: 2–3 ч
- Интеграционное тестирование: 2–3 ч
- **Итого: 8–12 ч**

