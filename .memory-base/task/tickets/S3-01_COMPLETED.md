–ö–æ–¥: S3-01 ‚Äî DOCX parse ‚Üí –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã (COMPLETED)

–¶–µ–ª—å
- Celery‚Äë–∑–∞–¥–∞—á–∞ –∏–∑–≤–ª–µ–∫–∞–µ—Ç `word/media/*` –∏ –ø–∏—à–µ—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã.

–û–ø–∏—Å–∞–Ω–∏–µ
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∑ `.docx` –≤ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞—Ç–∞–ª–æ–≥–æ–≤ –æ—Ç—á—ë—Ç–∞. –°—Ç–∞—Ç—É—Å—ã –æ—Ç—á—ë—Ç–∞ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É –æ–±—Ä–∞–±–æ—Ç–∫–∏; –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏.

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

## 1. –°–µ—Ä–≤–∏—Å –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (DocxImageExtractor)
**–§–∞–π–ª**: `api-gateway/app/services/docx_extraction.py`

- –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ `word/media/*` –≤–Ω—É—Ç—Ä–∏ DOCX-–∞—Ä—Ö–∏–≤–∞
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç—ã: PNG, JPG, JPEG, GIF, BMP
- –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ PNG –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å (RGBA ‚Üí RGB —Å –±–µ–ª—ã–º —Ñ–æ–Ω–æ–º)
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (info, debug, warning)
- Graceful –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã**:
- `extract_images(docx_path)` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è
- `convert_to_png(image_data)` ‚Äî –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ PNG
- `_detect_format(image_data)` ‚Äî –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ —á–µ—Ä–µ–∑ PIL

## 2. Celery –∑–∞–¥–∞—á–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è (extract_images_from_report)
**–§–∞–π–ª**: `api-gateway/app/tasks/extraction.py`

- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- –ü–æ–ª–Ω—ã–π –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏:
  1. –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á—ë—Ç–∞ –∏–∑ –ë–î (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—Ç–∞—Ç—É—Å–∞ UPLOADED)
  2. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∑ DOCX
  3. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ PNG
  4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
  5. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π FileRef –∏ ReportImage
  6. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –æ—Ç—á—ë—Ç–∞ (EXTRACTED/FAILED)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å retry –º–µ—Ö–∞–Ω–∏–∑–º–æ–º (60 —Å–µ–∫ –∑–∞–¥–µ—Ä–∂–∫–∞)
- –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è**:
```
reports/{participant_id}/{report_id}/images/image_0.png
reports/{participant_id}/{report_id}/images/image_1.png
...
```

## 3. API —ç–Ω–¥–ø–æ–∏–Ω—Ç
**–§–∞–π–ª**: `api-gateway/app/routers/reports.py:81`

**–≠–Ω–¥–ø–æ–∏–Ω—Ç**: `POST /reports/{report_id}/extract`

- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –æ—Ç—á—ë—Ç–∞
- –ó–∞–ø—É—Å–∫–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –∑–∞–¥–∞—á—É –∏–∑–≤–ª–µ—á–µ–Ω–∏—è
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç 202 Accepted —Å task_id
- –¢—Ä–µ–±—É–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

**–û—Ç–≤–µ—Ç**:
```json
{
  "report_id": "uuid",
  "task_id": "celery-task-id",
  "status": "accepted",
  "message": "Extraction task started"
}
```

## 4. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
–î–æ–±–∞–≤–ª–µ–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:

- **INFO**: –ù–∞—á–∞–ª–æ/–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- **DEBUG**: –î–µ—Ç–∞–ª–∏ –∫–∞–∂–¥–æ–≥–æ –∏–∑–≤–ª–µ—á—ë–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (—Ä–∞–∑–º–µ—Ä, —Ñ–æ—Ä–º–∞—Ç)
- **WARNING**: –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
- **ERROR**: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ —Å –ø–æ–ª–Ω—ã–º traceback (exc_info=True)

–í—Å–µ –ª–æ–≥–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç report_id –¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏.

## 5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit-—Ç–µ—Å—Ç—ã (TestDocxImageExtractor)
**–§–∞–π–ª**: `api-gateway/tests/test_docx_extraction.py`

‚úÖ `test_extract_images__valid_docx__returns_images` ‚Äî –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–∑ –≤–∞–ª–∏–¥–Ω–æ–≥–æ DOCX
‚úÖ `test_extract_images__no_images__returns_empty_list` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Å—Ç–æ–≥–æ DOCX
‚úÖ `test_extract_images__invalid_file__raises_error` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
‚úÖ `test_extract_images__nonexistent_file__raises_error` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ñ–∞–π–ª–∞
‚úÖ `test_convert_to_png__valid_image__converts_successfully` ‚Äî –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è JPEG‚ÜíPNG
‚úÖ `test_convert_to_png__rgba_image__handles_transparency` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã**: 6 passed in 0.12s ‚úÖ

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (TestReportImageExtraction)
‚úÖ `test_extract_report__uploaded_status__updates_to_extracted` ‚Äî –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –∏–∑–≤–ª–µ—á–µ–Ω–∏—è
‚úÖ `test_extract_report__invalid_docx__updates_to_failed` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è
‚úÖ `test_extract_report__creates_report_image_records` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ ReportImage –∏ FileRef

### API —Ç–µ—Å—Ç—ã (TestExtractionEndpoint)
‚úÖ `test_extract_endpoint__valid_report__returns_accepted` ‚Äî —É—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—É—Å–∫ –∑–∞–¥–∞—á–∏
‚úÖ `test_extract_endpoint__nonexistent_report__returns_404` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –æ—Ç—á—ë—Ç–∞
‚úÖ `test_extract_endpoint__unauthenticated__returns_401` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

### –•–µ–ª–ø–µ—Ä—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
–§—É–Ω–∫—Ü–∏—è `create_test_docx_with_images(path, num_images)` —Å–æ–∑–¥–∞—ë—Ç –≤–∞–ª–∏–¥–Ω—ã–µ DOCX —Ñ–∞–π–ª—ã —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

## Acceptance Criteria (AC)

‚úÖ **–°—Ç–∞—Ç—É—Å—ã –æ—Ç—á—ë—Ç–∞**: UPLOADED ‚Üí EXTRACTED (—É—Å–ø–µ—Ö) –∏–ª–∏ FAILED (–æ—à–∏–±–∫–∞)
‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å —É—Ä–æ–≤–Ω—è–º–∏ INFO/DEBUG/ERROR
‚úÖ **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤**: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `reports/{participant_id}/{report_id}/images/`
‚úÖ **–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –ë–î**: FileRef –∏ ReportImage —Å–æ–∑–¥–∞—é—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: Graceful handling —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º `extract_error` –ø–æ–ª—è
‚úÖ **–¢–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ**: Unit, integration –∏ API —Ç–µ—Å—Ç—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã

## –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. `api-gateway/app/services/docx_extraction.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
2. `api-gateway/app/tasks/extraction.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
3. `api-gateway/tests/test_docx_extraction.py` ‚Äî –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –≤–º–µ—Å—Ç–æ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

–í—ã–ø–æ–ª–Ω–µ–Ω—ã:
- ‚úÖ S1-07 (file_ref, report, storage)

–ì–æ—Ç–æ–≤–æ –¥–ª—è:
- üîú S3-02 (OCR endpoints)
- üîú S3-03 (Logging & Tracing)

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- Celery –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ `task_always_eager=True` –¥–ª—è —Ç–µ—Å—Ç–æ–≤ (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ)
- –í production –∑–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —á–µ—Ä–µ–∑ RabbitMQ
- Retry –º–µ—Ö–∞–Ω–∏–∑–º: 3 –ø–æ–ø—ã—Ç–∫–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 60 —Å–µ–∫
- Timeout –∑–∞–¥–∞—á–∏: 10 –º–∏–Ω—É—Ç (hard), 9 –º–∏–Ω—É—Ç (soft)
- –í—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≤ PNG –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è
