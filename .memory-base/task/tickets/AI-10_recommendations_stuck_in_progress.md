ID: AI-10
Title: Экран рекомендаций застревает в статусе «Формируются»
Type: bug
Priority: P1
Status: Open
Owner: backend+frontend
Created: 2025-11-12

Кратко
— После завершения всех этапов обработки отчёта блок «Рекомендации» на фронтенде не сменяет статус «Формируются», пользователю предлагается обновить страницу, но прогресс не завершается.

Контекст
— Пользователь загрузил отчёт, метрики и веса успешно рассчитаны, проценты и сильные/слабые стороны отображаются.
— На UI («Рекомендации: Формируются») постоянно висит спиннер/бейдж, рядом всплывает подсказка «Рекомендации формируются. Обновите страницу через пару минут».
— Проблема всплыла 12.11.2025; скриншот приложен пользователем.

Проблема
1. Backend:
   - Celery-таск генерации рекомендаций может зависать или завершаться ошибкой без обновления статуса `recommendations_status` в `scoring_result`.
   - `ScoringService.generate_final_report` может возвращать статус `processing`, если таск ещё идёт, но при ошибке статус не переключается на `failed`.
2. Frontend:
   - Компонент рекомендаций в Pinia-сторе/компоненте отчёта не обрабатывает статусы `failed`/`ready`, если backend вернул пустое поле.
   - Возможно, UI опирается на устаревший флаг (`isRecommendationsReady`), который не обновляется после ответа API.

Гипотезы
- Celery-таск висит в очереди `vision` или `normalize`, поэтому `status` остаётся `pending`.
- При ошибке генерации `recommendations_error` записывается, но фронтенд не реагирует и продолжает показывать «Формируются».
- В API отсутствует периодический пуш/поллинг статуса, поэтому после первого запроса фронт не делает повторных обновлений.
- В `scoring_result` нет поля `recommendations_status`, поэтому фронтенд всегда трактует null как «в процессе».

Диагностика 2025-11-12
- Backend: `generate_report_recommendations` в `app/tasks/recommendations.py` корректно устанавливает `recommendations_status = "ready"` (или `error/disabled`) и коммитит изменения; `ScoringService.generate_final_report` возвращает фактическое значение статуса из БД. Тесты `tests/test_recommendations.py` уже покрывают успешное завершение и выключенный режим, проблем не выявлено.
- Frontend: `ParticipantDetailView.vue` загружает историю скорингов (`loadScoringResults`) только один раз при `onMounted`. После расчёта пригодности новый результат добавляется локально со статусом `pending`, а дальнейший поллинг истории отсутствует; автorefresh охватывает только отчёты/метрики. В итоге состояние стора не синхронизируется с сервером после завершения Celery-таска, и UI продолжает показывать «Формируются».
- Дополнительно: `normalizeScoringResult` оставляет статус `pending`, если он пришёл из API, поэтому без повторной загрузки истории статус не переключится даже если в БД уже `ready`.

Зона изменений
- Backend:
  - Проверить `app/services/recommendations.py` и Celery-таски на корректное выставление статусов `ready/failed`.
  - Убедиться, что API `/api/participants/{id}/final-report` возвращает явный статус и сообщение об ошибке.
  - Добавить метрику/логирование длительности генерации, таймаут на повтор.
- Frontend:
  - Обновить стор `reportsStore` и компонент отчёта, чтобы он реагировал на статусы `ready`, `failed`, `timeout`.
  - Добавить обработку `failed` с пользовательским сообщением и возможностью перезапуска.
  - Настроить повторный поллинг (например, каждые 15 сек до статуса `ready/failed`).

Тестирование
- Backend: pytest на завершение таска и установку статуса в `scoring_result`, проверка реакции API.
- Frontend: Vitest на стор/компонент (рендер статусов `processing`, `ready`, `failed`), Playwright сценарий проверки статусов.

Критерии приёмки
- После успешного завершения генерации UI переключается на отображение списка рекомендаций без ручного обновления страницы.
- При ошибке пользователь видит понятное уведомление и предложение повторить попытку, статус «Формируются» не висит бесконечно.
- Логи содержат информацию о длительных задачах и ошибках генерации.

Связанные объекты
- Backend: `app/tasks/recommendations.py`, `app/services/recommendations.py`, `app/services/scoring.py`
- Frontend: `frontend/src/stores/reportsStore.ts`, `frontend/src/components/reports/FinalReportRecommendations.vue`
- ENV: `AI_RECOMMENDATIONS_ENABLED`, `CELERY_TASK_ALWAYS_EAGER`
- Тикеты: AI-08, AI-09

Артефакты
- Скриншот от 12.11.2025 «recommendations-forming.png» (сообщение пользователя)
- Логи Celery: `api-gateway/app/logs/recommendations-2025-11-12.log` (нужно запросить)

Оценка
- Диагностика + фиксы backend/frontend + тесты: 1–2 дня.


