Код: S3-08 — Объединение изображений из документа для оптимизации запросов к Gemini Vision

Цель
- Объединить все изображения, извлеченные из одного документа, в одно-два больших изображения для оптимизации количества запросов к Gemini Vision API и снижения затрат.

Описание
- В текущей реализации каждое изображение из документа обрабатывается отдельно, что приводит к множественным запросам к Gemini Vision API (по одному на каждое изображение). Для оптимизации необходимо объединить все изображения из одного отчета в одно или два больших составных изображения (в зависимости от количества и размера исходных изображений) и отправить их в Gemini Vision одним запросом. Это снизит количество API-вызовов, уменьшит задержки и оптимизирует использование квот.

Шаги

1. **Анализ текущей реализации**
   - Изучить `app/services/metric_extraction.py` метод `extract_metrics_from_report_images`
   - Изучить `app/services/vision_extraction.py` метод `extract_metrics_from_image`
   - Определить, как сейчас загружаются и обрабатываются изображения из `ReportImage`
   - Понять структуру данных изображений (PNG bytes, размеры)

2. **Реализация функции объединения изображений**
   - Создать метод `_combine_images()` в `MetricExtractionService` или отдельный утилитный класс
   - Использовать PIL/Pillow для объединения изображений:
     - Вертикальное объединение (столбец изображений)
     - Сохранение пропорций исходных изображений
     - Добавление отступов между изображениями для читаемости
     - Ограничение максимального размера итогового изображения (например, 4000x8000 px)
   - Если изображений много или итоговое изображение превышает лимиты, разделить на 2 составных изображения
   - Сохранить информацию о границах исходных изображений для последующего маппинга метрик

3. **Модификация логики извлечения метрик**
   - В `extract_metrics_from_report_images`:
     - Вместо цикла по каждому изображению, объединить все изображения отчета
     - Отправить объединенное изображение(я) в Gemini Vision одним запросом
     - Получить метрики из ответа и корректно распределить их по исходным изображениям
   - Сохранить связь между метриками и исходными `ReportImage` через границы или порядок

4. **Обработка ответа Gemini Vision**
   - Парсить ответ Gemini Vision для объединенного изображения
   - Если метрики содержат информацию о позиции (координаты), использовать её для маппинга
   - Если позиция не указана, использовать порядок метрик и порядок исходных изображений
   - Сохранить метрики с правильной привязкой к `ReportImage.id`

5. **Обработка граничных случаев**
   - Если изображений слишком много (>20) или они очень большие, разделить на 2-3 группы
   - Если объединенное изображение превышает лимиты Gemini Vision (например, 20MB), разделить на части
   - Сохранить возможность обработки одного изображения (fallback на текущую логику)
   - Обработать случай, когда изображений нет или только одно

6. **Оптимизация размера изображений**
   - Перед объединением нормализовать размеры изображений (например, привести к единой ширине)
   - Сжать изображения, если они слишком большие
   - Использовать эффективный формат (PNG для качества, но с оптимизацией)

7. **Логирование и мониторинг**
   - Логировать количество исходных изображений и количество итоговых запросов к Gemini
   - Логировать размеры объединенных изображений
   - Добавить метрики: количество запросов до/после оптимизации

Тестирование (обязательно)

- **Unit тесты**:
  - Тест объединения 2-3 изображений в одно
  - Тест объединения большого количества изображений (>10) в 2 составных
  - Тест обработки граничных случаев (0 изображений, 1 изображение)
  - Тест маппинга метрик обратно к исходным изображениям
  - Тест нормализации размеров перед объединением

- **Интеграционные тесты**:
  - Полный цикл: извлечение изображений → объединение → отправка в Gemini → парсинг ответа → сохранение метрик
  - Проверка корректности привязки метрик к исходным изображениям
  - Проверка работы с реальным отчетом (например, Prasol из S3-06)
  - Сравнение количества запросов до и после оптимизации

- **E2E тесты**:
  - Загрузка отчета с несколькими изображениями через UI
  - Проверка извлечения метрик из объединенных изображений
  - Проверка отображения метрик в карточке участника

AC (Критерии приемки)

- ✅ Все изображения из одного отчета объединяются в 1-2 составных изображения
- ✅ Количество запросов к Gemini Vision API сокращено (1-2 запроса вместо N, где N — количество изображений)
- ✅ Метрики корректно привязаны к исходным `ReportImage` после обработки объединенного изображения
- ✅ Система корректно обрабатывает граничные случаи (0, 1, много изображений)
- ✅ Объединенные изображения не превышают лимиты Gemini Vision API
- ✅ Качество извлечения метрик не ухудшилось (сравнение с текущей реализацией)
- ✅ Все тесты проходят успешно
- ✅ Логирование отражает оптимизацию (количество запросов до/после)

Зависимости

- ✅ S3-01 (извлечение изображений из DOCX)
- ✅ S3-02 (stub endpoints для извлечения)
- ✅ AI-01 (Gemini клиент)
- ✅ AI-02 (keys pool и rate limiting)
- ✅ S2-01 (MetricDef и ExtractedMetric модели)

Файлы для изменения

**Backend**:
- `api-gateway/app/services/metric_extraction.py` — добавить логику объединения изображений, модифицировать `extract_metrics_from_report_images`
- `api-gateway/app/services/vision_extraction.py` — возможно, добавить метод для обработки объединенных изображений
- `api-gateway/app/services/image_utils.py` — создать новый модуль для утилит объединения изображений (если нужно)
- `api-gateway/tests/test_metric_extraction.py` — добавить тесты для объединения изображений
- `api-gateway/tests/test_image_utils.py` — создать тесты для утилит объединения (если создан отдельный модуль)

Примечания

- Объединение изображений должно сохранять читаемость для Gemini Vision
- Важно сохранить возможность отслеживания, из какого исходного изображения извлечена каждая метрика
- При объединении учитывать ограничения Gemini Vision API на размер изображения и общий размер запроса
- Если объединение ухудшает качество извлечения метрик, можно сделать это опциональным (через настройку)
- Рассмотреть возможность горизонтального объединения для широких изображений (таблиц)
- Оптимизация должна быть прозрачной для пользователя — результат извлечения метрик не должен измениться

