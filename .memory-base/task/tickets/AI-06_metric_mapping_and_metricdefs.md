Title: AI-06: Маппинг ярлыков метрик → MetricDef и наполнение словаря метрик

Status: Proposed
Owner: backend
Labels: ai, extraction, metrics, mapping, db, fastapi
Priority: High

Context
- По результатам задачи извлечения метрик из DOCX (Gemini Vision) значения извлекаются, но не сохраняются в БД, т.к. сопоставление выполняется по `MetricDef.name.upper()` и большинство ярлыков отсутствуют в словаре метрик (`MetricDef`). В логах Celery: "No matching MetricDef found" для множественных ярлыков.
- В репозитории уже есть заготовки под YAML‑конфиг маппинга заголовков → `metric_code` (см. `.memory-base/Tech details/infrastructure/metric-mapping.md`, `app/cli/generate_template.py`).
- Существует выгрузка обнаруженных ярлыков из улучшенного пайплайна (`.memory-base/outputs/metrics/batura_improved_metric_names.json`) и подробные результаты (`batura_improved_extraction_results.json`, `batura_improved_metrics_with_values.csv`).

Goal
Обеспечить успешное сохранение извлечённых значений в `extracted_metric` для всех поддерживаемых ярлыков из отчётов, соблюдая правила:
- Маппинг делать через устойчивые `metric_code` (а не по полному `name`), согласно YAML‑конфигу для конкретного типа отчёта.
- Поддержать нормализацию ввода (TRIM/UPPERCASE) ярлыков и строгую валидацию чисел 1..10 с одним десятичным знаком.
- Неизвестные/непомеченные в YAML заголовки — фиксировать как ошибки для ручной валидации (не терять).

Scope
1) Конфигурация маппинга
- Создать YAML в `config/app/metric-mapping.yaml` с секцией `report_mappings` для типов отчётов (`REPORT_1/2/3`). Для каждого указать `header_map: "ТЕКСТ ЯРЛЫКА" -> metric_code`.
- Заполнить `header_map` на основе списка ярлыков из `batura_improved_metric_names.json` (см. ниже) и согласовать коды метрик.
- Добавить загрузку YAML на старте сервиса извлечения (или лениво при первом обращении). Кэшировать в памяти.

2) Словарь метрик (DB)
- Убедиться, что для всех `metric_code` из YAML существуют записи `MetricDef` (code уникален). Если нет — создать миграцию сидирования или управляемый скрипт инициализации (в духе `setup_test_data.py`) для добавления недостающих записей (min/max 0..10, unit "балл").
- Если требуется, согласовать человекочитаемые `name` (они могут отличаться от заголовков в отчётах) — критично чтобы UI показывал корректные названия, а бэкенд маппился по коду.

3) Обновление пайплайна извлечения
- В `app/services/metric_extraction.py` заменить текущую логику сопоставления `metric_def_by_name[normalized_label]` на:
  - Поиск `metric_code` через YAML `header_map` для текущего `report.type` по `normalized_label`.
  - Получение `MetricDef` по `code` (через `MetricDefRepository.get_by_code`), проверка `active`.
  - При отсутствии кода/метрики — добавлять запись в `errors` с пометкой `mapping_not_found` и исходным label.
- Сохранение в `extracted_metric` оставить прежним.

4) Наблюдаемость и отладка
- Улучшить логи: считать и выводить количество успешных маппингов, число пропусков по неизвестным ярлыкам, список первых N неизвестных ярлыков.
- Добавить короткий `GET /api/metrics/mapping/{report_type}` для просмотра текущего YAML‑маппинга (ADMIN).

Out of scope
- Генерация рекомендаций (AI-03) — без изменений.
- Изменение HTML/SPA — только если появятся новые названия в UI (стоит проверить локализацию названий).

Acceptance Criteria
- Запуск задачи извлечения для примеров из `e2e/fixtures` приводит к сохранению метрик (metrics_saved > 0) без массовых ошибок "No matching MetricDef found".
- Все ярлыки из списка ниже либо замапплены в существующие `MetricDef.code`, либо попадают в отчёт об ошибках `mapping_not_found` (не более 5-10% от общего числа на тестовых документах).
- Тесты backend проходят: `pytest` (юнит), интеграционные тесты извлечения без внешней сети (моки Gemini).
- Линтеры: `ruff` и `black` — зелёные.

Risk/Notes
- Названия в отчётах могут отличаться от пользовательских `MetricDef.name` — код решает конфликт. Нужна единая таблица `code -> name` для UI и API.
- Возможны дубликаты ярлыков (например, «КОНТРОЛЬ, АУДИТ» vs «КОНТРОЛЬ АУДИТ») — нормализуем ключ в YAML в UPPER/TRIM и ведём один канонический вариант ключа, а альтернативы — в `aliases` (опционально).

Technical Plan
- Добавить модуль загрузки YAML, например `app/services/metric_mapping.py`:
  - `load_mapping(path) -> Mapping[report_type][upper_label] = metric_code`
  - Кэш + релоад по env-переменной (dev).
- Обновить `MetricExtractionService`:
  - перед циклом сохранения собрать `metric_def_by_code` (repo.list_all(active_only=True) → dict by code).
  - для каждого `normalized_label` → lookup в YAML → `metric_code` → `metric_def_by_code[metric_code]`.
- Добавить small миграцию/скрипт для сидирования недостающих `MetricDef` по согласованным `metric_code`.

Discovered labels (исходник: .memory-base/outputs/metrics/batura_improved_metric_names.json)
- Примеры (не полный YAML, базовый перечень для маппинга):
  - АБСТРАКТНОСТЬ
  - АДМИНИСТРАТОР
  - АКТИВНОСТЬ
  - АНАЛИЗ И ПЛАНИРОВАНИЕ
  - АНАЛИТИК
  - ВЕРБАЛЬНАЯ ЛОГИКА
  - ВКЛЮЧЕННОСТЬ В КОМАНДУ
  - ВНЕШНЯЯ МОТИВАЦИЯ
  - ВНУТРЕННЯЯ МОТИВАЦИЯ
  - ВЫЧИСЛЕНИЯ
  - ГЕНЕРАТОР ИДЕЙ
  - ДЕНЬГИ
  - ДРУЖЕЛЮБИЕ
  - ДУША КОМАНДЫ
  - ЗАМКНУТОСТЬ
  - ЗДОРОВЬЕ
  - ИМПУЛЬСИВНОСТЬ
  - ИННОВАЦИОННОСТЬ
  - ИНТЕГРАТОР
  - ИНТЕЛЛЕКТУАЛЬНАЯ СДЕРЖАННОСТЬ
  - ИНТЕРЕС
  - ИССЛЕДОВАТЕЛЬ РЕСУРСОВ
  - КОМАНДНОСТЬ
  - КОММУНИКАБЕЛЬНОСТЬ
  - КОМПЛЕКСНОЕ РЕШЕНИЕ ПРОБЛЕМ
  - КОНКРЕТНОСТЬ
  - КОНТРОЛЕР
  - КОНТРОЛЬ, АУДИТ
  - КОНФЛИКТНОСТЬ
  - КОНФОРМИЗМ
  - КООРДИНАТОР
  - ЛЕКСИКА
  - ЛИДЕРСТВО
  - ЛЮБОЗНАТЕЛЬНОСТЬ
  - МОРАЛЬНАЯ ГИБКОСТЬ
  - МОРАЛЬНОСТЬ
  - МОТИВАТОР
  - МОТИВАЦИЯ ДОСТИЖЕНИЙ
  - НЕВЕРБАЛЬНАЯ ЛОГИКА
  - НЕДОВЕРЧИВОСТЬ
  - НЕЗАВИСИМОСТЬ
  - НЕЧУВСТВИТЕЛЬНОСТЬ
  - НОРМАТИВНОСТЬ
  - ОБЕСПЕЧЕНИЕ ПРОЦЕССА
  - ОБРАБОТКА ИНФОРМАЦИИ
  - ОБЩЕНИЕ
  - ОБЩИЙ БАЛЛ ИНТЕЛЛЕКТА
  - ОБЩИТЕЛЬНОСТЬ
  - ОРГАНИЗОВАННОСТЬ
  - ОРИГИНАЛЬНОСТЬ
  - ОРИЕНТАЦИЯ НА КЛИЕНТА
  - ОТВЕТСТВЕННОСТЬ
  - ПАССИВНОСТЬ
  - ПОДДЕРЖКА
  - ПОМОЩЬ ЛЮДЯМ
  - ПРЕДПРИНИМАТЕЛЬ
  - ПРИЗНАНИЕ
  - ПРИНЯТИЕ РЕШЕНИЙ
  - ПРОДВИЖЕНИЕ
  - ПРОИЗВОДИТЕЛЬ
  - ПРОИЗВОДСТВО И ТЕХНОЛОГИИ
  - ПРОСТРАНСТВЕННОЕ МЫШЛЕНИЕ
  - РАБОТА С ДОКУМЕНТАМИ
  - РАЗРАБОТКА
  - РЕАЛИЗАТОР
  - РУКОВОДСТВО
  - СВЯЗИ
  - СЕНЗИТИВНОСТЬ
  - СЛУЖЕНИЕ ОБЩЕСТВУ
  - СПЕЦИАЛИСТ
  - СТРЕМЛЕНИЕ К САМОРАЗВИТИЮ
  - СТРЕССОУСТОЙЧИВОСТЬ
  - ТВОРЧЕСТВО
  - ТРАДИЦИИ
  - ТРАДИЦИОННОСТЬ
  - ТРЕВОЖНОСТЬ
  - УРАВНОВЕШЕННОСТЬ
  - ЭРУДИЦИЯ

Deliverables
- YAML‑файл маппинга в `config/app/metric-mapping.yaml`.
- Обновлённый `MetricExtractionService` c поддержкой маппинга по `metric_code`.
- Скрипт/миграция для сидирования недостающих `MetricDef`.
- Обновлённые тесты (юнит/интеграция) + документация в `.memory-base/Tech details/infrastructure/metric-mapping.md` (пример структуры YAML и договорённости по кодам).

How to Test
1) Собрать фронтенд, запустить API, импортировать три DOCX (см. READMЕ). 
2) Запустить извлечение по отчётам и убедиться, что `metrics_saved > 0`, а список ошибок по маппингу минимален.
3) Проверить `GET /api/reports/{id}/metrics` — метрики возвращаются с корректными `metric_def`.


