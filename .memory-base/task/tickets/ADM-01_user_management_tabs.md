# ADM-01: Улучшение управления пользователями — вкладки и действия

Статус: Planned
Приоритет: High
Затронутые части: frontend (Vue), backend (FastAPI), тесты (pytest, vitest)
Ответственный: Admin module

## Контекст
Сейчас на странице «Управление пользователями» показываются только пользователи, ожидающие одобрения. Администратору необходимо:
- видеть список уже одобренных пользователей;
- уметь оперативно “забирать доступ” у одобренных (блокировка/revocation);
- иметь возможность полностью удалить пользователя.

## Цель
Разделить управление на три понятные вкладки и добавить нужные действия:
1) «Ожидают одобрения» (PENDING)
2) «Одобренные» (APPROVED)
3) «Заблокированные/Без доступа» (DISABLED) — пользователи с отозванным доступом

Удаление доступно из «Одобренные» и «Заблокированные» (с подтверждением).

## Термины и статусы
- PENDING — пользователь зарегистрирован, ожидает ручного одобрения администратора.
- APPROVED — пользователь одобрен и может входить в систему.
- DISABLED — доступ отозван администратором (логин запрещён, но запись сохранена).

Удаление (DELETE) удаляет пользователя полностью и необратимо. Предпочтительно soft-delete не вводить (нет отдельного поля в модели), но если в модели уже есть флаг — использовать его.

## UI/UX (Frontend, Vue 3)
- Экран «Управление пользователями» преобразовать во вью с тремя вкладками (Element Plus `el-tabs`):
  - «Ожидают одобрения (N)»
  - «Одобренные (N)»
  - «Без доступа (N)»
- В каждой вкладке: таблица с колонками
  - Email
  - Статус (badge)
  - Дата регистрации
  - Действия (зависят от вкладки)
- Действия:
  - PENDING: [Одобрить], [Удалить]
  - APPROVED: [Забрать доступ], [Удалить]
  - DISABLED: [Вернуть доступ], [Удалить]
- Все разрушительные действия сопровождаются confirm-диалогом с понятным текстом.
- Поддержать пагинацию (server-side), строковый поиск по email (поле ввода над таблицей).
- Показать загрузчики и пустые состояния. Ошибки — через уведомления.

## API (Backend, FastAPI)
Добавить/уточнить административные эндпоинты (под префиксом `/api/admin/users`), доступны только ADMIN-роли:

- GET `/api/admin/users` — список с фильтрами и пагинацией
  - query: `status=[pending|approved|disabled]`, `q=<email_substr>`, `page`, `page_size`
  - ответ: `{ items: [...], total: int }`

- POST `/api/admin/users/{user_id}/approve` — перевести PENDING → APPROVED
- POST `/api/admin/users/{user_id}/revoke` — перевести APPROVED → DISABLED
- POST `/api/admin/users/{user_id}/enable` — перевести DISABLED → APPROVED
- DELETE `/api/admin/users/{user_id}` — полное удаление

Требования к безопасности:
- Все маршруты защищены и проверяют роль ADMIN через `app.core.dependencies`.
- Аудит-лог: записывать кто и что сделал (approve/revoke/enable/delete) с timestamp.

## Модель и репозиторий
- В таблице `user` использовать поле `status` с перечислением PENDING/APPROVED/DISABLED.
- Репозиторий: методы для выборки по статусу, поиска, пагинации; методы для смены статуса и удаления.

## Валидные переходы статусов
- PENDING → APPROVED (approve)
- APPROVED → DISABLED (revoke)
- DISABLED → APPROVED (enable)

Попытки иных переходов возвращают 400.

## Тестирование
Backend (pytest):
- Юнит-тесты репозитория (фильтры, пагинация, переходы статусов, ошибки).
- Тесты роутов с ролью ADMIN: 200 на валидных переходах, 400 на невалидных, 403 для не-админов.

Frontend (vitest):
- Рендер трёх вкладок, корректная загрузка данных по статусу.
- Отображение счётчиков (N) по каждой вкладке.
- Вызовы соответствующих API при клике по действиям, подтверждения в модалках.

E2E (Playwright, опционально в отдельной задаче):
- Одобрение пользователя из PENDING.
- Отзыв доступа у APPROVED и возврат доступа.
- Удаление пользователя (включая подтверждение).

## Критерии приёмки
- Админ видит три вкладки с корректными счётчиками.
- Переходы статусов работают по кнопкам и отражаются в UI без перезагрузки страницы.
- Поиск и пагинация работают в каждой вкладке.
- Удаление требует подтверждения и после — запись исчезает из всех списков.
- Действия логируются на бэкенде.

## Замечания по реализации
- На фронтенде использовать существующий Axios-клиент (`/api` baseURL), не дублировать префикс.
- На бэкенде придерживаться слоёв: routers → services → repositories → models; типы — в `app/schemas`.
- Добавить ролевую защиту через зависимости из `app.core.dependencies` (не создавать сессии в роутерах вручную).

## Оценка
- Backend: 6–8 ч (эндпоинты, репозиторий, тесты)
- Frontend: 6–8 ч (вкладки, таблицы, действия, подтверждения, поиск/пагинация)
- Буфер: 2–4 ч (отладка, правки по UX)


