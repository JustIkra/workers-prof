Конвенции тестирования

Область действия
- Все сервисы проекта: backend (FastAPI), frontend (Vue 3), фоновые воркеры (Celery), интеграции (OCR/Gemini).
- Цель — детерминированные, быстрые и воспроизводимые тесты с понятными критериями готовности.

Уровни (пирамида)
- Unit — функции/сервисы без внешних зависимостей; время ≤ 200 мс на тест.
- Integration — БД/репозитории/HTTP API (локальные контейнеры); Celery в eager‑режиме по умолчанию.
- E2E — сквозные сценарии UI (Playwright): минимальный, но стабильный набор критических потоков.

Покрытие и SLAs
- Что такое «покрытие»: доля строк/ветвей кода, которые выполняются тестами; это не гарантия качества, но измеримый минимум.
- Предложение для MVP: backend (строки) ≥ 60% общ., критичные модули (auth, расчёт) ≥ 80%. После стабилизации — поднять до 70%/85%.
- E2E: покрыть 4 ключевых сценария (login, approve, upload, score+download), p95 ≤ 60 с. Запуск по запросу или по расписанию.
- Тесты не делают внешних сетевых вызовов (Gemini) — всегда мокаются.

Правила детерминизма
- Фиксировать время/случайность (freezegun/monkeypatch random/uuid).
- Не читать конфигурацию из реального окружения, использовать фикстуры settings.
- Для OCR/LLM — жёсткие фейки с фиксированными значениями и confidence.

Структура и инструменты
- Backend: pytest, pytest-asyncio, httpx[async], asgi-lifespan; см. `.memory-base/Conventions/Testing/backend.md`.
- Frontend: Vitest + Vue Test Utils (unit), Playwright (e2e); см. `.memory-base/Conventions/Testing/frontend.md`.
- Фикстуры/данные: см. `.memory-base/Conventions/Testing/fixtures.md`.
- Матрица E2E сценариев: `.memory-base/Conventions/Testing/e2e-matrix.md`.
- CI/quality gates: `.memory-base/Conventions/Testing/ci.md`.

Критичные сценарии и edge‑кейсы
- .docx с низким DPI/высоким сжатием, нестандартные шрифты.
- Диаграммы с пропущенными строками/многими знаками после запятой.
- Таблицы без сетки (bar‑charts) — только числовые ярлыки; символы «++/+/−/--» игнорируются.
- Повреждённые/частичные отчёты; повторная загрузка того же отчёта.
- Недостаточные веса или сумма ≠ 1.0; отсутствие активной таблицы.

Требования к тест‑кейсу
- Имя: `test_<unit>__<context>__<expected>()`.
- Структура: Arrange / Act / Assert (AAA) с визуальными разделами в коде.
- Явные проверки статуса/бизнес‑инвариантов, а не только 200‑ок.

Политика моков
- Внешние HTTP и ИИ — всегда мок, кроме целевых интеграционных прогонов в отдельном профиле.
- Celery по умолчанию: `task_always_eager=True`; отдельный флаг включает брокерные тесты.
- Файловое хранилище: temp‑директория вместо MinIO; пути очищаются фикстурой.

Отчётность и флак‑менеджмент
- Любой flakey тест помечается `@pytest.mark.flaky(reruns=2)` до устранения и берётся в бэклог.
- Playwright: запись видео/скриншотов при падениях; хранение артефактов ≤ 7 дней.

Минимальный набор, обязателен к PR
- Backend unit: расчёт коэффициента; валидация весов; RBAC на эндпоинтах.
- Backend integration: загрузка отчёта, сохранение file_ref; расчёт score через API.
- Frontend unit: auth store, форма загрузки, таблица метрик.
- E2E: login → approve → upload → manual metrics → score → download DOCX. На первом этапе — ручной прогон или nightly по расписанию.
