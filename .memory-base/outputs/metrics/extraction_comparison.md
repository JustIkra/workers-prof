# Сравнение методов извлечения метрик из отчетов Batura A.A.

## Исходные данные
- **3 DOCX файла**:
  1. Batura_A.A._Biznes-Profil_Biznes-otchyot_1718107.docx (6 изображений)
  2. Batura_A.A._Biznes-Profil_Otchyot_dlya_respondenta_1718107.docx (8 изображений)
  3. Batura_A.A._Biznes-Profil_Otchyot_po_kompetentsiyam_1718107.docx (4 изображения)

- **Всего**: 18 изображений с барчартами

## Результаты извлечения

### 1. Ручное извлечение (эталон)
- **Извлечено метрик**: 64
- **Время**: ~30-60 минут ручной работы
- **Точность**: 100% (человек)
- **Файл**: `batura_manual_data.csv`

**Примеры метрик**:
- РАБОТА С ДОКУМЕНТАМИ: 6.4
- ПРОДВИЖЕНИЕ: 7.6
- СТРЕССОУСТОЙЧИВОСТЬ: 4.0
- НЕВЕРБАЛЬНАЯ ЛОГИКА: 9.0
- (и еще 60...)

### 2. Gemini Vision с consensus (3 попытки на изображение)
- **Извлечено метрик**: 1 (!!!)
- **Время**: ~5 минут (много времени на retry из-за 503 ошибок)
- **Точность**: ~1.6% (1 из 64)
- **Файл**: `batura_metric_names.json`

**Проблемы**:
- Множественные 503 Server Errors от Gemini API
- Consensus подход с 3 попытками слишком медленный
- Из-за нестабильности API не смог извлечь метрики

**Извлеченная метрика**:
- "Стрессоустойчивость" (только 1 из 64!)

### 3. Hybrid OCR (Tesseract) + Gemini
- **Извлечено метрик**: 0 (!!!)
- **Время**: ~8 секунд (быстро, но бесполезно)
- **Точность**: 0%
- **Файлы**: `batura_hybrid_metric_names.json`, `batura_hybrid_errors.json`

**Проблемы**:
- Tesseract OCR плохо работает с графическими барчартами
- OCR извлекает легенды и оси, но не сами метрики
- Gemini structuring завершается с ошибкой: `'\\n  \"metrics\"'`

**Примеры OCR текста**:
```
ЗОНЫ ИНТЕРПРЕТАЦИИ › | КРАЙНЯЯ | УМЕРЕННАЯ | СРЕДНЯЯ
ОДНОПОЛЮСНАЯ ШКАЛА › шкала с одним полюсом
1 2 3 4 5 6 7 8 9 10
```
(Легенды, но не метрики!)

## Выводы

### Почему автоматическое извлечение не работает:

1. **Gemini Vision API нестабильный**:
   - Множественные 503 ошибки
   - Не все запросы проходят
   - Consensus (3 попытки) делает процесс еще медленнее

2. **OCR не подходит для барчартов**:
   - Барчарты = графика, а не текст
   - OCR видит оси и легенды, но не распознает названия метрик на барах
   - Tesseract не обучен для такого типа документов

3. **Сложность барчартов**:
   - Текст встроен в графику
   - Разная ориентация текста
   - Низкий контраст текста на фоне

### Рекомендуемый подход:

#### Краткосрочное решение (текущая система):
1. **Gemini Vision БЕЗ consensus** (1 попытка вместо 3):
   - Быстрее (в 3 раза)
   - Меньше шансов на 503 ошибки
   - Достаточно для большинства случаев

2. **Улучшенный промпт**:
   - Более четкие инструкции для Gemini
   - Примеры ожидаемого формата
   - Фокус на извлечении пар (название, значение)

3. **Fallback на ручной ввод**:
   - При неудаче автоматического извлечения
   - Показать изображение пользователю
   - Позволить ввести метрики вручную

#### Долгосрочное решение:
1. **Fine-tuned модель** (если есть достаточно данных):
   - Обучить модель специально для барчартов Бизнес-Профиль
   - Или использовать специализированные chart OCR модели

2. **Structured extraction pipeline**:
   - Шаг 1: Детекция областей барчартов
   - Шаг 2: Извлечение названий метрик отдельно
   - Шаг 3: Извлечение значений отдельно
   - Шаг 4: Сопоставление названий и значений

3. **API альтернативы**:
   - GPT-4 Vision (более стабильный, но дороже)
   - Claude Vision (если доступен)
   - Azure Document Intelligence

## Рекомендации для AI-06

**Immediate action**:
1. Переключиться на простой Gemini Vision (без consensus)
2. Добавить UI для ручной корректировки
3. Сохранять изображения для последующей переобработки

**Next steps**:
1. Собрать больше примеров для обучения/fine-tuning
2. Протестировать альтернативные Vision API
3. Рассмотреть специализированные chart/diagram OCR сервисы

## Статистика

| Метод | Извлечено | Время | Точность | Стоимость API |
|-------|-----------|-------|----------|---------------|
| Ручной ввод | 64/64 | ~45 мин | 100% | $0 |
| Gemini Vision (consensus) | 1/64 | ~5 мин | 1.6% | ~$0.20 |
| Hybrid OCR + Gemini | 0/64 | ~8 сек | 0% | ~$0 |

**Вывод**: На данный момент ручной ввод остается наиболее надежным методом для извлечения метрик из барчартов Бизнес-Профиль.
