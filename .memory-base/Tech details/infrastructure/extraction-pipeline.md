Пайплайн извлечения из .docx

Цели: извлечь ЧИСЛОВЫЕ метрики из таблиц/графиков, представленных как изображения в .docx. Важно: никогда не использовать символические оценки вида «++», «+», «-», «--» — только цифры из таблиц/подписей. По умолчанию — Gemini Vision.

Шаги
1) Парсинг .docx
- Инструменты: python-docx/docx2python
- Извлечь изображения (страница, порядок), сохранить как `report_image` (kind=TABLE, если распознано)

2) Предобработка изображений
- OpenCV/Pillow: повышение контраста, бинаризация, устранение перекосов
- Нормировать DPI/размер, фильтровать артефакты

3) Распознавание таблиц/значений (Gemini Vision)
- Отправлять кропы таблиц/ROI барчартов в Gemini Vision с промптом на строгий JSON по заданной схеме
- Перед отправкой минимизировать PII: обрезать до области таблицы/меток, маскировать личные данные
- Принимать только числовые токены диапазона 1..10, соответствующие регулярке `^(?:10|[1-9])([,.][0-9])?$`; все прочее отклонять

4) Нормализация в метрики
- Маппинг: строка-заголовок слева от бара/в первой колонке таблицы → MetricDef.code
- Значение: только числовая метка, извлечённая из бара/ячейки. Запретить использование «++/+/−/--».
- Преобразование строк → числа: локаль RU (запятая как десятичный разделитель). Диапазон [1,10].
- Рассчитать итоговую confidence (агрегация по ячейкам)

5) Правила качества
- Порог уверенности: min_confidence (напр., 0.8)
- Фильтры: отбрасывать токены, содержащие «+», «-», «%», текст служебных подписей («ЗОНЫ ИНТЕРПРЕТАЦИИ», «НИЗКАЯ», «ВЫСОКАЯ», «1…10» ось)
- Структурные проверки: ожидаемое кол-во метрик, диапазоны min/max (1..10)
- При несоответствии → повторная попытка/ручная валидация

6) Контроль качества и обработка ошибок
- Валидация схемы/диапазонов; при неуверенности — помечать для ручной проверки

7) Сохранение (S2-08)
- `extracted_metric` (value, source=LLM, confidence) — техническое хранилище для трассировки
- `participant_metric` — актуальные метрики участника (upsert):
  - Правила приоритета: более поздний report.uploaded_at имеет приоритет
  - При равных датах — выше confidence
  - Ключ уникальности: (participant_id, metric_code)
  - Используется для расчёта пригодности и отображения в UI
- Логи и артефакты (таблица, ячейки) — в файловое хранилище (опц.)

8) Ручная валидация (UI)
- Экран сравнения извлечённых значений с изображением; подсветка боксом места, где найдено число
- Возможность правки значений и повторного сохранения

Celery задачи и очереди
- queue: vision — обращения к Gemini (основной поток; ограничить rate)
- queue: normalize — нормализация/валидация/маппинг
- Ретраи с экспоненциальной задержкой, DLQ (отдельная очередь) для ручного разбирательства

Локализация
- Русский язык текста и формат чисел (запятая как десятичный разделитель)
- Набор тестовых документов с различными шрифтами/разрешением

Рекомендации по извлечению из графиков-барджартов
- Игнорировать легенды и подписи осей; работать в ROI каждой строки: [заголовок слева] + [бар] + [числовой ярлык]
- Группировка по Y-координате (кластеризация строк) и поиск максимальной confidence-цифры в строке
- Для исключения осевых «1..10»: отфильтровать области в нижних 15% изображения и/или элементы с высотой шрифта < минимального порога
- Разрешение нормализовать (ширина 1500–2000 px) для повышения точности распознавания

Безопасность и PII
- Отправка в Gemini Vision используется по умолчанию; при этом необходимо минимизировать PII (жёсткие кропы, маскирование лишнего)
- Логи не содержат PII/сканов; ссылки выданы только авторизованным
