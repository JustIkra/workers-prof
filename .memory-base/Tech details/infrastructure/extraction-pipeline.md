Пайплайн извлечения из .docx

Цели: извлечь ЧИСЛОВЫЕ метрики из таблиц/графиков, представленных как изображения в .docx. Важно: никогда не использовать символические оценки вида «++», «+», «-», «--» — только цифры из таблиц/подписей. По умолчанию — локальный OCR, при сложных случаях — fallback Gemini Vision.

Шаги
1) Парсинг .docx
- Инструменты: python-docx/docx2python
- Извлечь изображения (страница, порядок), сохранить как `report_image` (kind=TABLE, если распознано)

2) Предобработка изображений
- OpenCV/Pillow: повышение контраста, бинаризация, устранение перекосов
- Нормировать DPI/размер, фильтровать артефакты

3) Распознавание таблиц/значений (локально)
- PaddleOCR + PP-Structure: детекция сетки (если есть), ячеек и текстовых элементов
- Для графиков с горизонтальными барами (как на примере) извлекать значения из числовых меток внутри/рядом с баром (шестигранники «6,4», «7,6», …). Игнорировать текстовые обозначения зон и шкалу «1…10» внизу.
- Собрать значения как (text, bbox, confidence), отфильтровать регуляркой `^(?:10|[1-9])([,.][0-9])?$` и диапазоном 1..10

4) Нормализация в метрики
- Маппинг: строка-заголовок слева от бара/в первой колонке таблицы → MetricDef.code
- Значение: только числовая метка, извлечённая из бара/ячейки. Запретить использование «++/+/−/--».
- Преобразование строк → числа: локаль RU (запятая как десятичный разделитель). Диапазон [1,10].
- Рассчитать итоговую confidence (агрегация по ячейкам)

5) Правила качества
- Порог уверенности: min_confidence (напр., 0.8)
- Фильтры: отбрасывать токены, содержащие «+», «-», «%», текст служебных подписей («ЗОНЫ ИНТЕРПРЕТАЦИИ», «НИЗКАЯ», «ВЫСОКАЯ», «1…10» ось)
- Структурные проверки: ожидаемое кол-во метрик, диапазоны min/max (1..10)
- При несоответствии → fallback

6) Fallback: Gemini Vision (точечный)
- Отправить картинку таблицы с промптом на структурированный JSON по заданной схеме
- Проверить схему/диапазоны, при успехе — принять; иначе — пометить для ручной валидации

7) Сохранение
- `extracted_metric` (value, source=OCR|LLM, confidence)
- Логи и артефакты (таблица, ячейки) — в файловое хранилище (опц.)

8) Ручная валидация (UI)
- Экран сравнения извлечённых значений с изображением; подсветка боксом места, где OCR нашёл число
- Возможность правки значений и повторного сохранения

Celery задачи и очереди
- queue: ocr — локальное распознавание
- queue: normalize — нормализация/валидация/маппинг
- queue: vision — обращения к Gemini (ограничить rate)
- Ретраи с экспоненциальной задержкой, DLQ (отдельная очередь) для ручного разбирательства

Локализация
- Русский язык текста и формат чисел (запятая как десятичный разделитель)
- Набор тестовых документов с различными шрифтами/разрешением

Рекомендации по извлечению из графиков-барджартов
- Игнорировать легенды и подписи осей; работать в ROI каждой строки: [заголовок слева] + [бар] + [числовой ярлык]
- Группировка по Y-координате (кластеризация строк) и поиск максимальной confidence-цифры в строке
- Для исключения осевых «1..10»: отфильтровать области в нижних 15% изображения и/или элементы с высотой шрифта < минимального порога
- Разрешение нормализовать (ширина 1500–2000 px) для повышения точности OCR

Безопасность и PII
- Обработка локально приоритетна; внешние вызовы (Gemini) — только при необходимости
- Логи не содержат PII/сканов; ссылки выданы только авторизованным
