#!/usr/bin/env python3
"""
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —à–∞–±–ª–æ–Ω–∞ –ø—Ä–æ—Ñ. –æ–±–ª–∞—Å—Ç–µ–π –∏ –º–∞–ø–ø–∏–Ω–≥–∞ –º–µ—Ç—Ä–∏–∫ (AI-07).

–ù–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è AI-06 —Å–æ–∑–¥–∞–µ—Ç:
1. YAML —Ñ–∞–π–ª —Å —à–∞–±–ª–æ–Ω–æ–º –ø—Ä–æ—Ñ. –æ–±–ª–∞—Å—Ç–µ–π
2. –ö–∞–Ω–¥–∏–¥–∞—Ç—ã metric_code –¥–ª—è –∫–∞–∂–¥–æ–π –º–µ—Ç—Ä–∏–∫–∏ (—Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è + snake_case)
3. –°–µ–∫—Ü–∏–∏ report_mappings –¥–ª—è 3 —Ç–∏–ø–æ–≤ –æ—Ç—á–µ—Ç–æ–≤
"""

import json
from pathlib import Path


# –¢–∞–±–ª–∏—Ü–∞ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–∏ —Ä—É—Å—Å–∫–∏—Ö –±—É–∫–≤
TRANSLIT_MAP = {
    "–ê": "A",
    "–ë": "B",
    "–í": "V",
    "–ì": "G",
    "–î": "D",
    "–ï": "E",
    "–Å": "YO",
    "–ñ": "ZH",
    "–ó": "Z",
    "–ò": "I",
    "–ô": "Y",
    "–ö": "K",
    "–õ": "L",
    "–ú": "M",
    "–ù": "N",
    "–û": "O",
    "–ü": "P",
    "–†": "R",
    "–°": "S",
    "–¢": "T",
    "–£": "U",
    "–§": "F",
    "–•": "KH",
    "–¶": "TS",
    "–ß": "CH",
    "–®": "SH",
    "–©": "SHCH",
    "–™": "",
    "–´": "Y",
    "–¨": "",
    "–≠": "E",
    "–Æ": "YU",
    "–Ø": "YA",
    " ": "_",
    ",": "",
    ".": "",
}


def transliterate(text: str) -> str:
    """
    –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∏—Ä—É–µ—Ç —Ä—É—Å—Å–∫–∏–π —Ç–µ–∫—Å—Ç –≤ –ª–∞—Ç–∏–Ω–∏—Ü—É.

    Args:
        text: –†—É—Å—Å–∫–∏–π —Ç–µ–∫—Å—Ç –≤ –≤–µ—Ä—Ö–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ

    Returns:
        –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
    """
    result = []
    for char in text:
        if char in TRANSLIT_MAP:
            result.append(TRANSLIT_MAP[char])
        else:
            result.append(char)
    return "".join(result)


def generate_metric_code(metric_name: str) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç metric_code –∏–∑ —Ä—É—Å—Å–∫–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è –º–µ—Ç—Ä–∏–∫–∏.

    –ü—Ä–∞–≤–∏–ª–∞:
    1. –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è
    2. –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ UPPER_SNAKE_CASE
    3. –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è

    Args:
        metric_name: –ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–†–ê–ë–û–¢–ê –° –î–û–ö–£–ú–ï–ù–¢–ê–ú–ò")

    Returns:
        Metric code (–Ω–∞–ø—Ä–∏–º–µ—Ä: "RABOTA_S_DOKUMENTAMI")
    """
    # –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è
    transliterated = transliterate(metric_name.upper())

    # –ó–∞–º–µ–Ω—è–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è –Ω–∞ –æ–¥–Ω–æ
    code = "_".join(filter(None, transliterated.split("_")))

    return code


def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —à–∞–±–ª–æ–Ω–∞."""
    import csv

    # –ü—É—Ç—å –∫ –≤—Ö–æ–¥–Ω—ã–º –∏ –≤—ã—Ö–æ–¥–Ω—ã–º —Ñ–∞–π–ª–∞–º
    metrics_csv = Path(
        "/Users/maksim/git_projects/workers-prof/.memory-base/outputs/metrics/batura_improved_metrics_with_values.csv"
    )
    output_yaml = Path(
        "/Users/maksim/git_projects/workers-prof/.memory-base/config/templates/prof_areas_template.yaml"
    )

    # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –≤—ã—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    output_yaml.parent.mkdir(parents=True, exist_ok=True)

    # –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏ —Å–æ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –∏–∑ CSV
    metric_mappings = []
    metric_names_seen = set()

    with open(metrics_csv, "r", encoding="utf-8") as f:
        reader = csv.DictReader(f)
        for row in reader:
            label = row["label"].strip()
            value = row["value"].strip()
            source = row["source"].strip()

            # –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–π –º–µ—Ç—Ä–∏–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å –¥—É–±–ª–∏)
            if label not in metric_names_seen:
                metric_code = generate_metric_code(label)
                metric_mappings.append({
                    "name": label,
                    "code": metric_code,
                    "sample_value": value,
                    "source": source,
                })
                metric_names_seen.add(label)

    print(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(metric_mappings)} –º–µ—Ç—Ä–∏–∫ –∏–∑ {metrics_csv}")

    # –°–æ–∑–¥–∞–µ–º YAML –∫–æ–Ω—Ç–µ–Ω—Ç
    yaml_content = f"""# –®–∞–±–ª–æ–Ω –ø—Ä–æ—Ñ. –æ–±–ª–∞—Å—Ç–µ–π –∏ –º–∞–ø–ø–∏–Ω–≥–∞ –º–µ—Ç—Ä–∏–∫ (AI-07)
#
# –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è AI-06
# –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ –≤ MetricDef.code –∏ –≤–µ—Å–∞ –±—É–¥—É—Ç —É—Ç–≤–µ—Ä–∂–¥–∞—Ç—å—Å—è –≤—Ä—É—á–Ω—É—é
#
# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:
# 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏ —É—Ç–≤–µ—Ä–¥–∏—Ç–µ metric_code –¥–ª—è –∫–∞–∂–¥–æ–π –º–µ—Ç—Ä–∏–∫–∏
# 2. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤–µ—Å–∞ –¥–ª—è –∫–∞–∂–¥–æ–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏
# 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å—É–º–º–∞ –≤–µ—Å–æ–≤ –≤ –∫–∞–∂–¥–æ–π –æ–±–ª–∞—Å—Ç–∏ = 1.00
# 4. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ header_map –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –æ—Ç—á–µ—Ç–∞

# ===== –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏ =====

prof_areas:
  - code: DEFAULT
    name: –û–±—â–µ–µ
    description: –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –±–µ–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏
    weights:
      # –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è MetricDef –∏ –º–∞–ø–ø–∏–Ω–≥–∞
      # –ü—Ä–∏–º–µ—Ä—ã (–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –≤–µ—Å–∞):
      # - metric_code: RABOTA_S_DOKUMENTAMI
      #   weight: 0.05
      # - metric_code: PRODVIZHENIE
      #   weight: 0.05
      # ...
      # –°—É–º–º–∞ –≤–µ—Å–æ–≤ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–∞–≤–Ω–∞ 1.00

# ===== –ö–∞–Ω–¥–∏–¥–∞—Ç—ã –º–µ—Ç—Ä–∏–∫ –¥–ª—è –º–∞–ø–ø–∏–Ω–≥–∞ =====
# –í—Å–µ–≥–æ: {len(metric_mappings)} –º–µ—Ç—Ä–∏–∫

metric_candidates:
"""

    # –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –º–µ—Ç—Ä–∏–∫–∏ —Å –∏—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º–∏ metric_code –∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∑–Ω–∞—á–µ–Ω–∏–π
    for mapping in metric_mappings:
        yaml_content += f'  - name: "{mapping["name"]}"\n'
        yaml_content += f'    code: {mapping["code"]}\n'
        yaml_content += f'    sample_value: {mapping["sample_value"]}\n'
        yaml_content += f'    source: {mapping["source"]}\n'

    # –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–∫—Ü–∏—é report_mappings
    yaml_content += """
# ===== –ú–∞–ø–ø–∏–Ω–≥ –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—Ç—á–µ—Ç–æ–≤ =====
# –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –æ—Ç—á–µ—Ç–∞ —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –≤ –æ—Ç—á–µ—Ç–µ –∫ metric_code

report_mappings:
  REPORT_1:
    description: "–ë–∏–∑–Ω–µ—Å-–æ—Ç—á–µ—Ç (Biznes-otchyot)"
    header_map:
      # –ü—Ä–∏–º–µ—Ä—ã (–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –º–∞–ø–ø–∏–Ω–≥–∏):
      # "–†–ê–ë–û–¢–ê –° –î–û–ö–£–ú–ï–ù–¢–ê–ú–ò": RABOTA_S_DOKUMENTAMI
      # "–ü–†–û–î–í–ò–ñ–ï–ù–ò–ï": PRODVIZHENIE
      # "–ê–ù–ê–õ–ò–ó –ò –ü–õ–ê–ù–ò–†–û–í–ê–ù–ò–ï": ANALIZ_I_PLANIROVANIE
      # ...
    number:
      decimal: ","

  REPORT_2:
    description: "–û—Ç—á–µ—Ç –¥–ª—è respond–µ–Ω—Ç–∞ (Otchyot_dlya_respondenta)"
    header_map:
      # –ü—Ä–∏–º–µ—Ä—ã (–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –º–∞–ø–ø–∏–Ω–≥–∏):
      # "–ì–ï–ù–ï–†–ê–¢–û–† –ò–î–ï–ô": GENERATOR_IDEY
      # "–ò–°–°–õ–ï–î–û–í–ê–¢–ï–õ–¨ –†–ï–°–£–†–°–û–í": ISSLEDOVATEL_RESURSOV
      # ...
    number:
      decimal: ","

  REPORT_3:
    description: "–û—Ç—á–µ—Ç –ø–æ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏—è–º (Otchyot_po_kompetentsiyam)"
    header_map:
      # –ü—Ä–∏–º–µ—Ä—ã (–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –º–∞–ø–ø–∏–Ω–≥–∏):
      # "–õ–ò–î–ï–†–°–¢–í–û": LIDERSTVO
      # "–°–¢–†–ï–°–°–û–£–°–¢–û–ô–ß–ò–í–û–°–¢–¨": STRESSOUSTOYCHIVIST
      # ...
    number:
      decimal: ","

# ===== –ó–∞–º–µ—Ç–∫–∏ =====
# - Metric codes –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—é
# - –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–æ–¥—ã –º–æ–≥—É—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å —Ä—É—á–Ω–æ–π –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏
# - –ü–∞—Ä—ã –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ—Å—Ç–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ó–ê–ú–ö–ù–£–¢–û–°–¢–¨/–û–ë–©–ò–¢–ï–õ–¨–ù–û–°–¢–¨) –∏–∑–≤–ª–µ—á–µ–Ω—ã –æ—Ç–¥–µ–ª—å–Ω–æ
# - –ü–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:
#   1. –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å–∏ MetricDef –≤ –ë–î —Å —ç—Ç–∏–º–∏ –∫–æ–¥–∞–º–∏
#   2. –ó–∞–ø–æ–ª–Ω–∏—Ç—å –≤–µ—Å–∞ –¥–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –æ–±–ª–∞—Å—Ç–µ–π
#   3. –ó–∞–ø–æ–ª–Ω–∏—Ç—å header_map –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –æ—Ç—á–µ—Ç–∞
"""

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º YAML —Ñ–∞–π–ª
    with open(output_yaml, "w", encoding="utf-8") as f:
        f.write(yaml_content)

    print(f"\n‚úÖ –®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: {output_yaml}")
    print(f"   –í—Å–µ–≥–æ –º–µ—Ç—Ä–∏–∫: {len(metric_mappings)}")

    # –í—ã–≤–æ–¥–∏–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä–æ–≤
    print("\nüìã –ü—Ä–∏–º–µ—Ä—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö metric_code —Å–æ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏:")
    for i, mapping in enumerate(metric_mappings[:10], 1):
        print(f'   {i:2d}. "{mapping["name"]}" ‚Üí {mapping["code"]} = {mapping["sample_value"]}')

    if len(metric_mappings) > 10:
        print(f"   ... –∏ –µ—â–µ {len(metric_mappings) - 10} –º–µ—Ç—Ä–∏–∫")

    # –í—ã–≤–æ–¥–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º
    sources = {}
    for mapping in metric_mappings:
        source = mapping["source"]
        sources[source] = sources.get(source, 0) + 1

    print("\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º:")
    for source, count in sorted(sources.items()):
        print(f"   {source}: {count} –º–µ—Ç—Ä–∏–∫")


if __name__ == "__main__":
    main()
