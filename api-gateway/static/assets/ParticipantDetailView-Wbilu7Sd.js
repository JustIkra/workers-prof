import{G as X,m as b,H as Z,I as _e,r as _,c as h,o as n,d as t,v as A,J as bt,w as e,u as w,K as ht,C as kt,L as Ct,M as g,N as W,z as $e,q as f,f as m,O as Y,a as c,E as $,p as Je,e as Xe,P as Ge,A as He,B as fe,Q as Rt,R as Ie,k as Oe,S as Te,g as Ue,T as Et,U as Fe,V as ze,h as Pe,W as Se,X as Be,F as St,n as je,t as $t,Y as At,Z as Mt,_ as Dt,$ as xt,a0 as Lt}from"./index-DqXGjsgl.js";import{A as Vt}from"./AppLayout-DfwcIS6-.js";import{p as me,f as Ee,a as we,m as be,b as Nt,c as It,d as pe}from"./numberFormat-GvvEZKcK.js";import{_ as he}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{u as Ot,p as qe}from"./participants--pVZO_qZ.js";const ye={async upload(v,M){const d=new FormData;return d.append("file",M),(await X.post(`/participants/${v}/reports`,d,{headers:{"Content-Type":"multipart/form-data"}})).data},async download(v){return await X.get(`/reports/${v}/download`,{responseType:"blob"})},async getById(v){return(await X.get(`/reports/${v}`)).data},async delete(v){return(await X.delete(`/reports/${v}`)).data},async extract(v){return(await X.post(`/reports/${v}/extract`)).data},async getMetrics(v){return(await X.get(`/reports/${v}/metrics`)).data},async getList(v){return(await X.get(`/participants/${v}/reports`)).data}},ge={async calculate(v,M){return(await X.post(`/scoring/participants/${v}/calculate`,null,{params:{activity_code:M}})).data},async getHistory(v,M=10){return(await X.get(`/scoring/participants/${v}/scores`,{params:{limit:M}})).data},async getById(v){return(await X.get(`/scoring-results/${v}`)).data},async generateRecommendations(v){return(await X.post(`/reports/${v}/recommendations`)).data},async getFinalReport(v,M,d="json"){const E={params:{activity_code:M,format:d}};d==="html"&&(E.responseType="text");const T=await X.get(`/participants/${v}/final-report`,E);return T.data}},Tt={key:0,class:"error-message"},Ut={__name:"MetricInput",props:{modelValue:{type:[Number,String],default:null},min:{type:Number,default:1},max:{type:Number,default:10},step:{type:Number,default:.1},precision:{type:Number,default:1},placeholder:{type:String,default:"Введите значение"},disabled:{type:Boolean,default:!1},showControls:{type:Boolean,default:!0}},emits:["update:modelValue","change","blur"],setup(v,{emit:M}){const d=v,E=M,T=b(null),x=b(""),O=b(!1),S=b(!1),D=b(""),k=Z(()=>me(x.value)),V=Z(()=>{const r=k.value;return r===null||r<=d.min}),B=Z(()=>{const r=k.value;return r===null||r>=d.max}),U=r=>{if(r==null||r===""){x.value="";return}O.value?x.value=String(r).replace(".",","):x.value=Ee(r,d.precision)},j=r=>{if(r==null||r==="")return S.value=!1,D.value="",!0;const l=me(r);return l===null?(S.value=!0,D.value="Некорректное число",!1):l<d.min?(S.value=!0,D.value=`Значение должно быть не меньше ${Ee(d.min,d.precision)}`,!1):l>d.max?(S.value=!0,D.value=`Значение должно быть не больше ${Ee(d.max,d.precision)}`,!1):(S.value=!1,D.value="",!0)},G=r=>{const l=r.replace(/[^\d,.-]/g,"");let y=!1;const p=l.split("").filter(C=>C===","||C==="."?y?!1:(y=!0,!0):!0).join("").replace(".",",");x.value=p;const o=me(p);o!==null?E("update:modelValue",o):(p===""||p==="-")&&E("update:modelValue",null)},H=()=>{O.value=!1;const r=me(x.value);if(j(x.value)){if(r!==null){const l=Math.round(r*Math.pow(10,d.precision))/Math.pow(10,d.precision),y=Math.max(d.min,Math.min(d.max,l));E("update:modelValue",y),U(y),E("change",y)}}else if(r!==null&&(r<d.min||r>d.max)){const l=Math.max(d.min,Math.min(d.max,r));E("update:modelValue",l),U(l),E("change",l),S.value=!1,D.value=""}E("blur")},K=()=>{O.value=!0,k.value!==null&&(x.value=String(k.value).replace(".",","))},q=()=>{const r=k.value||0,l=Math.min(d.max,r+d.step),y=Math.round(l*Math.pow(10,d.precision))/Math.pow(10,d.precision);E("update:modelValue",y),E("change",y),U(y)},F=()=>{const r=k.value||0,l=Math.max(d.min,r-d.step),y=Math.round(l*Math.pow(10,d.precision))/Math.pow(10,d.precision);E("update:modelValue",y),E("change",y),U(y)};return _e(()=>d.modelValue,r=>{U(r)},{immediate:!0}),U(d.modelValue),(r,l)=>{const y=_("el-button"),p=_("el-button-group"),o=_("el-input");return n(),h(W,null,[t(o,{ref_key:"inputRef",ref:T,modelValue:x.value,"onUpdate:modelValue":l[0]||(l[0]=C=>x.value=C),placeholder:v.placeholder,disabled:v.disabled,class:Ct({"is-invalid":S.value}),onInput:G,onBlur:H,onFocus:K},bt({_:2},[v.showControls?{name:"append",fn:e(()=>[t(p,null,{default:e(()=>[t(y,{icon:w(ht),disabled:v.disabled||V.value,onClick:F},null,8,["icon","disabled"]),t(y,{icon:w(kt),disabled:v.disabled||B.value,onClick:q},null,8,["icon","disabled"])]),_:1})]),key:"0"}:void 0]),1032,["modelValue","placeholder","disabled","class"]),S.value?(n(),h("div",Tt,g(D.value),1)):A("",!0)],64)}}},Ft=he(Ut,[["__scopeId","data-v-74ef628d"]]),zt={class:"card-header"},Pt={key:1},Bt={key:0,class:"metric-description"},jt={key:2,class:"metrics-info"},qt={class:"info-row"},Jt={key:0,class:"info-row"},Xt={__name:"MetricsEditor",props:{reportId:{type:String,required:!0}},emits:["metrics-updated"],setup(v,{emit:M}){const d=v,E=M,T=b(!1),x=b(!1),O=b(!1),S=b(null),D=b([]),k=b([]),V=b({metrics:{}}),B=b({}),U=Z(()=>!k.value||k.value.length===0?[]:[...new Set(k.value.map(p=>p.source))]),j=Z(()=>!k.value||k.value.length===0?null:new Date),G=async()=>{try{const p=await be.listMetricDefs(!0);D.value=p.items||[]}catch(p){console.error("Failed to load metric definitions:",p),S.value="Не удалось загрузить определения метрик"}},H=async()=>{T.value=!0,S.value=null;try{const p=await be.listExtractedMetrics(d.reportId);k.value=p.items||[],V.value.metrics={},k.value.forEach(o=>{V.value.metrics[o.metric_def_id]=me(o.value)}),B.value=JSON.parse(JSON.stringify(V.value.metrics))}catch(p){console.error("Failed to load metrics:",p),S.value="Не удалось загрузить метрики"}finally{T.value=!1}},K=()=>{O.value=!0,B.value=JSON.parse(JSON.stringify(V.value.metrics))},q=()=>{V.value.metrics=JSON.parse(JSON.stringify(B.value)),O.value=!1,S.value=null},F=async()=>{x.value=!0,S.value=null;try{const p=[];for(const[o,C]of Object.entries(V.value.metrics))if(C!=null&&C!==""){const P=Nt(C);P!==null&&p.push({metric_def_id:o,value:P,source:"MANUAL",notes:null})}if(p.length===0){$.warning("Не введено ни одного значения метрики"),x.value=!1;return}await be.bulkCreateExtractedMetrics(d.reportId,p),$.success(`Успешно сохранено ${p.length} метрик`),O.value=!1,await H(),E("metrics-updated")}catch(p){console.error("Failed to save metrics:",p);let o="Не удалось сохранить метрики";p.response?.data?.detail&&(typeof p.response.data.detail=="string"?o=p.response.data.detail:Array.isArray(p.response.data.detail)&&(o=p.response.data.detail.map(C=>C.msg||C.message).join(", "))),S.value=o,$.error(o)}finally{x.value=!1}},r=p=>{switch(p){case"OCR":return"info";case"LLM":return"warning";case"MANUAL":return"success";default:return""}},l=p=>{switch(p){case"OCR":return"OCR";case"LLM":return"Gemini Vision";case"MANUAL":return"Ручной ввод";default:return p}},y=p=>new Date(p).toLocaleString("ru-RU",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});return $e(async()=>{await G(),await H()}),_e(()=>d.reportId,async p=>{p&&await H()}),(p,o)=>{const C=_("el-button"),P=_("el-alert"),Q=_("el-form-item"),ee=_("el-col"),J=_("el-row"),te=_("el-form"),ne=_("el-divider"),le=_("el-tag"),ae=_("el-card");return n(),f(ae,{class:"metrics-editor"},{header:e(()=>[c("div",zt,[o[4]||(o[4]=c("span",null,"Ручной ввод метрик",-1)),O.value?(n(),h("div",Pt,[t(C,{size:"small",onClick:q},{default:e(()=>[...o[2]||(o[2]=[m(" Отмена ",-1)])]),_:1}),t(C,{type:"primary",size:"small",loading:x.value,onClick:F},{default:e(()=>[...o[3]||(o[3]=[m(" Сохранить ",-1)])]),_:1},8,["loading"])])):(n(),f(C,{key:0,type:"primary",size:"small",onClick:K},{default:e(()=>[...o[1]||(o[1]=[m(" Редактировать ",-1)])]),_:1}))])]),default:e(()=>[S.value?(n(),f(P,{key:0,type:"error",title:S.value,closable:"",style:{"margin-bottom":"16px"},onClose:o[0]||(o[0]=L=>S.value=null)},null,8,["title"])):A("",!0),!k.value||k.value.length===0?(n(),f(P,{key:1,type:"info",closable:!1,style:{"margin-bottom":"16px"}},{default:e(()=>[...o[5]||(o[5]=[m(" Метрики для этого отчёта ещё не извлечены. Вы можете ввести их вручную. ",-1)])]),_:1})):A("",!0),t(te,{ref:"formRef",model:V.value,"label-position":"top",disabled:!O.value},{default:e(()=>[t(J,{gutter:20},{default:e(()=>[(n(!0),h(W,null,Y(D.value,L=>(n(),f(ee,{key:L.id,xs:24,sm:12,md:8,lg:6},{default:e(()=>[t(Q,{label:`${w(we)(L)}${L.unit?" ("+L.unit+")":""}`,prop:`metrics.${L.id}`},{default:e(()=>[t(Ft,{modelValue:V.value.metrics[L.id],"onUpdate:modelValue":u=>V.value.metrics[L.id]=u,min:L.min_value||1,max:L.max_value||10,precision:1,step:.1,disabled:!O.value,"show-controls":!0,placeholder:"Введите значение (например: 7,5)"},null,8,["modelValue","onUpdate:modelValue","min","max","disabled"]),L.description?(n(),h("div",Bt,g(L.description),1)):A("",!0)]),_:2},1032,["label","prop"])]),_:2},1024))),128))]),_:1})]),_:1},8,["model","disabled"]),k.value&&k.value.length>0?(n(),h("div",jt,[t(ne),c("div",qt,[o[6]||(o[6]=c("span",{class:"info-label"},"Источник данных:",-1)),(n(!0),h(W,null,Y(U.value,L=>(n(),f(le,{key:L,type:r(L),size:"small",style:{"margin-left":"8px"}},{default:e(()=>[m(g(l(L)),1)]),_:2},1032,["type"]))),128))]),j.value?(n(),h("div",Jt,[o[7]||(o[7]=c("span",{class:"info-label"},"Последнее обновление:",-1)),c("span",null,g(y(j.value)),1)])):A("",!0)])):A("",!0)]),_:1})}}},Gt=he(Xt,[["__scopeId","data-v-8f068e6d"]]),Ht={class:"report-list"},Wt={class:"report-list__controls"},Kt={class:"controls-left"},Qt={class:"controls-right"},Yt={class:"filename"},Zt={class:"status-cell"},ea={key:1,class:"report-list__cards"},ta={class:"report-card__header"},aa={class:"report-card__status"},sa={class:"report-card__body"},na={class:"report-card__field"},la={class:"field-value"},oa={class:"report-card__field"},ra={class:"field-value"},ia={class:"report-card__actions"},ua={__name:"ReportList",props:{reports:{type:Array,required:!0,default:()=>[]},loading:{type:Boolean,default:!1}},emits:["view","edit","extract","download","delete","upload"],setup(v,{emit:M}){const d=v,E=M,T=Je(),x=Xe(),O=b(window.innerWidth<=768),S=()=>{O.value=window.innerWidth<=768};$e(()=>{window.addEventListener("resize",S),T.query.status&&(D.value=T.query.status),T.query.sort&&(k.value=T.query.sort)}),Ge(()=>{window.removeEventListener("resize",S)});const D=b(""),k=b("desc"),V=[{label:"Загружен",value:"UPLOADED"},{label:"Извлечение метрик...",value:"PROCESSING"},{label:"Метрики извлечены",value:"EXTRACTED"},{label:"Ошибка",value:"FAILED"}];_e([D,k],([r,l])=>{const y={...T.query};r?y.status=r:delete y.status,l?y.sort=l:delete y.sort,x.replace({query:y})});const B=()=>{},U=()=>{k.value=k.value==="desc"?"asc":"desc"},j=Z(()=>{let r=[...d.reports];return D.value&&(r=r.filter(l=>l.status===D.value)),r.sort((l,y)=>{const p=new Date(l.uploaded_at),o=new Date(y.uploaded_at);return k.value==="desc"?o-p:p-o}),r}),G=Z(()=>D.value?"Нет отчётов с выбранным статусом":"Нет загруженных отчётов"),H=r=>{if(!r)return"—";const l=new Date(r);return Number.isNaN(l.getTime())?"—":l.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},K=r=>({UPLOADED:"Загружен",PROCESSING:"Извлечение метрик...",EXTRACTED:"Метрики извлечены",FAILED:"Ошибка"})[r]||r,q=r=>({UPLOADED:"info",PROCESSING:"warning",EXTRACTED:"success",FAILED:"danger"})[r]||"info",F=async({action:r,report:l})=>{switch(r){case"view":E("view",l.id);break;case"edit":E("edit",l.id);break;case"extract":E("extract",l.id);break;case"download":E("download",l.id);break;case"delete":try{await St.confirm("Вы уверены, что хотите удалить этот отчёт?","Подтверждение удаления",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}),E("delete",l.id)}catch{}break}};return(r,l)=>{const y=_("el-option"),p=_("el-select"),o=_("el-icon"),C=_("el-button"),P=_("el-table-column"),Q=_("el-tag"),ee=_("el-dropdown-item"),J=_("el-dropdown-menu"),te=_("el-dropdown"),ne=_("el-table"),le=_("el-card"),ae=_("el-empty"),L=He("loading");return n(),h("div",Ht,[c("div",Wt,[c("div",Kt,[t(p,{modelValue:D.value,"onUpdate:modelValue":l[0]||(l[0]=u=>D.value=u),placeholder:"Все статусы",clearable:"",style:{width:"200px"},onChange:B},{default:e(()=>[t(y,{label:"Все статусы",value:""}),(n(),h(W,null,Y(V,u=>t(y,{key:u.value,label:u.label,value:u.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),c("div",Qt,[t(C,{type:k.value==="desc"?"primary":"default",size:"small",onClick:U},{default:e(()=>[t(o,null,{default:e(()=>[t(w(Rt))]),_:1}),m(" "+g(k.value==="desc"?"Новые сверху":"Старые сверху"),1)]),_:1},8,["type"])])]),O.value?fe((n(),h("div",ea,[(n(!0),h(W,null,Y(j.value,u=>(n(),f(le,{key:u.id,class:"report-card",shadow:"hover"},{header:e(()=>[c("div",ta,[c("div",aa,[u.status==="PROCESSING"?(n(),f(o,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(w(Ie))]),_:1})):u.status==="EXTRACTED"?(n(),f(o,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(w(Oe))]),_:1})):u.status==="FAILED"?(n(),f(o,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(w(Te))]),_:1})):(n(),f(o,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(w(Ue))]),_:1})),t(Q,{type:q(u.status),size:"small"},{default:e(()=>[m(g(K(u.status)),1)]),_:2},1032,["type"])])])]),footer:e(()=>[c("div",ia,[u.status==="EXTRACTED"?(n(),f(C,{key:0,type:"success",size:"small",onClick:se=>F({action:"edit",report:u})},{default:e(()=>[t(o,null,{default:e(()=>[t(w(Fe))]),_:1}),l[10]||(l[10]=m(" Редактировать ",-1))]),_:1},8,["onClick"])):A("",!0),u.status==="PROCESSING"||u.status==="EXTRACTED"?(n(),f(C,{key:1,type:"info",size:"small",onClick:se=>F({action:"view",report:u})},{default:e(()=>[t(o,null,{default:e(()=>[t(w(ze))]),_:1}),l[11]||(l[11]=m(" Просмотр ",-1))]),_:1},8,["onClick"])):A("",!0),u.status==="UPLOADED"||u.status==="FAILED"?(n(),f(C,{key:2,type:"primary",size:"small",loading:u.status==="PROCESSING",onClick:se=>F({action:"extract",report:u})},{default:e(()=>[t(o,null,{default:e(()=>[t(w(Pe))]),_:1}),m(" "+g(u.status==="FAILED"?"Повторить":"Извлечь"),1)]),_:2},1032,["loading","onClick"])):A("",!0),t(C,{size:"small",onClick:se=>F({action:"download",report:u})},{default:e(()=>[t(o,null,{default:e(()=>[t(w(Se))]),_:1}),l[12]||(l[12]=m(" Скачать ",-1))]),_:1},8,["onClick"]),t(C,{type:"danger",size:"small",onClick:se=>F({action:"delete",report:u})},{default:e(()=>[t(o,null,{default:e(()=>[t(w(Be))]),_:1})]),_:1},8,["onClick"])])]),default:e(()=>[c("div",sa,[c("div",na,[l[8]||(l[8]=c("span",{class:"field-label"},"Файл:",-1)),c("span",la,g(u.file_ref?.filename||"Без названия"),1)]),c("div",oa,[l[9]||(l[9]=c("span",{class:"field-label"},"Дата загрузки:",-1)),c("span",ra,g(H(u.uploaded_at)),1)])])]),_:2},1024))),128)),!j.value.length&&!v.loading?(n(),f(ae,{key:0,description:G.value,"image-size":120},{default:e(()=>[D.value?A("",!0):(n(),f(C,{key:0,type:"primary",onClick:l[1]||(l[1]=u=>r.$emit("upload"))},{default:e(()=>[...l[13]||(l[13]=[m(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):A("",!0)])),[[L,v.loading]]):fe((n(),f(ne,{key:0,data:j.value,class:"report-list__table",stripe:"","empty-text":G.value},{default:e(()=>[t(P,{prop:"file_ref.filename",label:"Название файла","min-width":"200"},{default:e(({row:u})=>[c("span",Yt,g(u.file_ref?.filename||"Без названия"),1)]),_:1}),t(P,{prop:"status",label:"Статус",width:"200"},{default:e(({row:u})=>[c("div",Zt,[u.status==="PROCESSING"?(n(),f(o,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(w(Ie))]),_:1})):u.status==="EXTRACTED"?(n(),f(o,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(w(Oe))]),_:1})):u.status==="FAILED"?(n(),f(o,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(w(Te))]),_:1})):(n(),f(o,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(w(Ue))]),_:1})),t(Q,{type:q(u.status),size:"default"},{default:e(()=>[m(g(K(u.status)),1)]),_:2},1032,["type"])])]),_:1}),t(P,{prop:"uploaded_at",label:"Дата загрузки",width:"180",sortable:""},{default:e(({row:u})=>[m(g(H(u.uploaded_at)),1)]),_:1}),t(P,{label:"Действия",width:"200",fixed:"right",align:"right"},{default:e(({row:u})=>[t(te,{trigger:"click",onCommand:F},{dropdown:e(()=>[t(J,null,{default:e(()=>[u.status==="EXTRACTED"?(n(),f(ee,{key:0,command:{action:"edit",report:u}},{default:e(()=>[t(o,null,{default:e(()=>[t(w(Fe))]),_:1}),l[4]||(l[4]=m(" Редактировать метрики ",-1))]),_:1},8,["command"])):A("",!0),u.status==="PROCESSING"||u.status==="EXTRACTED"?(n(),f(ee,{key:1,command:{action:"view",report:u}},{default:e(()=>[t(o,null,{default:e(()=>[t(w(ze))]),_:1}),l[5]||(l[5]=m(" Просмотр метрик ",-1))]),_:1},8,["command"])):A("",!0),u.status==="UPLOADED"||u.status==="FAILED"?(n(),f(ee,{key:2,command:{action:"extract",report:u}},{default:e(()=>[t(o,null,{default:e(()=>[t(w(Pe))]),_:1}),m(" "+g(u.status==="FAILED"?"Повторить извлечение":"Извлечь метрики"),1)]),_:2},1032,["command"])):A("",!0),t(ee,{divided:"",command:{action:"download",report:u}},{default:e(()=>[t(o,null,{default:e(()=>[t(w(Se))]),_:1}),l[6]||(l[6]=m(" Скачать ",-1))]),_:1},8,["command"]),t(ee,{command:{action:"delete",report:u},class:"dropdown-item--danger"},{default:e(()=>[t(o,null,{default:e(()=>[t(w(Be))]),_:1}),l[7]||(l[7]=m(" Удалить ",-1))]),_:1},8,["command"])]),_:2},1024)]),default:e(()=>[t(C,{type:"primary",size:"small"},{default:e(()=>[l[3]||(l[3]=m(" Действия ",-1)),t(o,{class:"el-icon--right"},{default:e(()=>[t(w(Et))]),_:1})]),_:1})]),_:2},1024)]),_:1})]),_:1},8,["data","empty-text"])),[[L,v.loading]]),!j.value.length&&!v.loading&&!O.value?(n(),f(ae,{key:2,description:G.value,"image-size":120},{default:e(()=>[D.value?A("",!0):(n(),f(C,{key:0,type:"primary",onClick:l[2]||(l[2]=u=>r.$emit("upload"))},{default:e(()=>[...l[14]||(l[14]=[m(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):A("",!0)])}}},da=he(ua,[["__scopeId","data-v-2d471c96"]]),ca={class:"participant-detail"},pa={class:"card-header"},ma={class:"header-actions"},fa={class:"section-header"},_a={class:"section-header"},va={key:1},ya={key:1},ga={class:"scoring-result"},wa={class:"score-value"},ba={class:"score-number"},ha={class:"score-details"},ka={class:"score-section"},Ca={key:0},Ra={class:"score-section"},Ea={key:0},Sa={class:"score-section"},$a={key:0},Aa={key:0,class:"recommendation-skill-focus"},Ma={key:1,class:"recommendation-advice"},Da={key:2,class:"recommendation-formats"},xa={class:"formats-list"},La={key:0,class:"final-report-actions"},Va={style:{float:"right",color:"#8492a6","font-size":"13px"}},Na={__name:"ParticipantDetailView",setup(v){const M=Xe(),d=Je(),E=Ot(),T=b(!1),x=b(!1),O=b(!1),S=b(!1),D=b(!1),k=b(!1),V=Z(()=>E.currentParticipant),B=b([]),U=b([]),j=b([]),G=b([]),H=b([]);b([]);const K=b(null),q=b(null),F=b(null),r=Z(()=>B.value.some(a=>a.status==="PROCESSING")),l=Z(()=>U.value.some(a=>a.recommendations_status==="pending")),y=b(!1),p=b(!1),o=b(!1),C=b(null),P=b([]),Q=je({file:null}),ee={file:[{required:!0,message:"Выберите файл",trigger:"change"}]},J=je({activityCode:""}),te=a=>{if(!a)return"—";const s=new Date(a);return Number.isNaN(s.getTime())?"—":s.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},ne=a=>a>=80?"success":a>=60?"":"warning",le=a=>({pending:"Формируются",ready:"Готовы",error:"Ошибка",disabled:"Отключены"})[a]||a,ae=a=>({pending:"info",ready:"success",error:"danger",disabled:"warning"})[a]||"info",L=a=>a>=.8?"#67C23A":a>=.6?"#E6A23C":"#F56C6C",u=a=>a?H.value.find(R=>R.code===a)||{code:a}:null,se=async()=>{try{const a=await be.listMetricDefs(!0);H.value=a.items||[]}catch(a){console.error("Error loading metric definitions:",a)}},We=async()=>{T.value=!0;try{await E.getParticipant(d.params.id)}catch{$.error("Участник не найден"),M.push("/participants")}finally{T.value=!1}},oe=async()=>{x.value=!0;try{const a=await qe.getReports(d.params.id);B.value=a.items||[]}catch(a){console.error("Error loading reports:",a),$.error("Ошибка загрузки списка отчётов")}finally{x.value=!1}},Ae=a=>{if(!a)return a;const s=Array.isArray(a.recommendations)?a.recommendations:[];let R=a.recommendations_status||a.recommendationsStatus||null;R||(R=s.length>0?"ready":"pending");const I=Number(a.score_pct),z=Number.isNaN(I)?a.score_pct:I;return{...a,score_pct:z,recommendations:s,recommendations_status:R,recommendations_error:a.recommendations_error||a.recommendationsError||null}},Me=async()=>{try{const a=await ge.getHistory(d.params.id),s=Array.isArray(a.items)?a.items:[];U.value=s.map(Ae)}catch(a){console.error("Error loading scoring results:",a)}},Ke=async()=>{O.value=!0;try{const a=await It.list();j.value=a||[]}catch{$.error("Ошибка загрузки профессиональных областей")}finally{O.value=!1}},re=async()=>{S.value=!0;try{const a=await qe.getMetrics(d.params.id);G.value=a.metrics||[]}catch(a){console.error("Error loading participant metrics:",a),$.error("Ошибка загрузки метрик участника")}finally{S.value=!1}},Qe=a=>{Q.file=a.raw,P.value=[a]},Ye=async()=>{C.value&&await C.value.validate(async a=>{if(a){if(!Q.file){$.error("Выберите файл");return}D.value=!0;try{await ye.upload(d.params.id,Q.file),$.success("Отчёт загружен успешно"),y.value=!1,Q.file=null,P.value=[],await oe(),await re()}catch{$.error("Ошибка загрузки отчёта")}finally{D.value=!1}}})},Ze=async a=>{try{const s=await ye.download(a),R=window.URL.createObjectURL(new Blob([s.data])),I=document.createElement("a");I.href=R,I.setAttribute("download",`report_${a}.docx`),document.body.appendChild(I),I.click(),I.remove(),window.URL.revokeObjectURL(R),$.success("Отчёт скачан")}catch{$.error("Ошибка скачивания отчёта")}},et=async a=>{try{await ye.extract(a),$.success("Извлечение метрик запущено"),await oe()}catch{$.error("Ошибка запуска извлечения метрик")}},tt=()=>{q.value||(q.value=setInterval(async()=>{try{await oe(),await re()}catch(a){console.error("Auto-refresh error:",a)}},3e3))},De=()=>{q.value&&(clearInterval(q.value),q.value=null)},at=()=>{F.value||(F.value=setInterval(async()=>{try{await Me()}catch(a){console.error("Recommendations auto-refresh error:",a)}},15e3))},xe=()=>{F.value&&(clearInterval(F.value),F.value=null)};_e(r,a=>{a?tt():De()}),_e(l,a=>{a?at():xe()});const Le=async a=>{K.value=a,await Lt(),o.value=!0},st=async()=>{$.success("Метрики обновлены"),await re()},nt=async a=>{try{await ye.delete(a),$.success("Отчёт удалён"),await oe()}catch{$.error("Ошибка удаления отчёта")}},lt=async()=>{if(!J.activityCode){$.warning("Выберите профессиональную область");return}k.value=!0;try{const a=await ge.calculate(d.params.id,J.activityCode),s=Ae({id:a.scoring_result_id,participant_id:d.params.id,prof_activity_code:a.prof_activity_code||J.activityCode,prof_activity_name:a.prof_activity_name,score_pct:parseFloat(a.score_pct),strengths:a.strengths||[],dev_areas:a.dev_areas||[],recommendations:a.recommendations||[],recommendations_status:a.recommendations_status||((a.recommendations||[]).length>0?"ready":"pending"),recommendations_error:a.recommendations_error||null,created_at:new Date().toISOString()});U.value.unshift(s),$.success("Расчёт пригодности выполнен"),p.value=!1,J.activityCode=""}catch(a){console.error("Scoring calculation error:",a);const s=a.response?.data?.detail||"Ошибка расчёта пригодности";$.error(s)}finally{k.value=!1}},ot=async a=>{if(!a.prof_activity_code){$.warning("Код профессиональной деятельности не найден");return}try{const s=await ge.getFinalReport(d.params.id,a.prof_activity_code,"json"),R=JSON.stringify(s,null,2),I=new Blob([R],{type:"application/json"}),z=window.URL.createObjectURL(I);window.open(z,"_blank"),window.URL.revokeObjectURL(z),$.success("Отчёт JSON открыт в новой вкладке")}catch(s){console.error("Error viewing final report JSON:",s);const R=s.response?.data?.detail||"Ошибка загрузки финального отчёта";$.error(R)}},rt=async a=>{if(!a.prof_activity_code){$.warning("Код профессиональной деятельности не найден");return}try{const s=await ge.getFinalReport(d.params.id,a.prof_activity_code,"html"),R=new Blob([s],{type:"text/html"}),I=window.URL.createObjectURL(R),z=document.createElement("a");z.href=I,z.setAttribute("download",`final_report_${a.prof_activity_code}_${new Date().toISOString().split("T")[0]}.html`),document.body.appendChild(z),z.click(),z.remove(),window.URL.revokeObjectURL(I),$.success("Отчёт HTML скачан")}catch(s){console.error("Error downloading final report HTML:",s);const R=s.response?.data?.detail||"Ошибка загрузки финального отчёта";$.error(R)}},it=a=>a?.recommendations_status==="ready"&&Array.isArray(a?.recommendations)&&a.recommendations.length>0,ut=a=>a?.recommendations_error?`Ошибка генерации: ${a.recommendations_error}`:"Не удалось получить рекомендации";return $e(async()=>{await We(),await oe(),await Me(),await Ke(),await se(),await re()}),Ge(()=>{De(),xe()}),(a,s)=>{const R=_("el-button"),I=_("el-icon"),z=_("el-descriptions-item"),dt=_("el-descriptions"),ie=_("el-card"),ue=_("el-table-column"),ke=_("el-tag"),ct=_("el-table"),ve=_("el-empty"),pt=_("el-progress"),de=_("el-alert"),mt=_("el-timeline-item"),ft=_("el-timeline"),_t=_("el-upload"),Ve=_("el-form-item"),Ne=_("el-form"),Ce=_("el-dialog"),vt=_("el-option"),yt=_("el-select"),Re=He("loading");return n(),f(Vt,null,{default:e(()=>[fe((n(),h("div",ca,[V.value?(n(),f(ie,{key:0,class:"detail-card"},{header:e(()=>[c("div",pa,[c("h2",null,g(V.value.full_name),1),c("div",ma,[t(R,{onClick:s[0]||(s[0]=i=>w(M).back())},{default:e(()=>[...s[10]||(s[10]=[m(" Назад ",-1)])]),_:1}),t(R,{type:"primary",onClick:s[1]||(s[1]=i=>p.value=!0)},{default:e(()=>[t(I,null,{default:e(()=>[t(w($t))]),_:1}),s[11]||(s[11]=m(" Рассчитать пригодность ",-1))]),_:1})])])]),default:e(()=>[t(dt,{column:2,border:""},{default:e(()=>[t(z,{label:"ФИО"},{default:e(()=>[m(g(V.value.full_name),1)]),_:1}),t(z,{label:"Дата рождения"},{default:e(()=>[m(g(V.value.birth_date||"Не указана"),1)]),_:1}),t(z,{label:"Внешний ID"},{default:e(()=>[m(g(V.value.external_id||"Не указан"),1)]),_:1}),t(z,{label:"Дата создания"},{default:e(()=>[m(g(te(V.value.created_at)),1)]),_:1})]),_:1})]),_:1})):A("",!0),t(ie,{class:"section-card"},{header:e(()=>[c("div",fa,[s[13]||(s[13]=c("h3",null,"Отчёты",-1)),t(R,{type:"primary",onClick:s[2]||(s[2]=i=>y.value=!0)},{default:e(()=>[t(I,null,{default:e(()=>[t(w(At))]),_:1}),s[12]||(s[12]=m(" Загрузить отчёт ",-1))]),_:1})])]),default:e(()=>[t(da,{reports:B.value,loading:x.value,onView:Le,onEdit:Le,onExtract:et,onDownload:Ze,onDelete:nt,onUpload:s[3]||(s[3]=i=>y.value=!0)},null,8,["reports","loading"])]),_:1}),t(ie,{class:"section-card"},{header:e(()=>[c("div",_a,[s[15]||(s[15]=c("h3",null,"Актуальные метрики участника",-1)),t(R,{type:"primary",size:"small",onClick:re},{default:e(()=>[t(I,null,{default:e(()=>[t(w(Dt))]),_:1}),s[14]||(s[14]=m(" Обновить ",-1))]),_:1})])]),default:e(()=>[fe((n(),f(ct,{data:G.value,stripe:""},{default:e(()=>[t(ue,{prop:"metric_code",label:"Метрика",width:"300"},{default:e(({row:i})=>[c("span",null,g(w(we)(u(i.metric_code))),1)]),_:1}),t(ue,{prop:"value",label:"Значение",width:"120"},{default:e(({row:i})=>[t(ke,{type:"success"},{default:e(()=>[m(g(w(pe)(i.value)),1)]),_:2},1024)]),_:1}),t(ue,{prop:"confidence",label:"Уверенность",width:"150"},{default:e(({row:i})=>[i.confidence!==null?(n(),h("span",{key:0,style:Mt({color:L(i.confidence)})},g((i.confidence*100).toFixed(0))+"% ",5)):(n(),h("span",va,"—"))]),_:1}),t(ue,{prop:"updated_at",label:"Обновлено",width:"180"},{default:e(({row:i})=>[m(g(te(i.updated_at)),1)]),_:1}),t(ue,{prop:"last_source_report_id",label:"Источник"},{default:e(({row:i})=>[i.last_source_report_id?(n(),f(ke,{key:0,size:"small"},{default:e(()=>[...s[16]||(s[16]=[m(" Из отчёта ",-1)])]),_:1})):(n(),h("span",ya,"—"))]),_:1})]),_:1},8,["data"])),[[Re,S.value]]),!G.value.length&&!S.value?(n(),f(ve,{key:0,description:"Метрики ещё не извлечены. Загрузите и обработайте отчёты."})):A("",!0)]),_:1}),U.value.length>0?(n(),f(ie,{key:1,class:"section-card"},{header:e(()=>[...s[17]||(s[17]=[c("h3",null,"История оценок пригодности",-1)])]),default:e(()=>[t(ft,null,{default:e(()=>[(n(!0),h(W,null,Y(U.value,i=>(n(),f(mt,{key:i.id,timestamp:te(i.created_at),placement:"top"},{default:e(()=>[t(ie,null,{default:e(()=>[c("h4",null,g(i.prof_activity_name),1),c("div",ga,[c("div",wa,[c("span",ba,g(i.score_pct)+"%",1),t(pt,{percentage:i.score_pct,status:ne(i.score_pct)},null,8,["percentage","status"])]),c("div",ha,[c("div",ka,[s[18]||(s[18]=c("h5",null,"Сильные стороны:",-1)),i.strengths&&i.strengths.length?(n(),h("ul",Ca,[(n(!0),h(W,null,Y(i.strengths,(N,ce)=>(n(),h("li",{key:ce},[c("strong",null,g(w(we)({name:N.metric_name,code:N.metric_code})),1),m(" — "+g(w(pe)(N.value))+" (вес "+g(w(pe)(N.weight,2))+") ",1)]))),128))])):(n(),f(ve,{key:1,description:"Нет данных","image-size":60}))]),c("div",Ra,[s[19]||(s[19]=c("h5",null,"Зоны развития:",-1)),i.dev_areas&&i.dev_areas.length?(n(),h("ul",Ea,[(n(!0),h(W,null,Y(i.dev_areas,(N,ce)=>(n(),h("li",{key:ce},[c("strong",null,g(w(we)({name:N.metric_name,code:N.metric_code})),1),m(" — "+g(w(pe)(N.value))+" (вес "+g(w(pe)(N.weight,2))+") ",1)]))),128))])):(n(),f(ve,{key:1,description:"Нет данных","image-size":60}))]),c("div",Sa,[c("h5",null,[s[20]||(s[20]=m(" Рекомендации: ",-1)),i.recommendations_status?(n(),f(ke,{key:0,type:ae(i.recommendations_status),size:"small",class:"recommendation-status-tag"},{default:e(()=>[m(g(le(i.recommendations_status)),1)]),_:2},1032,["type"])):A("",!0)]),it(i)?(n(),h("ul",$a,[(n(!0),h(W,null,Y(i.recommendations,(N,ce)=>(n(),h("li",{key:ce,class:"recommendation-item"},[c("strong",null,g(N.title),1),N.skill_focus?(n(),h("div",Aa,[s[21]||(s[21]=c("strong",null,"Навык:",-1)),m(" "+g(N.skill_focus),1)])):A("",!0),N.development_advice?(n(),h("div",Ma,g(N.development_advice),1)):A("",!0),N.recommended_formats&&N.recommended_formats.length>0?(n(),h("div",Da,[s[22]||(s[22]=c("strong",null,"Рекомендуемые форматы:",-1)),c("ul",xa,[(n(!0),h(W,null,Y(N.recommended_formats,(gt,wt)=>(n(),h("li",{key:wt},g(gt),1))),128))])])):A("",!0)]))),128))])):i.recommendations_status==="pending"?(n(),f(de,{key:1,title:"Рекомендации формируются. Обновите страницу через пару минут.",type:"info",closable:!1,"show-icon":""})):i.recommendations_status==="error"?(n(),f(de,{key:2,title:ut(i),type:"error",closable:!1,"show-icon":""},null,8,["title"])):i.recommendations_status==="disabled"?(n(),f(de,{key:3,title:"Генерация рекомендаций отключена для данного окружения.",type:"warning",closable:!1,"show-icon":""})):(n(),f(ve,{key:4,description:"Нет данных","image-size":60}))])]),i.prof_activity_code?(n(),h("div",La,[t(R,{type:"info",size:"small",onClick:N=>ot(i)},{default:e(()=>[t(I,null,{default:e(()=>[t(w(xt))]),_:1}),s[23]||(s[23]=m(" Просмотреть JSON ",-1))]),_:1},8,["onClick"]),t(R,{type:"primary",size:"small",onClick:N=>rt(i)},{default:e(()=>[t(I,null,{default:e(()=>[t(w(Se))]),_:1}),s[24]||(s[24]=m(" Скачать HTML ",-1))]),_:1},8,["onClick"])])):A("",!0)])]),_:2},1024)]),_:2},1032,["timestamp"]))),128))]),_:1})]),_:1})):A("",!0),t(Ce,{modelValue:y.value,"onUpdate:modelValue":s[5]||(s[5]=i=>y.value=i),title:"Загрузить отчёт",width:"500px"},{footer:e(()=>[t(R,{onClick:s[4]||(s[4]=i=>y.value=!1)},{default:e(()=>[...s[27]||(s[27]=[m(" Отмена ",-1)])]),_:1}),t(R,{type:"primary",loading:D.value,onClick:Ye},{default:e(()=>[...s[28]||(s[28]=[m(" Загрузить ",-1)])]),_:1},8,["loading"])]),default:e(()=>[t(Ne,{ref_key:"uploadFormRef",ref:C,model:Q,rules:ee,"label-position":"top"},{default:e(()=>[t(Ve,{label:"Файл (DOCX)",prop:"file"},{default:e(()=>[t(_t,{ref:"uploadRef","auto-upload":!1,limit:1,accept:".docx","on-change":Qe,"file-list":P.value},{tip:e(()=>[...s[26]||(s[26]=[c("div",{class:"el-upload__tip"}," Только файлы DOCX, максимум 20 МБ ",-1)])]),default:e(()=>[t(R,{type:"primary"},{default:e(()=>[...s[25]||(s[25]=[m(" Выбрать файл ",-1)])]),_:1})]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(Ce,{modelValue:p.value,"onUpdate:modelValue":s[8]||(s[8]=i=>p.value=i),title:"Рассчитать профессиональную пригодность",width:"500px"},{footer:e(()=>[t(R,{onClick:s[7]||(s[7]=i=>p.value=!1)},{default:e(()=>[...s[29]||(s[29]=[m(" Отмена ",-1)])]),_:1}),t(R,{type:"primary",loading:k.value,disabled:!J.activityCode||B.value.length===0,onClick:lt},{default:e(()=>[...s[30]||(s[30]=[m(" Рассчитать ",-1)])]),_:1},8,["loading","disabled"])]),default:e(()=>[t(Ne,{model:J,"label-position":"top"},{default:e(()=>[t(Ve,{label:"Профессиональная область",required:""},{default:e(()=>[fe((n(),f(yt,{modelValue:J.activityCode,"onUpdate:modelValue":s[6]||(s[6]=i=>J.activityCode=i),placeholder:"Выберите область",style:{width:"100%"}},{default:e(()=>[(n(!0),h(W,null,Y(j.value,i=>(n(),f(vt,{key:i.code,label:i.name,value:i.code},{default:e(()=>[c("span",null,g(i.name),1),c("span",Va,g(i.code),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])),[[Re,O.value]])]),_:1}),t(de,{title:"Убедитесь, что у участника загружены и обработаны отчёты с метриками",type:"info",closable:!1,"show-icon":""}),B.value.length===0?(n(),f(de,{key:0,title:"У участника нет загруженных отчётов",type:"warning",closable:!1,"show-icon":"",style:{"margin-top":"12px"}})):A("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(Ce,{modelValue:o.value,"onUpdate:modelValue":s[9]||(s[9]=i=>o.value=i),title:"Метрики отчёта",width:"90%",top:"5vh"},{default:e(()=>[K.value?(n(),f(Gt,{key:0,"report-id":K.value,onMetricsUpdated:st},null,8,["report-id"])):A("",!0)]),_:1},8,["modelValue"])])),[[Re,T.value]])]),_:1})}}},za=he(Na,[["__scopeId","data-v-c0eab5f4"]]);export{za as default};
