import{G as ee,m as v,H as te,z as ze,q as f,w as l,E as p,r as u,A as De,o as s,a as _,d as t,B as Be,f as i,u as x,S as Me,C as se,c as b,J as P,K as R,L as r,x as Se,T as de,U as We,v as S,N as Pe,O as qe,F as ue}from"./index-C6WPBxo7.js";import{A as Ne}from"./AppLayout-CK_WJyM-.js";import{p as J,m as Ee}from"./metrics-BKPalf9i.js";import{_ as Le}from"./_plugin-vue_export-helper-DlAUqK2U.js";const le={async upload(C){return(await ee.post("/admin/weights/upload",C)).data},async list(C=null){const k=C?{prof_activity_code:C}:{};return(await ee.get("/admin/weights",{params:k})).data},async activate(C){return(await ee.post(`/admin/weights/${C}/activate`)).data}},Re={class:"admin-weights-view"},Je={class:"header-content"},Oe={class:"header-buttons"},Ge={class:"weights-editor"},He={key:0},Ie={key:1},Ke={key:0},je={key:0,style:{"margin-top":"16px"}},Qe={__name:"AdminWeightsView",setup(C){const k=v(!1),F=v(!1),q=v(null),N=v([]),O=v([]),G=v([]),H=v(null),U=v(!1),z=v(!1),A=v(!1),c=v(null),D=v(null),w=v(null),re=v(null),d=v({prof_activity_code:"",weights:[],metadata:{description:""}}),m=v({code:"",name:"",description:""}),V=te(()=>d.value.weights.reduce((o,e)=>o+(parseFloat(e.weight)||0),0)),ce=te(()=>Math.abs(V.value-1)<1e-4&&d.value.weights.length>0),pe=te(()=>Math.abs(V.value-1)<1e-4?"success":V.value<1?"warning":"error"),B=async()=>{try{k.value=!0;const o=await le.list(H.value);N.value=o}catch(o){console.error("Failed to load weight tables:",o),p.error("Ошибка загрузки весовых таблиц")}finally{k.value=!1}},I=async()=>{try{const o=await J.list();O.value=o}catch(o){console.error("Failed to load prof activities:",o),p.error("Ошибка загрузки профессиональных областей")}},ve=async()=>{try{const o=await Ee.listMetricDefs(!0);G.value=o.items||[]}catch(o){console.error("Failed to load metrics:",o),p.error("Ошибка загрузки метрик")}},me=()=>{D.value=null,d.value={prof_activity_code:"",weights:[],metadata:{description:""}},U.value=!0},fe=o=>{D.value=o,d.value={prof_activity_code:o.prof_activity_code,weights:o.weights.map(e=>({metric_code:e.metric_code,weight:parseFloat(e.weight)})),metadata:o.metadata||{description:""}},U.value=!0},_e=()=>{d.value.weights.push({metric_code:"",weight:0})},ge=o=>{d.value.weights.splice(o,1)},ye=async()=>{try{if(F.value=!0,!d.value.prof_activity_code){p.warning("Выберите профессиональную область");return}if(d.value.weights.length===0){p.warning("Добавьте хотя бы одну компетенцию");return}const o=d.value.weights.map(n=>n.metric_code);if(new Set(o.filter(n=>n)).size!==d.value.weights.length){p.warning("Компетенции должны быть уникальными");return}if(d.value.weights.some(n=>!n.metric_code)){p.warning("Все компетенции должны быть заполнены");return}const g={prof_activity_code:d.value.prof_activity_code,weights:d.value.weights.map(n=>({metric_code:n.metric_code,weight:parseFloat(n.weight)})),metadata:d.value.metadata.description?d.value.metadata:null};await le.upload(g),p.success(D.value?"Таблица сохранена":"Таблица создана"),U.value=!1,await B()}catch(o){console.error("Failed to save weight table:",o),p.error(o.response?.data?.detail||"Ошибка сохранения таблицы")}finally{F.value=!1}},we=o=>{c.value=o,z.value=!0},ae=async o=>{try{await ue.confirm(`Активировать весовую таблицу версии ${o.version} для "${o.prof_activity_name}"? Текущая активная версия будет деактивирована.`,"Подтверждение",{confirmButtonText:"Активировать",cancelButtonText:"Отмена",type:"warning"}),q.value=o.id,await le.activate(o.id),p.success("Весовая таблица активирована"),await B(),z.value&&(z.value=!1)}catch(e){e!=="cancel"&&(console.error("Failed to activate weight table:",e),p.error(e.response?.data?.detail||"Ошибка активации таблицы"))}finally{q.value=null}},be=()=>{w.value=null,m.value={code:"",name:"",description:""},A.value=!0},he=o=>{w.value=o,m.value={code:o.code,name:o.name,description:o.description||""},A.value=!0},ke=async()=>{try{if(F.value=!0,!m.value.code||!m.value.name){p.warning("Заполните обязательные поля");return}w.value?(await J.update(w.value.id,{name:m.value.name,description:m.value.description}),p.success("Область обновлена")):(await J.create(m.value),p.success("Область создана")),A.value=!1,await I()}catch(o){console.error("Failed to save prof activity:",o),p.error(o.response?.data?.detail||"Ошибка сохранения области")}finally{F.value=!1}},Ve=async()=>{try{await ue.confirm(`Удалить профессиональную область "${w.value.name}"? Это действие нельзя отменить.`,"Предупреждение",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"error"}),await J.delete(w.value.id),p.success("Область удалена"),A.value=!1,await I(),await B()}catch(o){o!=="cancel"&&(console.error("Failed to delete prof activity:",o),p.error(o.response?.data?.detail||"Ошибка удаления области"))}},K=o=>o.weights.reduce((e,g)=>e+parseFloat(g.weight),0),oe=o=>{const e=K(o);return Math.abs(e-1)<1e-4?"success":"danger"},xe=o=>o.map(e=>{const g=G.value.find(n=>n.code===e.metric_code);return{...e,metric_name:g?.name||e.metric_code,metric_code:e.metric_code}}),ie=o=>new Date(o).toLocaleString("ru-RU");return ze(async()=>{await Promise.all([B(),I(),ve()])}),(o,e)=>{const g=u("el-icon"),n=u("el-button"),j=u("el-card"),Q=u("el-option"),X=u("el-select"),$=u("el-form-item"),Y=u("el-form"),Ce=u("el-empty"),y=u("el-table-column"),T=u("el-tag"),ne=u("el-table"),E=u("el-divider"),Fe=u("el-alert"),Ae=u("el-input-number"),L=u("el-input"),Z=u("el-dialog"),W=u("el-descriptions-item"),$e=u("el-descriptions"),Te=u("el-text"),Ue=De("loading");return s(),f(Ne,null,{default:l(()=>[_("div",Re,[t(j,{class:"header-card"},{default:l(()=>[_("div",Je,[e[15]||(e[15]=_("div",null,[_("h1",null,"Управление весовыми таблицами"),_("p",null,"Создание и активация весовых таблиц для расчёта профессиональной пригодности")],-1)),_("div",Oe,[t(n,{onClick:be},{default:l(()=>[t(g,null,{default:l(()=>[t(x(Me))]),_:1}),e[13]||(e[13]=i(" Новая область ",-1))]),_:1}),t(n,{type:"primary",onClick:me},{default:l(()=>[t(g,null,{default:l(()=>[t(x(se))]),_:1}),e[14]||(e[14]=i(" Создать таблицу ",-1))]),_:1})])])]),_:1}),t(j,{class:"filters-card"},{default:l(()=>[t(Y,{inline:!0},{default:l(()=>[t($,{label:"Профессиональная область"},{default:l(()=>[t(X,{modelValue:H.value,"onUpdate:modelValue":e[0]||(e[0]=a=>H.value=a),placeholder:"Все области",clearable:"",style:{width:"300px"},onChange:B},{default:l(()=>[(s(!0),b(P,null,R(O.value,a=>(s(),f(Q,{key:a.id,label:a.name,value:a.code},{default:l(()=>[_("span",null,r(a.name),1),t(n,{link:"",type:"primary",size:"small",style:{float:"right"},onClick:Se(M=>he(a),["stop"])},{default:l(()=>[t(g,null,{default:l(()=>[t(x(de))]),_:1})]),_:1},8,["onClick"])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t($,null,{default:l(()=>[t(n,{onClick:B,loading:k.value},{default:l(()=>[t(g,null,{default:l(()=>[t(x(We))]),_:1}),e[16]||(e[16]=i(" Обновить ",-1))]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1}),Be((s(),f(j,null,{header:l(()=>[_("span",null,"Весовые таблицы ("+r(N.value.length)+")",1)]),default:l(()=>[N.value.length===0?(s(),f(Ce,{key:0,description:"Нет весовых таблиц"})):(s(),f(ne,{key:1,data:N.value,stripe:""},{default:l(()=>[t(y,{prop:"prof_activity_name",label:"Профессиональная область","min-width":"200"}),t(y,{prop:"version",label:"Версия",width:"100",align:"center"}),t(y,{label:"Активна",width:"100",align:"center"},{default:l(({row:a})=>[a.is_active?(s(),f(T,{key:0,type:"success",size:"small"},{default:l(()=>[...e[17]||(e[17]=[i("Активна",-1)])]),_:1})):(s(),f(T,{key:1,type:"info",size:"small"},{default:l(()=>[...e[18]||(e[18]=[i("Неактивна",-1)])]),_:1}))]),_:1}),t(y,{label:"Компетенций",width:"120",align:"center"},{default:l(({row:a})=>[t(T,{size:"small"},{default:l(()=>[i(r(a.weights.length),1)]),_:2},1024)]),_:1}),t(y,{label:"Сумма весов",width:"120",align:"center"},{default:l(({row:a})=>[t(T,{type:oe(a),size:"small"},{default:l(()=>[i(r(K(a).toFixed(3)),1)]),_:2},1032,["type"])]),_:1}),t(y,{prop:"created_at",label:"Создана",width:"180"},{default:l(({row:a})=>[i(r(ie(a.created_at)),1)]),_:1}),t(y,{label:"Действия",width:"280",fixed:"right"},{default:l(({row:a})=>[t(n,{size:"small",onClick:M=>we(a)},{default:l(()=>[t(g,null,{default:l(()=>[t(x(Pe))]),_:1})]),_:1},8,["onClick"]),t(n,{size:"small",onClick:M=>fe(a)},{default:l(()=>[t(g,null,{default:l(()=>[t(x(de))]),_:1})]),_:1},8,["onClick"]),a.is_active?S("",!0):(s(),f(n,{key:0,size:"small",type:"primary",onClick:M=>ae(a),loading:q.value===a.id},{default:l(()=>[...e[19]||(e[19]=[i(" Активировать ",-1)])]),_:1},8,["onClick","loading"]))]),_:1})]),_:1},8,["data"]))]),_:1})),[[Ue,k.value]])]),t(Z,{modelValue:U.value,"onUpdate:modelValue":e[4]||(e[4]=a=>U.value=a),title:D.value?"Редактировать весовую таблицу":"Создать весовую таблицу",width:"850px","close-on-click-modal":!1},{footer:l(()=>[t(n,{onClick:e[3]||(e[3]=a=>U.value=!1)},{default:l(()=>[...e[22]||(e[22]=[i("Отмена",-1)])]),_:1}),t(n,{type:"primary",onClick:ye,loading:F.value,disabled:!ce.value},{default:l(()=>[i(r(D.value?"Сохранить":"Создать"),1)]),_:1},8,["loading","disabled"])]),default:l(()=>[t(Y,{model:d.value,"label-width":"180px",ref_key:"formRef",ref:re},{default:l(()=>[t($,{label:"Профессиональная область",required:""},{default:l(()=>[t(X,{modelValue:d.value.prof_activity_code,"onUpdate:modelValue":e[1]||(e[1]=a=>d.value.prof_activity_code=a),placeholder:"Выберите область",style:{width:"100%"},disabled:!!D.value},{default:l(()=>[(s(!0),b(P,null,R(O.value,a=>(s(),f(Q,{key:a.id,label:a.name,value:a.code},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),t(E,{"content-position":"left"},{default:l(()=>[...e[20]||(e[20]=[i("Компетенции и веса",-1)])]),_:1}),_("div",Ge,[t(Fe,{type:pe.value,title:`Сумма весов: ${V.value.toFixed(4)} (требуется: 1.0000)`,closable:!1,"show-icon":"",style:{"margin-bottom":"16px"}},{default:l(()=>[V.value!==1?(s(),b(P,{key:0},[V.value<1?(s(),b("span",He," Осталось распределить: "+r((1-V.value).toFixed(4)),1)):(s(),b("span",Ie," Превышение: "+r((V.value-1).toFixed(4)),1))],64)):S("",!0)]),_:1},8,["type","title"]),(s(!0),b(P,null,R(d.value.weights,(a,M)=>(s(),b("div",{key:M,class:"weight-row"},[t(X,{modelValue:a.metric_code,"onUpdate:modelValue":h=>a.metric_code=h,placeholder:"Выберите метрику",filterable:"",style:{width:"420px"}},{default:l(()=>[(s(!0),b(P,null,R(G.value,h=>(s(),f(Q,{key:h.code,label:`${h.name} (${h.code})`,value:h.code},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue"]),t(Ae,{modelValue:a.weight,"onUpdate:modelValue":h=>a.weight=h,min:0,max:1,step:.01,precision:4,placeholder:"Вес",style:{width:"180px"}},null,8,["modelValue","onUpdate:modelValue"]),t(n,{type:"danger",size:"small",icon:x(qe),circle:"",onClick:h=>ge(M)},null,8,["icon","onClick"])]))),128)),t(n,{type:"primary",plain:"",onClick:_e,icon:x(se),style:{"margin-top":"16px"}},{default:l(()=>[...e[21]||(e[21]=[i(" Добавить компетенцию ",-1)])]),_:1},8,["icon"])]),t(E),t($,{label:"Метаданные (опционально)"},{default:l(()=>[t(L,{modelValue:d.value.metadata.description,"onUpdate:modelValue":e[2]||(e[2]=a=>d.value.metadata.description=a),type:"textarea",rows:3,placeholder:"Описание версии таблицы, примечания и т.д."},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),t(Z,{modelValue:z.value,"onUpdate:modelValue":e[7]||(e[7]=a=>z.value=a),title:`Весовая таблица: ${c.value?.prof_activity_name} (v${c.value?.version})`,width:"800px"},{footer:l(()=>[t(n,{onClick:e[5]||(e[5]=a=>z.value=!1)},{default:l(()=>[...e[27]||(e[27]=[i("Закрыть",-1)])]),_:1}),c.value&&!c.value.is_active?(s(),f(n,{key:0,type:"primary",onClick:e[6]||(e[6]=a=>ae(c.value)),loading:q.value===c.value.id},{default:l(()=>[...e[28]||(e[28]=[i(" Активировать ",-1)])]),_:1},8,["loading"])):S("",!0)]),default:l(()=>[c.value?(s(),b("div",Ke,[t($e,{column:2,border:""},{default:l(()=>[t(W,{label:"Профессиональная область"},{default:l(()=>[i(r(c.value.prof_activity_name),1)]),_:1}),t(W,{label:"Версия"},{default:l(()=>[i(r(c.value.version),1)]),_:1}),t(W,{label:"Статус"},{default:l(()=>[c.value.is_active?(s(),f(T,{key:0,type:"success"},{default:l(()=>[...e[23]||(e[23]=[i("Активна",-1)])]),_:1})):(s(),f(T,{key:1,type:"info"},{default:l(()=>[...e[24]||(e[24]=[i("Неактивна",-1)])]),_:1}))]),_:1}),t(W,{label:"Создана"},{default:l(()=>[i(r(ie(c.value.created_at)),1)]),_:1}),t(W,{label:"Сумма весов",span:2},{default:l(()=>[t(T,{type:oe(c.value)},{default:l(()=>[i(r(K(c.value).toFixed(4)),1)]),_:1},8,["type"])]),_:1})]),_:1}),t(E,{"content-position":"left"},{default:l(()=>[i("Компетенции ("+r(c.value.weights.length)+")",1)]),_:1}),t(ne,{data:xe(c.value.weights),stripe:"","max-height":"400"},{default:l(()=>[t(y,{type:"index",label:"#",width:"50"}),t(y,{label:"Метрика","min-width":"200"},{default:l(({row:a})=>[_("div",null,[_("strong",null,r(a.metric_name),1),e[25]||(e[25]=_("br",null,null,-1)),t(Te,{size:"small",type:"info"},{default:l(()=>[i(r(a.metric_code),1)]),_:2},1024)])]),_:1}),t(y,{prop:"weight",label:"Вес",width:"120",align:"right"},{default:l(({row:a})=>[i(r(parseFloat(a.weight).toFixed(4)),1)]),_:1}),t(y,{label:"Процент",width:"120",align:"right"},{default:l(({row:a})=>[i(r((parseFloat(a.weight)*100).toFixed(2))+"% ",1)]),_:1})]),_:1},8,["data"]),c.value.metadata?(s(),b("div",je,[t(E,{"content-position":"left"},{default:l(()=>[...e[26]||(e[26]=[i("Метаданные",-1)])]),_:1}),_("pre",null,r(JSON.stringify(c.value.metadata,null,2)),1)])):S("",!0)])):S("",!0)]),_:1},8,["modelValue","title"]),t(Z,{modelValue:A.value,"onUpdate:modelValue":e[12]||(e[12]=a=>A.value=a),title:w.value?"Редактировать область":"Создать область",width:"600px"},{footer:l(()=>[t(n,{onClick:e[11]||(e[11]=a=>A.value=!1)},{default:l(()=>[...e[29]||(e[29]=[i("Отмена",-1)])]),_:1}),w.value?(s(),f(n,{key:0,type:"danger",onClick:Ve},{default:l(()=>[...e[30]||(e[30]=[i(" Удалить ",-1)])]),_:1})):S("",!0),t(n,{type:"primary",onClick:ke,loading:F.value},{default:l(()=>[i(r(w.value?"Сохранить":"Создать"),1)]),_:1},8,["loading"])]),default:l(()=>[t(Y,{model:m.value,"label-width":"120px"},{default:l(()=>[t($,{label:"Код",required:""},{default:l(()=>[t(L,{modelValue:m.value.code,"onUpdate:modelValue":e[8]||(e[8]=a=>m.value.code=a),disabled:!!w.value,placeholder:"meeting_facilitation"},null,8,["modelValue","disabled"])]),_:1}),t($,{label:"Название",required:""},{default:l(()=>[t(L,{modelValue:m.value.name,"onUpdate:modelValue":e[9]||(e[9]=a=>m.value.name=a),placeholder:"Проведение совещаний"},null,8,["modelValue"])]),_:1}),t($,{label:"Описание"},{default:l(()=>[t(L,{modelValue:m.value.description,"onUpdate:modelValue":e[10]||(e[10]=a=>m.value.description=a),type:"textarea",rows:3,placeholder:"Описание профессиональной области"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])]),_:1})}}},tt=Le(Qe,[["__scopeId","data-v-e038cd46"]]);export{tt as default};
