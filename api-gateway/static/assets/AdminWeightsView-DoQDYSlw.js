import{G as K,m as v,H as W,z as qe,q as A,w as l,E as m,r as c,A as Ee,o as d,a as r,d as e,B as Pe,f as s,u as _,Z as ce,D as Le,c as f,_ as Ne,N as R,O as X,C as pe,M as p,R as ve,$ as Y,v as B,a0 as ee,S as Re,F as Ge}from"./index-Db0RtKnA.js";import{A as He}from"./AppLayout-DqVd2p56.js";import{p as G,m as Ie}from"./metrics-XI7SfwXr.js";import{_ as Oe}from"./_plugin-vue_export-helper-DlAUqK2U.js";const me={async upload(C){return(await K.post("/admin/weights/upload",C)).data},async list(C=null){const k=C?{prof_activity_code:C}:{};return(await K.get("/admin/weights",{params:k})).data},async activate(C){return(await K.post(`/admin/weights/${C}/activate`)).data}},Qe={class:"admin-weights-view"},Ze={class:"header-content"},je={class:"header-buttons"},Je={class:"areas-container"},Ke={key:2,class:"areas-grid"},Xe={class:"area-header"},Ye={class:"area-title"},et={key:0,class:"area-description"},tt={key:0,class:"no-table"},lt={key:1,class:"table-info"},at={class:"table-stats"},ot={class:"stat-item"},it={class:"stat-item"},st={class:"stat-item"},nt={class:"table-actions"},rt={class:"selected-area"},dt={class:"area-name"},ut={class:"selected-area"},ct={class:"area-name"},pt={class:"weights-editor"},vt={key:0},mt={key:1},_t={key:0},ft={class:"metric-cell"},gt={key:0,style:{"margin-top":"20px"}},yt={__name:"AdminWeightsView",setup(C){const k=v(!1),F=v(!1),q=v(""),V=v(null),te=v([]),H=v([]),I=v([]),z=v(!1),E=v(!1),T=v(!1),y=v(null),$=v(null),w=v(null),_e=v(null),u=v({prof_activity_code:"",weights:[],metadata:{description:""}}),g=v({code:"",name:"",description:""}),le=W(()=>{const a=H.value.map(n=>{const i=te.value.find(h=>h.prof_activity_code===n.code);return{...n,weightTable:i||null}});if(!q.value)return a;const t=q.value.toLowerCase();return a.filter(n=>n.name.toLowerCase().includes(t)||n.description&&n.description.toLowerCase().includes(t))}),P=W(()=>{const a=H.value.find(t=>t.code===u.value.prof_activity_code);return a?a.name:""}),fe=W(()=>$.value?`Редактировать весовую таблицу: ${P.value}`:`Создать весовую таблицу: ${P.value}`),x=W(()=>u.value.weights.reduce((a,t)=>a+(parseFloat(t.weight)||0),0)),ge=W(()=>Math.abs(x.value-1)<1e-4&&u.value.weights.length>0),ye=W(()=>Math.abs(x.value-1)<1e-4?"success":x.value<1?"warning":"error"),O=async()=>{try{const a=await me.list();te.value=a}catch(a){throw console.error("Failed to load weight tables:",a),V.value="Ошибка загрузки весовых таблиц",m.error("Ошибка загрузки весовых таблиц"),a}},we=a=>{$.value=null,u.value={prof_activity_code:a.code,weights:[],metadata:{description:""}},z.value=!0},Q=async()=>{try{const a=await G.list();H.value=a}catch(a){throw console.error("Failed to load prof activities:",a),V.value="Ошибка загрузки профессиональных областей",m.error("Ошибка загрузки профессиональных областей"),a}},he=async()=>{try{const a=await Ie.listMetricDefs(!0);I.value=a.items||[]}catch(a){throw console.error("Failed to load metrics:",a),V.value="Ошибка загрузки метрик",m.error("Ошибка загрузки метрик"),a}},ae=a=>{$.value=a,u.value={prof_activity_code:a.prof_activity_code,weights:a.weights.map(t=>({metric_code:t.metric_code,weight:parseFloat(t.weight)})),metadata:a.metadata||{description:""}},z.value=!0},be=()=>{u.value.weights.push({metric_code:"",weight:0})},ke=a=>{u.value.weights.splice(a,1)},Ve=async()=>{try{if(F.value=!0,!u.value.prof_activity_code){m.warning("Выберите профессиональную область");return}if(u.value.weights.length===0){m.warning("Добавьте хотя бы одну компетенцию");return}const a=u.value.weights.map(i=>i.metric_code);if(new Set(a.filter(i=>i)).size!==u.value.weights.length){m.warning("Компетенции должны быть уникальными");return}if(u.value.weights.some(i=>!i.metric_code)){m.warning("Все компетенции должны быть заполнены");return}const n={prof_activity_code:u.value.prof_activity_code,weights:u.value.weights.map(i=>({metric_code:i.metric_code,weight:parseFloat(i.weight)})),metadata:u.value.metadata.description?u.value.metadata:null};await me.upload(n),m.success($.value?"Таблица сохранена":"Таблица создана"),z.value=!1,await O()}catch(a){console.error("Failed to save weight table:",a),m.error(a.response?.data?.detail||"Ошибка сохранения таблицы")}finally{F.value=!1}},xe=a=>{y.value=a,E.value=!0},oe=()=>{w.value=null,g.value={code:"",name:"",description:""},T.value=!0},Ce=a=>{w.value=a,g.value={code:a.code,name:a.name,description:a.description||""},T.value=!0},Fe=async()=>{try{if(F.value=!0,!g.value.code||!g.value.name){m.warning("Заполните обязательные поля");return}w.value?(await G.update(w.value.id,{name:g.value.name,description:g.value.description}),m.success("Область обновлена")):(await G.create(g.value),m.success("Область создана")),T.value=!1,await Q()}catch(a){console.error("Failed to save prof activity:",a),m.error(a.response?.data?.detail||"Ошибка сохранения области")}finally{F.value=!1}},Te=async()=>{try{await Ge.confirm(`Удалить профессиональную область "${w.value.name}"? Это действие нельзя отменить.`,"Предупреждение",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"error"}),await G.delete(w.value.id),m.success("Область удалена"),T.value=!1,await Q(),await O()}catch(a){a!=="cancel"&&(console.error("Failed to delete prof activity:",a),m.error(a.response?.data?.detail||"Ошибка удаления области"))}},Z=a=>a.weights.reduce((t,n)=>t+parseFloat(n.weight),0),ie=a=>{const t=Z(a);return Math.abs(t-1)<1e-4?"success":"danger"},Ae=a=>a.map(t=>{const n=I.value.find(i=>i.code===t.metric_code);return{...t,metric_name:n?.name||t.metric_code,metric_code:t.metric_code}}),se=a=>new Date(a).toLocaleString("ru-RU"),ne=async()=>{k.value=!0,V.value=null;try{await Promise.all([O(),Q(),he()])}catch(a){console.error("Failed to load data:",a),V.value||(V.value="Не удалось загрузить данные")}finally{k.value=!1}};return qe(async()=>{await ne()}),(a,t)=>{const n=c("el-icon"),i=c("el-button"),h=c("el-card"),M=c("el-input"),ze=c("el-result"),re=c("el-empty"),S=c("el-tag"),de=c("el-text"),D=c("el-form-item"),L=c("el-divider"),$e=c("el-alert"),De=c("el-option"),Ue=c("el-select"),We=c("el-input-number"),ue=c("el-form"),j=c("el-dialog"),J=c("el-descriptions-item"),Me=c("el-descriptions"),N=c("el-table-column"),Se=c("el-table"),Be=Ee("loading");return d(),A(He,null,{default:l(()=>[r("div",Qe,[e(h,{class:"header-card"},{default:l(()=>[r("div",Ze,[t[13]||(t[13]=r("div",null,[r("h1",null,"Управление весовыми таблицами"),r("p",null,"Каждая профессиональная область имеет свою уникальную весовую таблицу")],-1)),r("div",je,[e(i,{onClick:oe,size:"large",type:"primary"},{default:l(()=>[e(n,null,{default:l(()=>[e(_(ce))]),_:1}),t[12]||(t[12]=s(" Новая область ",-1))]),_:1})])])]),_:1}),e(h,{class:"search-card"},{default:l(()=>[e(M,{modelValue:q.value,"onUpdate:modelValue":t[0]||(t[0]=o=>q.value=o),placeholder:"Поиск по названию профессиональной области...","prefix-icon":_(Le),size:"large",clearable:""},null,8,["modelValue","prefix-icon"])]),_:1}),Pe((d(),f("div",Je,[V.value?(d(),A(ze,{key:0,icon:"error",title:"Ошибка загрузки","sub-title":V.value},{extra:l(()=>[e(i,{type:"primary",onClick:ne},{default:l(()=>[e(n,null,{default:l(()=>[e(_(Ne))]),_:1}),t[14]||(t[14]=s(" Повторить ",-1))]),_:1})]),_:1},8,["sub-title"])):le.value.length===0&&!k.value?(d(),A(re,{key:1,description:"Нет профессиональных областей"},{default:l(()=>[e(i,{type:"primary",onClick:oe},{default:l(()=>[e(n,null,{default:l(()=>[e(_(ce))]),_:1}),t[15]||(t[15]=s(" Создать первую область ",-1))]),_:1})]),_:1})):(d(),f("div",Ke,[(d(!0),f(R,null,X(le.value,o=>(d(),f("div",{key:o.id,class:"area-card-wrapper"},[e(h,{class:"area-card",shadow:"hover"},{header:l(()=>[r("div",Xe,[r("div",Ye,[e(n,{size:24,color:"#409EFF"},{default:l(()=>[e(_(ee))]),_:1}),r("h3",null,p(o.name),1)]),e(i,{size:"small",onClick:U=>Ce(o),circle:""},{default:l(()=>[e(n,null,{default:l(()=>[e(_(Y))]),_:1})]),_:1},8,["onClick"])]),o.description?(d(),f("div",et,p(o.description),1)):B("",!0)]),default:l(()=>[o.weightTable?(d(),f("div",lt,[r("div",at,[r("div",ot,[t[17]||(t[17]=r("span",{class:"stat-label"},"Компетенций:",-1)),e(S,{size:"large"},{default:l(()=>[s(p(o.weightTable.weights.length),1)]),_:2},1024)]),r("div",it,[t[18]||(t[18]=r("span",{class:"stat-label"},"Сумма весов:",-1)),e(S,{type:ie(o.weightTable),size:"large"},{default:l(()=>[s(p(Z(o.weightTable).toFixed(4)),1)]),_:2},1032,["type"])]),r("div",st,[t[19]||(t[19]=r("span",{class:"stat-label"},"Обновлена:",-1)),e(de,{type:"info"},{default:l(()=>[s(p(se(o.weightTable.created_at)),1)]),_:2},1024)])]),r("div",nt,[e(i,{onClick:U=>xe(o.weightTable),type:"info"},{default:l(()=>[e(n,null,{default:l(()=>[e(_(ve))]),_:1}),t[20]||(t[20]=s(" Просмотр ",-1))]),_:1},8,["onClick"]),e(i,{onClick:U=>ae(o.weightTable),type:"primary"},{default:l(()=>[e(n,null,{default:l(()=>[e(_(Y))]),_:1}),t[21]||(t[21]=s(" Редактировать ",-1))]),_:1},8,["onClick"])])])):(d(),f("div",tt,[e(re,{description:"Весовая таблица не создана","image-size":80},{default:l(()=>[e(i,{type:"primary",onClick:U=>we(o)},{default:l(()=>[e(n,null,{default:l(()=>[e(_(pe))]),_:1}),t[16]||(t[16]=s(" Создать таблицу ",-1))]),_:1},8,["onClick"])]),_:2},1024)]))]),_:2},1024)]))),128))]))])),[[Be,k.value]])]),e(j,{modelValue:z.value,"onUpdate:modelValue":t[3]||(t[3]=o=>z.value=o),title:fe.value,width:"900px","close-on-click-modal":!1,"align-center":""},{footer:l(()=>[e(i,{onClick:t[2]||(t[2]=o=>z.value=!1)},{default:l(()=>[...t[24]||(t[24]=[s("Отмена",-1)])]),_:1}),e(i,{type:"primary",onClick:Ve,loading:F.value,disabled:!ge.value},{default:l(()=>[s(p($.value?"Сохранить":"Создать"),1)]),_:1},8,["loading","disabled"])]),default:l(()=>[e(ue,{model:u.value,"label-width":"200px",ref_key:"formRef",ref:_e,"label-position":"top"},{default:l(()=>[$.value?(d(),A(D,{key:1,label:"Профессиональная область"},{default:l(()=>[e(h,{shadow:"never",class:"area-display-card"},{default:l(()=>[r("div",ut,[e(n,{size:20,color:"#409EFF"},{default:l(()=>[e(_(ee))]),_:1}),r("span",ct,p(P.value),1)])]),_:1})]),_:1})):(d(),A(D,{key:0,label:"Профессиональная область",required:""},{default:l(()=>[e(h,{shadow:"never",class:"area-display-card"},{default:l(()=>[r("div",rt,[e(n,{size:20,color:"#409EFF"},{default:l(()=>[e(_(ee))]),_:1}),r("span",dt,p(P.value),1)])]),_:1})]),_:1})),e(L,{"content-position":"left"},{default:l(()=>[...t[22]||(t[22]=[s("Компетенции и веса",-1)])]),_:1}),r("div",pt,[e($e,{type:ye.value,title:`Сумма весов: ${x.value.toFixed(4)} (требуется: 1.0000)`,closable:!1,"show-icon":"",style:{"margin-bottom":"16px"}},{default:l(()=>[x.value!==1?(d(),f(R,{key:0},[x.value<1?(d(),f("span",vt," Осталось распределить: "+p((1-x.value).toFixed(4)),1)):(d(),f("span",mt," Превышение: "+p((x.value-1).toFixed(4)),1))],64)):B("",!0)]),_:1},8,["type","title"]),(d(!0),f(R,null,X(u.value.weights,(o,U)=>(d(),f("div",{key:U,class:"weight-row"},[e(Ue,{modelValue:o.metric_code,"onUpdate:modelValue":b=>o.metric_code=b,placeholder:"Выберите метрику",filterable:"",style:{width:"420px"}},{default:l(()=>[(d(!0),f(R,null,X(I.value,b=>(d(),A(De,{key:b.code,label:`${b.name} (${b.code})`,value:b.code},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue"]),e(We,{modelValue:o.weight,"onUpdate:modelValue":b=>o.weight=b,min:0,max:1,step:.01,precision:4,placeholder:"Вес",style:{width:"180px"}},null,8,["modelValue","onUpdate:modelValue"]),e(i,{type:"danger",size:"small",icon:_(Re),circle:"",onClick:b=>ke(U)},null,8,["icon","onClick"])]))),128)),e(i,{type:"primary",plain:"",onClick:be,icon:_(pe),style:{"margin-top":"16px"}},{default:l(()=>[...t[23]||(t[23]=[s(" Добавить компетенцию ",-1)])]),_:1},8,["icon"])]),e(L),e(D,{label:"Метаданные (опционально)"},{default:l(()=>[e(M,{modelValue:u.value.metadata.description,"onUpdate:modelValue":t[1]||(t[1]=o=>u.value.metadata.description=o),type:"textarea",rows:3,placeholder:"Описание версии таблицы, примечания и т.д."},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),e(j,{modelValue:E.value,"onUpdate:modelValue":t[6]||(t[6]=o=>E.value=o),title:`Весовая таблица: ${y.value?.prof_activity_name}`,width:"900px","align-center":""},{footer:l(()=>[e(i,{onClick:t[4]||(t[4]=o=>E.value=!1),size:"large"},{default:l(()=>[...t[27]||(t[27]=[s("Закрыть",-1)])]),_:1}),e(i,{type:"primary",onClick:t[5]||(t[5]=o=>ae(y.value)),size:"large"},{default:l(()=>[e(n,null,{default:l(()=>[e(_(Y))]),_:1}),t[28]||(t[28]=s(" Редактировать ",-1))]),_:1})]),default:l(()=>[y.value?(d(),f("div",_t,[e(h,{shadow:"never",class:"table-summary-card"},{default:l(()=>[e(Me,{column:2,border:""},{default:l(()=>[e(J,{label:"Профессиональная область",span:2},{default:l(()=>[s(p(y.value.prof_activity_name),1)]),_:1}),e(J,{label:"Создана"},{default:l(()=>[s(p(se(y.value.created_at)),1)]),_:1}),e(J,{label:"Сумма весов"},{default:l(()=>[e(S,{type:ie(y.value),size:"large"},{default:l(()=>[s(p(Z(y.value).toFixed(4)),1)]),_:1},8,["type"])]),_:1})]),_:1})]),_:1}),e(L,{"content-position":"left"},{default:l(()=>[e(n,null,{default:l(()=>[e(_(ve))]),_:1}),s(" Компетенции ("+p(y.value.weights.length)+") ",1)]),_:1}),e(Se,{data:Ae(y.value.weights),stripe:"","max-height":"500",size:"large"},{default:l(()=>[e(N,{type:"index",label:"#",width:"60",align:"center"}),e(N,{label:"Метрика","min-width":"250"},{default:l(({row:o})=>[r("div",ft,[r("strong",null,p(o.metric_name),1),t[25]||(t[25]=r("br",null,null,-1)),e(de,{size:"small",type:"info"},{default:l(()=>[s(p(o.metric_code),1)]),_:2},1024)])]),_:1}),e(N,{prop:"weight",label:"Вес",width:"140",align:"center"},{default:l(({row:o})=>[e(S,{size:"large"},{default:l(()=>[s(p(parseFloat(o.weight).toFixed(4)),1)]),_:2},1024)]),_:1}),e(N,{label:"Процент",width:"140",align:"center"},{default:l(({row:o})=>[e(S,{type:"info",size:"large"},{default:l(()=>[s(p((parseFloat(o.weight)*100).toFixed(2))+"% ",1)]),_:2},1024)]),_:1})]),_:1},8,["data"]),y.value.metadata&&y.value.metadata.description?(d(),f("div",gt,[e(L,{"content-position":"left"},{default:l(()=>[...t[26]||(t[26]=[s("Описание",-1)])]),_:1}),e(h,{shadow:"never",class:"metadata-card"},{default:l(()=>[s(p(y.value.metadata.description),1)]),_:1})])):B("",!0)])):B("",!0)]),_:1},8,["modelValue","title"]),e(j,{modelValue:T.value,"onUpdate:modelValue":t[11]||(t[11]=o=>T.value=o),title:w.value?"Редактировать область":"Создать область",width:"600px"},{footer:l(()=>[e(i,{onClick:t[10]||(t[10]=o=>T.value=!1)},{default:l(()=>[...t[29]||(t[29]=[s("Отмена",-1)])]),_:1}),w.value?(d(),A(i,{key:0,type:"danger",onClick:Te},{default:l(()=>[...t[30]||(t[30]=[s(" Удалить ",-1)])]),_:1})):B("",!0),e(i,{type:"primary",onClick:Fe,loading:F.value},{default:l(()=>[s(p(w.value?"Сохранить":"Создать"),1)]),_:1},8,["loading"])]),default:l(()=>[e(ue,{model:g.value,"label-width":"120px"},{default:l(()=>[e(D,{label:"Код",required:""},{default:l(()=>[e(M,{modelValue:g.value.code,"onUpdate:modelValue":t[7]||(t[7]=o=>g.value.code=o),disabled:!!w.value,placeholder:"meeting_facilitation"},null,8,["modelValue","disabled"])]),_:1}),e(D,{label:"Название",required:""},{default:l(()=>[e(M,{modelValue:g.value.name,"onUpdate:modelValue":t[8]||(t[8]=o=>g.value.name=o),placeholder:"Проведение совещаний"},null,8,["modelValue"])]),_:1}),e(D,{label:"Описание"},{default:l(()=>[e(M,{modelValue:g.value.description,"onUpdate:modelValue":t[9]||(t[9]=o=>g.value.description=o),type:"textarea",rows:3,placeholder:"Описание профессиональной области"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])]),_:1})}}},Vt=Oe(yt,[["__scopeId","data-v-359c5d87"]]);export{Vt as default};
