import{G as K,m as v,H as W,z as qe,q as z,w as l,E as m,r as c,A as Ee,o as d,a as r,d as e,B as Pe,f as s,u as _,a2 as pe,D as Le,c as f,a3 as Ne,N as R,O as Y,C as ve,M as p,V as me,U as Z,v as S,a4 as ee,X as Re,F as Ge}from"./index-CvNcLvWb.js";import{A as He}from"./AppLayout-B-umSza7.js";import{p as G,m as Ie}from"./metrics-1O8rZ6V4.js";import{_ as Oe}from"./_plugin-vue_export-helper-DlAUqK2U.js";const te={async upload(F){return(await K.post("/admin/weights/upload",F)).data},async update(F,h){return(await K.put(`/admin/weights/${F}`,h)).data},async list(F=null){const h=F?{prof_activity_code:F}:{};return(await K.get("/admin/weights",{params:h})).data}},Qe={class:"admin-weights-view"},Xe={class:"header-content"},je={class:"header-buttons"},Je={class:"areas-container"},Ke={key:2,class:"areas-grid"},Ye={class:"area-header"},Ze={class:"area-title"},et={key:0,class:"area-description"},tt={key:0,class:"no-table"},lt={key:1,class:"table-info"},at={class:"table-stats"},ot={class:"stat-item"},it={class:"stat-item"},st={class:"stat-item"},nt={class:"table-actions"},rt={class:"selected-area"},dt={class:"area-name"},ut={class:"selected-area"},ct={class:"area-name"},pt={class:"weights-editor"},vt={key:0},mt={key:1},_t={key:0},ft={class:"metric-cell"},gt={key:0,style:{"margin-top":"20px"}},yt={__name:"AdminWeightsView",setup(F){const h=v(!1),V=v(!1),q=v(""),x=v(null),le=v([]),H=v([]),I=v([]),$=v(!1),E=v(!1),T=v(!1),y=v(null),A=v(null),w=v(null),_e=v(null),u=v({prof_activity_code:"",weights:[],metadata:{description:""}}),g=v({code:"",name:"",description:""}),ae=W(()=>{const a=H.value.map(n=>{const i=le.value.find(b=>b.prof_activity_code===n.code);return{...n,weightTable:i||null}});if(!q.value)return a;const t=q.value.toLowerCase();return a.filter(n=>n.name.toLowerCase().includes(t)||n.description&&n.description.toLowerCase().includes(t))}),P=W(()=>{const a=H.value.find(t=>t.code===u.value.prof_activity_code);return a?a.name:""}),fe=W(()=>A.value?`Редактировать весовую таблицу: ${P.value}`:`Создать весовую таблицу: ${P.value}`),C=W(()=>u.value.weights.reduce((a,t)=>a+(parseFloat(t.weight)||0),0)),ge=W(()=>Math.abs(C.value-1)<1e-4&&u.value.weights.length>0),ye=W(()=>Math.abs(C.value-1)<1e-4?"success":C.value<1?"warning":"error"),O=async()=>{try{const a=await te.list();le.value=a}catch(a){throw console.error("Failed to load weight tables:",a),x.value="Ошибка загрузки весовых таблиц",m.error("Ошибка загрузки весовых таблиц"),a}},we=a=>{A.value=null,u.value={prof_activity_code:a.code,weights:[],metadata:{description:""}},$.value=!0},Q=async()=>{try{const a=await G.list();H.value=a}catch(a){throw console.error("Failed to load prof activities:",a),x.value="Ошибка загрузки профессиональных областей",m.error("Ошибка загрузки профессиональных областей"),a}},he=async()=>{try{const a=await Ie.listMetricDefs(!0);I.value=a.items||[]}catch(a){throw console.error("Failed to load metrics:",a),x.value="Ошибка загрузки метрик",m.error("Ошибка загрузки метрик"),a}},oe=a=>{A.value=a,u.value={prof_activity_code:a.prof_activity_code,weights:a.weights.map(t=>({metric_code:t.metric_code,weight:parseFloat(t.weight)})),metadata:a.metadata||{description:""}},$.value=!0},be=()=>{u.value.weights.push({metric_code:"",weight:0})},ke=a=>{u.value.weights.splice(a,1)},Ve=async()=>{try{if(V.value=!0,!u.value.prof_activity_code){m.warning("Выберите профессиональную область");return}if(u.value.weights.length===0){m.warning("Добавьте хотя бы одну компетенцию");return}const a=u.value.weights.map(i=>i.metric_code);if(new Set(a.filter(i=>i)).size!==u.value.weights.length){m.warning("Компетенции должны быть уникальными");return}if(u.value.weights.some(i=>!i.metric_code)){m.warning("Все компетенции должны быть заполнены");return}const n={prof_activity_code:u.value.prof_activity_code,weights:u.value.weights.map(i=>({metric_code:i.metric_code,weight:parseFloat(i.weight)})),metadata:u.value.metadata.description?u.value.metadata:null};A.value?(await te.update(A.value.id,n),m.success("Изменения применены")):(await te.upload(n),m.success("Таблица создана")),$.value=!1,await O()}catch(a){console.error("Failed to save weight table:",a),m.error(a.response?.data?.detail||"Ошибка сохранения таблицы")}finally{V.value=!1}},xe=a=>{y.value=a,E.value=!0},ie=()=>{w.value=null,g.value={code:"",name:"",description:""},T.value=!0},Ce=a=>{w.value=a,g.value={code:a.code,name:a.name,description:a.description||""},T.value=!0},Fe=async()=>{try{if(V.value=!0,!g.value.code||!g.value.name){m.warning("Заполните обязательные поля");return}w.value?(await G.update(w.value.id,{name:g.value.name,description:g.value.description}),m.success("Область обновлена")):(await G.create(g.value),m.success("Область создана")),T.value=!1,await Q()}catch(a){console.error("Failed to save prof activity:",a),m.error(a.response?.data?.detail||"Ошибка сохранения области")}finally{V.value=!1}},Te=async()=>{try{await Ge.confirm(`Удалить профессиональную область "${w.value.name}"? Это действие нельзя отменить.`,"Предупреждение",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"error"}),await G.delete(w.value.id),m.success("Область удалена"),T.value=!1,await Q(),await O()}catch(a){a!=="cancel"&&(console.error("Failed to delete prof activity:",a),m.error(a.response?.data?.detail||"Ошибка удаления области"))}},X=a=>a.weights.reduce((t,n)=>t+parseFloat(n.weight),0),se=a=>{const t=X(a);return Math.abs(t-1)<1e-4?"success":"danger"},Ae=a=>a.map(t=>{const n=I.value.find(i=>i.code===t.metric_code);return{...t,metric_name:n?.name||t.metric_code,metric_code:t.metric_code}}),ne=a=>new Date(a).toLocaleString("ru-RU"),re=async()=>{h.value=!0,x.value=null;try{await Promise.all([O(),Q(),he()])}catch(a){console.error("Failed to load data:",a),x.value||(x.value="Не удалось загрузить данные")}finally{h.value=!1}};return qe(async()=>{await re()}),(a,t)=>{const n=c("el-icon"),i=c("el-button"),b=c("el-card"),M=c("el-input"),ze=c("el-result"),de=c("el-empty"),B=c("el-tag"),ue=c("el-text"),U=c("el-form-item"),L=c("el-divider"),$e=c("el-alert"),Ue=c("el-option"),De=c("el-select"),We=c("el-input-number"),ce=c("el-form"),j=c("el-dialog"),J=c("el-descriptions-item"),Me=c("el-descriptions"),N=c("el-table-column"),Be=c("el-table"),Se=Ee("loading");return d(),z(He,null,{default:l(()=>[r("div",Qe,[e(b,{class:"header-card"},{default:l(()=>[r("div",Xe,[t[13]||(t[13]=r("div",null,[r("h1",null,"Управление весовыми таблицами"),r("p",null,"Каждая профессиональная область имеет свою уникальную весовую таблицу")],-1)),r("div",je,[e(i,{onClick:ie,size:"large",type:"primary"},{default:l(()=>[e(n,null,{default:l(()=>[e(_(pe))]),_:1}),t[12]||(t[12]=s(" Новая область ",-1))]),_:1})])])]),_:1}),e(b,{class:"search-card"},{default:l(()=>[e(M,{modelValue:q.value,"onUpdate:modelValue":t[0]||(t[0]=o=>q.value=o),placeholder:"Поиск по названию профессиональной области...","prefix-icon":_(Le),size:"large",clearable:""},null,8,["modelValue","prefix-icon"])]),_:1}),Pe((d(),f("div",Je,[x.value?(d(),z(ze,{key:0,icon:"error",title:"Ошибка загрузки","sub-title":x.value},{extra:l(()=>[e(i,{type:"primary",onClick:re},{default:l(()=>[e(n,null,{default:l(()=>[e(_(Ne))]),_:1}),t[14]||(t[14]=s(" Повторить ",-1))]),_:1})]),_:1},8,["sub-title"])):ae.value.length===0&&!h.value?(d(),z(de,{key:1,description:"Нет профессиональных областей"},{default:l(()=>[e(i,{type:"primary",onClick:ie},{default:l(()=>[e(n,null,{default:l(()=>[e(_(pe))]),_:1}),t[15]||(t[15]=s(" Создать первую область ",-1))]),_:1})]),_:1})):(d(),f("div",Ke,[(d(!0),f(R,null,Y(ae.value,o=>(d(),f("div",{key:o.id,class:"area-card-wrapper"},[e(b,{class:"area-card",shadow:"hover"},{header:l(()=>[r("div",Ye,[r("div",Ze,[e(n,{size:24,color:"#409EFF"},{default:l(()=>[e(_(ee))]),_:1}),r("h3",null,p(o.name),1)]),e(i,{size:"small",onClick:D=>Ce(o),circle:""},{default:l(()=>[e(n,null,{default:l(()=>[e(_(Z))]),_:1})]),_:1},8,["onClick"])]),o.description?(d(),f("div",et,p(o.description),1)):S("",!0)]),default:l(()=>[o.weightTable?(d(),f("div",lt,[r("div",at,[r("div",ot,[t[17]||(t[17]=r("span",{class:"stat-label"},"Компетенций:",-1)),e(B,{size:"large"},{default:l(()=>[s(p(o.weightTable.weights.length),1)]),_:2},1024)]),r("div",it,[t[18]||(t[18]=r("span",{class:"stat-label"},"Сумма весов:",-1)),e(B,{type:se(o.weightTable),size:"large"},{default:l(()=>[s(p(X(o.weightTable).toFixed(4)),1)]),_:2},1032,["type"])]),r("div",st,[t[19]||(t[19]=r("span",{class:"stat-label"},"Обновлена:",-1)),e(ue,{type:"info"},{default:l(()=>[s(p(ne(o.weightTable.created_at)),1)]),_:2},1024)])]),r("div",nt,[e(i,{onClick:D=>xe(o.weightTable),type:"info"},{default:l(()=>[e(n,null,{default:l(()=>[e(_(me))]),_:1}),t[20]||(t[20]=s(" Просмотр ",-1))]),_:1},8,["onClick"]),e(i,{onClick:D=>oe(o.weightTable),type:"primary"},{default:l(()=>[e(n,null,{default:l(()=>[e(_(Z))]),_:1}),t[21]||(t[21]=s(" Редактировать ",-1))]),_:1},8,["onClick"])])])):(d(),f("div",tt,[e(de,{description:"Весовая таблица не создана","image-size":80},{default:l(()=>[e(i,{type:"primary",onClick:D=>we(o)},{default:l(()=>[e(n,null,{default:l(()=>[e(_(ve))]),_:1}),t[16]||(t[16]=s(" Создать таблицу ",-1))]),_:1},8,["onClick"])]),_:2},1024)]))]),_:2},1024)]))),128))]))])),[[Se,h.value]])]),e(j,{modelValue:$.value,"onUpdate:modelValue":t[3]||(t[3]=o=>$.value=o),title:fe.value,width:"900px","close-on-click-modal":!1,"align-center":""},{footer:l(()=>[e(i,{onClick:t[2]||(t[2]=o=>$.value=!1)},{default:l(()=>[...t[24]||(t[24]=[s("Отмена",-1)])]),_:1}),e(i,{type:"primary",onClick:Ve,loading:V.value,disabled:!ge.value},{default:l(()=>[s(p(A.value?"Сохранить":"Создать"),1)]),_:1},8,["loading","disabled"])]),default:l(()=>[e(ce,{model:u.value,"label-width":"200px",ref_key:"formRef",ref:_e,"label-position":"top"},{default:l(()=>[A.value?(d(),z(U,{key:1,label:"Профессиональная область"},{default:l(()=>[e(b,{shadow:"never",class:"area-display-card"},{default:l(()=>[r("div",ut,[e(n,{size:20,color:"#409EFF"},{default:l(()=>[e(_(ee))]),_:1}),r("span",ct,p(P.value),1)])]),_:1})]),_:1})):(d(),z(U,{key:0,label:"Профессиональная область",required:""},{default:l(()=>[e(b,{shadow:"never",class:"area-display-card"},{default:l(()=>[r("div",rt,[e(n,{size:20,color:"#409EFF"},{default:l(()=>[e(_(ee))]),_:1}),r("span",dt,p(P.value),1)])]),_:1})]),_:1})),e(L,{"content-position":"left"},{default:l(()=>[...t[22]||(t[22]=[s("Компетенции и веса",-1)])]),_:1}),r("div",pt,[e($e,{type:ye.value,title:`Сумма весов: ${C.value.toFixed(4)} (требуется: 1.0000)`,closable:!1,"show-icon":"",style:{"margin-bottom":"16px"}},{default:l(()=>[C.value!==1?(d(),f(R,{key:0},[C.value<1?(d(),f("span",vt," Осталось распределить: "+p((1-C.value).toFixed(4)),1)):(d(),f("span",mt," Превышение: "+p((C.value-1).toFixed(4)),1))],64)):S("",!0)]),_:1},8,["type","title"]),(d(!0),f(R,null,Y(u.value.weights,(o,D)=>(d(),f("div",{key:D,class:"weight-row"},[e(De,{modelValue:o.metric_code,"onUpdate:modelValue":k=>o.metric_code=k,placeholder:"Выберите метрику",filterable:"",style:{width:"420px"}},{default:l(()=>[(d(!0),f(R,null,Y(I.value,k=>(d(),z(Ue,{key:k.code,label:`${k.name} (${k.code})`,value:k.code},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue"]),e(We,{modelValue:o.weight,"onUpdate:modelValue":k=>o.weight=k,min:0,max:1,step:.01,precision:4,placeholder:"Вес",style:{width:"180px"}},null,8,["modelValue","onUpdate:modelValue"]),e(i,{type:"danger",size:"small",icon:_(Re),circle:"",onClick:k=>ke(D)},null,8,["icon","onClick"])]))),128)),e(i,{type:"primary",plain:"",onClick:be,icon:_(ve),style:{"margin-top":"16px"}},{default:l(()=>[...t[23]||(t[23]=[s(" Добавить компетенцию ",-1)])]),_:1},8,["icon"])]),e(L),e(U,{label:"Метаданные (опционально)"},{default:l(()=>[e(M,{modelValue:u.value.metadata.description,"onUpdate:modelValue":t[1]||(t[1]=o=>u.value.metadata.description=o),type:"textarea",rows:3,placeholder:"Описание версии таблицы, примечания и т.д."},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),e(j,{modelValue:E.value,"onUpdate:modelValue":t[6]||(t[6]=o=>E.value=o),title:`Весовая таблица: ${y.value?.prof_activity_name}`,width:"900px","align-center":""},{footer:l(()=>[e(i,{onClick:t[4]||(t[4]=o=>E.value=!1),size:"large"},{default:l(()=>[...t[27]||(t[27]=[s("Закрыть",-1)])]),_:1}),e(i,{type:"primary",onClick:t[5]||(t[5]=o=>oe(y.value)),size:"large"},{default:l(()=>[e(n,null,{default:l(()=>[e(_(Z))]),_:1}),t[28]||(t[28]=s(" Редактировать ",-1))]),_:1})]),default:l(()=>[y.value?(d(),f("div",_t,[e(b,{shadow:"never",class:"table-summary-card"},{default:l(()=>[e(Me,{column:2,border:""},{default:l(()=>[e(J,{label:"Профессиональная область",span:2},{default:l(()=>[s(p(y.value.prof_activity_name),1)]),_:1}),e(J,{label:"Создана"},{default:l(()=>[s(p(ne(y.value.created_at)),1)]),_:1}),e(J,{label:"Сумма весов"},{default:l(()=>[e(B,{type:se(y.value),size:"large"},{default:l(()=>[s(p(X(y.value).toFixed(4)),1)]),_:1},8,["type"])]),_:1})]),_:1})]),_:1}),e(L,{"content-position":"left"},{default:l(()=>[e(n,null,{default:l(()=>[e(_(me))]),_:1}),s(" Компетенции ("+p(y.value.weights.length)+") ",1)]),_:1}),e(Be,{data:Ae(y.value.weights),stripe:"","max-height":"500",size:"large"},{default:l(()=>[e(N,{type:"index",label:"#",width:"60",align:"center"}),e(N,{label:"Метрика","min-width":"250"},{default:l(({row:o})=>[r("div",ft,[r("strong",null,p(o.metric_name),1),t[25]||(t[25]=r("br",null,null,-1)),e(ue,{size:"small",type:"info"},{default:l(()=>[s(p(o.metric_code),1)]),_:2},1024)])]),_:1}),e(N,{prop:"weight",label:"Вес",width:"140",align:"center"},{default:l(({row:o})=>[e(B,{size:"large"},{default:l(()=>[s(p(parseFloat(o.weight).toFixed(4)),1)]),_:2},1024)]),_:1}),e(N,{label:"Процент",width:"140",align:"center"},{default:l(({row:o})=>[e(B,{type:"info",size:"large"},{default:l(()=>[s(p((parseFloat(o.weight)*100).toFixed(2))+"% ",1)]),_:2},1024)]),_:1})]),_:1},8,["data"]),y.value.metadata&&y.value.metadata.description?(d(),f("div",gt,[e(L,{"content-position":"left"},{default:l(()=>[...t[26]||(t[26]=[s("Описание",-1)])]),_:1}),e(b,{shadow:"never",class:"metadata-card"},{default:l(()=>[s(p(y.value.metadata.description),1)]),_:1})])):S("",!0)])):S("",!0)]),_:1},8,["modelValue","title"]),e(j,{modelValue:T.value,"onUpdate:modelValue":t[11]||(t[11]=o=>T.value=o),title:w.value?"Редактировать область":"Создать область",width:"600px"},{footer:l(()=>[e(i,{onClick:t[10]||(t[10]=o=>T.value=!1)},{default:l(()=>[...t[29]||(t[29]=[s("Отмена",-1)])]),_:1}),w.value?(d(),z(i,{key:0,type:"danger",onClick:Te},{default:l(()=>[...t[30]||(t[30]=[s(" Удалить ",-1)])]),_:1})):S("",!0),e(i,{type:"primary",onClick:Fe,loading:V.value},{default:l(()=>[s(p(w.value?"Сохранить":"Создать"),1)]),_:1},8,["loading"])]),default:l(()=>[e(ce,{model:g.value,"label-width":"120px"},{default:l(()=>[e(U,{label:"Код",required:""},{default:l(()=>[e(M,{modelValue:g.value.code,"onUpdate:modelValue":t[7]||(t[7]=o=>g.value.code=o),disabled:!!w.value,placeholder:"meeting_facilitation"},null,8,["modelValue","disabled"])]),_:1}),e(U,{label:"Название",required:""},{default:l(()=>[e(M,{modelValue:g.value.name,"onUpdate:modelValue":t[8]||(t[8]=o=>g.value.name=o),placeholder:"Проведение совещаний"},null,8,["modelValue"])]),_:1}),e(U,{label:"Описание"},{default:l(()=>[e(M,{modelValue:g.value.description,"onUpdate:modelValue":t[9]||(t[9]=o=>g.value.description=o),type:"textarea",rows:3,placeholder:"Описание профессиональной области"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])]),_:1})}}},Vt=Oe(yt,[["__scopeId","data-v-d51f504d"]]);export{Vt as default};
