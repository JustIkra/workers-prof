import{G as X,m as g,H as Z,I as ge,r as f,c as E,o as s,d as t,v as A,J as nt,w as e,u as w,K as ot,C as rt,L as it,M as k,N as W,z as Se,q as v,f as m,O as Y,a as _,E as $,p as je,e as qe,P as Je,A as Xe,B as pe,Q as ut,R as Oe,k as Te,S as Ve,g as Ne,T as dt,U as Ue,V as Ie,h as Fe,W as Ee,X as Pe,F as ct,n as ze,t as pt,Y as mt,Z as ft,_ as _t,$ as vt,a0 as yt}from"./index-BGodjHWh.js";import{A as gt}from"./AppLayout-CDH1-cyz.js";import{_ as we}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{m as Ce,p as wt}from"./metrics-B2512Mmp.js";import{u as bt,p as Be}from"./participants-fsg8V0eB.js";const _e={async upload(o,R,r){const b=new FormData;return b.append("report_type",R),b.append("file",r),(await X.post(`/participants/${o}/reports`,b,{headers:{"Content-Type":"multipart/form-data"}})).data},async download(o){return await X.get(`/reports/${o}/download`,{responseType:"blob"})},async getById(o){return(await X.get(`/reports/${o}`)).data},async delete(o){return(await X.delete(`/reports/${o}`)).data},async extract(o){return(await X.post(`/reports/${o}/extract`)).data},async getMetrics(o){return(await X.get(`/reports/${o}/metrics`)).data},async getList(o){return(await X.get(`/participants/${o}/reports`)).data}},ve={async calculate(o,R){return(await X.post(`/scoring/participants/${o}/calculate`,null,{params:{activity_code:R}})).data},async getHistory(o,R=10){return(await X.get(`/scoring/participants/${o}/scores`,{params:{limit:R}})).data},async getById(o){return(await X.get(`/scoring-results/${o}`)).data},async generateRecommendations(o){return(await X.post(`/reports/${o}/recommendations`)).data},async getFinalReport(o,R,r="json"){const b={params:{activity_code:R,format:r}};r==="html"&&(b.responseType="text");const V=await X.get(`/participants/${o}/final-report`,b);return V.data}};function ye(o,R=1){if(o==null||o==="")return"";const r=typeof o=="string"?parseFloat(o):o;return isNaN(r)?"":r.toLocaleString("ru-RU",{minimumFractionDigits:R,maximumFractionDigits:R})}function ne(o){if(o==null||o==="")return null;const r=String(o).trim().replace(",","."),b=parseFloat(r);return isNaN(b)?null:b}function kt(o){return ne(o)}function ce(o,R=1){return ye(o,R)}const ht={key:0,class:"error-message"},Rt={__name:"MetricInput",props:{modelValue:{type:[Number,String],default:null},min:{type:Number,default:1},max:{type:Number,default:10},step:{type:Number,default:.1},precision:{type:Number,default:1},placeholder:{type:String,default:"Введите значение"},disabled:{type:Boolean,default:!1},showControls:{type:Boolean,default:!0}},emits:["update:modelValue","change","blur"],setup(o,{emit:R}){const r=o,b=R,V=g(null),O=g(""),N=g(!1),S=g(!1),D=g(""),C=Z(()=>ne(O.value)),T=Z(()=>{const p=C.value;return p===null||p<=r.min}),P=Z(()=>{const p=C.value;return p===null||p>=r.max}),I=p=>{if(p==null||p===""){O.value="";return}N.value?O.value=String(p).replace(".",","):O.value=ye(p,r.precision)},q=p=>{if(p==null||p==="")return S.value=!1,D.value="",!0;const h=ne(p);return h===null?(S.value=!0,D.value="Некорректное число",!1):h<r.min?(S.value=!0,D.value=`Значение должно быть не меньше ${ye(r.min,r.precision)}`,!1):h>r.max?(S.value=!0,D.value=`Значение должно быть не больше ${ye(r.max,r.precision)}`,!1):(S.value=!1,D.value="",!0)},G=p=>{const h=p.replace(/[^\d,.-]/g,"");let c=!1;const a=h.split("").filter(x=>x===","||x==="."?c?!1:(c=!0,!0):!0).join("").replace(".",",");O.value=a;const u=ne(a);u!==null?b("update:modelValue",u):(a===""||a==="-")&&b("update:modelValue",null)},J=()=>{N.value=!1;const p=ne(O.value);if(q(O.value)){if(p!==null){const h=Math.round(p*Math.pow(10,r.precision))/Math.pow(10,r.precision),c=Math.max(r.min,Math.min(r.max,h));b("update:modelValue",c),I(c),b("change",c)}}else if(p!==null&&(p<r.min||p>r.max)){const h=Math.max(r.min,Math.min(r.max,p));b("update:modelValue",h),I(h),b("change",h),S.value=!1,D.value=""}b("blur")},z=()=>{N.value=!0,C.value!==null&&(O.value=String(C.value).replace(".",","))},ee=()=>{const p=C.value||0,h=Math.min(r.max,p+r.step),c=Math.round(h*Math.pow(10,r.precision))/Math.pow(10,r.precision);b("update:modelValue",c),b("change",c),I(c)},B=()=>{const p=C.value||0,h=Math.max(r.min,p-r.step),c=Math.round(h*Math.pow(10,r.precision))/Math.pow(10,r.precision);b("update:modelValue",c),b("change",c),I(c)};return ge(()=>r.modelValue,p=>{I(p)},{immediate:!0}),I(r.modelValue),(p,h)=>{const c=f("el-button"),a=f("el-button-group"),u=f("el-input");return s(),E(W,null,[t(u,{ref_key:"inputRef",ref:V,modelValue:O.value,"onUpdate:modelValue":h[0]||(h[0]=x=>O.value=x),placeholder:o.placeholder,disabled:o.disabled,class:it({"is-invalid":S.value}),onInput:G,onBlur:J,onFocus:z},nt({_:2},[o.showControls?{name:"append",fn:e(()=>[t(a,null,{default:e(()=>[t(c,{icon:w(ot),disabled:o.disabled||T.value,onClick:B},null,8,["icon","disabled"]),t(c,{icon:w(rt),disabled:o.disabled||P.value,onClick:ee},null,8,["icon","disabled"])]),_:1})]),key:"0"}:void 0]),1032,["modelValue","placeholder","disabled","class"]),S.value?(s(),E("div",ht,k(D.value),1)):A("",!0)],64)}}},Ct=we(Rt,[["__scopeId","data-v-74ef628d"]]),Et={class:"card-header"},St={key:1},$t={key:0,class:"metric-description"},Dt={key:2,class:"metrics-info"},Mt={class:"info-row"},xt={key:0,class:"info-row"},At={__name:"MetricsEditor",props:{reportId:{type:String,required:!0}},emits:["metrics-updated"],setup(o,{emit:R}){const r=o,b=R,V=g(!1),O=g(!1),N=g(!1),S=g(null),D=g([]),C=g([]),T=g({metrics:{}}),P=g({}),I=Z(()=>!C.value||C.value.length===0?[]:[...new Set(C.value.map(a=>a.source))]),q=Z(()=>!C.value||C.value.length===0?null:new Date),G=async()=>{try{const a=await Ce.listMetricDefs(!0);D.value=a.items||[]}catch(a){console.error("Failed to load metric definitions:",a),S.value="Не удалось загрузить определения метрик"}},J=async()=>{V.value=!0,S.value=null;try{const a=await Ce.listExtractedMetrics(r.reportId);C.value=a.items||[],T.value.metrics={},C.value.forEach(u=>{T.value.metrics[u.metric_def_id]=ne(u.value)}),P.value=JSON.parse(JSON.stringify(T.value.metrics))}catch(a){console.error("Failed to load metrics:",a),S.value="Не удалось загрузить метрики"}finally{V.value=!1}},z=()=>{N.value=!0,P.value=JSON.parse(JSON.stringify(T.value.metrics))},ee=()=>{T.value.metrics=JSON.parse(JSON.stringify(P.value)),N.value=!1,S.value=null},B=async()=>{O.value=!0,S.value=null;try{const a=[];for(const[u,x]of Object.entries(T.value.metrics))if(x!=null&&x!==""){const y=kt(x);y!==null&&a.push({metric_def_id:u,value:y,source:"MANUAL",notes:null})}if(a.length===0){$.warning("Не введено ни одного значения метрики"),O.value=!1;return}await Ce.bulkCreateExtractedMetrics(r.reportId,a),$.success(`Успешно сохранено ${a.length} метрик`),N.value=!1,await J(),b("metrics-updated")}catch(a){console.error("Failed to save metrics:",a);let u="Не удалось сохранить метрики";a.response?.data?.detail&&(typeof a.response.data.detail=="string"?u=a.response.data.detail:Array.isArray(a.response.data.detail)&&(u=a.response.data.detail.map(x=>x.msg||x.message).join(", "))),S.value=u,$.error(u)}finally{O.value=!1}},p=a=>{switch(a){case"OCR":return"info";case"LLM":return"warning";case"MANUAL":return"success";default:return""}},h=a=>{switch(a){case"OCR":return"OCR";case"LLM":return"Gemini Vision";case"MANUAL":return"Ручной ввод";default:return a}},c=a=>new Date(a).toLocaleString("ru-RU",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});return Se(async()=>{await G(),await J()}),ge(()=>r.reportId,async a=>{a&&await J()}),(a,u)=>{const x=f("el-button"),y=f("el-alert"),F=f("el-form-item"),te=f("el-col"),ae=f("el-row"),K=f("el-form"),Q=f("el-divider"),oe=f("el-tag"),re=f("el-card");return s(),v(re,{class:"metrics-editor"},{header:e(()=>[_("div",Et,[u[4]||(u[4]=_("span",null,"Ручной ввод метрик",-1)),N.value?(s(),E("div",St,[t(x,{size:"small",onClick:ee},{default:e(()=>[...u[2]||(u[2]=[m(" Отмена ",-1)])]),_:1}),t(x,{type:"primary",size:"small",loading:O.value,onClick:B},{default:e(()=>[...u[3]||(u[3]=[m(" Сохранить ",-1)])]),_:1},8,["loading"])])):(s(),v(x,{key:0,type:"primary",size:"small",onClick:z},{default:e(()=>[...u[1]||(u[1]=[m(" Редактировать ",-1)])]),_:1}))])]),default:e(()=>[S.value?(s(),v(y,{key:0,type:"error",title:S.value,closable:"",style:{"margin-bottom":"16px"},onClose:u[0]||(u[0]=M=>S.value=null)},null,8,["title"])):A("",!0),!C.value||C.value.length===0?(s(),v(y,{key:1,type:"info",closable:!1,style:{"margin-bottom":"16px"}},{default:e(()=>[...u[5]||(u[5]=[m(" Метрики для этого отчёта ещё не извлечены. Вы можете ввести их вручную. ",-1)])]),_:1})):A("",!0),t(K,{ref:"formRef",model:T.value,"label-position":"top",disabled:!N.value},{default:e(()=>[t(ae,{gutter:20},{default:e(()=>[(s(!0),E(W,null,Y(D.value,M=>(s(),v(te,{key:M.id,xs:24,sm:12,md:8,lg:6},{default:e(()=>[t(F,{label:`${M.name} ${M.unit?"("+M.unit+")":""}`,prop:`metrics.${M.id}`},{default:e(()=>[t(Ct,{modelValue:T.value.metrics[M.id],"onUpdate:modelValue":le=>T.value.metrics[M.id]=le,min:M.min_value||1,max:M.max_value||10,precision:1,step:.1,disabled:!N.value,"show-controls":!0,placeholder:"Введите значение (например: 7,5)"},null,8,["modelValue","onUpdate:modelValue","min","max","disabled"]),M.description?(s(),E("div",$t,k(M.description),1)):A("",!0)]),_:2},1032,["label","prop"])]),_:2},1024))),128))]),_:1})]),_:1},8,["model","disabled"]),C.value&&C.value.length>0?(s(),E("div",Dt,[t(Q),_("div",Mt,[u[6]||(u[6]=_("span",{class:"info-label"},"Источник данных:",-1)),(s(!0),E(W,null,Y(I.value,M=>(s(),v(oe,{key:M,type:p(M),size:"small",style:{"margin-left":"8px"}},{default:e(()=>[m(k(h(M)),1)]),_:2},1032,["type"]))),128))]),q.value?(s(),E("div",xt,[u[7]||(u[7]=_("span",{class:"info-label"},"Последнее обновление:",-1)),_("span",null,k(c(q.value)),1)])):A("",!0)])):A("",!0)]),_:1})}}},Lt=we(At,[["__scopeId","data-v-bb0e5e9d"]]),Ot={class:"report-list"},Tt={class:"report-list__controls"},Vt={class:"controls-left"},Nt={class:"controls-right"},Ut={class:"status-cell"},It={key:1,class:"report-list__cards"},Ft={class:"report-card__header"},Pt={class:"report-card__status"},zt={class:"report-card__body"},Bt={class:"report-card__field"},jt={class:"field-value"},qt={class:"report-card__actions"},Jt={__name:"ReportList",props:{reports:{type:Array,required:!0,default:()=>[]},loading:{type:Boolean,default:!1}},emits:["view","edit","extract","download","delete","upload"],setup(o,{emit:R}){const r=o,b=R,V=je(),O=qe(),N=g(window.innerWidth<=768),S=()=>{N.value=window.innerWidth<=768};Se(()=>{window.addEventListener("resize",S),V.query.status&&(D.value=V.query.status),V.query.sort&&(C.value=V.query.sort)}),Je(()=>{window.removeEventListener("resize",S)});const D=g(""),C=g("desc"),T=[{label:"Загружен",value:"UPLOADED"},{label:"Извлечение метрик...",value:"PROCESSING"},{label:"Метрики извлечены",value:"EXTRACTED"},{label:"Ошибка",value:"FAILED"}];ge([D,C],([c,a])=>{const u={...V.query};c?u.status=c:delete u.status,a?u.sort=a:delete u.sort,O.replace({query:u})});const P=()=>{},I=()=>{C.value=C.value==="desc"?"asc":"desc"},q=Z(()=>{let c=[...r.reports];return D.value&&(c=c.filter(a=>a.status===D.value)),c.sort((a,u)=>{const x=new Date(a.uploaded_at),y=new Date(u.uploaded_at);return C.value==="desc"?y-x:x-y}),c}),G=Z(()=>D.value?"Нет отчётов с выбранным статусом":"Нет загруженных отчётов"),J=c=>{if(!c)return"—";const a=new Date(c);return Number.isNaN(a.getTime())?"—":a.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},z=c=>({REPORT_1:"Отчёт 1",REPORT_2:"Отчёт 2",REPORT_3:"Отчёт 3"})[c]||c,ee=c=>({UPLOADED:"Загружен",PROCESSING:"Извлечение метрик...",EXTRACTED:"Метрики извлечены",FAILED:"Ошибка"})[c]||c,B=c=>({UPLOADED:"info",PROCESSING:"warning",EXTRACTED:"success",FAILED:"danger"})[c]||"info",p=c=>({REPORT_1:"",REPORT_2:"success",REPORT_3:"warning"})[c]||"",h=async({action:c,report:a})=>{switch(c){case"view":b("view",a.id);break;case"edit":b("edit",a.id);break;case"extract":b("extract",a.id);break;case"download":b("download",a.id);break;case"delete":try{await ct.confirm(`Вы уверены, что хотите удалить отчёт "${z(a.type)}"?`,"Подтверждение удаления",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}),b("delete",a.id)}catch{}break}};return(c,a)=>{const u=f("el-option"),x=f("el-select"),y=f("el-icon"),F=f("el-button"),te=f("el-tag"),ae=f("el-table-column"),K=f("el-dropdown-item"),Q=f("el-dropdown-menu"),oe=f("el-dropdown"),re=f("el-table"),M=f("el-card"),le=f("el-empty"),me=Xe("loading");return s(),E("div",Ot,[_("div",Tt,[_("div",Vt,[t(x,{modelValue:D.value,"onUpdate:modelValue":a[0]||(a[0]=i=>D.value=i),placeholder:"Все статусы",clearable:"",style:{width:"200px"},onChange:P},{default:e(()=>[t(u,{label:"Все статусы",value:""}),(s(),E(W,null,Y(T,i=>t(u,{key:i.value,label:i.label,value:i.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_("div",Nt,[t(F,{type:C.value==="desc"?"primary":"default",size:"small",onClick:I},{default:e(()=>[t(y,null,{default:e(()=>[t(w(ut))]),_:1}),m(" "+k(C.value==="desc"?"Новые сверху":"Старые сверху"),1)]),_:1},8,["type"])])]),N.value?pe((s(),E("div",It,[(s(!0),E(W,null,Y(q.value,i=>(s(),v(M,{key:i.id,class:"report-card",shadow:"hover"},{header:e(()=>[_("div",Ft,[t(te,{type:p(i.type),size:"small"},{default:e(()=>[m(k(z(i.type)),1)]),_:2},1032,["type"]),_("div",Pt,[i.status==="PROCESSING"?(s(),v(y,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(w(Oe))]),_:1})):i.status==="EXTRACTED"?(s(),v(y,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(w(Te))]),_:1})):i.status==="FAILED"?(s(),v(y,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(w(Ve))]),_:1})):(s(),v(y,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(w(Ne))]),_:1})),t(te,{type:B(i.status),size:"small"},{default:e(()=>[m(k(ee(i.status)),1)]),_:2},1032,["type"])])])]),footer:e(()=>[_("div",qt,[i.status==="EXTRACTED"?(s(),v(F,{key:0,type:"success",size:"small",onClick:se=>h({action:"edit",report:i})},{default:e(()=>[t(y,null,{default:e(()=>[t(w(Ue))]),_:1}),a[9]||(a[9]=m(" Редактировать ",-1))]),_:1},8,["onClick"])):A("",!0),i.status==="PROCESSING"||i.status==="EXTRACTED"?(s(),v(F,{key:1,type:"info",size:"small",onClick:se=>h({action:"view",report:i})},{default:e(()=>[t(y,null,{default:e(()=>[t(w(Ie))]),_:1}),a[10]||(a[10]=m(" Просмотр ",-1))]),_:1},8,["onClick"])):A("",!0),i.status==="UPLOADED"||i.status==="FAILED"?(s(),v(F,{key:2,type:"primary",size:"small",loading:i.status==="PROCESSING",onClick:se=>h({action:"extract",report:i})},{default:e(()=>[t(y,null,{default:e(()=>[t(w(Fe))]),_:1}),m(" "+k(i.status==="FAILED"?"Повторить":"Извлечь"),1)]),_:2},1032,["loading","onClick"])):A("",!0),t(F,{size:"small",onClick:se=>h({action:"download",report:i})},{default:e(()=>[t(y,null,{default:e(()=>[t(w(Ee))]),_:1}),a[11]||(a[11]=m(" Скачать ",-1))]),_:1},8,["onClick"]),t(F,{type:"danger",size:"small",onClick:se=>h({action:"delete",report:i})},{default:e(()=>[t(y,null,{default:e(()=>[t(w(Pe))]),_:1})]),_:1},8,["onClick"])])]),default:e(()=>[_("div",zt,[_("div",Bt,[a[8]||(a[8]=_("span",{class:"field-label"},"Дата загрузки:",-1)),_("span",jt,k(J(i.uploaded_at)),1)])])]),_:2},1024))),128)),!q.value.length&&!o.loading?(s(),v(le,{key:0,description:G.value,"image-size":120},{default:e(()=>[D.value?A("",!0):(s(),v(F,{key:0,type:"primary",onClick:a[1]||(a[1]=i=>c.$emit("upload"))},{default:e(()=>[...a[12]||(a[12]=[m(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):A("",!0)])),[[me,o.loading]]):pe((s(),v(re,{key:0,data:q.value,class:"report-list__table",stripe:"","empty-text":G.value},{default:e(()=>[t(ae,{prop:"type",label:"Тип отчёта",width:"140"},{default:e(({row:i})=>[t(te,{type:p(i.type),size:"default"},{default:e(()=>[m(k(z(i.type)),1)]),_:2},1032,["type"])]),_:1}),t(ae,{prop:"status",label:"Статус",width:"180"},{default:e(({row:i})=>[_("div",Ut,[i.status==="PROCESSING"?(s(),v(y,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(w(Oe))]),_:1})):i.status==="EXTRACTED"?(s(),v(y,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(w(Te))]),_:1})):i.status==="FAILED"?(s(),v(y,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(w(Ve))]),_:1})):(s(),v(y,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(w(Ne))]),_:1})),t(te,{type:B(i.status),size:"default"},{default:e(()=>[m(k(ee(i.status)),1)]),_:2},1032,["type"])])]),_:1}),t(ae,{prop:"uploaded_at",label:"Дата загрузки",width:"180",sortable:""},{default:e(({row:i})=>[m(k(J(i.uploaded_at)),1)]),_:1}),t(ae,{label:"Действия",width:"200",fixed:"right",align:"right"},{default:e(({row:i})=>[t(oe,{trigger:"click",onCommand:h},{dropdown:e(()=>[t(Q,null,{default:e(()=>[i.status==="EXTRACTED"?(s(),v(K,{key:0,command:{action:"edit",report:i}},{default:e(()=>[t(y,null,{default:e(()=>[t(w(Ue))]),_:1}),a[4]||(a[4]=m(" Редактировать метрики ",-1))]),_:1},8,["command"])):A("",!0),i.status==="PROCESSING"||i.status==="EXTRACTED"?(s(),v(K,{key:1,command:{action:"view",report:i}},{default:e(()=>[t(y,null,{default:e(()=>[t(w(Ie))]),_:1}),a[5]||(a[5]=m(" Просмотр метрик ",-1))]),_:1},8,["command"])):A("",!0),i.status==="UPLOADED"||i.status==="FAILED"?(s(),v(K,{key:2,command:{action:"extract",report:i}},{default:e(()=>[t(y,null,{default:e(()=>[t(w(Fe))]),_:1}),m(" "+k(i.status==="FAILED"?"Повторить извлечение":"Извлечь метрики"),1)]),_:2},1032,["command"])):A("",!0),t(K,{divided:"",command:{action:"download",report:i}},{default:e(()=>[t(y,null,{default:e(()=>[t(w(Ee))]),_:1}),a[6]||(a[6]=m(" Скачать ",-1))]),_:1},8,["command"]),t(K,{command:{action:"delete",report:i},class:"dropdown-item--danger"},{default:e(()=>[t(y,null,{default:e(()=>[t(w(Pe))]),_:1}),a[7]||(a[7]=m(" Удалить ",-1))]),_:1},8,["command"])]),_:2},1024)]),default:e(()=>[t(F,{type:"primary",size:"small"},{default:e(()=>[a[3]||(a[3]=m(" Действия ",-1)),t(y,{class:"el-icon--right"},{default:e(()=>[t(w(dt))]),_:1})]),_:1})]),_:2},1024)]),_:1})]),_:1},8,["data","empty-text"])),[[me,o.loading]]),!q.value.length&&!o.loading&&!N.value?(s(),v(le,{key:2,description:G.value,"image-size":120},{default:e(()=>[D.value?A("",!0):(s(),v(F,{key:0,type:"primary",onClick:a[2]||(a[2]=i=>c.$emit("upload"))},{default:e(()=>[...a[13]||(a[13]=[m(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):A("",!0)])}}},Xt=we(Jt,[["__scopeId","data-v-65db6ab8"]]),Gt={class:"participant-detail"},Ht={class:"card-header"},Wt={class:"header-actions"},Kt={class:"section-header"},Qt={class:"section-header"},Yt={key:1},Zt={key:1},ea={class:"scoring-result"},ta={class:"score-value"},aa={class:"score-number"},la={class:"score-details"},sa={class:"score-section"},na={key:0},oa={class:"score-section"},ra={key:0},ia={key:0,class:"score-section"},ua={key:0,class:"final-report-actions"},da={style:{float:"right",color:"#8492a6","font-size":"13px"}},ca={__name:"ParticipantDetailView",setup(o){const R=qe(),r=je(),b=bt(),V=g(!1),O=g(!1),N=g(!1),S=g(!1),D=g(!1),C=g(!1),T=Z(()=>b.currentParticipant),P=g([]),I=g([]),q=g([]),G=g([]);g([]);const J=g(null),z=g(null),ee=Z(()=>P.value.some(n=>n.status==="PROCESSING")),B=g(!1),p=g(!1),h=g(!1),c=g(null),a=g([]),u=ze({report_type:"",file:null}),x={report_type:[{required:!0,message:"Выберите тип отчёта",trigger:"change"}],file:[{required:!0,message:"Выберите файл",trigger:"change"}]},y=ze({activityCode:""}),F=n=>{if(!n)return"—";const l=new Date(n);return Number.isNaN(l.getTime())?"—":l.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},te=n=>n>=80?"success":n>=60?"":"warning",ae=n=>n>=.8?"#67C23A":n>=.6?"#E6A23C":"#F56C6C",K=async()=>{V.value=!0;try{await b.getParticipant(r.params.id)}catch{$.error("Участник не найден"),R.push("/participants")}finally{V.value=!1}},Q=async()=>{O.value=!0;try{const n=await Be.getReports(r.params.id);P.value=n.items||[]}catch(n){console.error("Error loading reports:",n),$.error("Ошибка загрузки списка отчётов")}finally{O.value=!1}},oe=async()=>{try{const n=await ve.getHistory(r.params.id);I.value=n.items||[]}catch(n){console.error("Error loading scoring results:",n)}},re=async()=>{N.value=!0;try{const n=await wt.list();q.value=n.activities||[]}catch{$.error("Ошибка загрузки профессиональных областей")}finally{N.value=!1}},M=async()=>{S.value=!0;try{const n=await Be.getMetrics(r.params.id);G.value=n.metrics||[]}catch(n){console.error("Error loading participant metrics:",n),$.error("Ошибка загрузки метрик участника")}finally{S.value=!1}},le=n=>{u.file=n.raw,a.value=[n]},me=async()=>{c.value&&await c.value.validate(async n=>{if(n){if(!u.file){$.error("Выберите файл");return}D.value=!0;try{await _e.upload(r.params.id,u.report_type,u.file),$.success("Отчёт загружен успешно"),B.value=!1,u.report_type="",u.file=null,a.value=[],await Q(),await M()}catch{$.error("Ошибка загрузки отчёта")}finally{D.value=!1}}})},i=async n=>{try{const l=await _e.download(n),L=window.URL.createObjectURL(new Blob([l.data])),U=document.createElement("a");U.href=L,U.setAttribute("download",`report_${n}.docx`),document.body.appendChild(U),U.click(),U.remove(),window.URL.revokeObjectURL(L),$.success("Отчёт скачан")}catch{$.error("Ошибка скачивания отчёта")}},se=async n=>{try{await _e.extract(n),$.success("Извлечение метрик запущено"),await Q()}catch{$.error("Ошибка запуска извлечения метрик")}},Ge=()=>{z.value||(z.value=setInterval(async()=>{try{await Q(),await M()}catch(n){console.error("Auto-refresh error:",n)}},3e3))},$e=()=>{z.value&&(clearInterval(z.value),z.value=null)};ge(ee,n=>{n?Ge():$e()});const De=async n=>{J.value=n,await yt(),h.value=!0},He=async()=>{$.success("Метрики обновлены"),await M()},We=async n=>{try{await _e.delete(n),$.success("Отчёт удалён"),await Q()}catch{$.error("Ошибка удаления отчёта")}},Ke=async()=>{if(!y.activityCode){$.warning("Выберите профессиональную область");return}C.value=!0;try{const n=await ve.calculate(r.params.id,y.activityCode);I.value.unshift({id:n.scoring_result_id,prof_activity_code:n.prof_activity_code||y.activityCode,prof_activity_name:n.prof_activity_name,score_pct:parseFloat(n.score_pct),strengths:n.strengths||[],dev_areas:n.dev_areas||[],recommendations:n.recommendations||[],created_at:new Date().toISOString()}),$.success("Расчёт пригодности выполнен"),p.value=!1,y.activityCode=""}catch(n){console.error("Scoring calculation error:",n);const l=n.response?.data?.detail||"Ошибка расчёта пригодности";$.error(l)}finally{C.value=!1}},Qe=async n=>{if(!n.prof_activity_code){$.warning("Код профессиональной деятельности не найден");return}try{const l=await ve.getFinalReport(r.params.id,n.prof_activity_code,"json"),L=JSON.stringify(l,null,2),U=new Blob([L],{type:"application/json"}),j=window.URL.createObjectURL(U);window.open(j,"_blank"),window.URL.revokeObjectURL(j),$.success("Отчёт JSON открыт в новой вкладке")}catch(l){console.error("Error viewing final report JSON:",l);const L=l.response?.data?.detail||"Ошибка загрузки финального отчёта";$.error(L)}},Ye=async n=>{if(!n.prof_activity_code){$.warning("Код профессиональной деятельности не найден");return}try{const l=await ve.getFinalReport(r.params.id,n.prof_activity_code,"html"),L=new Blob([l],{type:"text/html"}),U=window.URL.createObjectURL(L),j=document.createElement("a");j.href=U,j.setAttribute("download",`final_report_${n.prof_activity_code}_${new Date().toISOString().split("T")[0]}.html`),document.body.appendChild(j),j.click(),j.remove(),window.URL.revokeObjectURL(U),$.success("Отчёт HTML скачан")}catch(l){console.error("Error downloading final report HTML:",l);const L=l.response?.data?.detail||"Ошибка загрузки финального отчёта";$.error(L)}};return Se(async()=>{await K(),await Q(),await oe(),await re(),await M()}),Je(()=>{$e()}),(n,l)=>{const L=f("el-button"),U=f("el-icon"),j=f("el-descriptions-item"),Ze=f("el-descriptions"),ie=f("el-card"),ue=f("el-table-column"),Me=f("el-tag"),et=f("el-table"),be=f("el-empty"),tt=f("el-progress"),at=f("el-timeline-item"),lt=f("el-timeline"),fe=f("el-option"),xe=f("el-select"),ke=f("el-form-item"),st=f("el-upload"),Ae=f("el-form"),he=f("el-dialog"),Le=f("el-alert"),Re=Xe("loading");return s(),v(gt,null,{default:e(()=>[pe((s(),E("div",Gt,[T.value?(s(),v(ie,{key:0,class:"detail-card"},{header:e(()=>[_("div",Ht,[_("h2",null,k(T.value.full_name),1),_("div",Wt,[t(L,{onClick:l[0]||(l[0]=d=>w(R).back())},{default:e(()=>[...l[11]||(l[11]=[m(" Назад ",-1)])]),_:1}),t(L,{type:"primary",onClick:l[1]||(l[1]=d=>p.value=!0)},{default:e(()=>[t(U,null,{default:e(()=>[t(w(pt))]),_:1}),l[12]||(l[12]=m(" Рассчитать пригодность ",-1))]),_:1})])])]),default:e(()=>[t(Ze,{column:2,border:""},{default:e(()=>[t(j,{label:"ФИО"},{default:e(()=>[m(k(T.value.full_name),1)]),_:1}),t(j,{label:"Дата рождения"},{default:e(()=>[m(k(T.value.birth_date||"Не указана"),1)]),_:1}),t(j,{label:"Внешний ID"},{default:e(()=>[m(k(T.value.external_id||"Не указан"),1)]),_:1}),t(j,{label:"Дата создания"},{default:e(()=>[m(k(F(T.value.created_at)),1)]),_:1})]),_:1})]),_:1})):A("",!0),t(ie,{class:"section-card"},{header:e(()=>[_("div",Kt,[l[14]||(l[14]=_("h3",null,"Отчёты",-1)),t(L,{type:"primary",onClick:l[2]||(l[2]=d=>B.value=!0)},{default:e(()=>[t(U,null,{default:e(()=>[t(w(mt))]),_:1}),l[13]||(l[13]=m(" Загрузить отчёт ",-1))]),_:1})])]),default:e(()=>[t(Xt,{reports:P.value,loading:O.value,onView:De,onEdit:De,onExtract:se,onDownload:i,onDelete:We,onUpload:l[3]||(l[3]=d=>B.value=!0)},null,8,["reports","loading"])]),_:1}),t(ie,{class:"section-card"},{header:e(()=>[_("div",Qt,[l[16]||(l[16]=_("h3",null,"Актуальные метрики участника",-1)),t(L,{type:"primary",size:"small",onClick:M},{default:e(()=>[t(U,null,{default:e(()=>[t(w(_t))]),_:1}),l[15]||(l[15]=m(" Обновить ",-1))]),_:1})])]),default:e(()=>[pe((s(),v(et,{data:G.value,stripe:""},{default:e(()=>[t(ue,{prop:"metric_code",label:"Код метрики",width:"200"}),t(ue,{prop:"value",label:"Значение",width:"120"},{default:e(({row:d})=>[t(Me,{type:"success"},{default:e(()=>[m(k(w(ce)(d.value)),1)]),_:2},1024)]),_:1}),t(ue,{prop:"confidence",label:"Уверенность",width:"150"},{default:e(({row:d})=>[d.confidence!==null?(s(),E("span",{key:0,style:ft({color:ae(d.confidence)})},k((d.confidence*100).toFixed(0))+"% ",5)):(s(),E("span",Yt,"—"))]),_:1}),t(ue,{prop:"updated_at",label:"Обновлено",width:"180"},{default:e(({row:d})=>[m(k(F(d.updated_at)),1)]),_:1}),t(ue,{prop:"last_source_report_id",label:"Источник"},{default:e(({row:d})=>[d.last_source_report_id?(s(),v(Me,{key:0,size:"small"},{default:e(()=>[...l[17]||(l[17]=[m(" Из отчёта ",-1)])]),_:1})):(s(),E("span",Zt,"—"))]),_:1})]),_:1},8,["data"])),[[Re,S.value]]),!G.value.length&&!S.value?(s(),v(be,{key:0,description:"Метрики ещё не извлечены. Загрузите и обработайте отчёты."})):A("",!0)]),_:1}),I.value.length>0?(s(),v(ie,{key:1,class:"section-card"},{header:e(()=>[...l[18]||(l[18]=[_("h3",null,"История оценок пригодности",-1)])]),default:e(()=>[t(lt,null,{default:e(()=>[(s(!0),E(W,null,Y(I.value,d=>(s(),v(at,{key:d.id,timestamp:F(d.created_at),placement:"top"},{default:e(()=>[t(ie,null,{default:e(()=>[_("h4",null,k(d.prof_activity_name),1),_("div",ea,[_("div",ta,[_("span",aa,k(d.score_pct)+"%",1),t(tt,{percentage:d.score_pct,status:te(d.score_pct)},null,8,["percentage","status"])]),_("div",la,[_("div",sa,[l[19]||(l[19]=_("h5",null,"Сильные стороны:",-1)),d.strengths&&d.strengths.length?(s(),E("ul",na,[(s(!0),E(W,null,Y(d.strengths,(H,de)=>(s(),E("li",{key:de},[_("strong",null,k(H.metric_name),1),m(" — "+k(w(ce)(H.value))+" (вес "+k(w(ce)(H.weight,2))+") ",1)]))),128))])):(s(),v(be,{key:1,description:"Нет данных","image-size":60}))]),_("div",oa,[l[20]||(l[20]=_("h5",null,"Зоны развития:",-1)),d.dev_areas&&d.dev_areas.length?(s(),E("ul",ra,[(s(!0),E(W,null,Y(d.dev_areas,(H,de)=>(s(),E("li",{key:de},[_("strong",null,k(H.metric_name),1),m(" — "+k(w(ce)(H.value))+" (вес "+k(w(ce)(H.weight,2))+") ",1)]))),128))])):(s(),v(be,{key:1,description:"Нет данных","image-size":60}))]),d.recommendations&&d.recommendations.length?(s(),E("div",ia,[l[21]||(l[21]=_("h5",null,"Рекомендации:",-1)),_("ul",null,[(s(!0),E(W,null,Y(d.recommendations,(H,de)=>(s(),E("li",{key:de},k(H),1))),128))])])):A("",!0)]),d.prof_activity_code?(s(),E("div",ua,[t(L,{type:"info",size:"small",onClick:H=>Qe(d)},{default:e(()=>[t(U,null,{default:e(()=>[t(w(vt))]),_:1}),l[22]||(l[22]=m(" Просмотреть JSON ",-1))]),_:1},8,["onClick"]),t(L,{type:"primary",size:"small",onClick:H=>Ye(d)},{default:e(()=>[t(U,null,{default:e(()=>[t(w(Ee))]),_:1}),l[23]||(l[23]=m(" Скачать HTML ",-1))]),_:1},8,["onClick"])])):A("",!0)])]),_:2},1024)]),_:2},1032,["timestamp"]))),128))]),_:1})]),_:1})):A("",!0),t(he,{modelValue:B.value,"onUpdate:modelValue":l[6]||(l[6]=d=>B.value=d),title:"Загрузить отчёт",width:"500px"},{footer:e(()=>[t(L,{onClick:l[5]||(l[5]=d=>B.value=!1)},{default:e(()=>[...l[26]||(l[26]=[m(" Отмена ",-1)])]),_:1}),t(L,{type:"primary",loading:D.value,onClick:me},{default:e(()=>[...l[27]||(l[27]=[m(" Загрузить ",-1)])]),_:1},8,["loading"])]),default:e(()=>[t(Ae,{ref_key:"uploadFormRef",ref:c,model:u,rules:x,"label-position":"top"},{default:e(()=>[t(ke,{label:"Тип отчёта",prop:"report_type"},{default:e(()=>[t(xe,{modelValue:u.report_type,"onUpdate:modelValue":l[4]||(l[4]=d=>u.report_type=d),placeholder:"Выберите тип",style:{width:"100%"}},{default:e(()=>[t(fe,{label:"Отчёт 1",value:"REPORT_1"}),t(fe,{label:"Отчёт 2",value:"REPORT_2"}),t(fe,{label:"Отчёт 3",value:"REPORT_3"})]),_:1},8,["modelValue"])]),_:1}),t(ke,{label:"Файл (DOCX)",prop:"file"},{default:e(()=>[t(st,{ref:"uploadRef","auto-upload":!1,limit:1,accept:".docx","on-change":le,"file-list":a.value},{tip:e(()=>[...l[25]||(l[25]=[_("div",{class:"el-upload__tip"}," Только файлы DOCX, максимум 20 МБ ",-1)])]),default:e(()=>[t(L,{type:"primary"},{default:e(()=>[...l[24]||(l[24]=[m(" Выбрать файл ",-1)])]),_:1})]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(he,{modelValue:p.value,"onUpdate:modelValue":l[9]||(l[9]=d=>p.value=d),title:"Рассчитать профессиональную пригодность",width:"500px"},{footer:e(()=>[t(L,{onClick:l[8]||(l[8]=d=>p.value=!1)},{default:e(()=>[...l[28]||(l[28]=[m(" Отмена ",-1)])]),_:1}),t(L,{type:"primary",loading:C.value,disabled:!y.activityCode||P.value.length===0,onClick:Ke},{default:e(()=>[...l[29]||(l[29]=[m(" Рассчитать ",-1)])]),_:1},8,["loading","disabled"])]),default:e(()=>[t(Ae,{model:y,"label-position":"top"},{default:e(()=>[t(ke,{label:"Профессиональная область",required:""},{default:e(()=>[pe((s(),v(xe,{modelValue:y.activityCode,"onUpdate:modelValue":l[7]||(l[7]=d=>y.activityCode=d),placeholder:"Выберите область",style:{width:"100%"}},{default:e(()=>[(s(!0),E(W,null,Y(q.value,d=>(s(),v(fe,{key:d.code,label:d.name,value:d.code},{default:e(()=>[_("span",null,k(d.name),1),_("span",da,k(d.code),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])),[[Re,N.value]])]),_:1}),t(Le,{title:"Убедитесь, что у участника загружены и обработаны отчёты с метриками",type:"info",closable:!1,"show-icon":""}),P.value.length===0?(s(),v(Le,{key:0,title:"У участника нет загруженных отчётов",type:"warning",closable:!1,"show-icon":"",style:{"margin-top":"12px"}})):A("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(he,{modelValue:h.value,"onUpdate:modelValue":l[10]||(l[10]=d=>h.value=d),title:"Метрики отчёта",width:"90%",top:"5vh"},{default:e(()=>[J.value?(s(),v(Lt,{key:0,"report-id":J.value,onMetricsUpdated:He},null,8,["report-id"])):A("",!0)]),_:1},8,["modelValue"])])),[[Re,V.value]])]),_:1})}}},ya=we(ca,[["__scopeId","data-v-6deb2f1d"]]);export{ya as default};
