import{G,m as w,H as ee,I as fe,r as v,c as h,o as s,d as t,v as A,J as wt,w as e,u as k,K as bt,C as kt,L as ht,M as y,N as W,z as Ee,q as _,f,O as Z,a as p,E as D,p as je,e as qe,P as Je,A as Xe,B as me,Q as Ct,R as Ne,k as Ve,S as Ie,g as Oe,T as Rt,U as Ue,V as Te,h as Fe,W as Re,X as ze,F as Et,n as Pe,t as St,Y as $t,Z as Dt,_ as At,$ as Mt,a0 as xt}from"./index-7i9_ZqRL.js";import{A as Lt}from"./AppLayout-B4syDbeR.js";import{_ as be}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{m as ge,p as Nt}from"./metrics-BLVkYRp8.js";import{u as Vt,p as Be}from"./participants-CkclCSGO.js";const ve={async upload(r,b){const l=new FormData;return l.append("file",b),(await G.post(`/participants/${r}/reports`,l,{headers:{"Content-Type":"multipart/form-data"}})).data},async download(r){return await G.get(`/reports/${r}/download`,{responseType:"blob"})},async getById(r){return(await G.get(`/reports/${r}`)).data},async delete(r){return(await G.delete(`/reports/${r}`)).data},async extract(r){return(await G.post(`/reports/${r}/extract`)).data},async getMetrics(r){return(await G.get(`/reports/${r}/metrics`)).data},async getList(r){return(await G.get(`/participants/${r}/reports`)).data}},ye={async calculate(r,b){return(await G.post(`/scoring/participants/${r}/calculate`,null,{params:{activity_code:b}})).data},async getHistory(r,b=10){return(await G.get(`/scoring/participants/${r}/scores`,{params:{limit:b}})).data},async getById(r){return(await G.get(`/scoring-results/${r}`)).data},async generateRecommendations(r){return(await G.post(`/reports/${r}/recommendations`)).data},async getFinalReport(r,b,l="json"){const E={params:{activity_code:b,format:l}};l==="html"&&(E.responseType="text");const U=await G.get(`/participants/${r}/final-report`,E);return U.data}};function we(r,b=1){if(r==null||r==="")return"";const l=typeof r=="string"?parseFloat(r):r;return isNaN(l)?"":l.toLocaleString("ru-RU",{minimumFractionDigits:b,maximumFractionDigits:b})}function se(r){if(r==null||r==="")return null;const l=String(r).trim().replace(",","."),E=parseFloat(l);return isNaN(E)?null:E}function It(r){return se(r)}function pe(r,b=1){return we(r,b)}const Ot={key:0,class:"error-message"},Ut={__name:"MetricInput",props:{modelValue:{type:[Number,String],default:null},min:{type:Number,default:1},max:{type:Number,default:10},step:{type:Number,default:.1},precision:{type:Number,default:1},placeholder:{type:String,default:"Введите значение"},disabled:{type:Boolean,default:!1},showControls:{type:Boolean,default:!0}},emits:["update:modelValue","change","blur"],setup(r,{emit:b}){const l=r,E=b,U=w(null),L=w(""),O=w(!1),$=w(!1),M=w(""),C=ee(()=>se(L.value)),N=ee(()=>{const u=C.value;return u===null||u<=l.min}),B=ee(()=>{const u=C.value;return u===null||u>=l.max}),T=u=>{if(u==null||u===""){L.value="";return}O.value?L.value=String(u).replace(".",","):L.value=we(u,l.precision)},j=u=>{if(u==null||u==="")return $.value=!1,M.value="",!0;const o=se(u);return o===null?($.value=!0,M.value="Некорректное число",!1):o<l.min?($.value=!0,M.value=`Значение должно быть не меньше ${we(l.min,l.precision)}`,!1):o>l.max?($.value=!0,M.value=`Значение должно быть не больше ${we(l.max,l.precision)}`,!1):($.value=!1,M.value="",!0)},H=u=>{const o=u.replace(/[^\d,.-]/g,"");let g=!1;const m=o.split("").filter(R=>R===","||R==="."?g?!1:(g=!0,!0):!0).join("").replace(".",",");L.value=m;const i=se(m);i!==null?E("update:modelValue",i):(m===""||m==="-")&&E("update:modelValue",null)},q=()=>{O.value=!1;const u=se(L.value);if(j(L.value)){if(u!==null){const o=Math.round(u*Math.pow(10,l.precision))/Math.pow(10,l.precision),g=Math.max(l.min,Math.min(l.max,o));E("update:modelValue",g),T(g),E("change",g)}}else if(u!==null&&(u<l.min||u>l.max)){const o=Math.max(l.min,Math.min(l.max,u));E("update:modelValue",o),T(o),E("change",o),$.value=!1,M.value=""}E("blur")},K=()=>{O.value=!0,C.value!==null&&(L.value=String(C.value).replace(".",","))},J=()=>{const u=C.value||0,o=Math.min(l.max,u+l.step),g=Math.round(o*Math.pow(10,l.precision))/Math.pow(10,l.precision);E("update:modelValue",g),E("change",g),T(g)},F=()=>{const u=C.value||0,o=Math.max(l.min,u-l.step),g=Math.round(o*Math.pow(10,l.precision))/Math.pow(10,l.precision);E("update:modelValue",g),E("change",g),T(g)};return fe(()=>l.modelValue,u=>{T(u)},{immediate:!0}),T(l.modelValue),(u,o)=>{const g=v("el-button"),m=v("el-button-group"),i=v("el-input");return s(),h(W,null,[t(i,{ref_key:"inputRef",ref:U,modelValue:L.value,"onUpdate:modelValue":o[0]||(o[0]=R=>L.value=R),placeholder:r.placeholder,disabled:r.disabled,class:ht({"is-invalid":$.value}),onInput:H,onBlur:q,onFocus:K},wt({_:2},[r.showControls?{name:"append",fn:e(()=>[t(m,null,{default:e(()=>[t(g,{icon:k(bt),disabled:r.disabled||N.value,onClick:F},null,8,["icon","disabled"]),t(g,{icon:k(kt),disabled:r.disabled||B.value,onClick:J},null,8,["icon","disabled"])]),_:1})]),key:"0"}:void 0]),1032,["modelValue","placeholder","disabled","class"]),$.value?(s(),h("div",Ot,y(M.value),1)):A("",!0)],64)}}},Tt=be(Ut,[["__scopeId","data-v-74ef628d"]]),Ft={class:"card-header"},zt={key:1},Pt={key:0,class:"metric-description"},Bt={key:2,class:"metrics-info"},jt={class:"info-row"},qt={key:0,class:"info-row"},Jt={__name:"MetricsEditor",props:{reportId:{type:String,required:!0}},emits:["metrics-updated"],setup(r,{emit:b}){const l=r,E=b,U=w(!1),L=w(!1),O=w(!1),$=w(null),M=w([]),C=w([]),N=w({metrics:{}}),B=w({}),T=ee(()=>!C.value||C.value.length===0?[]:[...new Set(C.value.map(m=>m.source))]),j=ee(()=>!C.value||C.value.length===0?null:new Date),H=async()=>{try{const m=await ge.listMetricDefs(!0);M.value=m.items||[]}catch(m){console.error("Failed to load metric definitions:",m),$.value="Не удалось загрузить определения метрик"}},q=async()=>{U.value=!0,$.value=null;try{const m=await ge.listExtractedMetrics(l.reportId);C.value=m.items||[],N.value.metrics={},C.value.forEach(i=>{N.value.metrics[i.metric_def_id]=se(i.value)}),B.value=JSON.parse(JSON.stringify(N.value.metrics))}catch(m){console.error("Failed to load metrics:",m),$.value="Не удалось загрузить метрики"}finally{U.value=!1}},K=()=>{O.value=!0,B.value=JSON.parse(JSON.stringify(N.value.metrics))},J=()=>{N.value.metrics=JSON.parse(JSON.stringify(B.value)),O.value=!1,$.value=null},F=async()=>{L.value=!0,$.value=null;try{const m=[];for(const[i,R]of Object.entries(N.value.metrics))if(R!=null&&R!==""){const P=It(R);P!==null&&m.push({metric_def_id:i,value:P,source:"MANUAL",notes:null})}if(m.length===0){D.warning("Не введено ни одного значения метрики"),L.value=!1;return}await ge.bulkCreateExtractedMetrics(l.reportId,m),D.success(`Успешно сохранено ${m.length} метрик`),O.value=!1,await q(),E("metrics-updated")}catch(m){console.error("Failed to save metrics:",m);let i="Не удалось сохранить метрики";m.response?.data?.detail&&(typeof m.response.data.detail=="string"?i=m.response.data.detail:Array.isArray(m.response.data.detail)&&(i=m.response.data.detail.map(R=>R.msg||R.message).join(", "))),$.value=i,D.error(i)}finally{L.value=!1}},u=m=>{switch(m){case"OCR":return"info";case"LLM":return"warning";case"MANUAL":return"success";default:return""}},o=m=>{switch(m){case"OCR":return"OCR";case"LLM":return"Gemini Vision";case"MANUAL":return"Ручной ввод";default:return m}},g=m=>new Date(m).toLocaleString("ru-RU",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});return Ee(async()=>{await H(),await q()}),fe(()=>l.reportId,async m=>{m&&await q()}),(m,i)=>{const R=v("el-button"),P=v("el-alert"),Q=v("el-form-item"),te=v("el-col"),X=v("el-row"),ae=v("el-form"),oe=v("el-divider"),le=v("el-tag"),ne=v("el-card");return s(),_(ne,{class:"metrics-editor"},{header:e(()=>[p("div",Ft,[i[4]||(i[4]=p("span",null,"Ручной ввод метрик",-1)),O.value?(s(),h("div",zt,[t(R,{size:"small",onClick:J},{default:e(()=>[...i[2]||(i[2]=[f(" Отмена ",-1)])]),_:1}),t(R,{type:"primary",size:"small",loading:L.value,onClick:F},{default:e(()=>[...i[3]||(i[3]=[f(" Сохранить ",-1)])]),_:1},8,["loading"])])):(s(),_(R,{key:0,type:"primary",size:"small",onClick:K},{default:e(()=>[...i[1]||(i[1]=[f(" Редактировать ",-1)])]),_:1}))])]),default:e(()=>[$.value?(s(),_(P,{key:0,type:"error",title:$.value,closable:"",style:{"margin-bottom":"16px"},onClose:i[0]||(i[0]=x=>$.value=null)},null,8,["title"])):A("",!0),!C.value||C.value.length===0?(s(),_(P,{key:1,type:"info",closable:!1,style:{"margin-bottom":"16px"}},{default:e(()=>[...i[5]||(i[5]=[f(" Метрики для этого отчёта ещё не извлечены. Вы можете ввести их вручную. ",-1)])]),_:1})):A("",!0),t(ae,{ref:"formRef",model:N.value,"label-position":"top",disabled:!O.value},{default:e(()=>[t(X,{gutter:20},{default:e(()=>[(s(!0),h(W,null,Z(M.value,x=>(s(),_(te,{key:x.id,xs:24,sm:12,md:8,lg:6},{default:e(()=>[t(Q,{label:`${x.name} (${x.code})${x.unit?" "+x.unit:""}`,prop:`metrics.${x.id}`},{default:e(()=>[t(Tt,{modelValue:N.value.metrics[x.id],"onUpdate:modelValue":c=>N.value.metrics[x.id]=c,min:x.min_value||1,max:x.max_value||10,precision:1,step:.1,disabled:!O.value,"show-controls":!0,placeholder:"Введите значение (например: 7,5)"},null,8,["modelValue","onUpdate:modelValue","min","max","disabled"]),x.description?(s(),h("div",Pt,y(x.description),1)):A("",!0)]),_:2},1032,["label","prop"])]),_:2},1024))),128))]),_:1})]),_:1},8,["model","disabled"]),C.value&&C.value.length>0?(s(),h("div",Bt,[t(oe),p("div",jt,[i[6]||(i[6]=p("span",{class:"info-label"},"Источник данных:",-1)),(s(!0),h(W,null,Z(T.value,x=>(s(),_(le,{key:x,type:u(x),size:"small",style:{"margin-left":"8px"}},{default:e(()=>[f(y(o(x)),1)]),_:2},1032,["type"]))),128))]),j.value?(s(),h("div",qt,[i[7]||(i[7]=p("span",{class:"info-label"},"Последнее обновление:",-1)),p("span",null,y(g(j.value)),1)])):A("",!0)])):A("",!0)]),_:1})}}},Xt=be(Jt,[["__scopeId","data-v-eda2e3f7"]]),Gt={class:"report-list"},Ht={class:"report-list__controls"},Wt={class:"controls-left"},Kt={class:"controls-right"},Qt={class:"filename"},Yt={class:"status-cell"},Zt={key:1,class:"report-list__cards"},ea={class:"report-card__header"},ta={class:"report-card__status"},aa={class:"report-card__body"},na={class:"report-card__field"},sa={class:"field-value"},oa={class:"report-card__field"},la={class:"field-value"},ra={class:"report-card__actions"},ia={__name:"ReportList",props:{reports:{type:Array,required:!0,default:()=>[]},loading:{type:Boolean,default:!1}},emits:["view","edit","extract","download","delete","upload"],setup(r,{emit:b}){const l=r,E=b,U=je(),L=qe(),O=w(window.innerWidth<=768),$=()=>{O.value=window.innerWidth<=768};Ee(()=>{window.addEventListener("resize",$),U.query.status&&(M.value=U.query.status),U.query.sort&&(C.value=U.query.sort)}),Je(()=>{window.removeEventListener("resize",$)});const M=w(""),C=w("desc"),N=[{label:"Загружен",value:"UPLOADED"},{label:"Извлечение метрик...",value:"PROCESSING"},{label:"Метрики извлечены",value:"EXTRACTED"},{label:"Ошибка",value:"FAILED"}];fe([M,C],([u,o])=>{const g={...U.query};u?g.status=u:delete g.status,o?g.sort=o:delete g.sort,L.replace({query:g})});const B=()=>{},T=()=>{C.value=C.value==="desc"?"asc":"desc"},j=ee(()=>{let u=[...l.reports];return M.value&&(u=u.filter(o=>o.status===M.value)),u.sort((o,g)=>{const m=new Date(o.uploaded_at),i=new Date(g.uploaded_at);return C.value==="desc"?i-m:m-i}),u}),H=ee(()=>M.value?"Нет отчётов с выбранным статусом":"Нет загруженных отчётов"),q=u=>{if(!u)return"—";const o=new Date(u);return Number.isNaN(o.getTime())?"—":o.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},K=u=>({UPLOADED:"Загружен",PROCESSING:"Извлечение метрик...",EXTRACTED:"Метрики извлечены",FAILED:"Ошибка"})[u]||u,J=u=>({UPLOADED:"info",PROCESSING:"warning",EXTRACTED:"success",FAILED:"danger"})[u]||"info",F=async({action:u,report:o})=>{switch(u){case"view":E("view",o.id);break;case"edit":E("edit",o.id);break;case"extract":E("extract",o.id);break;case"download":E("download",o.id);break;case"delete":try{await Et.confirm("Вы уверены, что хотите удалить этот отчёт?","Подтверждение удаления",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}),E("delete",o.id)}catch{}break}};return(u,o)=>{const g=v("el-option"),m=v("el-select"),i=v("el-icon"),R=v("el-button"),P=v("el-table-column"),Q=v("el-tag"),te=v("el-dropdown-item"),X=v("el-dropdown-menu"),ae=v("el-dropdown"),oe=v("el-table"),le=v("el-card"),ne=v("el-empty"),x=Xe("loading");return s(),h("div",Gt,[p("div",Ht,[p("div",Wt,[t(m,{modelValue:M.value,"onUpdate:modelValue":o[0]||(o[0]=c=>M.value=c),placeholder:"Все статусы",clearable:"",style:{width:"200px"},onChange:B},{default:e(()=>[t(g,{label:"Все статусы",value:""}),(s(),h(W,null,Z(N,c=>t(g,{key:c.value,label:c.label,value:c.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),p("div",Kt,[t(R,{type:C.value==="desc"?"primary":"default",size:"small",onClick:T},{default:e(()=>[t(i,null,{default:e(()=>[t(k(Ct))]),_:1}),f(" "+y(C.value==="desc"?"Новые сверху":"Старые сверху"),1)]),_:1},8,["type"])])]),O.value?me((s(),h("div",Zt,[(s(!0),h(W,null,Z(j.value,c=>(s(),_(le,{key:c.id,class:"report-card",shadow:"hover"},{header:e(()=>[p("div",ea,[p("div",ta,[c.status==="PROCESSING"?(s(),_(i,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(k(Ne))]),_:1})):c.status==="EXTRACTED"?(s(),_(i,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(k(Ve))]),_:1})):c.status==="FAILED"?(s(),_(i,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(k(Ie))]),_:1})):(s(),_(i,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(k(Oe))]),_:1})),t(Q,{type:J(c.status),size:"small"},{default:e(()=>[f(y(K(c.status)),1)]),_:2},1032,["type"])])])]),footer:e(()=>[p("div",ra,[c.status==="EXTRACTED"?(s(),_(R,{key:0,type:"success",size:"small",onClick:Y=>F({action:"edit",report:c})},{default:e(()=>[t(i,null,{default:e(()=>[t(k(Ue))]),_:1}),o[10]||(o[10]=f(" Редактировать ",-1))]),_:1},8,["onClick"])):A("",!0),c.status==="PROCESSING"||c.status==="EXTRACTED"?(s(),_(R,{key:1,type:"info",size:"small",onClick:Y=>F({action:"view",report:c})},{default:e(()=>[t(i,null,{default:e(()=>[t(k(Te))]),_:1}),o[11]||(o[11]=f(" Просмотр ",-1))]),_:1},8,["onClick"])):A("",!0),c.status==="UPLOADED"||c.status==="FAILED"?(s(),_(R,{key:2,type:"primary",size:"small",loading:c.status==="PROCESSING",onClick:Y=>F({action:"extract",report:c})},{default:e(()=>[t(i,null,{default:e(()=>[t(k(Fe))]),_:1}),f(" "+y(c.status==="FAILED"?"Повторить":"Извлечь"),1)]),_:2},1032,["loading","onClick"])):A("",!0),t(R,{size:"small",onClick:Y=>F({action:"download",report:c})},{default:e(()=>[t(i,null,{default:e(()=>[t(k(Re))]),_:1}),o[12]||(o[12]=f(" Скачать ",-1))]),_:1},8,["onClick"]),t(R,{type:"danger",size:"small",onClick:Y=>F({action:"delete",report:c})},{default:e(()=>[t(i,null,{default:e(()=>[t(k(ze))]),_:1})]),_:1},8,["onClick"])])]),default:e(()=>[p("div",aa,[p("div",na,[o[8]||(o[8]=p("span",{class:"field-label"},"Файл:",-1)),p("span",sa,y(c.file_ref?.filename||"Без названия"),1)]),p("div",oa,[o[9]||(o[9]=p("span",{class:"field-label"},"Дата загрузки:",-1)),p("span",la,y(q(c.uploaded_at)),1)])])]),_:2},1024))),128)),!j.value.length&&!r.loading?(s(),_(ne,{key:0,description:H.value,"image-size":120},{default:e(()=>[M.value?A("",!0):(s(),_(R,{key:0,type:"primary",onClick:o[1]||(o[1]=c=>u.$emit("upload"))},{default:e(()=>[...o[13]||(o[13]=[f(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):A("",!0)])),[[x,r.loading]]):me((s(),_(oe,{key:0,data:j.value,class:"report-list__table",stripe:"","empty-text":H.value},{default:e(()=>[t(P,{prop:"file_ref.filename",label:"Название файла","min-width":"200"},{default:e(({row:c})=>[p("span",Qt,y(c.file_ref?.filename||"Без названия"),1)]),_:1}),t(P,{prop:"status",label:"Статус",width:"200"},{default:e(({row:c})=>[p("div",Yt,[c.status==="PROCESSING"?(s(),_(i,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(k(Ne))]),_:1})):c.status==="EXTRACTED"?(s(),_(i,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(k(Ve))]),_:1})):c.status==="FAILED"?(s(),_(i,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(k(Ie))]),_:1})):(s(),_(i,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(k(Oe))]),_:1})),t(Q,{type:J(c.status),size:"default"},{default:e(()=>[f(y(K(c.status)),1)]),_:2},1032,["type"])])]),_:1}),t(P,{prop:"uploaded_at",label:"Дата загрузки",width:"180",sortable:""},{default:e(({row:c})=>[f(y(q(c.uploaded_at)),1)]),_:1}),t(P,{label:"Действия",width:"200",fixed:"right",align:"right"},{default:e(({row:c})=>[t(ae,{trigger:"click",onCommand:F},{dropdown:e(()=>[t(X,null,{default:e(()=>[c.status==="EXTRACTED"?(s(),_(te,{key:0,command:{action:"edit",report:c}},{default:e(()=>[t(i,null,{default:e(()=>[t(k(Ue))]),_:1}),o[4]||(o[4]=f(" Редактировать метрики ",-1))]),_:1},8,["command"])):A("",!0),c.status==="PROCESSING"||c.status==="EXTRACTED"?(s(),_(te,{key:1,command:{action:"view",report:c}},{default:e(()=>[t(i,null,{default:e(()=>[t(k(Te))]),_:1}),o[5]||(o[5]=f(" Просмотр метрик ",-1))]),_:1},8,["command"])):A("",!0),c.status==="UPLOADED"||c.status==="FAILED"?(s(),_(te,{key:2,command:{action:"extract",report:c}},{default:e(()=>[t(i,null,{default:e(()=>[t(k(Fe))]),_:1}),f(" "+y(c.status==="FAILED"?"Повторить извлечение":"Извлечь метрики"),1)]),_:2},1032,["command"])):A("",!0),t(te,{divided:"",command:{action:"download",report:c}},{default:e(()=>[t(i,null,{default:e(()=>[t(k(Re))]),_:1}),o[6]||(o[6]=f(" Скачать ",-1))]),_:1},8,["command"]),t(te,{command:{action:"delete",report:c},class:"dropdown-item--danger"},{default:e(()=>[t(i,null,{default:e(()=>[t(k(ze))]),_:1}),o[7]||(o[7]=f(" Удалить ",-1))]),_:1},8,["command"])]),_:2},1024)]),default:e(()=>[t(R,{type:"primary",size:"small"},{default:e(()=>[o[3]||(o[3]=f(" Действия ",-1)),t(i,{class:"el-icon--right"},{default:e(()=>[t(k(Rt))]),_:1})]),_:1})]),_:2},1024)]),_:1})]),_:1},8,["data","empty-text"])),[[x,r.loading]]),!j.value.length&&!r.loading&&!O.value?(s(),_(ne,{key:2,description:H.value,"image-size":120},{default:e(()=>[M.value?A("",!0):(s(),_(R,{key:0,type:"primary",onClick:o[2]||(o[2]=c=>u.$emit("upload"))},{default:e(()=>[...o[14]||(o[14]=[f(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):A("",!0)])}}},ua=be(ia,[["__scopeId","data-v-2d471c96"]]);function da(r){if(!r)return"";const b=r.name||r.metric_name,l=r.code||r.metric_code;return!b&&!l?"":b&&l?`${b} (${l})`:l||b||""}const ca={class:"participant-detail"},pa={class:"card-header"},ma={class:"header-actions"},fa={class:"section-header"},_a={class:"section-header"},va={key:1},ya={key:1},ga={class:"scoring-result"},wa={class:"score-value"},ba={class:"score-number"},ka={class:"score-details"},ha={class:"score-section"},Ca={key:0},Ra={style:{color:"#909399","font-size":"0.9em"}},Ea={class:"score-section"},Sa={key:0},$a={style:{color:"#909399","font-size":"0.9em"}},Da={class:"score-section"},Aa={key:0},Ma={key:0,class:"recommendation-skill-focus"},xa={key:1,class:"recommendation-advice"},La={key:2,class:"recommendation-formats"},Na={class:"formats-list"},Va={key:0,class:"final-report-actions"},Ia={style:{float:"right",color:"#8492a6","font-size":"13px"}},Oa={__name:"ParticipantDetailView",setup(r){const b=qe(),l=je(),E=Vt(),U=w(!1),L=w(!1),O=w(!1),$=w(!1),M=w(!1),C=w(!1),N=ee(()=>E.currentParticipant),B=w([]),T=w([]),j=w([]),H=w([]),q=w([]);w([]);const K=w(null),J=w(null),F=w(null),u=ee(()=>B.value.some(a=>a.status==="PROCESSING")),o=ee(()=>T.value.some(a=>a.recommendations_status==="pending")),g=w(!1),m=w(!1),i=w(!1),R=w(null),P=w([]),Q=Pe({file:null}),te={file:[{required:!0,message:"Выберите файл",trigger:"change"}]},X=Pe({activityCode:""}),ae=a=>{if(!a)return"—";const n=new Date(a);return Number.isNaN(n.getTime())?"—":n.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},oe=a=>a>=80?"success":a>=60?"":"warning",le=a=>({pending:"Формируются",ready:"Готовы",error:"Ошибка",disabled:"Отключены"})[a]||a,ne=a=>({pending:"info",ready:"success",error:"danger",disabled:"warning"})[a]||"info",x=a=>a>=.8?"#67C23A":a>=.6?"#E6A23C":"#F56C6C",c=async()=>{U.value=!0;try{await E.getParticipant(l.params.id)}catch{D.error("Участник не найден"),b.push("/participants")}finally{U.value=!1}},Y=async()=>{L.value=!0;try{const a=await Be.getReports(l.params.id);B.value=a.items||[]}catch(a){console.error("Error loading reports:",a),D.error("Ошибка загрузки списка отчётов")}finally{L.value=!1}},Se=a=>{if(!a)return a;const n=Array.isArray(a.recommendations)?a.recommendations:[];let S=a.recommendations_status||a.recommendationsStatus||null;S||(S=n.length>0?"ready":"pending");const I=Number(a.score_pct),z=Number.isNaN(I)?a.score_pct:I;return{...a,score_pct:z,recommendations:n,recommendations_status:S,recommendations_error:a.recommendations_error||a.recommendationsError||null}},$e=async()=>{try{const a=await ye.getHistory(l.params.id),n=Array.isArray(a.items)?a.items:[];T.value=n.map(Se)}catch(a){console.error("Error loading scoring results:",a)}},Ge=async()=>{O.value=!0;try{const a=await Nt.list();j.value=a||[]}catch{D.error("Ошибка загрузки профессиональных областей")}finally{O.value=!1}},He=async()=>{try{const a=await ge.listMetricDefs(!0);q.value=a.items||[]}catch(a){console.error("Error loading metric definitions:",a)}},We=a=>!a||!q.value.length?null:q.value.find(S=>S.code===a)?.name||null,re=async()=>{$.value=!0;try{const a=await Be.getMetrics(l.params.id);H.value=a.metrics||[]}catch(a){console.error("Error loading participant metrics:",a),D.error("Ошибка загрузки метрик участника")}finally{$.value=!1}},Ke=a=>{Q.file=a.raw,P.value=[a]},Qe=async()=>{R.value&&await R.value.validate(async a=>{if(a){if(!Q.file){D.error("Выберите файл");return}M.value=!0;try{await ve.upload(l.params.id,Q.file),D.success("Отчёт загружен успешно"),g.value=!1,Q.file=null,P.value=[],await Y(),await re()}catch{D.error("Ошибка загрузки отчёта")}finally{M.value=!1}}})},Ye=async a=>{try{const n=await ve.download(a),S=window.URL.createObjectURL(new Blob([n.data])),I=document.createElement("a");I.href=S,I.setAttribute("download",`report_${a}.docx`),document.body.appendChild(I),I.click(),I.remove(),window.URL.revokeObjectURL(S),D.success("Отчёт скачан")}catch{D.error("Ошибка скачивания отчёта")}},Ze=async a=>{try{await ve.extract(a),D.success("Извлечение метрик запущено"),await Y()}catch{D.error("Ошибка запуска извлечения метрик")}},et=()=>{J.value||(J.value=setInterval(async()=>{try{await Y(),await re()}catch(a){console.error("Auto-refresh error:",a)}},3e3))},De=()=>{J.value&&(clearInterval(J.value),J.value=null)},tt=()=>{F.value||(F.value=setInterval(async()=>{try{await $e()}catch(a){console.error("Recommendations auto-refresh error:",a)}},15e3))},Ae=()=>{F.value&&(clearInterval(F.value),F.value=null)};fe(u,a=>{a?et():De()}),fe(o,a=>{a?tt():Ae()});const Me=async a=>{K.value=a,await xt(),i.value=!0},at=async()=>{D.success("Метрики обновлены"),await re()},nt=async a=>{try{await ve.delete(a),D.success("Отчёт удалён"),await Y()}catch{D.error("Ошибка удаления отчёта")}},st=async()=>{if(!X.activityCode){D.warning("Выберите профессиональную область");return}C.value=!0;try{const a=await ye.calculate(l.params.id,X.activityCode),n=Se({id:a.scoring_result_id,participant_id:l.params.id,prof_activity_code:a.prof_activity_code||X.activityCode,prof_activity_name:a.prof_activity_name,score_pct:parseFloat(a.score_pct),strengths:a.strengths||[],dev_areas:a.dev_areas||[],recommendations:a.recommendations||[],recommendations_status:a.recommendations_status||((a.recommendations||[]).length>0?"ready":"pending"),recommendations_error:a.recommendations_error||null,created_at:new Date().toISOString()});T.value.unshift(n),D.success("Расчёт пригодности выполнен"),m.value=!1,X.activityCode=""}catch(a){console.error("Scoring calculation error:",a);const n=a.response?.data?.detail||"Ошибка расчёта пригодности";D.error(n)}finally{C.value=!1}},ot=async a=>{if(!a.prof_activity_code){D.warning("Код профессиональной деятельности не найден");return}try{const n=await ye.getFinalReport(l.params.id,a.prof_activity_code,"json"),S=JSON.stringify(n,null,2),I=new Blob([S],{type:"application/json"}),z=window.URL.createObjectURL(I);window.open(z,"_blank"),window.URL.revokeObjectURL(z),D.success("Отчёт JSON открыт в новой вкладке")}catch(n){console.error("Error viewing final report JSON:",n);const S=n.response?.data?.detail||"Ошибка загрузки финального отчёта";D.error(S)}},lt=async a=>{if(!a.prof_activity_code){D.warning("Код профессиональной деятельности не найден");return}try{const n=await ye.getFinalReport(l.params.id,a.prof_activity_code,"html"),S=new Blob([n],{type:"text/html"}),I=window.URL.createObjectURL(S),z=document.createElement("a");z.href=I,z.setAttribute("download",`final_report_${a.prof_activity_code}_${new Date().toISOString().split("T")[0]}.html`),document.body.appendChild(z),z.click(),z.remove(),window.URL.revokeObjectURL(I),D.success("Отчёт HTML скачан")}catch(n){console.error("Error downloading final report HTML:",n);const S=n.response?.data?.detail||"Ошибка загрузки финального отчёта";D.error(S)}},rt=a=>a?.recommendations_status==="ready"&&Array.isArray(a?.recommendations)&&a.recommendations.length>0,it=a=>a?.recommendations_error?`Ошибка генерации: ${a.recommendations_error}`:"Не удалось получить рекомендации";return Ee(async()=>{await c(),await Y(),await $e(),await Ge(),await He(),await re()}),Je(()=>{De(),Ae()}),(a,n)=>{const S=v("el-button"),I=v("el-icon"),z=v("el-descriptions-item"),ut=v("el-descriptions"),ie=v("el-card"),ue=v("el-table-column"),ke=v("el-tag"),dt=v("el-table"),_e=v("el-empty"),ct=v("el-progress"),de=v("el-alert"),pt=v("el-timeline-item"),mt=v("el-timeline"),ft=v("el-upload"),xe=v("el-form-item"),Le=v("el-form"),he=v("el-dialog"),_t=v("el-option"),vt=v("el-select"),Ce=Xe("loading");return s(),_(Lt,null,{default:e(()=>[me((s(),h("div",ca,[N.value?(s(),_(ie,{key:0,class:"detail-card"},{header:e(()=>[p("div",pa,[p("h2",null,y(N.value.full_name),1),p("div",ma,[t(S,{onClick:n[0]||(n[0]=d=>k(b).back())},{default:e(()=>[...n[10]||(n[10]=[f(" Назад ",-1)])]),_:1}),t(S,{type:"primary",onClick:n[1]||(n[1]=d=>m.value=!0)},{default:e(()=>[t(I,null,{default:e(()=>[t(k(St))]),_:1}),n[11]||(n[11]=f(" Рассчитать пригодность ",-1))]),_:1})])])]),default:e(()=>[t(ut,{column:2,border:""},{default:e(()=>[t(z,{label:"ФИО"},{default:e(()=>[f(y(N.value.full_name),1)]),_:1}),t(z,{label:"Дата рождения"},{default:e(()=>[f(y(N.value.birth_date||"Не указана"),1)]),_:1}),t(z,{label:"Внешний ID"},{default:e(()=>[f(y(N.value.external_id||"Не указан"),1)]),_:1}),t(z,{label:"Дата создания"},{default:e(()=>[f(y(ae(N.value.created_at)),1)]),_:1})]),_:1})]),_:1})):A("",!0),t(ie,{class:"section-card"},{header:e(()=>[p("div",fa,[n[13]||(n[13]=p("h3",null,"Отчёты",-1)),t(S,{type:"primary",onClick:n[2]||(n[2]=d=>g.value=!0)},{default:e(()=>[t(I,null,{default:e(()=>[t(k($t))]),_:1}),n[12]||(n[12]=f(" Загрузить отчёт ",-1))]),_:1})])]),default:e(()=>[t(ua,{reports:B.value,loading:L.value,onView:Me,onEdit:Me,onExtract:Ze,onDownload:Ye,onDelete:nt,onUpload:n[3]||(n[3]=d=>g.value=!0)},null,8,["reports","loading"])]),_:1}),t(ie,{class:"section-card"},{header:e(()=>[p("div",_a,[n[15]||(n[15]=p("h3",null,"Актуальные метрики участника",-1)),t(S,{type:"primary",size:"small",onClick:re},{default:e(()=>[t(I,null,{default:e(()=>[t(k(At))]),_:1}),n[14]||(n[14]=f(" Обновить ",-1))]),_:1})])]),default:e(()=>[me((s(),_(dt,{data:H.value,stripe:""},{default:e(()=>[t(ue,{prop:"metric_code",label:"Метрика",width:"300"},{default:e(({row:d})=>[f(y(k(da)({code:d.metric_code,name:We(d.metric_code)})),1)]),_:1}),t(ue,{prop:"value",label:"Значение",width:"120"},{default:e(({row:d})=>[t(ke,{type:"success"},{default:e(()=>[f(y(k(pe)(d.value)),1)]),_:2},1024)]),_:1}),t(ue,{prop:"confidence",label:"Уверенность",width:"150"},{default:e(({row:d})=>[d.confidence!==null?(s(),h("span",{key:0,style:Dt({color:x(d.confidence)})},y((d.confidence*100).toFixed(0))+"% ",5)):(s(),h("span",va,"—"))]),_:1}),t(ue,{prop:"updated_at",label:"Обновлено",width:"180"},{default:e(({row:d})=>[f(y(ae(d.updated_at)),1)]),_:1}),t(ue,{prop:"last_source_report_id",label:"Источник"},{default:e(({row:d})=>[d.last_source_report_id?(s(),_(ke,{key:0,size:"small"},{default:e(()=>[...n[16]||(n[16]=[f(" Из отчёта ",-1)])]),_:1})):(s(),h("span",ya,"—"))]),_:1})]),_:1},8,["data"])),[[Ce,$.value]]),!H.value.length&&!$.value?(s(),_(_e,{key:0,description:"Метрики ещё не извлечены. Загрузите и обработайте отчёты."})):A("",!0)]),_:1}),T.value.length>0?(s(),_(ie,{key:1,class:"section-card"},{header:e(()=>[...n[17]||(n[17]=[p("h3",null,"История оценок пригодности",-1)])]),default:e(()=>[t(mt,null,{default:e(()=>[(s(!0),h(W,null,Z(T.value,d=>(s(),_(pt,{key:d.id,timestamp:ae(d.created_at),placement:"top"},{default:e(()=>[t(ie,null,{default:e(()=>[p("h4",null,y(d.prof_activity_name),1),p("div",ga,[p("div",wa,[p("span",ba,y(d.score_pct)+"%",1),t(ct,{percentage:d.score_pct,status:oe(d.score_pct)},null,8,["percentage","status"])]),p("div",ka,[p("div",ha,[n[19]||(n[19]=p("h5",null,"Сильные стороны:",-1)),d.strengths&&d.strengths.length?(s(),h("ul",Ca,[(s(!0),h(W,null,Z(d.strengths,(V,ce)=>(s(),h("li",{key:ce},[p("strong",null,y(V.metric_name),1),n[18]||(n[18]=f()),p("span",Ra,"("+y(V.metric_code)+")",1),f(" — "+y(k(pe)(V.value))+" (вес "+y(k(pe)(V.weight,2))+") ",1)]))),128))])):(s(),_(_e,{key:1,description:"Нет данных","image-size":60}))]),p("div",Ea,[n[21]||(n[21]=p("h5",null,"Зоны развития:",-1)),d.dev_areas&&d.dev_areas.length?(s(),h("ul",Sa,[(s(!0),h(W,null,Z(d.dev_areas,(V,ce)=>(s(),h("li",{key:ce},[p("strong",null,y(V.metric_name),1),n[20]||(n[20]=f()),p("span",$a,"("+y(V.metric_code)+")",1),f(" — "+y(k(pe)(V.value))+" (вес "+y(k(pe)(V.weight,2))+") ",1)]))),128))])):(s(),_(_e,{key:1,description:"Нет данных","image-size":60}))]),p("div",Da,[p("h5",null,[n[22]||(n[22]=f(" Рекомендации: ",-1)),d.recommendations_status?(s(),_(ke,{key:0,type:ne(d.recommendations_status),size:"small",class:"recommendation-status-tag"},{default:e(()=>[f(y(le(d.recommendations_status)),1)]),_:2},1032,["type"])):A("",!0)]),rt(d)?(s(),h("ul",Aa,[(s(!0),h(W,null,Z(d.recommendations,(V,ce)=>(s(),h("li",{key:ce,class:"recommendation-item"},[p("strong",null,y(V.title),1),V.skill_focus?(s(),h("div",Ma,[n[23]||(n[23]=p("strong",null,"Навык:",-1)),f(" "+y(V.skill_focus),1)])):A("",!0),V.development_advice?(s(),h("div",xa,y(V.development_advice),1)):A("",!0),V.recommended_formats&&V.recommended_formats.length>0?(s(),h("div",La,[n[24]||(n[24]=p("strong",null,"Рекомендуемые форматы:",-1)),p("ul",Na,[(s(!0),h(W,null,Z(V.recommended_formats,(yt,gt)=>(s(),h("li",{key:gt},y(yt),1))),128))])])):A("",!0)]))),128))])):d.recommendations_status==="pending"?(s(),_(de,{key:1,title:"Рекомендации формируются. Обновите страницу через пару минут.",type:"info",closable:!1,"show-icon":""})):d.recommendations_status==="error"?(s(),_(de,{key:2,title:it(d),type:"error",closable:!1,"show-icon":""},null,8,["title"])):d.recommendations_status==="disabled"?(s(),_(de,{key:3,title:"Генерация рекомендаций отключена для данного окружения.",type:"warning",closable:!1,"show-icon":""})):(s(),_(_e,{key:4,description:"Нет данных","image-size":60}))])]),d.prof_activity_code?(s(),h("div",Va,[t(S,{type:"info",size:"small",onClick:V=>ot(d)},{default:e(()=>[t(I,null,{default:e(()=>[t(k(Mt))]),_:1}),n[25]||(n[25]=f(" Просмотреть JSON ",-1))]),_:1},8,["onClick"]),t(S,{type:"primary",size:"small",onClick:V=>lt(d)},{default:e(()=>[t(I,null,{default:e(()=>[t(k(Re))]),_:1}),n[26]||(n[26]=f(" Скачать HTML ",-1))]),_:1},8,["onClick"])])):A("",!0)])]),_:2},1024)]),_:2},1032,["timestamp"]))),128))]),_:1})]),_:1})):A("",!0),t(he,{modelValue:g.value,"onUpdate:modelValue":n[5]||(n[5]=d=>g.value=d),title:"Загрузить отчёт",width:"500px"},{footer:e(()=>[t(S,{onClick:n[4]||(n[4]=d=>g.value=!1)},{default:e(()=>[...n[29]||(n[29]=[f(" Отмена ",-1)])]),_:1}),t(S,{type:"primary",loading:M.value,onClick:Qe},{default:e(()=>[...n[30]||(n[30]=[f(" Загрузить ",-1)])]),_:1},8,["loading"])]),default:e(()=>[t(Le,{ref_key:"uploadFormRef",ref:R,model:Q,rules:te,"label-position":"top"},{default:e(()=>[t(xe,{label:"Файл (DOCX)",prop:"file"},{default:e(()=>[t(ft,{ref:"uploadRef","auto-upload":!1,limit:1,accept:".docx","on-change":Ke,"file-list":P.value},{tip:e(()=>[...n[28]||(n[28]=[p("div",{class:"el-upload__tip"}," Только файлы DOCX, максимум 20 МБ ",-1)])]),default:e(()=>[t(S,{type:"primary"},{default:e(()=>[...n[27]||(n[27]=[f(" Выбрать файл ",-1)])]),_:1})]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(he,{modelValue:m.value,"onUpdate:modelValue":n[8]||(n[8]=d=>m.value=d),title:"Рассчитать профессиональную пригодность",width:"500px"},{footer:e(()=>[t(S,{onClick:n[7]||(n[7]=d=>m.value=!1)},{default:e(()=>[...n[31]||(n[31]=[f(" Отмена ",-1)])]),_:1}),t(S,{type:"primary",loading:C.value,disabled:!X.activityCode||B.value.length===0,onClick:st},{default:e(()=>[...n[32]||(n[32]=[f(" Рассчитать ",-1)])]),_:1},8,["loading","disabled"])]),default:e(()=>[t(Le,{model:X,"label-position":"top"},{default:e(()=>[t(xe,{label:"Профессиональная область",required:""},{default:e(()=>[me((s(),_(vt,{modelValue:X.activityCode,"onUpdate:modelValue":n[6]||(n[6]=d=>X.activityCode=d),placeholder:"Выберите область",style:{width:"100%"}},{default:e(()=>[(s(!0),h(W,null,Z(j.value,d=>(s(),_(_t,{key:d.code,label:d.name,value:d.code},{default:e(()=>[p("span",null,y(d.name),1),p("span",Ia,y(d.code),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])),[[Ce,O.value]])]),_:1}),t(de,{title:"Убедитесь, что у участника загружены и обработаны отчёты с метриками",type:"info",closable:!1,"show-icon":""}),B.value.length===0?(s(),_(de,{key:0,title:"У участника нет загруженных отчётов",type:"warning",closable:!1,"show-icon":"",style:{"margin-top":"12px"}})):A("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(he,{modelValue:i.value,"onUpdate:modelValue":n[9]||(n[9]=d=>i.value=d),title:"Метрики отчёта",width:"90%",top:"5vh"},{default:e(()=>[K.value?(s(),_(Xt,{key:0,"report-id":K.value,onMetricsUpdated:at},null,8,["report-id"])):A("",!0)]),_:1},8,["modelValue"])])),[[Ce,U.value]])]),_:1})}}},Ba=be(Oa,[["__scopeId","data-v-3886ccfd"]]);export{Ba as default};
