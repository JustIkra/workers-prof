import{G as j,m as v,H as U,z as We,q as D,w as l,E as m,r as p,A as Me,o as r,a as s,d as t,B as Se,f as n,u as y,S as Be,D as qe,c as _,J as N,K as X,C as de,L as c,N as re,T as Y,v as S,U as Z,O as Ee,F as Le}from"./index-D4RVC3ZO.js";import{A as Pe}from"./AppLayout-Dp03s9i3.js";import{p as R,m as Ne}from"./metrics-DKy_Yvg2.js";import{_ as Re}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ue={async upload(k){return(await j.post("/admin/weights/upload",k)).data},async list(k=null){const x=k?{prof_activity_code:k}:{};return(await j.get("/admin/weights",{params:x})).data},async activate(k){return(await j.post(`/admin/weights/${k}/activate`)).data}},Ge={class:"admin-weights-view"},He={class:"header-content"},Ie={class:"header-buttons"},Je={class:"areas-container"},Ke={key:1,class:"areas-grid"},Oe={class:"area-header"},Qe={class:"area-title"},je={key:0,class:"area-description"},Xe={key:0,class:"no-table"},Ye={key:1,class:"table-info"},Ze={class:"table-stats"},et={class:"stat-item"},tt={class:"stat-item"},lt={class:"stat-item"},at={class:"table-actions"},ot={class:"selected-area"},it={class:"area-name"},st={class:"selected-area"},nt={class:"area-name"},dt={class:"weights-editor"},rt={key:0},ut={key:1},ct={key:0},pt={class:"metric-cell"},vt={key:0,style:{"margin-top":"20px"}},mt={__name:"AdminWeightsView",setup(k){const x=v(!1),F=v(!1),B=v(""),ee=v([]),G=v([]),H=v([]),T=v(!1),q=v(!1),C=v(!1),g=v(null),A=v(null),w=v(null),ce=v(null),u=v({prof_activity_code:"",weights:[],metadata:{description:""}}),f=v({code:"",name:"",description:""}),te=U(()=>{const a=G.value.map(d=>{const i=ee.value.find(h=>h.prof_activity_code===d.code);return{...d,weightTable:i||null}});if(!B.value)return a;const e=B.value.toLowerCase();return a.filter(d=>d.name.toLowerCase().includes(e)||d.description&&d.description.toLowerCase().includes(e))}),E=U(()=>{const a=G.value.find(e=>e.code===u.value.prof_activity_code);return a?a.name:""}),pe=U(()=>A.value?`Редактировать весовую таблицу: ${E.value}`:`Создать весовую таблицу: ${E.value}`),V=U(()=>u.value.weights.reduce((a,e)=>a+(parseFloat(e.weight)||0),0)),ve=U(()=>Math.abs(V.value-1)<1e-4&&u.value.weights.length>0),me=U(()=>Math.abs(V.value-1)<1e-4?"success":V.value<1?"warning":"error"),I=async()=>{try{x.value=!0;const a=await ue.list();ee.value=a}catch(a){console.error("Failed to load weight tables:",a),m.error("Ошибка загрузки весовых таблиц")}finally{x.value=!1}},_e=a=>{A.value=null,u.value={prof_activity_code:a.code,weights:[],metadata:{description:""}},T.value=!0},J=async()=>{try{const a=await R.list();G.value=a}catch(a){console.error("Failed to load prof activities:",a),m.error("Ошибка загрузки профессиональных областей")}},fe=async()=>{try{const a=await Ne.listMetricDefs(!0);H.value=a.items||[]}catch(a){console.error("Failed to load metrics:",a),m.error("Ошибка загрузки метрик")}},le=a=>{A.value=a,u.value={prof_activity_code:a.prof_activity_code,weights:a.weights.map(e=>({metric_code:e.metric_code,weight:parseFloat(e.weight)})),metadata:a.metadata||{description:""}},T.value=!0},ge=()=>{u.value.weights.push({metric_code:"",weight:0})},ye=a=>{u.value.weights.splice(a,1)},we=async()=>{try{if(F.value=!0,!u.value.prof_activity_code){m.warning("Выберите профессиональную область");return}if(u.value.weights.length===0){m.warning("Добавьте хотя бы одну компетенцию");return}const a=u.value.weights.map(i=>i.metric_code);if(new Set(a.filter(i=>i)).size!==u.value.weights.length){m.warning("Компетенции должны быть уникальными");return}if(u.value.weights.some(i=>!i.metric_code)){m.warning("Все компетенции должны быть заполнены");return}const d={prof_activity_code:u.value.prof_activity_code,weights:u.value.weights.map(i=>({metric_code:i.metric_code,weight:parseFloat(i.weight)})),metadata:u.value.metadata.description?u.value.metadata:null};await ue.upload(d),m.success(A.value?"Таблица сохранена":"Таблица создана"),T.value=!1,await I()}catch(a){console.error("Failed to save weight table:",a),m.error(a.response?.data?.detail||"Ошибка сохранения таблицы")}finally{F.value=!1}},he=a=>{g.value=a,q.value=!0},be=()=>{w.value=null,f.value={code:"",name:"",description:""},C.value=!0},Ve=a=>{w.value=a,f.value={code:a.code,name:a.name,description:a.description||""},C.value=!0},ke=async()=>{try{if(F.value=!0,!f.value.code||!f.value.name){m.warning("Заполните обязательные поля");return}w.value?(await R.update(w.value.id,{name:f.value.name,description:f.value.description}),m.success("Область обновлена")):(await R.create(f.value),m.success("Область создана")),C.value=!1,await J()}catch(a){console.error("Failed to save prof activity:",a),m.error(a.response?.data?.detail||"Ошибка сохранения области")}finally{F.value=!1}},xe=async()=>{try{await Le.confirm(`Удалить профессиональную область "${w.value.name}"? Это действие нельзя отменить.`,"Предупреждение",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"error"}),await R.delete(w.value.id),m.success("Область удалена"),C.value=!1,await J(),await I()}catch(a){a!=="cancel"&&(console.error("Failed to delete prof activity:",a),m.error(a.response?.data?.detail||"Ошибка удаления области"))}},K=a=>a.weights.reduce((e,d)=>e+parseFloat(d.weight),0),ae=a=>{const e=K(a);return Math.abs(e-1)<1e-4?"success":"danger"},Fe=a=>a.map(e=>{const d=H.value.find(i=>i.code===e.metric_code);return{...e,metric_name:d?.name||e.metric_code,metric_code:e.metric_code}}),oe=a=>new Date(a).toLocaleString("ru-RU");return We(async()=>{await Promise.all([I(),J(),fe()])}),(a,e)=>{const d=p("el-icon"),i=p("el-button"),h=p("el-card"),W=p("el-input"),ie=p("el-empty"),M=p("el-tag"),se=p("el-text"),z=p("el-form-item"),L=p("el-divider"),Ce=p("el-alert"),Te=p("el-option"),Ae=p("el-select"),ze=p("el-input-number"),ne=p("el-form"),O=p("el-dialog"),Q=p("el-descriptions-item"),$e=p("el-descriptions"),P=p("el-table-column"),Ue=p("el-table"),De=Me("loading");return r(),D(Pe,null,{default:l(()=>[s("div",Ge,[t(h,{class:"header-card"},{default:l(()=>[s("div",He,[e[13]||(e[13]=s("div",null,[s("h1",null,"Управление весовыми таблицами"),s("p",null,"Каждая профессиональная область имеет свою уникальную весовую таблицу")],-1)),s("div",Ie,[t(i,{onClick:be,size:"large",type:"primary"},{default:l(()=>[t(d,null,{default:l(()=>[t(y(Be))]),_:1}),e[12]||(e[12]=n(" Новая область ",-1))]),_:1})])])]),_:1}),t(h,{class:"search-card"},{default:l(()=>[t(W,{modelValue:B.value,"onUpdate:modelValue":e[0]||(e[0]=o=>B.value=o),placeholder:"Поиск по названию профессиональной области...","prefix-icon":y(qe),size:"large",clearable:""},null,8,["modelValue","prefix-icon"])]),_:1}),Se((r(),_("div",Je,[te.value.length===0?(r(),D(ie,{key:0,description:"Нет профессиональных областей"})):(r(),_("div",Ke,[(r(!0),_(N,null,X(te.value,o=>(r(),_("div",{key:o.id,class:"area-card-wrapper"},[t(h,{class:"area-card",shadow:"hover"},{header:l(()=>[s("div",Oe,[s("div",Qe,[t(d,{size:24,color:"#409EFF"},{default:l(()=>[t(y(Z))]),_:1}),s("h3",null,c(o.name),1)]),t(i,{size:"small",onClick:$=>Ve(o),circle:""},{default:l(()=>[t(d,null,{default:l(()=>[t(y(Y))]),_:1})]),_:1},8,["onClick"])]),o.description?(r(),_("div",je,c(o.description),1)):S("",!0)]),default:l(()=>[o.weightTable?(r(),_("div",Ye,[s("div",Ze,[s("div",et,[e[15]||(e[15]=s("span",{class:"stat-label"},"Компетенций:",-1)),t(M,{size:"large"},{default:l(()=>[n(c(o.weightTable.weights.length),1)]),_:2},1024)]),s("div",tt,[e[16]||(e[16]=s("span",{class:"stat-label"},"Сумма весов:",-1)),t(M,{type:ae(o.weightTable),size:"large"},{default:l(()=>[n(c(K(o.weightTable).toFixed(4)),1)]),_:2},1032,["type"])]),s("div",lt,[e[17]||(e[17]=s("span",{class:"stat-label"},"Обновлена:",-1)),t(se,{type:"info"},{default:l(()=>[n(c(oe(o.weightTable.created_at)),1)]),_:2},1024)])]),s("div",at,[t(i,{onClick:$=>he(o.weightTable),type:"info"},{default:l(()=>[t(d,null,{default:l(()=>[t(y(re))]),_:1}),e[18]||(e[18]=n(" Просмотр ",-1))]),_:1},8,["onClick"]),t(i,{onClick:$=>le(o.weightTable),type:"primary"},{default:l(()=>[t(d,null,{default:l(()=>[t(y(Y))]),_:1}),e[19]||(e[19]=n(" Редактировать ",-1))]),_:1},8,["onClick"])])])):(r(),_("div",Xe,[t(ie,{description:"Весовая таблица не создана","image-size":80},{default:l(()=>[t(i,{type:"primary",onClick:$=>_e(o)},{default:l(()=>[t(d,null,{default:l(()=>[t(y(de))]),_:1}),e[14]||(e[14]=n(" Создать таблицу ",-1))]),_:1},8,["onClick"])]),_:2},1024)]))]),_:2},1024)]))),128))]))])),[[De,x.value]])]),t(O,{modelValue:T.value,"onUpdate:modelValue":e[3]||(e[3]=o=>T.value=o),title:pe.value,width:"900px","close-on-click-modal":!1,"align-center":""},{footer:l(()=>[t(i,{onClick:e[2]||(e[2]=o=>T.value=!1)},{default:l(()=>[...e[22]||(e[22]=[n("Отмена",-1)])]),_:1}),t(i,{type:"primary",onClick:we,loading:F.value,disabled:!ve.value},{default:l(()=>[n(c(A.value?"Сохранить":"Создать"),1)]),_:1},8,["loading","disabled"])]),default:l(()=>[t(ne,{model:u.value,"label-width":"200px",ref_key:"formRef",ref:ce,"label-position":"top"},{default:l(()=>[A.value?(r(),D(z,{key:1,label:"Профессиональная область"},{default:l(()=>[t(h,{shadow:"never",class:"area-display-card"},{default:l(()=>[s("div",st,[t(d,{size:20,color:"#409EFF"},{default:l(()=>[t(y(Z))]),_:1}),s("span",nt,c(E.value),1)])]),_:1})]),_:1})):(r(),D(z,{key:0,label:"Профессиональная область",required:""},{default:l(()=>[t(h,{shadow:"never",class:"area-display-card"},{default:l(()=>[s("div",ot,[t(d,{size:20,color:"#409EFF"},{default:l(()=>[t(y(Z))]),_:1}),s("span",it,c(E.value),1)])]),_:1})]),_:1})),t(L,{"content-position":"left"},{default:l(()=>[...e[20]||(e[20]=[n("Компетенции и веса",-1)])]),_:1}),s("div",dt,[t(Ce,{type:me.value,title:`Сумма весов: ${V.value.toFixed(4)} (требуется: 1.0000)`,closable:!1,"show-icon":"",style:{"margin-bottom":"16px"}},{default:l(()=>[V.value!==1?(r(),_(N,{key:0},[V.value<1?(r(),_("span",rt," Осталось распределить: "+c((1-V.value).toFixed(4)),1)):(r(),_("span",ut," Превышение: "+c((V.value-1).toFixed(4)),1))],64)):S("",!0)]),_:1},8,["type","title"]),(r(!0),_(N,null,X(u.value.weights,(o,$)=>(r(),_("div",{key:$,class:"weight-row"},[t(Ae,{modelValue:o.metric_code,"onUpdate:modelValue":b=>o.metric_code=b,placeholder:"Выберите метрику",filterable:"",style:{width:"420px"}},{default:l(()=>[(r(!0),_(N,null,X(H.value,b=>(r(),D(Te,{key:b.code,label:`${b.name} (${b.code})`,value:b.code},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue"]),t(ze,{modelValue:o.weight,"onUpdate:modelValue":b=>o.weight=b,min:0,max:1,step:.01,precision:4,placeholder:"Вес",style:{width:"180px"}},null,8,["modelValue","onUpdate:modelValue"]),t(i,{type:"danger",size:"small",icon:y(Ee),circle:"",onClick:b=>ye($)},null,8,["icon","onClick"])]))),128)),t(i,{type:"primary",plain:"",onClick:ge,icon:y(de),style:{"margin-top":"16px"}},{default:l(()=>[...e[21]||(e[21]=[n(" Добавить компетенцию ",-1)])]),_:1},8,["icon"])]),t(L),t(z,{label:"Метаданные (опционально)"},{default:l(()=>[t(W,{modelValue:u.value.metadata.description,"onUpdate:modelValue":e[1]||(e[1]=o=>u.value.metadata.description=o),type:"textarea",rows:3,placeholder:"Описание версии таблицы, примечания и т.д."},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),t(O,{modelValue:q.value,"onUpdate:modelValue":e[6]||(e[6]=o=>q.value=o),title:`Весовая таблица: ${g.value?.prof_activity_name}`,width:"900px","align-center":""},{footer:l(()=>[t(i,{onClick:e[4]||(e[4]=o=>q.value=!1),size:"large"},{default:l(()=>[...e[25]||(e[25]=[n("Закрыть",-1)])]),_:1}),t(i,{type:"primary",onClick:e[5]||(e[5]=o=>le(g.value)),size:"large"},{default:l(()=>[t(d,null,{default:l(()=>[t(y(Y))]),_:1}),e[26]||(e[26]=n(" Редактировать ",-1))]),_:1})]),default:l(()=>[g.value?(r(),_("div",ct,[t(h,{shadow:"never",class:"table-summary-card"},{default:l(()=>[t($e,{column:2,border:""},{default:l(()=>[t(Q,{label:"Профессиональная область",span:2},{default:l(()=>[n(c(g.value.prof_activity_name),1)]),_:1}),t(Q,{label:"Создана"},{default:l(()=>[n(c(oe(g.value.created_at)),1)]),_:1}),t(Q,{label:"Сумма весов"},{default:l(()=>[t(M,{type:ae(g.value),size:"large"},{default:l(()=>[n(c(K(g.value).toFixed(4)),1)]),_:1},8,["type"])]),_:1})]),_:1})]),_:1}),t(L,{"content-position":"left"},{default:l(()=>[t(d,null,{default:l(()=>[t(y(re))]),_:1}),n(" Компетенции ("+c(g.value.weights.length)+") ",1)]),_:1}),t(Ue,{data:Fe(g.value.weights),stripe:"","max-height":"500",size:"large"},{default:l(()=>[t(P,{type:"index",label:"#",width:"60",align:"center"}),t(P,{label:"Метрика","min-width":"250"},{default:l(({row:o})=>[s("div",pt,[s("strong",null,c(o.metric_name),1),e[23]||(e[23]=s("br",null,null,-1)),t(se,{size:"small",type:"info"},{default:l(()=>[n(c(o.metric_code),1)]),_:2},1024)])]),_:1}),t(P,{prop:"weight",label:"Вес",width:"140",align:"center"},{default:l(({row:o})=>[t(M,{size:"large"},{default:l(()=>[n(c(parseFloat(o.weight).toFixed(4)),1)]),_:2},1024)]),_:1}),t(P,{label:"Процент",width:"140",align:"center"},{default:l(({row:o})=>[t(M,{type:"info",size:"large"},{default:l(()=>[n(c((parseFloat(o.weight)*100).toFixed(2))+"% ",1)]),_:2},1024)]),_:1})]),_:1},8,["data"]),g.value.metadata&&g.value.metadata.description?(r(),_("div",vt,[t(L,{"content-position":"left"},{default:l(()=>[...e[24]||(e[24]=[n("Описание",-1)])]),_:1}),t(h,{shadow:"never",class:"metadata-card"},{default:l(()=>[n(c(g.value.metadata.description),1)]),_:1})])):S("",!0)])):S("",!0)]),_:1},8,["modelValue","title"]),t(O,{modelValue:C.value,"onUpdate:modelValue":e[11]||(e[11]=o=>C.value=o),title:w.value?"Редактировать область":"Создать область",width:"600px"},{footer:l(()=>[t(i,{onClick:e[10]||(e[10]=o=>C.value=!1)},{default:l(()=>[...e[27]||(e[27]=[n("Отмена",-1)])]),_:1}),w.value?(r(),D(i,{key:0,type:"danger",onClick:xe},{default:l(()=>[...e[28]||(e[28]=[n(" Удалить ",-1)])]),_:1})):S("",!0),t(i,{type:"primary",onClick:ke,loading:F.value},{default:l(()=>[n(c(w.value?"Сохранить":"Создать"),1)]),_:1},8,["loading"])]),default:l(()=>[t(ne,{model:f.value,"label-width":"120px"},{default:l(()=>[t(z,{label:"Код",required:""},{default:l(()=>[t(W,{modelValue:f.value.code,"onUpdate:modelValue":e[7]||(e[7]=o=>f.value.code=o),disabled:!!w.value,placeholder:"meeting_facilitation"},null,8,["modelValue","disabled"])]),_:1}),t(z,{label:"Название",required:""},{default:l(()=>[t(W,{modelValue:f.value.name,"onUpdate:modelValue":e[8]||(e[8]=o=>f.value.name=o),placeholder:"Проведение совещаний"},null,8,["modelValue"])]),_:1}),t(z,{label:"Описание"},{default:l(()=>[t(W,{modelValue:f.value.description,"onUpdate:modelValue":e[9]||(e[9]=o=>f.value.description=o),type:"textarea",rows:3,placeholder:"Описание профессиональной области"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])]),_:1})}}},wt=Re(mt,[["__scopeId","data-v-8e5ddf1f"]]);export{wt as default};
