import{G as J,m as g,H as Y,I as _e,r as f,c as E,o as s,d as t,v as x,J as nt,w as e,u as w,K as ot,C as rt,L as it,M as b,N as H,z as he,q as v,f as _,O as Q,a as m,E as S,p as Te,e as ze,P as Pe,A as Be,B as ce,Q as ut,R as Me,k as xe,S as Ae,g as Le,T as dt,U as Ve,V as Ne,h as Oe,W as ke,X as Ie,F as ct,n as Ue,t as pt,Y as mt,Z as ft,_ as _t,$ as vt,a0 as yt}from"./index-CwPM0ZK4.js";import{A as gt}from"./AppLayout-BabA3jIa.js";import{_ as ve}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{m as be,p as wt}from"./metrics-BFBy4lYq.js";import{u as bt,p as Fe}from"./participants-Dw2mZHHx.js";const pe={async upload(u,k){const i=new FormData;return i.append("file",k),(await J.post(`/participants/${u}/reports`,i,{headers:{"Content-Type":"multipart/form-data"}})).data},async download(u){return await J.get(`/reports/${u}/download`,{responseType:"blob"})},async getById(u){return(await J.get(`/reports/${u}`)).data},async delete(u){return(await J.delete(`/reports/${u}`)).data},async extract(u){return(await J.post(`/reports/${u}/extract`)).data},async getMetrics(u){return(await J.get(`/reports/${u}/metrics`)).data},async getList(u){return(await J.get(`/participants/${u}/reports`)).data}},me={async calculate(u,k){return(await J.post(`/scoring/participants/${u}/calculate`,null,{params:{activity_code:k}})).data},async getHistory(u,k=10){return(await J.get(`/scoring/participants/${u}/scores`,{params:{limit:k}})).data},async getById(u){return(await J.get(`/scoring-results/${u}`)).data},async generateRecommendations(u){return(await J.post(`/reports/${u}/recommendations`)).data},async getFinalReport(u,k,i="json"){const C={params:{activity_code:k,format:i}};i==="html"&&(C.responseType="text");const I=await J.get(`/participants/${u}/final-report`,C);return I.data}};function fe(u,k=1){if(u==null||u==="")return"";const i=typeof u=="string"?parseFloat(u):u;return isNaN(i)?"":i.toLocaleString("ru-RU",{minimumFractionDigits:k,maximumFractionDigits:k})}function le(u){if(u==null||u==="")return null;const i=String(u).trim().replace(",","."),C=parseFloat(i);return isNaN(C)?null:C}function kt(u){return le(u)}function de(u,k=1){return fe(u,k)}const ht={key:0,class:"error-message"},Ct={__name:"MetricInput",props:{modelValue:{type:[Number,String],default:null},min:{type:Number,default:1},max:{type:Number,default:10},step:{type:Number,default:.1},precision:{type:Number,default:1},placeholder:{type:String,default:"Введите значение"},disabled:{type:Boolean,default:!1},showControls:{type:Boolean,default:!0}},emits:["update:modelValue","change","blur"],setup(u,{emit:k}){const i=u,C=k,I=g(null),L=g(""),O=g(!1),$=g(!1),M=g(""),h=Y(()=>le(L.value)),V=Y(()=>{const o=h.value;return o===null||o<=i.min}),z=Y(()=>{const o=h.value;return o===null||o>=i.max}),T=o=>{if(o==null||o===""){L.value="";return}O.value?L.value=String(o).replace(".",","):L.value=fe(o,i.precision)},B=o=>{if(o==null||o==="")return $.value=!1,M.value="",!0;const l=le(o);return l===null?($.value=!0,M.value="Некорректное число",!1):l<i.min?($.value=!0,M.value=`Значение должно быть не меньше ${fe(i.min,i.precision)}`,!1):l>i.max?($.value=!0,M.value=`Значение должно быть не больше ${fe(i.max,i.precision)}`,!1):($.value=!1,M.value="",!0)},X=o=>{const l=o.replace(/[^\d,.-]/g,"");let y=!1;const p=l.split("").filter(R=>R===","||R==="."?y?!1:(y=!0,!0):!0).join("").replace(".",",");L.value=p;const r=le(p);r!==null?C("update:modelValue",r):(p===""||p==="-")&&C("update:modelValue",null)},j=()=>{O.value=!1;const o=le(L.value);if(B(L.value)){if(o!==null){const l=Math.round(o*Math.pow(10,i.precision))/Math.pow(10,i.precision),y=Math.max(i.min,Math.min(i.max,l));C("update:modelValue",y),T(y),C("change",y)}}else if(o!==null&&(o<i.min||o>i.max)){const l=Math.max(i.min,Math.min(i.max,o));C("update:modelValue",l),T(l),C("change",l),$.value=!1,M.value=""}C("blur")},q=()=>{O.value=!0,h.value!==null&&(L.value=String(h.value).replace(".",","))},Z=()=>{const o=h.value||0,l=Math.min(i.max,o+i.step),y=Math.round(l*Math.pow(10,i.precision))/Math.pow(10,i.precision);C("update:modelValue",y),C("change",y),T(y)},U=()=>{const o=h.value||0,l=Math.max(i.min,o-i.step),y=Math.round(l*Math.pow(10,i.precision))/Math.pow(10,i.precision);C("update:modelValue",y),C("change",y),T(y)};return _e(()=>i.modelValue,o=>{T(o)},{immediate:!0}),T(i.modelValue),(o,l)=>{const y=f("el-button"),p=f("el-button-group"),r=f("el-input");return s(),E(H,null,[t(r,{ref_key:"inputRef",ref:I,modelValue:L.value,"onUpdate:modelValue":l[0]||(l[0]=R=>L.value=R),placeholder:u.placeholder,disabled:u.disabled,class:it({"is-invalid":$.value}),onInput:X,onBlur:j,onFocus:q},nt({_:2},[u.showControls?{name:"append",fn:e(()=>[t(p,null,{default:e(()=>[t(y,{icon:w(ot),disabled:u.disabled||V.value,onClick:U},null,8,["icon","disabled"]),t(y,{icon:w(rt),disabled:u.disabled||z.value,onClick:Z},null,8,["icon","disabled"])]),_:1})]),key:"0"}:void 0]),1032,["modelValue","placeholder","disabled","class"]),$.value?(s(),E("div",ht,b(M.value),1)):x("",!0)],64)}}},Rt=ve(Ct,[["__scopeId","data-v-74ef628d"]]),Et={class:"card-header"},$t={key:1},St={key:0,class:"metric-description"},Dt={key:2,class:"metrics-info"},Mt={class:"info-row"},xt={key:0,class:"info-row"},At={__name:"MetricsEditor",props:{reportId:{type:String,required:!0}},emits:["metrics-updated"],setup(u,{emit:k}){const i=u,C=k,I=g(!1),L=g(!1),O=g(!1),$=g(null),M=g([]),h=g([]),V=g({metrics:{}}),z=g({}),T=Y(()=>!h.value||h.value.length===0?[]:[...new Set(h.value.map(p=>p.source))]),B=Y(()=>!h.value||h.value.length===0?null:new Date),X=async()=>{try{const p=await be.listMetricDefs(!0);M.value=p.items||[]}catch(p){console.error("Failed to load metric definitions:",p),$.value="Не удалось загрузить определения метрик"}},j=async()=>{I.value=!0,$.value=null;try{const p=await be.listExtractedMetrics(i.reportId);h.value=p.items||[],V.value.metrics={},h.value.forEach(r=>{V.value.metrics[r.metric_def_id]=le(r.value)}),z.value=JSON.parse(JSON.stringify(V.value.metrics))}catch(p){console.error("Failed to load metrics:",p),$.value="Не удалось загрузить метрики"}finally{I.value=!1}},q=()=>{O.value=!0,z.value=JSON.parse(JSON.stringify(V.value.metrics))},Z=()=>{V.value.metrics=JSON.parse(JSON.stringify(z.value)),O.value=!1,$.value=null},U=async()=>{L.value=!0,$.value=null;try{const p=[];for(const[r,R]of Object.entries(V.value.metrics))if(R!=null&&R!==""){const N=kt(R);N!==null&&p.push({metric_def_id:r,value:N,source:"MANUAL",notes:null})}if(p.length===0){S.warning("Не введено ни одного значения метрики"),L.value=!1;return}await be.bulkCreateExtractedMetrics(i.reportId,p),S.success(`Успешно сохранено ${p.length} метрик`),O.value=!1,await j(),C("metrics-updated")}catch(p){console.error("Failed to save metrics:",p);let r="Не удалось сохранить метрики";p.response?.data?.detail&&(typeof p.response.data.detail=="string"?r=p.response.data.detail:Array.isArray(p.response.data.detail)&&(r=p.response.data.detail.map(R=>R.msg||R.message).join(", "))),$.value=r,S.error(r)}finally{L.value=!1}},o=p=>{switch(p){case"OCR":return"info";case"LLM":return"warning";case"MANUAL":return"success";default:return""}},l=p=>{switch(p){case"OCR":return"OCR";case"LLM":return"Gemini Vision";case"MANUAL":return"Ручной ввод";default:return p}},y=p=>new Date(p).toLocaleString("ru-RU",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});return he(async()=>{await X(),await j()}),_e(()=>i.reportId,async p=>{p&&await j()}),(p,r)=>{const R=f("el-button"),N=f("el-alert"),ee=f("el-form-item"),W=f("el-col"),se=f("el-row"),ne=f("el-form"),K=f("el-divider"),oe=f("el-tag"),te=f("el-card");return s(),v(te,{class:"metrics-editor"},{header:e(()=>[m("div",Et,[r[4]||(r[4]=m("span",null,"Ручной ввод метрик",-1)),O.value?(s(),E("div",$t,[t(R,{size:"small",onClick:Z},{default:e(()=>[...r[2]||(r[2]=[_(" Отмена ",-1)])]),_:1}),t(R,{type:"primary",size:"small",loading:L.value,onClick:U},{default:e(()=>[...r[3]||(r[3]=[_(" Сохранить ",-1)])]),_:1},8,["loading"])])):(s(),v(R,{key:0,type:"primary",size:"small",onClick:q},{default:e(()=>[...r[1]||(r[1]=[_(" Редактировать ",-1)])]),_:1}))])]),default:e(()=>[$.value?(s(),v(N,{key:0,type:"error",title:$.value,closable:"",style:{"margin-bottom":"16px"},onClose:r[0]||(r[0]=D=>$.value=null)},null,8,["title"])):x("",!0),!h.value||h.value.length===0?(s(),v(N,{key:1,type:"info",closable:!1,style:{"margin-bottom":"16px"}},{default:e(()=>[...r[5]||(r[5]=[_(" Метрики для этого отчёта ещё не извлечены. Вы можете ввести их вручную. ",-1)])]),_:1})):x("",!0),t(ne,{ref:"formRef",model:V.value,"label-position":"top",disabled:!O.value},{default:e(()=>[t(se,{gutter:20},{default:e(()=>[(s(!0),E(H,null,Q(M.value,D=>(s(),v(W,{key:D.id,xs:24,sm:12,md:8,lg:6},{default:e(()=>[t(ee,{label:`${D.name} ${D.unit?"("+D.unit+")":""}`,prop:`metrics.${D.id}`},{default:e(()=>[t(Rt,{modelValue:V.value.metrics[D.id],"onUpdate:modelValue":d=>V.value.metrics[D.id]=d,min:D.min_value||1,max:D.max_value||10,precision:1,step:.1,disabled:!O.value,"show-controls":!0,placeholder:"Введите значение (например: 7,5)"},null,8,["modelValue","onUpdate:modelValue","min","max","disabled"]),D.description?(s(),E("div",St,b(D.description),1)):x("",!0)]),_:2},1032,["label","prop"])]),_:2},1024))),128))]),_:1})]),_:1},8,["model","disabled"]),h.value&&h.value.length>0?(s(),E("div",Dt,[t(K),m("div",Mt,[r[6]||(r[6]=m("span",{class:"info-label"},"Источник данных:",-1)),(s(!0),E(H,null,Q(T.value,D=>(s(),v(oe,{key:D,type:o(D),size:"small",style:{"margin-left":"8px"}},{default:e(()=>[_(b(l(D)),1)]),_:2},1032,["type"]))),128))]),B.value?(s(),E("div",xt,[r[7]||(r[7]=m("span",{class:"info-label"},"Последнее обновление:",-1)),m("span",null,b(y(B.value)),1)])):x("",!0)])):x("",!0)]),_:1})}}},Lt=ve(At,[["__scopeId","data-v-bb0e5e9d"]]),Vt={class:"report-list"},Nt={class:"report-list__controls"},Ot={class:"controls-left"},It={class:"controls-right"},Ut={class:"filename"},Ft={class:"status-cell"},Tt={key:1,class:"report-list__cards"},zt={class:"report-card__header"},Pt={class:"report-card__status"},Bt={class:"report-card__body"},jt={class:"report-card__field"},qt={class:"field-value"},Jt={class:"report-card__field"},Xt={class:"field-value"},Gt={class:"report-card__actions"},Ht={__name:"ReportList",props:{reports:{type:Array,required:!0,default:()=>[]},loading:{type:Boolean,default:!1}},emits:["view","edit","extract","download","delete","upload"],setup(u,{emit:k}){const i=u,C=k,I=Te(),L=ze(),O=g(window.innerWidth<=768),$=()=>{O.value=window.innerWidth<=768};he(()=>{window.addEventListener("resize",$),I.query.status&&(M.value=I.query.status),I.query.sort&&(h.value=I.query.sort)}),Pe(()=>{window.removeEventListener("resize",$)});const M=g(""),h=g("desc"),V=[{label:"Загружен",value:"UPLOADED"},{label:"Извлечение метрик...",value:"PROCESSING"},{label:"Метрики извлечены",value:"EXTRACTED"},{label:"Ошибка",value:"FAILED"}];_e([M,h],([o,l])=>{const y={...I.query};o?y.status=o:delete y.status,l?y.sort=l:delete y.sort,L.replace({query:y})});const z=()=>{},T=()=>{h.value=h.value==="desc"?"asc":"desc"},B=Y(()=>{let o=[...i.reports];return M.value&&(o=o.filter(l=>l.status===M.value)),o.sort((l,y)=>{const p=new Date(l.uploaded_at),r=new Date(y.uploaded_at);return h.value==="desc"?r-p:p-r}),o}),X=Y(()=>M.value?"Нет отчётов с выбранным статусом":"Нет загруженных отчётов"),j=o=>{if(!o)return"—";const l=new Date(o);return Number.isNaN(l.getTime())?"—":l.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},q=o=>({UPLOADED:"Загружен",PROCESSING:"Извлечение метрик...",EXTRACTED:"Метрики извлечены",FAILED:"Ошибка"})[o]||o,Z=o=>({UPLOADED:"info",PROCESSING:"warning",EXTRACTED:"success",FAILED:"danger"})[o]||"info",U=async({action:o,report:l})=>{switch(o){case"view":C("view",l.id);break;case"edit":C("edit",l.id);break;case"extract":C("extract",l.id);break;case"download":C("download",l.id);break;case"delete":try{await ct.confirm("Вы уверены, что хотите удалить этот отчёт?","Подтверждение удаления",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}),C("delete",l.id)}catch{}break}};return(o,l)=>{const y=f("el-option"),p=f("el-select"),r=f("el-icon"),R=f("el-button"),N=f("el-table-column"),ee=f("el-tag"),W=f("el-dropdown-item"),se=f("el-dropdown-menu"),ne=f("el-dropdown"),K=f("el-table"),oe=f("el-card"),te=f("el-empty"),D=Be("loading");return s(),E("div",Vt,[m("div",Nt,[m("div",Ot,[t(p,{modelValue:M.value,"onUpdate:modelValue":l[0]||(l[0]=d=>M.value=d),placeholder:"Все статусы",clearable:"",style:{width:"200px"},onChange:z},{default:e(()=>[t(y,{label:"Все статусы",value:""}),(s(),E(H,null,Q(V,d=>t(y,{key:d.value,label:d.label,value:d.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),m("div",It,[t(R,{type:h.value==="desc"?"primary":"default",size:"small",onClick:T},{default:e(()=>[t(r,null,{default:e(()=>[t(w(ut))]),_:1}),_(" "+b(h.value==="desc"?"Новые сверху":"Старые сверху"),1)]),_:1},8,["type"])])]),O.value?ce((s(),E("div",Tt,[(s(!0),E(H,null,Q(B.value,d=>(s(),v(oe,{key:d.id,class:"report-card",shadow:"hover"},{header:e(()=>[m("div",zt,[m("div",Pt,[d.status==="PROCESSING"?(s(),v(r,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(w(Me))]),_:1})):d.status==="EXTRACTED"?(s(),v(r,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(w(xe))]),_:1})):d.status==="FAILED"?(s(),v(r,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(w(Ae))]),_:1})):(s(),v(r,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(w(Le))]),_:1})),t(ee,{type:Z(d.status),size:"small"},{default:e(()=>[_(b(q(d.status)),1)]),_:2},1032,["type"])])])]),footer:e(()=>[m("div",Gt,[d.status==="EXTRACTED"?(s(),v(R,{key:0,type:"success",size:"small",onClick:ae=>U({action:"edit",report:d})},{default:e(()=>[t(r,null,{default:e(()=>[t(w(Ve))]),_:1}),l[10]||(l[10]=_(" Редактировать ",-1))]),_:1},8,["onClick"])):x("",!0),d.status==="PROCESSING"||d.status==="EXTRACTED"?(s(),v(R,{key:1,type:"info",size:"small",onClick:ae=>U({action:"view",report:d})},{default:e(()=>[t(r,null,{default:e(()=>[t(w(Ne))]),_:1}),l[11]||(l[11]=_(" Просмотр ",-1))]),_:1},8,["onClick"])):x("",!0),d.status==="UPLOADED"||d.status==="FAILED"?(s(),v(R,{key:2,type:"primary",size:"small",loading:d.status==="PROCESSING",onClick:ae=>U({action:"extract",report:d})},{default:e(()=>[t(r,null,{default:e(()=>[t(w(Oe))]),_:1}),_(" "+b(d.status==="FAILED"?"Повторить":"Извлечь"),1)]),_:2},1032,["loading","onClick"])):x("",!0),t(R,{size:"small",onClick:ae=>U({action:"download",report:d})},{default:e(()=>[t(r,null,{default:e(()=>[t(w(ke))]),_:1}),l[12]||(l[12]=_(" Скачать ",-1))]),_:1},8,["onClick"]),t(R,{type:"danger",size:"small",onClick:ae=>U({action:"delete",report:d})},{default:e(()=>[t(r,null,{default:e(()=>[t(w(Ie))]),_:1})]),_:1},8,["onClick"])])]),default:e(()=>[m("div",Bt,[m("div",jt,[l[8]||(l[8]=m("span",{class:"field-label"},"Файл:",-1)),m("span",qt,b(d.file_ref?.filename||"Без названия"),1)]),m("div",Jt,[l[9]||(l[9]=m("span",{class:"field-label"},"Дата загрузки:",-1)),m("span",Xt,b(j(d.uploaded_at)),1)])])]),_:2},1024))),128)),!B.value.length&&!u.loading?(s(),v(te,{key:0,description:X.value,"image-size":120},{default:e(()=>[M.value?x("",!0):(s(),v(R,{key:0,type:"primary",onClick:l[1]||(l[1]=d=>o.$emit("upload"))},{default:e(()=>[...l[13]||(l[13]=[_(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):x("",!0)])),[[D,u.loading]]):ce((s(),v(K,{key:0,data:B.value,class:"report-list__table",stripe:"","empty-text":X.value},{default:e(()=>[t(N,{prop:"file_ref.filename",label:"Название файла","min-width":"200"},{default:e(({row:d})=>[m("span",Ut,b(d.file_ref?.filename||"Без названия"),1)]),_:1}),t(N,{prop:"status",label:"Статус",width:"200"},{default:e(({row:d})=>[m("div",Ft,[d.status==="PROCESSING"?(s(),v(r,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(w(Me))]),_:1})):d.status==="EXTRACTED"?(s(),v(r,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(w(xe))]),_:1})):d.status==="FAILED"?(s(),v(r,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(w(Ae))]),_:1})):(s(),v(r,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(w(Le))]),_:1})),t(ee,{type:Z(d.status),size:"default"},{default:e(()=>[_(b(q(d.status)),1)]),_:2},1032,["type"])])]),_:1}),t(N,{prop:"uploaded_at",label:"Дата загрузки",width:"180",sortable:""},{default:e(({row:d})=>[_(b(j(d.uploaded_at)),1)]),_:1}),t(N,{label:"Действия",width:"200",fixed:"right",align:"right"},{default:e(({row:d})=>[t(ne,{trigger:"click",onCommand:U},{dropdown:e(()=>[t(se,null,{default:e(()=>[d.status==="EXTRACTED"?(s(),v(W,{key:0,command:{action:"edit",report:d}},{default:e(()=>[t(r,null,{default:e(()=>[t(w(Ve))]),_:1}),l[4]||(l[4]=_(" Редактировать метрики ",-1))]),_:1},8,["command"])):x("",!0),d.status==="PROCESSING"||d.status==="EXTRACTED"?(s(),v(W,{key:1,command:{action:"view",report:d}},{default:e(()=>[t(r,null,{default:e(()=>[t(w(Ne))]),_:1}),l[5]||(l[5]=_(" Просмотр метрик ",-1))]),_:1},8,["command"])):x("",!0),d.status==="UPLOADED"||d.status==="FAILED"?(s(),v(W,{key:2,command:{action:"extract",report:d}},{default:e(()=>[t(r,null,{default:e(()=>[t(w(Oe))]),_:1}),_(" "+b(d.status==="FAILED"?"Повторить извлечение":"Извлечь метрики"),1)]),_:2},1032,["command"])):x("",!0),t(W,{divided:"",command:{action:"download",report:d}},{default:e(()=>[t(r,null,{default:e(()=>[t(w(ke))]),_:1}),l[6]||(l[6]=_(" Скачать ",-1))]),_:1},8,["command"]),t(W,{command:{action:"delete",report:d},class:"dropdown-item--danger"},{default:e(()=>[t(r,null,{default:e(()=>[t(w(Ie))]),_:1}),l[7]||(l[7]=_(" Удалить ",-1))]),_:1},8,["command"])]),_:2},1024)]),default:e(()=>[t(R,{type:"primary",size:"small"},{default:e(()=>[l[3]||(l[3]=_(" Действия ",-1)),t(r,{class:"el-icon--right"},{default:e(()=>[t(w(dt))]),_:1})]),_:1})]),_:2},1024)]),_:1})]),_:1},8,["data","empty-text"])),[[D,u.loading]]),!B.value.length&&!u.loading&&!O.value?(s(),v(te,{key:2,description:X.value,"image-size":120},{default:e(()=>[M.value?x("",!0):(s(),v(R,{key:0,type:"primary",onClick:l[2]||(l[2]=d=>o.$emit("upload"))},{default:e(()=>[...l[14]||(l[14]=[_(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):x("",!0)])}}},Wt=ve(Ht,[["__scopeId","data-v-2d471c96"]]),Kt={class:"participant-detail"},Qt={class:"card-header"},Yt={class:"header-actions"},Zt={class:"section-header"},ea={class:"section-header"},ta={key:1},aa={key:1},la={class:"scoring-result"},sa={class:"score-value"},na={class:"score-number"},oa={class:"score-details"},ra={class:"score-section"},ia={key:0},ua={class:"score-section"},da={key:0},ca={key:0,class:"score-section"},pa={key:0,class:"final-report-actions"},ma={style:{float:"right",color:"#8492a6","font-size":"13px"}},fa={__name:"ParticipantDetailView",setup(u){const k=ze(),i=Te(),C=bt(),I=g(!1),L=g(!1),O=g(!1),$=g(!1),M=g(!1),h=g(!1),V=Y(()=>C.currentParticipant),z=g([]),T=g([]),B=g([]),X=g([]);g([]);const j=g(null),q=g(null),Z=Y(()=>z.value.some(n=>n.status==="PROCESSING")),U=g(!1),o=g(!1),l=g(!1),y=g(null),p=g([]),r=Ue({file:null}),R={file:[{required:!0,message:"Выберите файл",trigger:"change"}]},N=Ue({activityCode:""}),ee=n=>{if(!n)return"—";const a=new Date(n);return Number.isNaN(a.getTime())?"—":a.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},W=n=>n>=80?"success":n>=60?"":"warning",se=n=>n>=.8?"#67C23A":n>=.6?"#E6A23C":"#F56C6C",ne=async()=>{I.value=!0;try{await C.getParticipant(i.params.id)}catch{S.error("Участник не найден"),k.push("/participants")}finally{I.value=!1}},K=async()=>{L.value=!0;try{const n=await Fe.getReports(i.params.id);z.value=n.items||[]}catch(n){console.error("Error loading reports:",n),S.error("Ошибка загрузки списка отчётов")}finally{L.value=!1}},oe=async()=>{try{const n=await me.getHistory(i.params.id);T.value=n.items||[]}catch(n){console.error("Error loading scoring results:",n)}},te=async()=>{O.value=!0;try{const n=await wt.list();B.value=n||[]}catch{S.error("Ошибка загрузки профессиональных областей")}finally{O.value=!1}},D=async()=>{$.value=!0;try{const n=await Fe.getMetrics(i.params.id);X.value=n.metrics||[]}catch(n){console.error("Error loading participant metrics:",n),S.error("Ошибка загрузки метрик участника")}finally{$.value=!1}},d=n=>{r.file=n.raw,p.value=[n]},ae=async()=>{y.value&&await y.value.validate(async n=>{if(n){if(!r.file){S.error("Выберите файл");return}M.value=!0;try{await pe.upload(i.params.id,r.file),S.success("Отчёт загружен успешно"),U.value=!1,r.file=null,p.value=[],await K(),await D()}catch{S.error("Ошибка загрузки отчёта")}finally{M.value=!1}}})},je=async n=>{try{const a=await pe.download(n),A=window.URL.createObjectURL(new Blob([a.data])),F=document.createElement("a");F.href=A,F.setAttribute("download",`report_${n}.docx`),document.body.appendChild(F),F.click(),F.remove(),window.URL.revokeObjectURL(A),S.success("Отчёт скачан")}catch{S.error("Ошибка скачивания отчёта")}},qe=async n=>{try{await pe.extract(n),S.success("Извлечение метрик запущено"),await K()}catch{S.error("Ошибка запуска извлечения метрик")}},Je=()=>{q.value||(q.value=setInterval(async()=>{try{await K(),await D()}catch(n){console.error("Auto-refresh error:",n)}},3e3))},Ce=()=>{q.value&&(clearInterval(q.value),q.value=null)};_e(Z,n=>{n?Je():Ce()});const Re=async n=>{j.value=n,await yt(),l.value=!0},Xe=async()=>{S.success("Метрики обновлены"),await D()},Ge=async n=>{try{await pe.delete(n),S.success("Отчёт удалён"),await K()}catch{S.error("Ошибка удаления отчёта")}},He=async()=>{if(!N.activityCode){S.warning("Выберите профессиональную область");return}h.value=!0;try{const n=await me.calculate(i.params.id,N.activityCode);T.value.unshift({id:n.scoring_result_id,prof_activity_code:n.prof_activity_code||N.activityCode,prof_activity_name:n.prof_activity_name,score_pct:parseFloat(n.score_pct),strengths:n.strengths||[],dev_areas:n.dev_areas||[],recommendations:n.recommendations||[],created_at:new Date().toISOString()}),S.success("Расчёт пригодности выполнен"),o.value=!1,N.activityCode=""}catch(n){console.error("Scoring calculation error:",n);const a=n.response?.data?.detail||"Ошибка расчёта пригодности";S.error(a)}finally{h.value=!1}},We=async n=>{if(!n.prof_activity_code){S.warning("Код профессиональной деятельности не найден");return}try{const a=await me.getFinalReport(i.params.id,n.prof_activity_code,"json"),A=JSON.stringify(a,null,2),F=new Blob([A],{type:"application/json"}),P=window.URL.createObjectURL(F);window.open(P,"_blank"),window.URL.revokeObjectURL(P),S.success("Отчёт JSON открыт в новой вкладке")}catch(a){console.error("Error viewing final report JSON:",a);const A=a.response?.data?.detail||"Ошибка загрузки финального отчёта";S.error(A)}},Ke=async n=>{if(!n.prof_activity_code){S.warning("Код профессиональной деятельности не найден");return}try{const a=await me.getFinalReport(i.params.id,n.prof_activity_code,"html"),A=new Blob([a],{type:"text/html"}),F=window.URL.createObjectURL(A),P=document.createElement("a");P.href=F,P.setAttribute("download",`final_report_${n.prof_activity_code}_${new Date().toISOString().split("T")[0]}.html`),document.body.appendChild(P),P.click(),P.remove(),window.URL.revokeObjectURL(F),S.success("Отчёт HTML скачан")}catch(a){console.error("Error downloading final report HTML:",a);const A=a.response?.data?.detail||"Ошибка загрузки финального отчёта";S.error(A)}};return he(async()=>{await ne(),await K(),await oe(),await te(),await D()}),Pe(()=>{Ce()}),(n,a)=>{const A=f("el-button"),F=f("el-icon"),P=f("el-descriptions-item"),Qe=f("el-descriptions"),re=f("el-card"),ie=f("el-table-column"),Ee=f("el-tag"),Ye=f("el-table"),ye=f("el-empty"),Ze=f("el-progress"),et=f("el-timeline-item"),tt=f("el-timeline"),at=f("el-upload"),$e=f("el-form-item"),Se=f("el-form"),ge=f("el-dialog"),lt=f("el-option"),st=f("el-select"),De=f("el-alert"),we=Be("loading");return s(),v(gt,null,{default:e(()=>[ce((s(),E("div",Kt,[V.value?(s(),v(re,{key:0,class:"detail-card"},{header:e(()=>[m("div",Qt,[m("h2",null,b(V.value.full_name),1),m("div",Yt,[t(A,{onClick:a[0]||(a[0]=c=>w(k).back())},{default:e(()=>[...a[10]||(a[10]=[_(" Назад ",-1)])]),_:1}),t(A,{type:"primary",onClick:a[1]||(a[1]=c=>o.value=!0)},{default:e(()=>[t(F,null,{default:e(()=>[t(w(pt))]),_:1}),a[11]||(a[11]=_(" Рассчитать пригодность ",-1))]),_:1})])])]),default:e(()=>[t(Qe,{column:2,border:""},{default:e(()=>[t(P,{label:"ФИО"},{default:e(()=>[_(b(V.value.full_name),1)]),_:1}),t(P,{label:"Дата рождения"},{default:e(()=>[_(b(V.value.birth_date||"Не указана"),1)]),_:1}),t(P,{label:"Внешний ID"},{default:e(()=>[_(b(V.value.external_id||"Не указан"),1)]),_:1}),t(P,{label:"Дата создания"},{default:e(()=>[_(b(ee(V.value.created_at)),1)]),_:1})]),_:1})]),_:1})):x("",!0),t(re,{class:"section-card"},{header:e(()=>[m("div",Zt,[a[13]||(a[13]=m("h3",null,"Отчёты",-1)),t(A,{type:"primary",onClick:a[2]||(a[2]=c=>U.value=!0)},{default:e(()=>[t(F,null,{default:e(()=>[t(w(mt))]),_:1}),a[12]||(a[12]=_(" Загрузить отчёт ",-1))]),_:1})])]),default:e(()=>[t(Wt,{reports:z.value,loading:L.value,onView:Re,onEdit:Re,onExtract:qe,onDownload:je,onDelete:Ge,onUpload:a[3]||(a[3]=c=>U.value=!0)},null,8,["reports","loading"])]),_:1}),t(re,{class:"section-card"},{header:e(()=>[m("div",ea,[a[15]||(a[15]=m("h3",null,"Актуальные метрики участника",-1)),t(A,{type:"primary",size:"small",onClick:D},{default:e(()=>[t(F,null,{default:e(()=>[t(w(_t))]),_:1}),a[14]||(a[14]=_(" Обновить ",-1))]),_:1})])]),default:e(()=>[ce((s(),v(Ye,{data:X.value,stripe:""},{default:e(()=>[t(ie,{prop:"metric_code",label:"Код метрики",width:"200"}),t(ie,{prop:"value",label:"Значение",width:"120"},{default:e(({row:c})=>[t(Ee,{type:"success"},{default:e(()=>[_(b(w(de)(c.value)),1)]),_:2},1024)]),_:1}),t(ie,{prop:"confidence",label:"Уверенность",width:"150"},{default:e(({row:c})=>[c.confidence!==null?(s(),E("span",{key:0,style:ft({color:se(c.confidence)})},b((c.confidence*100).toFixed(0))+"% ",5)):(s(),E("span",ta,"—"))]),_:1}),t(ie,{prop:"updated_at",label:"Обновлено",width:"180"},{default:e(({row:c})=>[_(b(ee(c.updated_at)),1)]),_:1}),t(ie,{prop:"last_source_report_id",label:"Источник"},{default:e(({row:c})=>[c.last_source_report_id?(s(),v(Ee,{key:0,size:"small"},{default:e(()=>[...a[16]||(a[16]=[_(" Из отчёта ",-1)])]),_:1})):(s(),E("span",aa,"—"))]),_:1})]),_:1},8,["data"])),[[we,$.value]]),!X.value.length&&!$.value?(s(),v(ye,{key:0,description:"Метрики ещё не извлечены. Загрузите и обработайте отчёты."})):x("",!0)]),_:1}),T.value.length>0?(s(),v(re,{key:1,class:"section-card"},{header:e(()=>[...a[17]||(a[17]=[m("h3",null,"История оценок пригодности",-1)])]),default:e(()=>[t(tt,null,{default:e(()=>[(s(!0),E(H,null,Q(T.value,c=>(s(),v(et,{key:c.id,timestamp:ee(c.created_at),placement:"top"},{default:e(()=>[t(re,null,{default:e(()=>[m("h4",null,b(c.prof_activity_name),1),m("div",la,[m("div",sa,[m("span",na,b(c.score_pct)+"%",1),t(Ze,{percentage:c.score_pct,status:W(c.score_pct)},null,8,["percentage","status"])]),m("div",oa,[m("div",ra,[a[18]||(a[18]=m("h5",null,"Сильные стороны:",-1)),c.strengths&&c.strengths.length?(s(),E("ul",ia,[(s(!0),E(H,null,Q(c.strengths,(G,ue)=>(s(),E("li",{key:ue},[m("strong",null,b(G.metric_name),1),_(" — "+b(w(de)(G.value))+" (вес "+b(w(de)(G.weight,2))+") ",1)]))),128))])):(s(),v(ye,{key:1,description:"Нет данных","image-size":60}))]),m("div",ua,[a[19]||(a[19]=m("h5",null,"Зоны развития:",-1)),c.dev_areas&&c.dev_areas.length?(s(),E("ul",da,[(s(!0),E(H,null,Q(c.dev_areas,(G,ue)=>(s(),E("li",{key:ue},[m("strong",null,b(G.metric_name),1),_(" — "+b(w(de)(G.value))+" (вес "+b(w(de)(G.weight,2))+") ",1)]))),128))])):(s(),v(ye,{key:1,description:"Нет данных","image-size":60}))]),c.recommendations&&c.recommendations.length?(s(),E("div",ca,[a[20]||(a[20]=m("h5",null,"Рекомендации:",-1)),m("ul",null,[(s(!0),E(H,null,Q(c.recommendations,(G,ue)=>(s(),E("li",{key:ue},b(G),1))),128))])])):x("",!0)]),c.prof_activity_code?(s(),E("div",pa,[t(A,{type:"info",size:"small",onClick:G=>We(c)},{default:e(()=>[t(F,null,{default:e(()=>[t(w(vt))]),_:1}),a[21]||(a[21]=_(" Просмотреть JSON ",-1))]),_:1},8,["onClick"]),t(A,{type:"primary",size:"small",onClick:G=>Ke(c)},{default:e(()=>[t(F,null,{default:e(()=>[t(w(ke))]),_:1}),a[22]||(a[22]=_(" Скачать HTML ",-1))]),_:1},8,["onClick"])])):x("",!0)])]),_:2},1024)]),_:2},1032,["timestamp"]))),128))]),_:1})]),_:1})):x("",!0),t(ge,{modelValue:U.value,"onUpdate:modelValue":a[5]||(a[5]=c=>U.value=c),title:"Загрузить отчёт",width:"500px"},{footer:e(()=>[t(A,{onClick:a[4]||(a[4]=c=>U.value=!1)},{default:e(()=>[...a[25]||(a[25]=[_(" Отмена ",-1)])]),_:1}),t(A,{type:"primary",loading:M.value,onClick:ae},{default:e(()=>[...a[26]||(a[26]=[_(" Загрузить ",-1)])]),_:1},8,["loading"])]),default:e(()=>[t(Se,{ref_key:"uploadFormRef",ref:y,model:r,rules:R,"label-position":"top"},{default:e(()=>[t($e,{label:"Файл (DOCX)",prop:"file"},{default:e(()=>[t(at,{ref:"uploadRef","auto-upload":!1,limit:1,accept:".docx","on-change":d,"file-list":p.value},{tip:e(()=>[...a[24]||(a[24]=[m("div",{class:"el-upload__tip"}," Только файлы DOCX, максимум 20 МБ ",-1)])]),default:e(()=>[t(A,{type:"primary"},{default:e(()=>[...a[23]||(a[23]=[_(" Выбрать файл ",-1)])]),_:1})]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(ge,{modelValue:o.value,"onUpdate:modelValue":a[8]||(a[8]=c=>o.value=c),title:"Рассчитать профессиональную пригодность",width:"500px"},{footer:e(()=>[t(A,{onClick:a[7]||(a[7]=c=>o.value=!1)},{default:e(()=>[...a[27]||(a[27]=[_(" Отмена ",-1)])]),_:1}),t(A,{type:"primary",loading:h.value,disabled:!N.activityCode||z.value.length===0,onClick:He},{default:e(()=>[...a[28]||(a[28]=[_(" Рассчитать ",-1)])]),_:1},8,["loading","disabled"])]),default:e(()=>[t(Se,{model:N,"label-position":"top"},{default:e(()=>[t($e,{label:"Профессиональная область",required:""},{default:e(()=>[ce((s(),v(st,{modelValue:N.activityCode,"onUpdate:modelValue":a[6]||(a[6]=c=>N.activityCode=c),placeholder:"Выберите область",style:{width:"100%"}},{default:e(()=>[(s(!0),E(H,null,Q(B.value,c=>(s(),v(lt,{key:c.code,label:c.name,value:c.code},{default:e(()=>[m("span",null,b(c.name),1),m("span",ma,b(c.code),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])),[[we,O.value]])]),_:1}),t(De,{title:"Убедитесь, что у участника загружены и обработаны отчёты с метриками",type:"info",closable:!1,"show-icon":""}),z.value.length===0?(s(),v(De,{key:0,title:"У участника нет загруженных отчётов",type:"warning",closable:!1,"show-icon":"",style:{"margin-top":"12px"}})):x("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(ge,{modelValue:l.value,"onUpdate:modelValue":a[9]||(a[9]=c=>l.value=c),title:"Метрики отчёта",width:"90%",top:"5vh"},{default:e(()=>[j.value?(s(),v(Lt,{key:0,"report-id":j.value,onMetricsUpdated:Xe},null,8,["report-id"])):x("",!0)]),_:1},8,["modelValue"])])),[[we,I.value]])]),_:1})}}},ba=ve(fa,[["__scopeId","data-v-1aefbb75"]]);export{ba as default};
