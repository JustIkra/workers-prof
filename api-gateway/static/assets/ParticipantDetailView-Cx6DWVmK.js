import{G as y,m as _,H as Ve,n as ue,z as xe,q as k,w as a,p as Pe,E as c,e as Oe,r as i,A as Ue,o as u,B as ee,c as g,v as V,d as t,f as r,I as p,a as n,u as D,t as Le,J as Fe,h as Be,K as Me,L as Se,M as ze,N as x,O as P,F as Ie}from"./index-B1Cqir3n.js";import{A as Xe}from"./AppLayout-Bl2VZUNY.js";import{u as Ne}from"./participants-y9wrR4OW.js";import{_ as je}from"./_plugin-vue_export-helper-DlAUqK2U.js";const O={async upload(s,d,v){const w=new FormData;return w.append("report_type",d),w.append("file",v),(await y.post(`/participants/${s}/reports`,w,{headers:{"Content-Type":"multipart/form-data"}})).data},async download(s){return await y.get(`/reports/${s}/download`,{responseType:"blob"})},async getById(s){return(await y.get(`/reports/${s}`)).data},async delete(s){return(await y.delete(`/reports/${s}`)).data},async extract(s){return(await y.post(`/reports/${s}/extract`)).data},async getMetrics(s){return(await y.get(`/reports/${s}/metrics`)).data}},qe={async list(){return(await y.get("/prof-activities")).data}},de={async calculate(s,d){return(await y.post(`/participants/${s}/score`,null,{params:{activity:d}})).data},async getHistory(s){return(await y.get(`/participants/${s}/scores`)).data},async getById(s){return(await y.get(`/scoring-results/${s}`)).data},async generateRecommendations(s){return(await y.post(`/reports/${s}/recommendations`)).data},async getFinalReport(s,d="json"){const v={params:{format:d}};d==="pdf"&&(v.responseType="blob");const w=await y.get(`/participants/${s}/final-report`,v);return d==="pdf"?w:w.data}},He={class:"participant-detail"},Ge={class:"card-header"},Je={class:"header-actions"},Ke={class:"section-header"},Qe={class:"scoring-result"},We={class:"score-value"},Ye={class:"score-number"},Ze={class:"score-details"},et={class:"score-section"},tt={class:"score-section"},at={key:0,class:"score-section"},lt={style:{float:"right",color:"#8492a6","font-size":"13px"}},ot={__name:"ParticipantDetailView",setup(s){const d=Oe(),v=Pe(),w=Ne(),U=_(!1),L=_(!1),z=_(!1),I=_(!1),X=_(!1),E=Ve(()=>w.currentParticipant),N=_([]),j=_([]),te=_([]),q=_([]),T=_(!1),A=_(!1),H=_(!1),G=_(null),J=_([]),b=ue({report_type:"",file:null}),ce={report_type:[{required:!0,message:"Выберите тип отчёта",trigger:"change"}],file:[{required:!0,message:"Выберите файл",trigger:"change"}]},h=ue({activityCode:""}),K=o=>o?new Date(o).toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"",ae=o=>({REPORT_1:"Отчёт 1",REPORT_2:"Отчёт 2",REPORT_3:"Отчёт 3"})[o]||o,pe=o=>({UPLOADED:"Загружен",EXTRACTED:"Обработан",FAILED:"Ошибка"})[o]||o,fe=o=>({UPLOADED:"info",EXTRACTED:"success",FAILED:"danger"})[o]||"info",_e=o=>o>=80?"success":o>=60?"":"warning",me=o=>o>=.8?"#67C23A":o>=.6?"#E6A23C":"#F56C6C",ye=async()=>{U.value=!0;try{await w.getParticipant(v.params.id)}catch{c.error("Участник не найден"),d.push("/participants")}finally{U.value=!1}},F=async()=>{L.value=!0;try{N.value=[],c.info("Функция загрузки списка отчётов будет доступна после реализации соответствующего API")}catch(o){console.error("Error loading reports:",o)}finally{L.value=!1}},le=async()=>{try{const o=await de.getHistory(v.params.id);j.value=o.results||[]}catch(o){console.error("Error loading scoring results:",o)}},ve=async()=>{z.value=!0;try{const o=await qe.list();te.value=o.activities||[]}catch{c.error("Ошибка загрузки профессиональных областей")}finally{z.value=!1}},ge=o=>{b.file=o.raw,J.value=[o]},we=async()=>{G.value&&await G.value.validate(async o=>{if(o){if(!b.file){c.error("Выберите файл");return}I.value=!0;try{await O.upload(v.params.id,b.report_type,b.file),c.success("Отчёт загружен успешно"),T.value=!1,b.report_type="",b.file=null,J.value=[],await F()}catch{c.error("Ошибка загрузки отчёта")}finally{I.value=!1}}})},be=async o=>{try{const e=await O.download(o),f=window.URL.createObjectURL(new Blob([e.data])),m=document.createElement("a");m.href=f,m.setAttribute("download",`report_${o}.docx`),document.body.appendChild(m),m.click(),m.remove(),window.URL.revokeObjectURL(f),c.success("Отчёт скачан")}catch{c.error("Ошибка скачивания отчёта")}},Ce=async o=>{try{await O.extract(o),c.success("Извлечение метрик запущено"),setTimeout(()=>F(),2e3)}catch{c.error("Ошибка запуска извлечения метрик")}},Re=async o=>{try{const e=await O.getMetrics(o);q.value=e.metrics||[],H.value=!0}catch{c.error("Ошибка загрузки метрик")}},ke=o=>{Ie.confirm(`Вы уверены, что хотите удалить отчёт "${ae(o.report_type)}"?`,"Подтверждение удаления",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}).then(async()=>{try{await O.delete(o.id),c.success("Отчёт удалён"),await F()}catch{c.error("Ошибка удаления отчёта")}}).catch(()=>{})},he=async()=>{if(!h.activityCode){c.warning("Выберите профессиональную область");return}X.value=!0;try{await de.calculate(v.params.id,h.activityCode),c.success("Расчёт пригодности выполнен"),A.value=!1,h.activityCode="",await le()}catch{c.error("Ошибка расчёта пригодности")}finally{X.value=!1}};return xe(async()=>{await ye(),await F(),await le(),await ve()}),(o,e)=>{const f=i("el-button"),m=i("el-icon"),B=i("el-descriptions-item"),De=i("el-descriptions"),M=i("el-card"),Q=i("el-tag"),C=i("el-table-column"),oe=i("el-table"),se=i("el-empty"),ne=i("el-progress"),Ee=i("el-timeline-item"),Te=i("el-timeline"),S=i("el-option"),re=i("el-select"),W=i("el-form-item"),Ae=i("el-upload"),ie=i("el-form"),Y=i("el-dialog"),$e=i("el-alert"),Z=Ue("loading");return u(),k(Xe,null,{default:a(()=>[ee((u(),g("div",He,[E.value?(u(),k(M,{key:0,class:"detail-card"},{header:a(()=>[n("div",Ge,[n("h2",null,p(E.value.full_name),1),n("div",Je,[t(f,{onClick:e[0]||(e[0]=l=>D(d).back())},{default:a(()=>[...e[10]||(e[10]=[r("Назад",-1)])]),_:1}),t(f,{type:"primary",onClick:e[1]||(e[1]=l=>A.value=!0)},{default:a(()=>[t(m,null,{default:a(()=>[t(D(Le))]),_:1}),e[11]||(e[11]=r(" Рассчитать пригодность ",-1))]),_:1})])])]),default:a(()=>[t(De,{column:2,border:""},{default:a(()=>[t(B,{label:"ФИО"},{default:a(()=>[r(p(E.value.full_name),1)]),_:1}),t(B,{label:"Дата рождения"},{default:a(()=>[r(p(E.value.birth_date||"Не указана"),1)]),_:1}),t(B,{label:"Внешний ID"},{default:a(()=>[r(p(E.value.external_id||"Не указан"),1)]),_:1}),t(B,{label:"Дата создания"},{default:a(()=>[r(p(K(E.value.created_at)),1)]),_:1})]),_:1})]),_:1})):V("",!0),t(M,{class:"section-card"},{header:a(()=>[n("div",Ke,[e[13]||(e[13]=n("h3",null,"Отчёты",-1)),t(f,{type:"primary",onClick:e[2]||(e[2]=l=>T.value=!0)},{default:a(()=>[t(m,null,{default:a(()=>[t(D(ze))]),_:1}),e[12]||(e[12]=r(" Загрузить отчёт ",-1))]),_:1})])]),default:a(()=>[ee((u(),k(oe,{data:N.value,stripe:""},{default:a(()=>[t(C,{prop:"report_type",label:"Тип",width:"120"},{default:a(({row:l})=>[t(Q,null,{default:a(()=>[r(p(ae(l.report_type)),1)]),_:2},1024)]),_:1}),t(C,{prop:"status",label:"Статус",width:"150"},{default:a(({row:l})=>[t(Q,{type:fe(l.status)},{default:a(()=>[r(p(pe(l.status)),1)]),_:2},1032,["type"])]),_:1}),t(C,{prop:"created_at",label:"Дата загрузки",width:"180"},{default:a(({row:l})=>[r(p(K(l.created_at)),1)]),_:1}),t(C,{label:"Действия",width:"400",fixed:"right"},{default:a(({row:l})=>[t(f,{size:"small",onClick:R=>be(l.id)},{default:a(()=>[t(m,null,{default:a(()=>[t(D(Fe))]),_:1}),e[14]||(e[14]=r(" Скачать ",-1))]),_:1},8,["onClick"]),t(f,{size:"small",type:"primary",onClick:R=>Ce(l.id),disabled:l.status==="EXTRACTED"},{default:a(()=>[t(m,null,{default:a(()=>[t(D(Be))]),_:1}),e[15]||(e[15]=r(" Извлечь метрики ",-1))]),_:1},8,["onClick","disabled"]),t(f,{size:"small",type:"info",onClick:R=>Re(l.id),disabled:l.status!=="EXTRACTED"},{default:a(()=>[t(m,null,{default:a(()=>[t(D(Me))]),_:1}),e[16]||(e[16]=r(" Просмотр ",-1))]),_:1},8,["onClick","disabled"]),t(f,{size:"small",type:"danger",onClick:R=>ke(l)},{default:a(()=>[t(m,null,{default:a(()=>[t(D(Se))]),_:1}),e[17]||(e[17]=r(" Удалить ",-1))]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[Z,L.value]]),!N.value.length&&!L.value?(u(),k(se,{key:0,description:"Нет загруженных отчётов"})):V("",!0)]),_:1}),j.value.length>0?(u(),k(M,{key:1,class:"section-card"},{header:a(()=>[...e[18]||(e[18]=[n("h3",null,"История оценок пригодности",-1)])]),default:a(()=>[t(Te,null,{default:a(()=>[(u(!0),g(x,null,P(j.value,l=>(u(),k(Ee,{key:l.id,timestamp:K(l.created_at),placement:"top"},{default:a(()=>[t(M,null,{default:a(()=>[n("h4",null,p(l.prof_activity_name),1),n("div",Qe,[n("div",We,[n("span",Ye,p(l.score_pct)+"%",1),t(ne,{percentage:l.score_pct,status:_e(l.score_pct)},null,8,["percentage","status"])]),n("div",Ze,[n("div",et,[e[19]||(e[19]=n("h5",null,"Сильные стороны:",-1)),n("ul",null,[(u(!0),g(x,null,P(l.strengths,(R,$)=>(u(),g("li",{key:$},p(R),1))),128))])]),n("div",tt,[e[20]||(e[20]=n("h5",null,"Зоны развития:",-1)),n("ul",null,[(u(!0),g(x,null,P(l.dev_areas,(R,$)=>(u(),g("li",{key:$},p(R),1))),128))])]),l.recommendations&&l.recommendations.length?(u(),g("div",at,[e[21]||(e[21]=n("h5",null,"Рекомендации:",-1)),n("ul",null,[(u(!0),g(x,null,P(l.recommendations,(R,$)=>(u(),g("li",{key:$},p(R),1))),128))])])):V("",!0)])])]),_:2},1024)]),_:2},1032,["timestamp"]))),128))]),_:1})]),_:1})):V("",!0),t(Y,{modelValue:T.value,"onUpdate:modelValue":e[5]||(e[5]=l=>T.value=l),title:"Загрузить отчёт",width:"500px"},{footer:a(()=>[t(f,{onClick:e[4]||(e[4]=l=>T.value=!1)},{default:a(()=>[...e[24]||(e[24]=[r("Отмена",-1)])]),_:1}),t(f,{type:"primary",loading:I.value,onClick:we},{default:a(()=>[...e[25]||(e[25]=[r(" Загрузить ",-1)])]),_:1},8,["loading"])]),default:a(()=>[t(ie,{ref_key:"uploadFormRef",ref:G,model:b,rules:ce,"label-position":"top"},{default:a(()=>[t(W,{label:"Тип отчёта",prop:"report_type"},{default:a(()=>[t(re,{modelValue:b.report_type,"onUpdate:modelValue":e[3]||(e[3]=l=>b.report_type=l),placeholder:"Выберите тип",style:{width:"100%"}},{default:a(()=>[t(S,{label:"Отчёт 1",value:"REPORT_1"}),t(S,{label:"Отчёт 2",value:"REPORT_2"}),t(S,{label:"Отчёт 3",value:"REPORT_3"})]),_:1},8,["modelValue"])]),_:1}),t(W,{label:"Файл (DOCX)",prop:"file"},{default:a(()=>[t(Ae,{ref:"uploadRef","auto-upload":!1,limit:1,accept:".docx","on-change":ge,"file-list":J.value},{tip:a(()=>[...e[23]||(e[23]=[n("div",{class:"el-upload__tip"},"Только файлы DOCX, максимум 20 МБ",-1)])]),default:a(()=>[t(f,{type:"primary"},{default:a(()=>[...e[22]||(e[22]=[r("Выбрать файл",-1)])]),_:1})]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(Y,{modelValue:A.value,"onUpdate:modelValue":e[8]||(e[8]=l=>A.value=l),title:"Рассчитать профессиональную пригодность",width:"500px"},{footer:a(()=>[t(f,{onClick:e[7]||(e[7]=l=>A.value=!1)},{default:a(()=>[...e[26]||(e[26]=[r("Отмена",-1)])]),_:1}),t(f,{type:"primary",loading:X.value,onClick:he,disabled:!h.activityCode},{default:a(()=>[...e[27]||(e[27]=[r(" Рассчитать ",-1)])]),_:1},8,["loading","disabled"])]),default:a(()=>[t(ie,{model:h,"label-position":"top"},{default:a(()=>[t(W,{label:"Профессиональная область"},{default:a(()=>[ee((u(),k(re,{modelValue:h.activityCode,"onUpdate:modelValue":e[6]||(e[6]=l=>h.activityCode=l),placeholder:"Выберите область",style:{width:"100%"}},{default:a(()=>[(u(!0),g(x,null,P(te.value,l=>(u(),k(S,{key:l.code,label:l.name,value:l.code},{default:a(()=>[n("span",null,p(l.name),1),n("span",lt,p(l.code),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])),[[Z,z.value]])]),_:1}),t($e,{title:"Убедитесь, что у участника загружены и обработаны отчёты",type:"info",closable:!1,"show-icon":""})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(Y,{modelValue:H.value,"onUpdate:modelValue":e[9]||(e[9]=l=>H.value=l),title:"Извлечённые метрики",width:"700px"},{default:a(()=>[t(oe,{data:q.value,stripe:""},{default:a(()=>[t(C,{prop:"metric_name",label:"Метрика","min-width":"200"}),t(C,{prop:"value",label:"Значение",width:"100"}),t(C,{prop:"unit",label:"Единица",width:"100"}),t(C,{prop:"source",label:"Источник",width:"100"},{default:a(({row:l})=>[t(Q,{type:l.source==="OCR"?"success":"warning",size:"small"},{default:a(()=>[r(p(l.source),1)]),_:2},1032,["type"])]),_:1}),t(C,{prop:"confidence",label:"Уверенность",width:"120"},{default:a(({row:l})=>[t(ne,{percentage:Math.round(l.confidence*100),color:me(l.confidence),"stroke-width":8},null,8,["percentage","color"])]),_:1})]),_:1},8,["data"]),q.value.length?V("",!0):(u(),k(se,{key:0,description:"Метрики не найдены"}))]),_:1},8,["modelValue"])])),[[Z,U.value]])]),_:1})}}},ut=je(ot,[["__scopeId","data-v-7eedf472"]]);export{ut as default};
