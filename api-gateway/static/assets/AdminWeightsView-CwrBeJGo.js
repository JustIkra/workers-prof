import{G as O,m,H as G,z as ge,q as p,w as t,E as f,r as d,A as ye,o as n,a as h,d as l,B as we,f as i,u as B,C as ee,c as _,J as A,K as N,S as he,L as c,v as T,O as be,F as ke}from"./index-6CPMfeHh.js";import{A as Ve}from"./AppLayout-D1uvUNC-.js";import{p as xe,m as Ce}from"./metrics-CaD5Ac4d.js";import{_ as Fe}from"./_plugin-vue_export-helper-DlAUqK2U.js";const H={async upload(b){return(await O.post("/admin/weights/upload",b)).data},async list(b=null){const y=b?{prof_activity_code:b}:{};return(await O.get("/admin/weights",{params:y})).data},async activate(b){return(await O.post(`/admin/weights/${b}/activate`)).data}},$e={class:"admin-weights-view"},Ae={class:"header-content"},Te={class:"weights-editor"},De={key:0},Se={key:1},Ue={key:0},We={key:0,style:{"margin-top":"16px"}},ze={__name:"AdminWeightsView",setup(b){const y=m(!1),D=m(!1),S=m(null),U=m([]),q=m([]),I=m([]),E=m(null),C=m(!1),V=m(!1),u=m(null),te=m(null),s=m({prof_activity_code:"",weights:[],metadata:{description:""}}),w=G(()=>s.value.weights.reduce((o,e)=>o+(parseFloat(e.weight)||0),0)),le=G(()=>Math.abs(w.value-1)<1e-4&&s.value.weights.length>0),ae=G(()=>Math.abs(w.value-1)<1e-4?"success":w.value<1?"warning":"error"),F=async()=>{try{y.value=!0;const o=await H.list(E.value);U.value=o}catch(o){console.error("Failed to load weight tables:",o),f.error("Ошибка загрузки весовых таблиц")}finally{y.value=!1}},oe=async()=>{try{const o=await xe.list();q.value=o}catch(o){console.error("Failed to load prof activities:",o),f.error("Ошибка загрузки профессиональных областей")}},ie=async()=>{try{const o=await Ce.listMetricDefs(!0);I.value=o.items||[]}catch(o){console.error("Failed to load metrics:",o),f.error("Ошибка загрузки метрик")}},ne=()=>{s.value={prof_activity_code:"",weights:[],metadata:{description:""}},C.value=!0},se=()=>{s.value.weights.push({metric_code:"",weight:0})},re=o=>{s.value.weights.splice(o,1)},ue=async()=>{try{if(D.value=!0,!s.value.prof_activity_code){f.warning("Выберите профессиональную область");return}if(s.value.weights.length===0){f.warning("Добавьте хотя бы одну компетенцию");return}const o=s.value.weights.map(r=>r.metric_code);if(new Set(o.filter(r=>r)).size!==s.value.weights.length){f.warning("Компетенции должны быть уникальными");return}if(s.value.weights.some(r=>!r.metric_code)){f.warning("Все компетенции должны быть заполнены");return}const x={prof_activity_code:s.value.prof_activity_code,weights:s.value.weights.map(r=>({metric_code:r.metric_code,weight:parseFloat(r.weight)})),metadata:s.value.metadata.description?s.value.metadata:null};await H.upload(x),f.success("Весовая таблица создана"),C.value=!1,await F()}catch(o){console.error("Failed to create weight table:",o),f.error(o.response?.data?.detail||"Ошибка создания весовой таблицы")}finally{D.value=!1}},de=o=>{u.value=o,V.value=!0},K=async o=>{try{await ke.confirm(`Активировать весовую таблицу версии ${o.version} для "${o.prof_activity_name}"? Текущая активная версия будет деактивирована.`,"Подтверждение",{confirmButtonText:"Активировать",cancelButtonText:"Отмена",type:"warning"}),S.value=o.id,await H.activate(o.id),f.success("Весовая таблица активирована"),await F(),V.value&&(V.value=!1)}catch(e){e!=="cancel"&&(console.error("Failed to activate weight table:",e),f.error(e.response?.data?.detail||"Ошибка активации весовой таблицы"))}finally{S.value=null}},L=o=>o.weights.reduce((e,x)=>e+parseFloat(x.weight),0),j=o=>{const e=L(o);return Math.abs(e-1)<1e-4?"success":"danger"},Q=o=>new Date(o).toLocaleString("ru-RU");return ge(async()=>{await Promise.all([F(),oe(),ie()])}),(o,e)=>{const x=d("el-icon"),r=d("el-button"),P=d("el-card"),R=d("el-option"),J=d("el-select"),W=d("el-form-item"),X=d("el-form"),ce=d("el-empty"),v=d("el-table-column"),k=d("el-tag"),Y=d("el-table"),z=d("el-divider"),pe=d("el-alert"),me=d("el-input-number"),ve=d("el-input"),Z=d("el-dialog"),$=d("el-descriptions-item"),fe=d("el-descriptions"),_e=ye("loading");return n(),p(Ve,null,{default:t(()=>[h("div",$e,[l(P,{class:"header-card"},{default:t(()=>[h("div",Ae,[e[9]||(e[9]=h("div",null,[h("h1",null,"Управление весовыми таблицами"),h("p",null,"Создание и активация весовых таблиц для расчёта профессиональной пригодности")],-1)),l(r,{type:"primary",onClick:ne},{default:t(()=>[l(x,null,{default:t(()=>[l(B(ee))]),_:1}),e[8]||(e[8]=i(" Создать весовую таблицу ",-1))]),_:1})])]),_:1}),l(P,{class:"filters-card"},{default:t(()=>[l(X,{inline:!0},{default:t(()=>[l(W,{label:"Профессиональная область"},{default:t(()=>[l(J,{modelValue:E.value,"onUpdate:modelValue":e[0]||(e[0]=a=>E.value=a),placeholder:"Все области",clearable:"",style:{width:"300px"},onChange:F},{default:t(()=>[(n(!0),_(A,null,N(q.value,a=>(n(),p(R,{key:a.id,label:a.name,value:a.code},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(W,null,{default:t(()=>[l(r,{onClick:F,loading:y.value},{default:t(()=>[l(x,null,{default:t(()=>[l(B(he))]),_:1}),e[10]||(e[10]=i(" Обновить ",-1))]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1}),we((n(),p(P,null,{header:t(()=>[h("span",null,"Весовые таблицы ("+c(U.value.length)+")",1)]),default:t(()=>[U.value.length===0?(n(),p(ce,{key:0,description:"Нет весовых таблиц"})):(n(),p(Y,{key:1,data:U.value,stripe:""},{default:t(()=>[l(v,{prop:"prof_activity_name",label:"Профессиональная область","min-width":"200"}),l(v,{prop:"version",label:"Версия",width:"100",align:"center"}),l(v,{label:"Активна",width:"100",align:"center"},{default:t(({row:a})=>[a.is_active?(n(),p(k,{key:0,type:"success",size:"small"},{default:t(()=>[...e[11]||(e[11]=[i("Активна",-1)])]),_:1})):(n(),p(k,{key:1,type:"info",size:"small"},{default:t(()=>[...e[12]||(e[12]=[i("Неактивна",-1)])]),_:1}))]),_:1}),l(v,{label:"Компетенций",width:"120",align:"center"},{default:t(({row:a})=>[l(k,{size:"small"},{default:t(()=>[i(c(a.weights.length),1)]),_:2},1024)]),_:1}),l(v,{label:"Сумма весов",width:"120",align:"center"},{default:t(({row:a})=>[l(k,{type:j(a),size:"small"},{default:t(()=>[i(c(L(a).toFixed(3)),1)]),_:2},1032,["type"])]),_:1}),l(v,{prop:"created_at",label:"Создана",width:"180"},{default:t(({row:a})=>[i(c(Q(a.created_at)),1)]),_:1}),l(v,{label:"Действия",width:"200",fixed:"right"},{default:t(({row:a})=>[l(r,{size:"small",onClick:M=>de(a)},{default:t(()=>[...e[13]||(e[13]=[i("Просмотр",-1)])]),_:1},8,["onClick"]),a.is_active?T("",!0):(n(),p(r,{key:0,size:"small",type:"primary",onClick:M=>K(a),loading:S.value===a.id},{default:t(()=>[...e[14]||(e[14]=[i(" Активировать ",-1)])]),_:1},8,["onClick","loading"]))]),_:1})]),_:1},8,["data"]))]),_:1})),[[_e,y.value]])]),l(Z,{modelValue:C.value,"onUpdate:modelValue":e[4]||(e[4]=a=>C.value=a),title:"Создать весовую таблицу",width:"800px","close-on-click-modal":!1},{footer:t(()=>[l(r,{onClick:e[3]||(e[3]=a=>C.value=!1)},{default:t(()=>[...e[17]||(e[17]=[i("Отмена",-1)])]),_:1}),l(r,{type:"primary",onClick:ue,loading:D.value,disabled:!le.value},{default:t(()=>[...e[18]||(e[18]=[i(" Создать ",-1)])]),_:1},8,["loading","disabled"])]),default:t(()=>[l(X,{model:s.value,"label-width":"180px",ref_key:"formRef",ref:te},{default:t(()=>[l(W,{label:"Профессиональная область",required:""},{default:t(()=>[l(J,{modelValue:s.value.prof_activity_code,"onUpdate:modelValue":e[1]||(e[1]=a=>s.value.prof_activity_code=a),placeholder:"Выберите область",style:{width:"100%"}},{default:t(()=>[(n(!0),_(A,null,N(q.value,a=>(n(),p(R,{key:a.id,label:a.name,value:a.code},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(z,{"content-position":"left"},{default:t(()=>[...e[15]||(e[15]=[i("Компетенции и веса",-1)])]),_:1}),h("div",Te,[l(pe,{type:ae.value,title:`Сумма весов: ${w.value.toFixed(4)} (требуется: 1.0000)`,closable:!1,"show-icon":"",style:{"margin-bottom":"16px"}},{default:t(()=>[w.value!==1?(n(),_(A,{key:0},[w.value<1?(n(),_("span",De," Осталось распределить: "+c((1-w.value).toFixed(4)),1)):(n(),_("span",Se," Превышение: "+c((w.value-1).toFixed(4)),1))],64)):T("",!0)]),_:1},8,["type","title"]),(n(!0),_(A,null,N(s.value.weights,(a,M)=>(n(),_("div",{key:M,class:"weight-row"},[l(J,{modelValue:a.metric_code,"onUpdate:modelValue":g=>a.metric_code=g,placeholder:"Выберите метрику",filterable:"",style:{width:"400px"}},{default:t(()=>[(n(!0),_(A,null,N(I.value,g=>(n(),p(R,{key:g.code,label:`${g.name} (${g.code})`,value:g.code},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue"]),l(me,{modelValue:a.weight,"onUpdate:modelValue":g=>a.weight=g,min:0,max:1,step:.01,precision:4,placeholder:"Вес",style:{width:"200px"}},null,8,["modelValue","onUpdate:modelValue"]),l(r,{type:"danger",size:"small",icon:B(be),circle:"",onClick:g=>re(M)},null,8,["icon","onClick"])]))),128)),l(r,{type:"primary",plain:"",onClick:se,icon:B(ee),style:{"margin-top":"16px"}},{default:t(()=>[...e[16]||(e[16]=[i(" Добавить компетенцию ",-1)])]),_:1},8,["icon"])]),l(z),l(W,{label:"Метаданные (опционально)"},{default:t(()=>[l(ve,{modelValue:s.value.metadata.description,"onUpdate:modelValue":e[2]||(e[2]=a=>s.value.metadata.description=a),type:"textarea",rows:3,placeholder:"Описание версии таблицы, примечания и т.д."},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(Z,{modelValue:V.value,"onUpdate:modelValue":e[7]||(e[7]=a=>V.value=a),title:`Весовая таблица: ${u.value?.prof_activity_name} (v${u.value?.version})`,width:"700px"},{footer:t(()=>[l(r,{onClick:e[5]||(e[5]=a=>V.value=!1)},{default:t(()=>[...e[22]||(e[22]=[i("Закрыть",-1)])]),_:1}),u.value&&!u.value.is_active?(n(),p(r,{key:0,type:"primary",onClick:e[6]||(e[6]=a=>K(u.value)),loading:S.value===u.value.id},{default:t(()=>[...e[23]||(e[23]=[i(" Активировать ",-1)])]),_:1},8,["loading"])):T("",!0)]),default:t(()=>[u.value?(n(),_("div",Ue,[l(fe,{column:2,border:""},{default:t(()=>[l($,{label:"Профессиональная область"},{default:t(()=>[i(c(u.value.prof_activity_name),1)]),_:1}),l($,{label:"Версия"},{default:t(()=>[i(c(u.value.version),1)]),_:1}),l($,{label:"Статус"},{default:t(()=>[u.value.is_active?(n(),p(k,{key:0,type:"success"},{default:t(()=>[...e[19]||(e[19]=[i("Активна",-1)])]),_:1})):(n(),p(k,{key:1,type:"info"},{default:t(()=>[...e[20]||(e[20]=[i("Неактивна",-1)])]),_:1}))]),_:1}),l($,{label:"Создана"},{default:t(()=>[i(c(Q(u.value.created_at)),1)]),_:1}),l($,{label:"Сумма весов",span:2},{default:t(()=>[l(k,{type:j(u.value)},{default:t(()=>[i(c(L(u.value).toFixed(4)),1)]),_:1},8,["type"])]),_:1})]),_:1}),l(z,{"content-position":"left"},{default:t(()=>[i("Компетенции ("+c(u.value.weights.length)+")",1)]),_:1}),l(Y,{data:u.value.weights,stripe:"","max-height":"400"},{default:t(()=>[l(v,{type:"index",label:"#",width:"50"}),l(v,{prop:"metric_code",label:"Код метрики",width:"200"}),l(v,{prop:"weight",label:"Вес",width:"120",align:"right"},{default:t(({row:a})=>[i(c(parseFloat(a.weight).toFixed(4)),1)]),_:1}),l(v,{label:"Процент",align:"right"},{default:t(({row:a})=>[i(c((parseFloat(a.weight)*100).toFixed(2))+"% ",1)]),_:1})]),_:1},8,["data"]),u.value.metadata?(n(),_("div",We,[l(z,{"content-position":"left"},{default:t(()=>[...e[21]||(e[21]=[i("Метаданные",-1)])]),_:1}),h("pre",null,c(JSON.stringify(u.value.metadata,null,2)),1)])):T("",!0)])):T("",!0)]),_:1},8,["modelValue","title"])]),_:1})}}},Ee=Fe(ze,[["__scopeId","data-v-881bfaf9"]]);export{Ee as default};
