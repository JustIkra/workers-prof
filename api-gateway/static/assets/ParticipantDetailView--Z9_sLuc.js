import{G as f,m,H as ve,z as $e,I as Se,r as u,q as C,o as i,w as e,v as V,d as a,c as k,f as p,J as B,K as z,L as w,a as d,E as g,n as be,p as Te,e as Le,A as Pe,B as fe,u as N,t as Fe,M as Ie,h as Ne,N as Be,O as ze,P as Je,F as qe}from"./index-DgoEdr1D.js";import{A as Xe}from"./AppLayout-DzChpU5Q.js";import{_ as Ce}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{u as je}from"./participants-D-Ob5NDy.js";const se={async upload(s,n,_){const R=new FormData;return R.append("report_type",n),R.append("file",_),(await f.post(`/participants/${s}/reports`,R,{headers:{"Content-Type":"multipart/form-data"}})).data},async download(s){return await f.get(`/reports/${s}/download`,{responseType:"blob"})},async getById(s){return(await f.get(`/reports/${s}`)).data},async delete(s){return(await f.delete(`/reports/${s}`)).data},async extract(s){return(await f.post(`/reports/${s}/extract`)).data},async getMetrics(s){return(await f.get(`/reports/${s}/metrics`)).data}},He={async list(){return(await f.get("/prof-activities")).data}},ke={async calculate(s,n){return(await f.post(`/participants/${s}/score`,null,{params:{activity:n}})).data},async getHistory(s){return(await f.get(`/participants/${s}/scores`)).data},async getById(s){return(await f.get(`/scoring-results/${s}`)).data},async generateRecommendations(s){return(await f.post(`/reports/${s}/recommendations`)).data},async getFinalReport(s,n="json"){const _={params:{format:n}};n==="pdf"&&(_.responseType="blob");const R=await f.get(`/participants/${s}/final-report`,_);return n==="pdf"?R:R.data}},_e={async listMetricDefs(s=!1){return(await f.get("/metric-defs",{params:{active_only:s}})).data},async getMetricDef(s){return(await f.get(`/metric-defs/${s}`)).data},async createMetricDef(s){return(await f.post("/metric-defs",s)).data},async updateMetricDef(s,n){return(await f.put(`/metric-defs/${s}`,n)).data},async deleteMetricDef(s){return(await f.delete(`/metric-defs/${s}`)).data},async listExtractedMetrics(s){return(await f.get(`/reports/${s}/metrics`)).data},async createOrUpdateExtractedMetric(s,n){return(await f.post(`/reports/${s}/metrics`,n)).data},async bulkCreateExtractedMetrics(s,n){return(await f.post(`/reports/${s}/metrics/bulk`,{metrics:n})).data},async updateExtractedMetric(s,n,_,R=null){return(await f.put(`/reports/${s}/metrics/${n}`,{value:_,notes:R})).data},async deleteExtractedMetric(s){return(await f.delete(`/extracted-metrics/${s}`)).data}},Ge={class:"card-header"},Ke={key:1},Qe={key:0,class:"metric-description"},We={key:2,class:"metrics-info"},Ye={class:"info-row"},Ze={key:0,class:"info-row"},et={__name:"MetricsEditor",props:{reportId:{type:String,required:!0}},emits:["metrics-updated"],setup(s,{emit:n}){const _=s,R=n,P=m(!1),A=m(!1),D=m(!1),E=m(null),J=m([]),y=m([]),x=m({metrics:{}}),F=m({}),W=ve(()=>!y.value||y.value.length===0?[]:[...new Set(y.value.map(r=>r.source))]),q=ve(()=>!y.value||y.value.length===0?null:new Date),I=async()=>{try{const r=await _e.listMetricDefs(!0);J.value=r.items||[]}catch(r){console.error("Failed to load metric definitions:",r),E.value="Не удалось загрузить определения метрик"}},O=async()=>{P.value=!0,E.value=null;try{const r=await _e.listExtractedMetrics(_.reportId);y.value=r.items||[],x.value.metrics={},y.value.forEach(c=>{x.value.metrics[c.metric_def_id]=parseFloat(c.value)}),F.value=JSON.parse(JSON.stringify(x.value.metrics))}catch(r){console.error("Failed to load metrics:",r),E.value="Не удалось загрузить метрики"}finally{P.value=!1}},j=r=>[{validator:(c,b,S)=>{if(b==null||b===""){S();return}const X=r.min_value||1,T=r.max_value||10;b<X?S(new Error(`Значение должно быть не меньше ${X}`)):b>T?S(new Error(`Значение должно быть не больше ${T}`)):S()},trigger:"change"}],H=()=>{D.value=!0,F.value=JSON.parse(JSON.stringify(x.value.metrics))},G=()=>{x.value.metrics=JSON.parse(JSON.stringify(F.value)),D.value=!1,E.value=null},h=async()=>{A.value=!0,E.value=null;try{const r=[];for(const[c,b]of Object.entries(x.value.metrics))b!=null&&b!==""&&r.push({metric_def_id:c,value:parseFloat(b),source:"MANUAL",notes:null});if(r.length===0){g.warning("Не введено ни одного значения метрики"),A.value=!1;return}await _e.bulkCreateExtractedMetrics(_.reportId,r),g.success("Метрики успешно сохранены"),D.value=!1,await O(),R("metrics-updated")}catch(r){console.error("Failed to save metrics:",r),E.value=r.response?.data?.detail||"Не удалось сохранить метрики"}finally{A.value=!1}},le=r=>{switch(r){case"OCR":return"info";case"LLM":return"warning";case"MANUAL":return"success";default:return""}},U=r=>{switch(r){case"OCR":return"OCR";case"LLM":return"Gemini Vision";case"MANUAL":return"Ручной ввод";default:return r}},K=r=>new Date(r).toLocaleString("ru-RU",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});return $e(async()=>{await I(),await O()}),Se(()=>_.reportId,async r=>{r&&await O()}),(r,c)=>{const b=u("el-button"),S=u("el-alert"),X=u("el-input-number"),T=u("el-form-item"),Y=u("el-col"),oe=u("el-row"),ne=u("el-form"),re=u("el-divider"),ie=u("el-tag"),ue=u("el-card");return i(),C(ue,{class:"metrics-editor"},{header:e(()=>[d("div",Ge,[c[4]||(c[4]=d("span",null,"Ручной ввод метрик",-1)),D.value?(i(),k("div",Ke,[a(b,{size:"small",onClick:G},{default:e(()=>[...c[2]||(c[2]=[p("Отмена",-1)])]),_:1}),a(b,{type:"primary",size:"small",onClick:h,loading:A.value},{default:e(()=>[...c[3]||(c[3]=[p(" Сохранить ",-1)])]),_:1},8,["loading"])])):(i(),C(b,{key:0,type:"primary",size:"small",onClick:H},{default:e(()=>[...c[1]||(c[1]=[p(" Редактировать ",-1)])]),_:1}))])]),default:e(()=>[E.value?(i(),C(S,{key:0,type:"error",title:E.value,closable:"",onClose:c[0]||(c[0]=v=>E.value=null),style:{"margin-bottom":"16px"}},null,8,["title"])):V("",!0),!y.value||y.value.length===0?(i(),C(S,{key:1,type:"info",closable:!1,style:{"margin-bottom":"16px"}},{default:e(()=>[...c[5]||(c[5]=[p(" Метрики для этого отчёта ещё не извлечены. Вы можете ввести их вручную. ",-1)])]),_:1})):V("",!0),a(ne,{ref:"formRef",model:x.value,"label-position":"top",disabled:!D.value},{default:e(()=>[a(oe,{gutter:20},{default:e(()=>[(i(!0),k(B,null,z(J.value,v=>(i(),C(Y,{key:v.id,xs:24,sm:12,md:8,lg:6},{default:e(()=>[a(T,{label:`${v.name} ${v.unit?"("+v.unit+")":""}`,prop:`metrics.${v.id}`,rules:j(v)},{default:e(()=>[a(X,{modelValue:x.value.metrics[v.id],"onUpdate:modelValue":de=>x.value.metrics[v.id]=de,min:v.min_value||1,max:v.max_value||10,precision:1,step:.1,controls:!0,style:{width:"100%"},placeholder:"Введите значение"},null,8,["modelValue","onUpdate:modelValue","min","max"]),v.description?(i(),k("div",Qe,w(v.description),1)):V("",!0)]),_:2},1032,["label","prop","rules"])]),_:2},1024))),128))]),_:1})]),_:1},8,["model","disabled"]),y.value&&y.value.length>0?(i(),k("div",We,[a(re),d("div",Ye,[c[6]||(c[6]=d("span",{class:"info-label"},"Источник данных:",-1)),(i(!0),k(B,null,z(W.value,v=>(i(),C(ie,{key:v,type:le(v),size:"small",style:{"margin-left":"8px"}},{default:e(()=>[p(w(U(v)),1)]),_:2},1032,["type"]))),128))]),q.value?(i(),k("div",Ze,[c[7]||(c[7]=d("span",{class:"info-label"},"Последнее обновление:",-1)),d("span",null,w(K(q.value)),1)])):V("",!0)])):V("",!0)]),_:1})}}},tt=Ce(et,[["__scopeId","data-v-e7c0b257"]]),at={class:"participant-detail"},st={class:"card-header"},lt={class:"header-actions"},ot={class:"section-header"},nt={class:"scoring-result"},rt={class:"score-value"},it={class:"score-number"},ut={class:"score-details"},dt={class:"score-section"},ct={class:"score-section"},pt={key:0,class:"score-section"},mt={style:{float:"right",color:"#8492a6","font-size":"13px"}},ft={__name:"ParticipantDetailView",setup(s){const n=Le(),_=Te(),R=je(),P=m(!1),A=m(!1),D=m(!1),E=m(!1),J=m(!1),y=ve(()=>R.currentParticipant),x=m([]),F=m([]),W=m([]);m([]);const q=m(null),I=m(!1),O=m(!1),j=m(!1),H=m(null),G=m([]),h=be({report_type:"",file:null}),le={report_type:[{required:!0,message:"Выберите тип отчёта",trigger:"change"}],file:[{required:!0,message:"Выберите файл",trigger:"change"}]},U=be({activityCode:""}),K=o=>o?new Date(o).toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"",r=o=>({REPORT_1:"Отчёт 1",REPORT_2:"Отчёт 2",REPORT_3:"Отчёт 3"})[o]||o,c=o=>({UPLOADED:"Загружен",EXTRACTED:"Обработан",FAILED:"Ошибка"})[o]||o,b=o=>({UPLOADED:"info",EXTRACTED:"success",FAILED:"danger"})[o]||"info",S=o=>o>=80?"success":o>=60?"":"warning",X=async()=>{P.value=!0;try{await R.getParticipant(_.params.id)}catch{g.error("Участник не найден"),n.push("/participants")}finally{P.value=!1}},T=async()=>{A.value=!0;try{x.value=[],g.info("Функция загрузки списка отчётов будет доступна после реализации соответствующего API")}catch(o){console.error("Error loading reports:",o)}finally{A.value=!1}},Y=async()=>{try{const o=await ke.getHistory(_.params.id);F.value=o.results||[]}catch(o){console.error("Error loading scoring results:",o)}},oe=async()=>{D.value=!0;try{const o=await He.list();W.value=o.activities||[]}catch{g.error("Ошибка загрузки профессиональных областей")}finally{D.value=!1}},ne=o=>{h.file=o.raw,G.value=[o]},re=async()=>{H.value&&await H.value.validate(async o=>{if(o){if(!h.file){g.error("Выберите файл");return}E.value=!0;try{await se.upload(_.params.id,h.report_type,h.file),g.success("Отчёт загружен успешно"),I.value=!1,h.report_type="",h.file=null,G.value=[],await T()}catch{g.error("Ошибка загрузки отчёта")}finally{E.value=!1}}})},ie=async o=>{try{const t=await se.download(o),$=window.URL.createObjectURL(new Blob([t.data])),M=document.createElement("a");M.href=$,M.setAttribute("download",`report_${o}.docx`),document.body.appendChild(M),M.click(),M.remove(),window.URL.revokeObjectURL($),g.success("Отчёт скачан")}catch{g.error("Ошибка скачивания отчёта")}},ue=async o=>{try{await se.extract(o),g.success("Извлечение метрик запущено"),setTimeout(()=>T(),2e3)}catch{g.error("Ошибка запуска извлечения метрик")}},v=async o=>{q.value=o,j.value=!0},de=()=>{g.success("Метрики обновлены")},Re=o=>{qe.confirm(`Вы уверены, что хотите удалить отчёт "${r(o.report_type)}"?`,"Подтверждение удаления",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}).then(async()=>{try{await se.delete(o.id),g.success("Отчёт удалён"),await T()}catch{g.error("Ошибка удаления отчёта")}}).catch(()=>{})},Ee=async()=>{if(!U.activityCode){g.warning("Выберите профессиональную область");return}J.value=!0;try{await ke.calculate(_.params.id,U.activityCode),g.success("Расчёт пригодности выполнен"),O.value=!1,U.activityCode="",await Y()}catch{g.error("Ошибка расчёта пригодности")}finally{J.value=!1}};return $e(async()=>{await X(),await T(),await Y(),await oe()}),(o,t)=>{const $=u("el-button"),M=u("el-icon"),Z=u("el-descriptions-item"),xe=u("el-descriptions"),ee=u("el-card"),ye=u("el-tag"),te=u("el-table-column"),Me=u("el-table"),he=u("el-empty"),Ve=u("el-progress"),Ae=u("el-timeline-item"),De=u("el-timeline"),ae=u("el-option"),ge=u("el-select"),ce=u("el-form-item"),Oe=u("el-upload"),we=u("el-form"),pe=u("el-dialog"),Ue=u("el-alert"),me=Pe("loading");return i(),C(Xe,null,{default:e(()=>[fe((i(),k("div",at,[y.value?(i(),C(ee,{key:0,class:"detail-card"},{header:e(()=>[d("div",st,[d("h2",null,w(y.value.full_name),1),d("div",lt,[a($,{onClick:t[0]||(t[0]=l=>N(n).back())},{default:e(()=>[...t[10]||(t[10]=[p("Назад",-1)])]),_:1}),a($,{type:"primary",onClick:t[1]||(t[1]=l=>O.value=!0)},{default:e(()=>[a(M,null,{default:e(()=>[a(N(Fe))]),_:1}),t[11]||(t[11]=p(" Рассчитать пригодность ",-1))]),_:1})])])]),default:e(()=>[a(xe,{column:2,border:""},{default:e(()=>[a(Z,{label:"ФИО"},{default:e(()=>[p(w(y.value.full_name),1)]),_:1}),a(Z,{label:"Дата рождения"},{default:e(()=>[p(w(y.value.birth_date||"Не указана"),1)]),_:1}),a(Z,{label:"Внешний ID"},{default:e(()=>[p(w(y.value.external_id||"Не указан"),1)]),_:1}),a(Z,{label:"Дата создания"},{default:e(()=>[p(w(K(y.value.created_at)),1)]),_:1})]),_:1})]),_:1})):V("",!0),a(ee,{class:"section-card"},{header:e(()=>[d("div",ot,[t[13]||(t[13]=d("h3",null,"Отчёты",-1)),a($,{type:"primary",onClick:t[2]||(t[2]=l=>I.value=!0)},{default:e(()=>[a(M,null,{default:e(()=>[a(N(Je))]),_:1}),t[12]||(t[12]=p(" Загрузить отчёт ",-1))]),_:1})])]),default:e(()=>[fe((i(),C(Me,{data:x.value,stripe:""},{default:e(()=>[a(te,{prop:"report_type",label:"Тип",width:"120"},{default:e(({row:l})=>[a(ye,null,{default:e(()=>[p(w(r(l.report_type)),1)]),_:2},1024)]),_:1}),a(te,{prop:"status",label:"Статус",width:"150"},{default:e(({row:l})=>[a(ye,{type:b(l.status)},{default:e(()=>[p(w(c(l.status)),1)]),_:2},1032,["type"])]),_:1}),a(te,{prop:"created_at",label:"Дата загрузки",width:"180"},{default:e(({row:l})=>[p(w(K(l.created_at)),1)]),_:1}),a(te,{label:"Действия",width:"400",fixed:"right"},{default:e(({row:l})=>[a($,{size:"small",onClick:L=>ie(l.id)},{default:e(()=>[a(M,null,{default:e(()=>[a(N(Ie))]),_:1}),t[14]||(t[14]=p(" Скачать ",-1))]),_:1},8,["onClick"]),a($,{size:"small",type:"primary",onClick:L=>ue(l.id),disabled:l.status==="EXTRACTED"},{default:e(()=>[a(M,null,{default:e(()=>[a(N(Ne))]),_:1}),t[15]||(t[15]=p(" Извлечь метрики ",-1))]),_:1},8,["onClick","disabled"]),a($,{size:"small",type:"info",onClick:L=>v(l.id)},{default:e(()=>[a(M,null,{default:e(()=>[a(N(Be))]),_:1}),t[16]||(t[16]=p(" Метрики ",-1))]),_:1},8,["onClick"]),a($,{size:"small",type:"danger",onClick:L=>Re(l)},{default:e(()=>[a(M,null,{default:e(()=>[a(N(ze))]),_:1}),t[17]||(t[17]=p(" Удалить ",-1))]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[me,A.value]]),!x.value.length&&!A.value?(i(),C(he,{key:0,description:"Нет загруженных отчётов"})):V("",!0)]),_:1}),F.value.length>0?(i(),C(ee,{key:1,class:"section-card"},{header:e(()=>[...t[18]||(t[18]=[d("h3",null,"История оценок пригодности",-1)])]),default:e(()=>[a(De,null,{default:e(()=>[(i(!0),k(B,null,z(F.value,l=>(i(),C(Ae,{key:l.id,timestamp:K(l.created_at),placement:"top"},{default:e(()=>[a(ee,null,{default:e(()=>[d("h4",null,w(l.prof_activity_name),1),d("div",nt,[d("div",rt,[d("span",it,w(l.score_pct)+"%",1),a(Ve,{percentage:l.score_pct,status:S(l.score_pct)},null,8,["percentage","status"])]),d("div",ut,[d("div",dt,[t[19]||(t[19]=d("h5",null,"Сильные стороны:",-1)),d("ul",null,[(i(!0),k(B,null,z(l.strengths,(L,Q)=>(i(),k("li",{key:Q},w(L),1))),128))])]),d("div",ct,[t[20]||(t[20]=d("h5",null,"Зоны развития:",-1)),d("ul",null,[(i(!0),k(B,null,z(l.dev_areas,(L,Q)=>(i(),k("li",{key:Q},w(L),1))),128))])]),l.recommendations&&l.recommendations.length?(i(),k("div",pt,[t[21]||(t[21]=d("h5",null,"Рекомендации:",-1)),d("ul",null,[(i(!0),k(B,null,z(l.recommendations,(L,Q)=>(i(),k("li",{key:Q},w(L),1))),128))])])):V("",!0)])])]),_:2},1024)]),_:2},1032,["timestamp"]))),128))]),_:1})]),_:1})):V("",!0),a(pe,{modelValue:I.value,"onUpdate:modelValue":t[5]||(t[5]=l=>I.value=l),title:"Загрузить отчёт",width:"500px"},{footer:e(()=>[a($,{onClick:t[4]||(t[4]=l=>I.value=!1)},{default:e(()=>[...t[24]||(t[24]=[p("Отмена",-1)])]),_:1}),a($,{type:"primary",loading:E.value,onClick:re},{default:e(()=>[...t[25]||(t[25]=[p(" Загрузить ",-1)])]),_:1},8,["loading"])]),default:e(()=>[a(we,{ref_key:"uploadFormRef",ref:H,model:h,rules:le,"label-position":"top"},{default:e(()=>[a(ce,{label:"Тип отчёта",prop:"report_type"},{default:e(()=>[a(ge,{modelValue:h.report_type,"onUpdate:modelValue":t[3]||(t[3]=l=>h.report_type=l),placeholder:"Выберите тип",style:{width:"100%"}},{default:e(()=>[a(ae,{label:"Отчёт 1",value:"REPORT_1"}),a(ae,{label:"Отчёт 2",value:"REPORT_2"}),a(ae,{label:"Отчёт 3",value:"REPORT_3"})]),_:1},8,["modelValue"])]),_:1}),a(ce,{label:"Файл (DOCX)",prop:"file"},{default:e(()=>[a(Oe,{ref:"uploadRef","auto-upload":!1,limit:1,accept:".docx","on-change":ne,"file-list":G.value},{tip:e(()=>[...t[23]||(t[23]=[d("div",{class:"el-upload__tip"},"Только файлы DOCX, максимум 20 МБ",-1)])]),default:e(()=>[a($,{type:"primary"},{default:e(()=>[...t[22]||(t[22]=[p("Выбрать файл",-1)])]),_:1})]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),a(pe,{modelValue:O.value,"onUpdate:modelValue":t[8]||(t[8]=l=>O.value=l),title:"Рассчитать профессиональную пригодность",width:"500px"},{footer:e(()=>[a($,{onClick:t[7]||(t[7]=l=>O.value=!1)},{default:e(()=>[...t[26]||(t[26]=[p("Отмена",-1)])]),_:1}),a($,{type:"primary",loading:J.value,onClick:Ee,disabled:!U.activityCode},{default:e(()=>[...t[27]||(t[27]=[p(" Рассчитать ",-1)])]),_:1},8,["loading","disabled"])]),default:e(()=>[a(we,{model:U,"label-position":"top"},{default:e(()=>[a(ce,{label:"Профессиональная область"},{default:e(()=>[fe((i(),C(ge,{modelValue:U.activityCode,"onUpdate:modelValue":t[6]||(t[6]=l=>U.activityCode=l),placeholder:"Выберите область",style:{width:"100%"}},{default:e(()=>[(i(!0),k(B,null,z(W.value,l=>(i(),C(ae,{key:l.code,label:l.name,value:l.code},{default:e(()=>[d("span",null,w(l.name),1),d("span",mt,w(l.code),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])),[[me,D.value]])]),_:1}),a(Ue,{title:"Убедитесь, что у участника загружены и обработаны отчёты",type:"info",closable:!1,"show-icon":""})]),_:1},8,["model"])]),_:1},8,["modelValue"]),a(pe,{modelValue:j.value,"onUpdate:modelValue":t[9]||(t[9]=l=>j.value=l),title:"Метрики отчёта",width:"90%",top:"5vh"},{default:e(()=>[q.value?(i(),C(tt,{key:0,"report-id":q.value,onMetricsUpdated:de},null,8,["report-id"])):V("",!0)]),_:1},8,["modelValue"])])),[[me,P.value]])]),_:1})}}},wt=Ce(ft,[["__scopeId","data-v-51df5219"]]);export{wt as default};
