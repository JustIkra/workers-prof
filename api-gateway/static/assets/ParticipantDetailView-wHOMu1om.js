import{G as H,m as g,H as Q,I as fe,r as v,c as R,o as l,d as t,v as D,J as ft,w as e,u as b,K as _t,C as vt,L as yt,M as w,N as K,z as Se,q as f,f as _,O as Y,a as m,E as A,p as Be,e as je,P as qe,A as Je,B as me,Q as gt,R as Le,k as Ne,S as Ve,g as Ie,T as wt,U as Oe,V as Ue,h as Te,W as Re,X as Fe,F as bt,n as ze,t as ht,Y as kt,Z as Ct,_ as Rt,$ as St,a0 as Et}from"./index-Dnq68sSa.js";import{A as $t}from"./AppLayout-DoHKlCl6.js";import{_ as we}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{m as Ce,p as At}from"./metrics-BGsJ4-Z5.js";import{u as Dt,p as Pe}from"./participants-SFSR1hDo.js";const ve={async upload(d,h){const i=new FormData;return i.append("file",h),(await H.post(`/participants/${d}/reports`,i,{headers:{"Content-Type":"multipart/form-data"}})).data},async download(d){return await H.get(`/reports/${d}/download`,{responseType:"blob"})},async getById(d){return(await H.get(`/reports/${d}`)).data},async delete(d){return(await H.delete(`/reports/${d}`)).data},async extract(d){return(await H.post(`/reports/${d}/extract`)).data},async getMetrics(d){return(await H.get(`/reports/${d}/metrics`)).data},async getList(d){return(await H.get(`/participants/${d}/reports`)).data}},ye={async calculate(d,h){return(await H.post(`/scoring/participants/${d}/calculate`,null,{params:{activity_code:h}})).data},async getHistory(d,h=10){return(await H.get(`/scoring/participants/${d}/scores`,{params:{limit:h}})).data},async getById(d){return(await H.get(`/scoring-results/${d}`)).data},async generateRecommendations(d){return(await H.post(`/reports/${d}/recommendations`)).data},async getFinalReport(d,h,i="json"){const S={params:{activity_code:h,format:i}};i==="html"&&(S.responseType="text");const O=await H.get(`/participants/${d}/final-report`,S);return O.data}};function ge(d,h=1){if(d==null||d==="")return"";const i=typeof d=="string"?parseFloat(d):d;return isNaN(i)?"":i.toLocaleString("ru-RU",{minimumFractionDigits:h,maximumFractionDigits:h})}function ne(d){if(d==null||d==="")return null;const i=String(d).trim().replace(",","."),S=parseFloat(i);return isNaN(S)?null:S}function Mt(d){return ne(d)}function pe(d,h=1){return ge(d,h)}const xt={key:0,class:"error-message"},Lt={__name:"MetricInput",props:{modelValue:{type:[Number,String],default:null},min:{type:Number,default:1},max:{type:Number,default:10},step:{type:Number,default:.1},precision:{type:Number,default:1},placeholder:{type:String,default:"Введите значение"},disabled:{type:Boolean,default:!1},showControls:{type:Boolean,default:!0}},emits:["update:modelValue","change","blur"],setup(d,{emit:h}){const i=d,S=h,O=g(null),x=g(""),I=g(!1),E=g(!1),M=g(""),k=Q(()=>ne(x.value)),N=Q(()=>{const u=k.value;return u===null||u<=i.min}),B=Q(()=>{const u=k.value;return u===null||u>=i.max}),U=u=>{if(u==null||u===""){x.value="";return}I.value?x.value=String(u).replace(".",","):x.value=ge(u,i.precision)},j=u=>{if(u==null||u==="")return E.value=!1,M.value="",!0;const s=ne(u);return s===null?(E.value=!0,M.value="Некорректное число",!1):s<i.min?(E.value=!0,M.value=`Значение должно быть не меньше ${ge(i.min,i.precision)}`,!1):s>i.max?(E.value=!0,M.value=`Значение должно быть не больше ${ge(i.max,i.precision)}`,!1):(E.value=!1,M.value="",!0)},W=u=>{const s=u.replace(/[^\d,.-]/g,"");let y=!1;const p=s.split("").filter(C=>C===","||C==="."?y?!1:(y=!0,!0):!0).join("").replace(".",",");x.value=p;const o=ne(p);o!==null?S("update:modelValue",o):(p===""||p==="-")&&S("update:modelValue",null)},q=()=>{I.value=!1;const u=ne(x.value);if(j(x.value)){if(u!==null){const s=Math.round(u*Math.pow(10,i.precision))/Math.pow(10,i.precision),y=Math.max(i.min,Math.min(i.max,s));S("update:modelValue",y),U(y),S("change",y)}}else if(u!==null&&(u<i.min||u>i.max)){const s=Math.max(i.min,Math.min(i.max,u));S("update:modelValue",s),U(s),S("change",s),E.value=!1,M.value=""}S("blur")},J=()=>{I.value=!0,k.value!==null&&(x.value=String(k.value).replace(".",","))},X=()=>{const u=k.value||0,s=Math.min(i.max,u+i.step),y=Math.round(s*Math.pow(10,i.precision))/Math.pow(10,i.precision);S("update:modelValue",y),S("change",y),U(y)},G=()=>{const u=k.value||0,s=Math.max(i.min,u-i.step),y=Math.round(s*Math.pow(10,i.precision))/Math.pow(10,i.precision);S("update:modelValue",y),S("change",y),U(y)};return fe(()=>i.modelValue,u=>{U(u)},{immediate:!0}),U(i.modelValue),(u,s)=>{const y=v("el-button"),p=v("el-button-group"),o=v("el-input");return l(),R(K,null,[t(o,{ref_key:"inputRef",ref:O,modelValue:x.value,"onUpdate:modelValue":s[0]||(s[0]=C=>x.value=C),placeholder:d.placeholder,disabled:d.disabled,class:yt({"is-invalid":E.value}),onInput:W,onBlur:q,onFocus:J},ft({_:2},[d.showControls?{name:"append",fn:e(()=>[t(p,null,{default:e(()=>[t(y,{icon:b(_t),disabled:d.disabled||N.value,onClick:G},null,8,["icon","disabled"]),t(y,{icon:b(vt),disabled:d.disabled||B.value,onClick:X},null,8,["icon","disabled"])]),_:1})]),key:"0"}:void 0]),1032,["modelValue","placeholder","disabled","class"]),E.value?(l(),R("div",xt,w(M.value),1)):D("",!0)],64)}}},Nt=we(Lt,[["__scopeId","data-v-74ef628d"]]),Vt={class:"card-header"},It={key:1},Ot={key:0,class:"metric-description"},Ut={key:2,class:"metrics-info"},Tt={class:"info-row"},Ft={key:0,class:"info-row"},zt={__name:"MetricsEditor",props:{reportId:{type:String,required:!0}},emits:["metrics-updated"],setup(d,{emit:h}){const i=d,S=h,O=g(!1),x=g(!1),I=g(!1),E=g(null),M=g([]),k=g([]),N=g({metrics:{}}),B=g({}),U=Q(()=>!k.value||k.value.length===0?[]:[...new Set(k.value.map(p=>p.source))]),j=Q(()=>!k.value||k.value.length===0?null:new Date),W=async()=>{try{const p=await Ce.listMetricDefs(!0);M.value=p.items||[]}catch(p){console.error("Failed to load metric definitions:",p),E.value="Не удалось загрузить определения метрик"}},q=async()=>{O.value=!0,E.value=null;try{const p=await Ce.listExtractedMetrics(i.reportId);k.value=p.items||[],N.value.metrics={},k.value.forEach(o=>{N.value.metrics[o.metric_def_id]=ne(o.value)}),B.value=JSON.parse(JSON.stringify(N.value.metrics))}catch(p){console.error("Failed to load metrics:",p),E.value="Не удалось загрузить метрики"}finally{O.value=!1}},J=()=>{I.value=!0,B.value=JSON.parse(JSON.stringify(N.value.metrics))},X=()=>{N.value.metrics=JSON.parse(JSON.stringify(B.value)),I.value=!1,E.value=null},G=async()=>{x.value=!0,E.value=null;try{const p=[];for(const[o,C]of Object.entries(N.value.metrics))if(C!=null&&C!==""){const T=Mt(C);T!==null&&p.push({metric_def_id:o,value:T,source:"MANUAL",notes:null})}if(p.length===0){A.warning("Не введено ни одного значения метрики"),x.value=!1;return}await Ce.bulkCreateExtractedMetrics(i.reportId,p),A.success(`Успешно сохранено ${p.length} метрик`),I.value=!1,await q(),S("metrics-updated")}catch(p){console.error("Failed to save metrics:",p);let o="Не удалось сохранить метрики";p.response?.data?.detail&&(typeof p.response.data.detail=="string"?o=p.response.data.detail:Array.isArray(p.response.data.detail)&&(o=p.response.data.detail.map(C=>C.msg||C.message).join(", "))),E.value=o,A.error(o)}finally{x.value=!1}},u=p=>{switch(p){case"OCR":return"info";case"LLM":return"warning";case"MANUAL":return"success";default:return""}},s=p=>{switch(p){case"OCR":return"OCR";case"LLM":return"Gemini Vision";case"MANUAL":return"Ручной ввод";default:return p}},y=p=>new Date(p).toLocaleString("ru-RU",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});return Se(async()=>{await W(),await q()}),fe(()=>i.reportId,async p=>{p&&await q()}),(p,o)=>{const C=v("el-button"),T=v("el-alert"),te=v("el-form-item"),F=v("el-col"),Z=v("el-row"),se=v("el-form"),le=v("el-divider"),oe=v("el-tag"),ae=v("el-card");return l(),f(ae,{class:"metrics-editor"},{header:e(()=>[m("div",Vt,[o[4]||(o[4]=m("span",null,"Ручной ввод метрик",-1)),I.value?(l(),R("div",It,[t(C,{size:"small",onClick:X},{default:e(()=>[...o[2]||(o[2]=[_(" Отмена ",-1)])]),_:1}),t(C,{type:"primary",size:"small",loading:x.value,onClick:G},{default:e(()=>[...o[3]||(o[3]=[_(" Сохранить ",-1)])]),_:1},8,["loading"])])):(l(),f(C,{key:0,type:"primary",size:"small",onClick:J},{default:e(()=>[...o[1]||(o[1]=[_(" Редактировать ",-1)])]),_:1}))])]),default:e(()=>[E.value?(l(),f(T,{key:0,type:"error",title:E.value,closable:"",style:{"margin-bottom":"16px"},onClose:o[0]||(o[0]=L=>E.value=null)},null,8,["title"])):D("",!0),!k.value||k.value.length===0?(l(),f(T,{key:1,type:"info",closable:!1,style:{"margin-bottom":"16px"}},{default:e(()=>[...o[5]||(o[5]=[_(" Метрики для этого отчёта ещё не извлечены. Вы можете ввести их вручную. ",-1)])]),_:1})):D("",!0),t(se,{ref:"formRef",model:N.value,"label-position":"top",disabled:!I.value},{default:e(()=>[t(Z,{gutter:20},{default:e(()=>[(l(!0),R(K,null,Y(M.value,L=>(l(),f(F,{key:L.id,xs:24,sm:12,md:8,lg:6},{default:e(()=>[t(te,{label:`${L.name} ${L.unit?"("+L.unit+")":""}`,prop:`metrics.${L.id}`},{default:e(()=>[t(Nt,{modelValue:N.value.metrics[L.id],"onUpdate:modelValue":r=>N.value.metrics[L.id]=r,min:L.min_value||1,max:L.max_value||10,precision:1,step:.1,disabled:!I.value,"show-controls":!0,placeholder:"Введите значение (например: 7,5)"},null,8,["modelValue","onUpdate:modelValue","min","max","disabled"]),L.description?(l(),R("div",Ot,w(L.description),1)):D("",!0)]),_:2},1032,["label","prop"])]),_:2},1024))),128))]),_:1})]),_:1},8,["model","disabled"]),k.value&&k.value.length>0?(l(),R("div",Ut,[t(le),m("div",Tt,[o[6]||(o[6]=m("span",{class:"info-label"},"Источник данных:",-1)),(l(!0),R(K,null,Y(U.value,L=>(l(),f(oe,{key:L,type:u(L),size:"small",style:{"margin-left":"8px"}},{default:e(()=>[_(w(s(L)),1)]),_:2},1032,["type"]))),128))]),j.value?(l(),R("div",Ft,[o[7]||(o[7]=m("span",{class:"info-label"},"Последнее обновление:",-1)),m("span",null,w(y(j.value)),1)])):D("",!0)])):D("",!0)]),_:1})}}},Pt=we(zt,[["__scopeId","data-v-bb0e5e9d"]]),Bt={class:"report-list"},jt={class:"report-list__controls"},qt={class:"controls-left"},Jt={class:"controls-right"},Xt={class:"filename"},Gt={class:"status-cell"},Ht={key:1,class:"report-list__cards"},Wt={class:"report-card__header"},Kt={class:"report-card__status"},Qt={class:"report-card__body"},Yt={class:"report-card__field"},Zt={class:"field-value"},ea={class:"report-card__field"},ta={class:"field-value"},aa={class:"report-card__actions"},na={__name:"ReportList",props:{reports:{type:Array,required:!0,default:()=>[]},loading:{type:Boolean,default:!1}},emits:["view","edit","extract","download","delete","upload"],setup(d,{emit:h}){const i=d,S=h,O=Be(),x=je(),I=g(window.innerWidth<=768),E=()=>{I.value=window.innerWidth<=768};Se(()=>{window.addEventListener("resize",E),O.query.status&&(M.value=O.query.status),O.query.sort&&(k.value=O.query.sort)}),qe(()=>{window.removeEventListener("resize",E)});const M=g(""),k=g("desc"),N=[{label:"Загружен",value:"UPLOADED"},{label:"Извлечение метрик...",value:"PROCESSING"},{label:"Метрики извлечены",value:"EXTRACTED"},{label:"Ошибка",value:"FAILED"}];fe([M,k],([u,s])=>{const y={...O.query};u?y.status=u:delete y.status,s?y.sort=s:delete y.sort,x.replace({query:y})});const B=()=>{},U=()=>{k.value=k.value==="desc"?"asc":"desc"},j=Q(()=>{let u=[...i.reports];return M.value&&(u=u.filter(s=>s.status===M.value)),u.sort((s,y)=>{const p=new Date(s.uploaded_at),o=new Date(y.uploaded_at);return k.value==="desc"?o-p:p-o}),u}),W=Q(()=>M.value?"Нет отчётов с выбранным статусом":"Нет загруженных отчётов"),q=u=>{if(!u)return"—";const s=new Date(u);return Number.isNaN(s.getTime())?"—":s.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},J=u=>({UPLOADED:"Загружен",PROCESSING:"Извлечение метрик...",EXTRACTED:"Метрики извлечены",FAILED:"Ошибка"})[u]||u,X=u=>({UPLOADED:"info",PROCESSING:"warning",EXTRACTED:"success",FAILED:"danger"})[u]||"info",G=async({action:u,report:s})=>{switch(u){case"view":S("view",s.id);break;case"edit":S("edit",s.id);break;case"extract":S("extract",s.id);break;case"download":S("download",s.id);break;case"delete":try{await bt.confirm("Вы уверены, что хотите удалить этот отчёт?","Подтверждение удаления",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}),S("delete",s.id)}catch{}break}};return(u,s)=>{const y=v("el-option"),p=v("el-select"),o=v("el-icon"),C=v("el-button"),T=v("el-table-column"),te=v("el-tag"),F=v("el-dropdown-item"),Z=v("el-dropdown-menu"),se=v("el-dropdown"),le=v("el-table"),oe=v("el-card"),ae=v("el-empty"),L=Je("loading");return l(),R("div",Bt,[m("div",jt,[m("div",qt,[t(p,{modelValue:M.value,"onUpdate:modelValue":s[0]||(s[0]=r=>M.value=r),placeholder:"Все статусы",clearable:"",style:{width:"200px"},onChange:B},{default:e(()=>[t(y,{label:"Все статусы",value:""}),(l(),R(K,null,Y(N,r=>t(y,{key:r.value,label:r.label,value:r.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),m("div",Jt,[t(C,{type:k.value==="desc"?"primary":"default",size:"small",onClick:U},{default:e(()=>[t(o,null,{default:e(()=>[t(b(gt))]),_:1}),_(" "+w(k.value==="desc"?"Новые сверху":"Старые сверху"),1)]),_:1},8,["type"])])]),I.value?me((l(),R("div",Ht,[(l(!0),R(K,null,Y(j.value,r=>(l(),f(oe,{key:r.id,class:"report-card",shadow:"hover"},{header:e(()=>[m("div",Wt,[m("div",Kt,[r.status==="PROCESSING"?(l(),f(o,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(b(Le))]),_:1})):r.status==="EXTRACTED"?(l(),f(o,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(b(Ne))]),_:1})):r.status==="FAILED"?(l(),f(o,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(b(Ve))]),_:1})):(l(),f(o,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(b(Ie))]),_:1})),t(te,{type:X(r.status),size:"small"},{default:e(()=>[_(w(J(r.status)),1)]),_:2},1032,["type"])])])]),footer:e(()=>[m("div",aa,[r.status==="EXTRACTED"?(l(),f(C,{key:0,type:"success",size:"small",onClick:ee=>G({action:"edit",report:r})},{default:e(()=>[t(o,null,{default:e(()=>[t(b(Oe))]),_:1}),s[10]||(s[10]=_(" Редактировать ",-1))]),_:1},8,["onClick"])):D("",!0),r.status==="PROCESSING"||r.status==="EXTRACTED"?(l(),f(C,{key:1,type:"info",size:"small",onClick:ee=>G({action:"view",report:r})},{default:e(()=>[t(o,null,{default:e(()=>[t(b(Ue))]),_:1}),s[11]||(s[11]=_(" Просмотр ",-1))]),_:1},8,["onClick"])):D("",!0),r.status==="UPLOADED"||r.status==="FAILED"?(l(),f(C,{key:2,type:"primary",size:"small",loading:r.status==="PROCESSING",onClick:ee=>G({action:"extract",report:r})},{default:e(()=>[t(o,null,{default:e(()=>[t(b(Te))]),_:1}),_(" "+w(r.status==="FAILED"?"Повторить":"Извлечь"),1)]),_:2},1032,["loading","onClick"])):D("",!0),t(C,{size:"small",onClick:ee=>G({action:"download",report:r})},{default:e(()=>[t(o,null,{default:e(()=>[t(b(Re))]),_:1}),s[12]||(s[12]=_(" Скачать ",-1))]),_:1},8,["onClick"]),t(C,{type:"danger",size:"small",onClick:ee=>G({action:"delete",report:r})},{default:e(()=>[t(o,null,{default:e(()=>[t(b(Fe))]),_:1})]),_:1},8,["onClick"])])]),default:e(()=>[m("div",Qt,[m("div",Yt,[s[8]||(s[8]=m("span",{class:"field-label"},"Файл:",-1)),m("span",Zt,w(r.file_ref?.filename||"Без названия"),1)]),m("div",ea,[s[9]||(s[9]=m("span",{class:"field-label"},"Дата загрузки:",-1)),m("span",ta,w(q(r.uploaded_at)),1)])])]),_:2},1024))),128)),!j.value.length&&!d.loading?(l(),f(ae,{key:0,description:W.value,"image-size":120},{default:e(()=>[M.value?D("",!0):(l(),f(C,{key:0,type:"primary",onClick:s[1]||(s[1]=r=>u.$emit("upload"))},{default:e(()=>[...s[13]||(s[13]=[_(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):D("",!0)])),[[L,d.loading]]):me((l(),f(le,{key:0,data:j.value,class:"report-list__table",stripe:"","empty-text":W.value},{default:e(()=>[t(T,{prop:"file_ref.filename",label:"Название файла","min-width":"200"},{default:e(({row:r})=>[m("span",Xt,w(r.file_ref?.filename||"Без названия"),1)]),_:1}),t(T,{prop:"status",label:"Статус",width:"200"},{default:e(({row:r})=>[m("div",Gt,[r.status==="PROCESSING"?(l(),f(o,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(b(Le))]),_:1})):r.status==="EXTRACTED"?(l(),f(o,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(b(Ne))]),_:1})):r.status==="FAILED"?(l(),f(o,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(b(Ve))]),_:1})):(l(),f(o,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(b(Ie))]),_:1})),t(te,{type:X(r.status),size:"default"},{default:e(()=>[_(w(J(r.status)),1)]),_:2},1032,["type"])])]),_:1}),t(T,{prop:"uploaded_at",label:"Дата загрузки",width:"180",sortable:""},{default:e(({row:r})=>[_(w(q(r.uploaded_at)),1)]),_:1}),t(T,{label:"Действия",width:"200",fixed:"right",align:"right"},{default:e(({row:r})=>[t(se,{trigger:"click",onCommand:G},{dropdown:e(()=>[t(Z,null,{default:e(()=>[r.status==="EXTRACTED"?(l(),f(F,{key:0,command:{action:"edit",report:r}},{default:e(()=>[t(o,null,{default:e(()=>[t(b(Oe))]),_:1}),s[4]||(s[4]=_(" Редактировать метрики ",-1))]),_:1},8,["command"])):D("",!0),r.status==="PROCESSING"||r.status==="EXTRACTED"?(l(),f(F,{key:1,command:{action:"view",report:r}},{default:e(()=>[t(o,null,{default:e(()=>[t(b(Ue))]),_:1}),s[5]||(s[5]=_(" Просмотр метрик ",-1))]),_:1},8,["command"])):D("",!0),r.status==="UPLOADED"||r.status==="FAILED"?(l(),f(F,{key:2,command:{action:"extract",report:r}},{default:e(()=>[t(o,null,{default:e(()=>[t(b(Te))]),_:1}),_(" "+w(r.status==="FAILED"?"Повторить извлечение":"Извлечь метрики"),1)]),_:2},1032,["command"])):D("",!0),t(F,{divided:"",command:{action:"download",report:r}},{default:e(()=>[t(o,null,{default:e(()=>[t(b(Re))]),_:1}),s[6]||(s[6]=_(" Скачать ",-1))]),_:1},8,["command"]),t(F,{command:{action:"delete",report:r},class:"dropdown-item--danger"},{default:e(()=>[t(o,null,{default:e(()=>[t(b(Fe))]),_:1}),s[7]||(s[7]=_(" Удалить ",-1))]),_:1},8,["command"])]),_:2},1024)]),default:e(()=>[t(C,{type:"primary",size:"small"},{default:e(()=>[s[3]||(s[3]=_(" Действия ",-1)),t(o,{class:"el-icon--right"},{default:e(()=>[t(b(wt))]),_:1})]),_:1})]),_:2},1024)]),_:1})]),_:1},8,["data","empty-text"])),[[L,d.loading]]),!j.value.length&&!d.loading&&!I.value?(l(),f(ae,{key:2,description:W.value,"image-size":120},{default:e(()=>[M.value?D("",!0):(l(),f(C,{key:0,type:"primary",onClick:s[2]||(s[2]=r=>u.$emit("upload"))},{default:e(()=>[...s[14]||(s[14]=[_(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):D("",!0)])}}},sa=we(na,[["__scopeId","data-v-2d471c96"]]),la={class:"participant-detail"},oa={class:"card-header"},ra={class:"header-actions"},ia={class:"section-header"},ua={class:"section-header"},da={key:1},ca={key:1},pa={class:"scoring-result"},ma={class:"score-value"},fa={class:"score-number"},_a={class:"score-details"},va={class:"score-section"},ya={key:0},ga={class:"score-section"},wa={key:0},ba={class:"score-section"},ha={key:0},ka=["href"],Ca={key:1,class:"recommendation-priority"},Ra={key:0,class:"final-report-actions"},Sa={style:{float:"right",color:"#8492a6","font-size":"13px"}},Ea={__name:"ParticipantDetailView",setup(d){const h=je(),i=Be(),S=Dt(),O=g(!1),x=g(!1),I=g(!1),E=g(!1),M=g(!1),k=g(!1),N=Q(()=>S.currentParticipant),B=g([]),U=g([]),j=g([]),W=g([]);g([]);const q=g(null),J=g(null),X=g(null),G=Q(()=>B.value.some(a=>a.status==="PROCESSING")),u=Q(()=>U.value.some(a=>a.recommendations_status==="pending")),s=g(!1),y=g(!1),p=g(!1),o=g(null),C=g([]),T=ze({file:null}),te={file:[{required:!0,message:"Выберите файл",trigger:"change"}]},F=ze({activityCode:""}),Z=a=>{if(!a)return"—";const n=new Date(a);return Number.isNaN(n.getTime())?"—":n.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},se=a=>a>=80?"success":a>=60?"":"warning",le=a=>({pending:"Формируются",ready:"Готовы",error:"Ошибка",disabled:"Отключены"})[a]||a,oe=a=>({pending:"info",ready:"success",error:"danger",disabled:"warning"})[a]||"info",ae=a=>a>=.8?"#67C23A":a>=.6?"#E6A23C":"#F56C6C",L=async()=>{O.value=!0;try{await S.getParticipant(i.params.id)}catch{A.error("Участник не найден"),h.push("/participants")}finally{O.value=!1}},r=async()=>{x.value=!0;try{const a=await Pe.getReports(i.params.id);B.value=a.items||[]}catch(a){console.error("Error loading reports:",a),A.error("Ошибка загрузки списка отчётов")}finally{x.value=!1}},ee=a=>{if(!a)return a;const n=Array.isArray(a.recommendations)?a.recommendations:[];let $=a.recommendations_status||a.recommendationsStatus||null;$||($=n.length>0?"ready":"pending");const V=Number(a.score_pct),z=Number.isNaN(V)?a.score_pct:V;return{...a,score_pct:z,recommendations:n,recommendations_status:$,recommendations_error:a.recommendations_error||a.recommendationsError||null}},Ee=async()=>{try{const a=await ye.getHistory(i.params.id),n=Array.isArray(a.items)?a.items:[];U.value=n.map(ee)}catch(a){console.error("Error loading scoring results:",a)}},Xe=async()=>{I.value=!0;try{const a=await At.list();j.value=a||[]}catch{A.error("Ошибка загрузки профессиональных областей")}finally{I.value=!1}},re=async()=>{E.value=!0;try{const a=await Pe.getMetrics(i.params.id);W.value=a.metrics||[]}catch(a){console.error("Error loading participant metrics:",a),A.error("Ошибка загрузки метрик участника")}finally{E.value=!1}},Ge=a=>{T.file=a.raw,C.value=[a]},He=async()=>{o.value&&await o.value.validate(async a=>{if(a){if(!T.file){A.error("Выберите файл");return}M.value=!0;try{await ve.upload(i.params.id,T.file),A.success("Отчёт загружен успешно"),s.value=!1,T.file=null,C.value=[],await r(),await re()}catch{A.error("Ошибка загрузки отчёта")}finally{M.value=!1}}})},We=async a=>{try{const n=await ve.download(a),$=window.URL.createObjectURL(new Blob([n.data])),V=document.createElement("a");V.href=$,V.setAttribute("download",`report_${a}.docx`),document.body.appendChild(V),V.click(),V.remove(),window.URL.revokeObjectURL($),A.success("Отчёт скачан")}catch{A.error("Ошибка скачивания отчёта")}},Ke=async a=>{try{await ve.extract(a),A.success("Извлечение метрик запущено"),await r()}catch{A.error("Ошибка запуска извлечения метрик")}},Qe=()=>{J.value||(J.value=setInterval(async()=>{try{await r(),await re()}catch(a){console.error("Auto-refresh error:",a)}},3e3))},$e=()=>{J.value&&(clearInterval(J.value),J.value=null)},Ye=()=>{X.value||(X.value=setInterval(async()=>{try{await Ee()}catch(a){console.error("Recommendations auto-refresh error:",a)}},15e3))},Ae=()=>{X.value&&(clearInterval(X.value),X.value=null)};fe(G,a=>{a?Qe():$e()}),fe(u,a=>{a?Ye():Ae()});const De=async a=>{q.value=a,await Et(),p.value=!0},Ze=async()=>{A.success("Метрики обновлены"),await re()},et=async a=>{try{await ve.delete(a),A.success("Отчёт удалён"),await r()}catch{A.error("Ошибка удаления отчёта")}},tt=async()=>{if(!F.activityCode){A.warning("Выберите профессиональную область");return}k.value=!0;try{const a=await ye.calculate(i.params.id,F.activityCode),n=ee({id:a.scoring_result_id,participant_id:i.params.id,prof_activity_code:a.prof_activity_code||F.activityCode,prof_activity_name:a.prof_activity_name,score_pct:parseFloat(a.score_pct),strengths:a.strengths||[],dev_areas:a.dev_areas||[],recommendations:a.recommendations||[],recommendations_status:a.recommendations_status||((a.recommendations||[]).length>0?"ready":"pending"),recommendations_error:a.recommendations_error||null,created_at:new Date().toISOString()});U.value.unshift(n),A.success("Расчёт пригодности выполнен"),y.value=!1,F.activityCode=""}catch(a){console.error("Scoring calculation error:",a);const n=a.response?.data?.detail||"Ошибка расчёта пригодности";A.error(n)}finally{k.value=!1}},at=async a=>{if(!a.prof_activity_code){A.warning("Код профессиональной деятельности не найден");return}try{const n=await ye.getFinalReport(i.params.id,a.prof_activity_code,"json"),$=JSON.stringify(n,null,2),V=new Blob([$],{type:"application/json"}),z=window.URL.createObjectURL(V);window.open(z,"_blank"),window.URL.revokeObjectURL(z),A.success("Отчёт JSON открыт в новой вкладке")}catch(n){console.error("Error viewing final report JSON:",n);const $=n.response?.data?.detail||"Ошибка загрузки финального отчёта";A.error($)}},nt=async a=>{if(!a.prof_activity_code){A.warning("Код профессиональной деятельности не найден");return}try{const n=await ye.getFinalReport(i.params.id,a.prof_activity_code,"html"),$=new Blob([n],{type:"text/html"}),V=window.URL.createObjectURL($),z=document.createElement("a");z.href=V,z.setAttribute("download",`final_report_${a.prof_activity_code}_${new Date().toISOString().split("T")[0]}.html`),document.body.appendChild(z),z.click(),z.remove(),window.URL.revokeObjectURL(V),A.success("Отчёт HTML скачан")}catch(n){console.error("Error downloading final report HTML:",n);const $=n.response?.data?.detail||"Ошибка загрузки финального отчёта";A.error($)}},st=a=>a?.recommendations_status==="ready"&&Array.isArray(a?.recommendations)&&a.recommendations.length>0,lt=a=>a?.recommendations_error?`Ошибка генерации: ${a.recommendations_error}`:"Не удалось получить рекомендации";return Se(async()=>{await L(),await r(),await Ee(),await Xe(),await re()}),qe(()=>{$e(),Ae()}),(a,n)=>{const $=v("el-button"),V=v("el-icon"),z=v("el-descriptions-item"),ot=v("el-descriptions"),ie=v("el-card"),ue=v("el-table-column"),be=v("el-tag"),rt=v("el-table"),_e=v("el-empty"),it=v("el-progress"),de=v("el-alert"),ut=v("el-timeline-item"),dt=v("el-timeline"),ct=v("el-upload"),Me=v("el-form-item"),xe=v("el-form"),he=v("el-dialog"),pt=v("el-option"),mt=v("el-select"),ke=Je("loading");return l(),f($t,null,{default:e(()=>[me((l(),R("div",la,[N.value?(l(),f(ie,{key:0,class:"detail-card"},{header:e(()=>[m("div",oa,[m("h2",null,w(N.value.full_name),1),m("div",ra,[t($,{onClick:n[0]||(n[0]=c=>b(h).back())},{default:e(()=>[...n[10]||(n[10]=[_(" Назад ",-1)])]),_:1}),t($,{type:"primary",onClick:n[1]||(n[1]=c=>y.value=!0)},{default:e(()=>[t(V,null,{default:e(()=>[t(b(ht))]),_:1}),n[11]||(n[11]=_(" Рассчитать пригодность ",-1))]),_:1})])])]),default:e(()=>[t(ot,{column:2,border:""},{default:e(()=>[t(z,{label:"ФИО"},{default:e(()=>[_(w(N.value.full_name),1)]),_:1}),t(z,{label:"Дата рождения"},{default:e(()=>[_(w(N.value.birth_date||"Не указана"),1)]),_:1}),t(z,{label:"Внешний ID"},{default:e(()=>[_(w(N.value.external_id||"Не указан"),1)]),_:1}),t(z,{label:"Дата создания"},{default:e(()=>[_(w(Z(N.value.created_at)),1)]),_:1})]),_:1})]),_:1})):D("",!0),t(ie,{class:"section-card"},{header:e(()=>[m("div",ia,[n[13]||(n[13]=m("h3",null,"Отчёты",-1)),t($,{type:"primary",onClick:n[2]||(n[2]=c=>s.value=!0)},{default:e(()=>[t(V,null,{default:e(()=>[t(b(kt))]),_:1}),n[12]||(n[12]=_(" Загрузить отчёт ",-1))]),_:1})])]),default:e(()=>[t(sa,{reports:B.value,loading:x.value,onView:De,onEdit:De,onExtract:Ke,onDownload:We,onDelete:et,onUpload:n[3]||(n[3]=c=>s.value=!0)},null,8,["reports","loading"])]),_:1}),t(ie,{class:"section-card"},{header:e(()=>[m("div",ua,[n[15]||(n[15]=m("h3",null,"Актуальные метрики участника",-1)),t($,{type:"primary",size:"small",onClick:re},{default:e(()=>[t(V,null,{default:e(()=>[t(b(Rt))]),_:1}),n[14]||(n[14]=_(" Обновить ",-1))]),_:1})])]),default:e(()=>[me((l(),f(rt,{data:W.value,stripe:""},{default:e(()=>[t(ue,{prop:"metric_code",label:"Код метрики",width:"200"}),t(ue,{prop:"value",label:"Значение",width:"120"},{default:e(({row:c})=>[t(be,{type:"success"},{default:e(()=>[_(w(b(pe)(c.value)),1)]),_:2},1024)]),_:1}),t(ue,{prop:"confidence",label:"Уверенность",width:"150"},{default:e(({row:c})=>[c.confidence!==null?(l(),R("span",{key:0,style:Ct({color:ae(c.confidence)})},w((c.confidence*100).toFixed(0))+"% ",5)):(l(),R("span",da,"—"))]),_:1}),t(ue,{prop:"updated_at",label:"Обновлено",width:"180"},{default:e(({row:c})=>[_(w(Z(c.updated_at)),1)]),_:1}),t(ue,{prop:"last_source_report_id",label:"Источник"},{default:e(({row:c})=>[c.last_source_report_id?(l(),f(be,{key:0,size:"small"},{default:e(()=>[...n[16]||(n[16]=[_(" Из отчёта ",-1)])]),_:1})):(l(),R("span",ca,"—"))]),_:1})]),_:1},8,["data"])),[[ke,E.value]]),!W.value.length&&!E.value?(l(),f(_e,{key:0,description:"Метрики ещё не извлечены. Загрузите и обработайте отчёты."})):D("",!0)]),_:1}),U.value.length>0?(l(),f(ie,{key:1,class:"section-card"},{header:e(()=>[...n[17]||(n[17]=[m("h3",null,"История оценок пригодности",-1)])]),default:e(()=>[t(dt,null,{default:e(()=>[(l(!0),R(K,null,Y(U.value,c=>(l(),f(ut,{key:c.id,timestamp:Z(c.created_at),placement:"top"},{default:e(()=>[t(ie,null,{default:e(()=>[m("h4",null,w(c.prof_activity_name),1),m("div",pa,[m("div",ma,[m("span",fa,w(c.score_pct)+"%",1),t(it,{percentage:c.score_pct,status:se(c.score_pct)},null,8,["percentage","status"])]),m("div",_a,[m("div",va,[n[18]||(n[18]=m("h5",null,"Сильные стороны:",-1)),c.strengths&&c.strengths.length?(l(),R("ul",ya,[(l(!0),R(K,null,Y(c.strengths,(P,ce)=>(l(),R("li",{key:ce},[m("strong",null,w(P.metric_name),1),_(" — "+w(b(pe)(P.value))+" (вес "+w(b(pe)(P.weight,2))+") ",1)]))),128))])):(l(),f(_e,{key:1,description:"Нет данных","image-size":60}))]),m("div",ga,[n[19]||(n[19]=m("h5",null,"Зоны развития:",-1)),c.dev_areas&&c.dev_areas.length?(l(),R("ul",wa,[(l(!0),R(K,null,Y(c.dev_areas,(P,ce)=>(l(),R("li",{key:ce},[m("strong",null,w(P.metric_name),1),_(" — "+w(b(pe)(P.value))+" (вес "+w(b(pe)(P.weight,2))+") ",1)]))),128))])):(l(),f(_e,{key:1,description:"Нет данных","image-size":60}))]),m("div",ba,[m("h5",null,[n[20]||(n[20]=_(" Рекомендации: ",-1)),c.recommendations_status?(l(),f(be,{key:0,type:oe(c.recommendations_status),size:"small",class:"recommendation-status-tag"},{default:e(()=>[_(w(le(c.recommendations_status)),1)]),_:2},1032,["type"])):D("",!0)]),st(c)?(l(),R("ul",ha,[(l(!0),R(K,null,Y(c.recommendations,(P,ce)=>(l(),R("li",{key:ce},[m("strong",null,w(P.title),1),P.link_url?(l(),R("a",{key:0,href:P.link_url,target:"_blank",class:"recommendation-link"}," (перейти к курсу) ",8,ka)):D("",!0),P.priority?(l(),R("span",Ca," [Приоритет: "+w(P.priority)+"] ",1)):D("",!0)]))),128))])):c.recommendations_status==="pending"?(l(),f(de,{key:1,title:"Рекомендации формируются. Обновите страницу через пару минут.",type:"info",closable:!1,"show-icon":""})):c.recommendations_status==="error"?(l(),f(de,{key:2,title:lt(c),type:"error",closable:!1,"show-icon":""},null,8,["title"])):c.recommendations_status==="disabled"?(l(),f(de,{key:3,title:"Генерация рекомендаций отключена для данного окружения.",type:"warning",closable:!1,"show-icon":""})):(l(),f(_e,{key:4,description:"Нет данных","image-size":60}))])]),c.prof_activity_code?(l(),R("div",Ra,[t($,{type:"info",size:"small",onClick:P=>at(c)},{default:e(()=>[t(V,null,{default:e(()=>[t(b(St))]),_:1}),n[21]||(n[21]=_(" Просмотреть JSON ",-1))]),_:1},8,["onClick"]),t($,{type:"primary",size:"small",onClick:P=>nt(c)},{default:e(()=>[t(V,null,{default:e(()=>[t(b(Re))]),_:1}),n[22]||(n[22]=_(" Скачать HTML ",-1))]),_:1},8,["onClick"])])):D("",!0)])]),_:2},1024)]),_:2},1032,["timestamp"]))),128))]),_:1})]),_:1})):D("",!0),t(he,{modelValue:s.value,"onUpdate:modelValue":n[5]||(n[5]=c=>s.value=c),title:"Загрузить отчёт",width:"500px"},{footer:e(()=>[t($,{onClick:n[4]||(n[4]=c=>s.value=!1)},{default:e(()=>[...n[25]||(n[25]=[_(" Отмена ",-1)])]),_:1}),t($,{type:"primary",loading:M.value,onClick:He},{default:e(()=>[...n[26]||(n[26]=[_(" Загрузить ",-1)])]),_:1},8,["loading"])]),default:e(()=>[t(xe,{ref_key:"uploadFormRef",ref:o,model:T,rules:te,"label-position":"top"},{default:e(()=>[t(Me,{label:"Файл (DOCX)",prop:"file"},{default:e(()=>[t(ct,{ref:"uploadRef","auto-upload":!1,limit:1,accept:".docx","on-change":Ge,"file-list":C.value},{tip:e(()=>[...n[24]||(n[24]=[m("div",{class:"el-upload__tip"}," Только файлы DOCX, максимум 20 МБ ",-1)])]),default:e(()=>[t($,{type:"primary"},{default:e(()=>[...n[23]||(n[23]=[_(" Выбрать файл ",-1)])]),_:1})]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(he,{modelValue:y.value,"onUpdate:modelValue":n[8]||(n[8]=c=>y.value=c),title:"Рассчитать профессиональную пригодность",width:"500px"},{footer:e(()=>[t($,{onClick:n[7]||(n[7]=c=>y.value=!1)},{default:e(()=>[...n[27]||(n[27]=[_(" Отмена ",-1)])]),_:1}),t($,{type:"primary",loading:k.value,disabled:!F.activityCode||B.value.length===0,onClick:tt},{default:e(()=>[...n[28]||(n[28]=[_(" Рассчитать ",-1)])]),_:1},8,["loading","disabled"])]),default:e(()=>[t(xe,{model:F,"label-position":"top"},{default:e(()=>[t(Me,{label:"Профессиональная область",required:""},{default:e(()=>[me((l(),f(mt,{modelValue:F.activityCode,"onUpdate:modelValue":n[6]||(n[6]=c=>F.activityCode=c),placeholder:"Выберите область",style:{width:"100%"}},{default:e(()=>[(l(!0),R(K,null,Y(j.value,c=>(l(),f(pt,{key:c.code,label:c.name,value:c.code},{default:e(()=>[m("span",null,w(c.name),1),m("span",Sa,w(c.code),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])),[[ke,I.value]])]),_:1}),t(de,{title:"Убедитесь, что у участника загружены и обработаны отчёты с метриками",type:"info",closable:!1,"show-icon":""}),B.value.length===0?(l(),f(de,{key:0,title:"У участника нет загруженных отчётов",type:"warning",closable:!1,"show-icon":"",style:{"margin-top":"12px"}})):D("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(he,{modelValue:p.value,"onUpdate:modelValue":n[9]||(n[9]=c=>p.value=c),title:"Метрики отчёта",width:"90%",top:"5vh"},{default:e(()=>[q.value?(l(),f(Pt,{key:0,"report-id":q.value,onMetricsUpdated:Ze},null,8,["report-id"])):D("",!0)]),_:1},8,["modelValue"])])),[[ke,O.value]])]),_:1})}}},La=we(Ea,[["__scopeId","data-v-9d2fbe0b"]]);export{La as default};
