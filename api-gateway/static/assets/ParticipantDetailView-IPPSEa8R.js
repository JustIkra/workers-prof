import{G as X,m as w,H as Y,I as ge,r as v,c as C,o as s,d as t,v as D,J as dt,w as e,u as b,K as ct,C as pt,L as mt,M as g,N as W,z as Se,q as f,f as _,O as Q,a as m,E as A,p as ze,e as Pe,P as Be,A as je,B as me,Q as ft,R as Me,k as xe,S as Le,g as Ne,T as _t,U as Ve,V as Oe,h as Ie,W as Re,X as Ue,F as vt,n as Te,t as yt,Y as gt,Z as wt,_ as bt,$ as kt,a0 as ht}from"./index-Bg7iacWT.js";import{A as Ct}from"./AppLayout-BU9qdcqy.js";import{_ as we}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{m as Ce,p as Rt}from"./metrics-DiJt55GY.js";import{u as St,p as Fe}from"./participants-B-e-YT7p.js";const _e={async upload(u,k){const i=new FormData;return i.append("file",k),(await X.post(`/participants/${u}/reports`,i,{headers:{"Content-Type":"multipart/form-data"}})).data},async download(u){return await X.get(`/reports/${u}/download`,{responseType:"blob"})},async getById(u){return(await X.get(`/reports/${u}`)).data},async delete(u){return(await X.delete(`/reports/${u}`)).data},async extract(u){return(await X.post(`/reports/${u}/extract`)).data},async getMetrics(u){return(await X.get(`/reports/${u}/metrics`)).data},async getList(u){return(await X.get(`/participants/${u}/reports`)).data}},ve={async calculate(u,k){return(await X.post(`/scoring/participants/${u}/calculate`,null,{params:{activity_code:k}})).data},async getHistory(u,k=10){return(await X.get(`/scoring/participants/${u}/scores`,{params:{limit:k}})).data},async getById(u){return(await X.get(`/scoring-results/${u}`)).data},async generateRecommendations(u){return(await X.post(`/reports/${u}/recommendations`)).data},async getFinalReport(u,k,i="json"){const R={params:{activity_code:k,format:i}};i==="html"&&(R.responseType="text");const U=await X.get(`/participants/${u}/final-report`,R);return U.data}};function ye(u,k=1){if(u==null||u==="")return"";const i=typeof u=="string"?parseFloat(u):u;return isNaN(i)?"":i.toLocaleString("ru-RU",{minimumFractionDigits:k,maximumFractionDigits:k})}function ae(u){if(u==null||u==="")return null;const i=String(u).trim().replace(",","."),R=parseFloat(i);return isNaN(R)?null:R}function Et(u){return ae(u)}function pe(u,k=1){return ye(u,k)}const $t={key:0,class:"error-message"},At={__name:"MetricInput",props:{modelValue:{type:[Number,String],default:null},min:{type:Number,default:1},max:{type:Number,default:10},step:{type:Number,default:.1},precision:{type:Number,default:1},placeholder:{type:String,default:"Введите значение"},disabled:{type:Boolean,default:!1},showControls:{type:Boolean,default:!0}},emits:["update:modelValue","change","blur"],setup(u,{emit:k}){const i=u,R=k,U=w(null),L=w(""),I=w(!1),E=w(!1),M=w(""),h=Y(()=>ae(L.value)),N=Y(()=>{const o=h.value;return o===null||o<=i.min}),B=Y(()=>{const o=h.value;return o===null||o>=i.max}),F=o=>{if(o==null||o===""){L.value="";return}I.value?L.value=String(o).replace(".",","):L.value=ye(o,i.precision)},j=o=>{if(o==null||o==="")return E.value=!1,M.value="",!0;const l=ae(o);return l===null?(E.value=!0,M.value="Некорректное число",!1):l<i.min?(E.value=!0,M.value=`Значение должно быть не меньше ${ye(i.min,i.precision)}`,!1):l>i.max?(E.value=!0,M.value=`Значение должно быть не больше ${ye(i.max,i.precision)}`,!1):(E.value=!1,M.value="",!0)},G=o=>{const l=o.replace(/[^\d,.-]/g,"");let y=!1;const p=l.split("").filter(S=>S===","||S==="."?y?!1:(y=!0,!0):!0).join("").replace(".",",");L.value=p;const r=ae(p);r!==null?R("update:modelValue",r):(p===""||p==="-")&&R("update:modelValue",null)},q=()=>{I.value=!1;const o=ae(L.value);if(j(L.value)){if(o!==null){const l=Math.round(o*Math.pow(10,i.precision))/Math.pow(10,i.precision),y=Math.max(i.min,Math.min(i.max,l));R("update:modelValue",y),F(y),R("change",y)}}else if(o!==null&&(o<i.min||o>i.max)){const l=Math.max(i.min,Math.min(i.max,o));R("update:modelValue",l),F(l),R("change",l),E.value=!1,M.value=""}R("blur")},J=()=>{I.value=!0,h.value!==null&&(L.value=String(h.value).replace(".",","))},Z=()=>{const o=h.value||0,l=Math.min(i.max,o+i.step),y=Math.round(l*Math.pow(10,i.precision))/Math.pow(10,i.precision);R("update:modelValue",y),R("change",y),F(y)},T=()=>{const o=h.value||0,l=Math.max(i.min,o-i.step),y=Math.round(l*Math.pow(10,i.precision))/Math.pow(10,i.precision);R("update:modelValue",y),R("change",y),F(y)};return ge(()=>i.modelValue,o=>{F(o)},{immediate:!0}),F(i.modelValue),(o,l)=>{const y=v("el-button"),p=v("el-button-group"),r=v("el-input");return s(),C(W,null,[t(r,{ref_key:"inputRef",ref:U,modelValue:L.value,"onUpdate:modelValue":l[0]||(l[0]=S=>L.value=S),placeholder:u.placeholder,disabled:u.disabled,class:mt({"is-invalid":E.value}),onInput:G,onBlur:q,onFocus:J},dt({_:2},[u.showControls?{name:"append",fn:e(()=>[t(p,null,{default:e(()=>[t(y,{icon:b(ct),disabled:u.disabled||N.value,onClick:T},null,8,["icon","disabled"]),t(y,{icon:b(pt),disabled:u.disabled||B.value,onClick:Z},null,8,["icon","disabled"])]),_:1})]),key:"0"}:void 0]),1032,["modelValue","placeholder","disabled","class"]),E.value?(s(),C("div",$t,g(M.value),1)):D("",!0)],64)}}},Dt=we(At,[["__scopeId","data-v-74ef628d"]]),Mt={class:"card-header"},xt={key:1},Lt={key:0,class:"metric-description"},Nt={key:2,class:"metrics-info"},Vt={class:"info-row"},Ot={key:0,class:"info-row"},It={__name:"MetricsEditor",props:{reportId:{type:String,required:!0}},emits:["metrics-updated"],setup(u,{emit:k}){const i=u,R=k,U=w(!1),L=w(!1),I=w(!1),E=w(null),M=w([]),h=w([]),N=w({metrics:{}}),B=w({}),F=Y(()=>!h.value||h.value.length===0?[]:[...new Set(h.value.map(p=>p.source))]),j=Y(()=>!h.value||h.value.length===0?null:new Date),G=async()=>{try{const p=await Ce.listMetricDefs(!0);M.value=p.items||[]}catch(p){console.error("Failed to load metric definitions:",p),E.value="Не удалось загрузить определения метрик"}},q=async()=>{U.value=!0,E.value=null;try{const p=await Ce.listExtractedMetrics(i.reportId);h.value=p.items||[],N.value.metrics={},h.value.forEach(r=>{N.value.metrics[r.metric_def_id]=ae(r.value)}),B.value=JSON.parse(JSON.stringify(N.value.metrics))}catch(p){console.error("Failed to load metrics:",p),E.value="Не удалось загрузить метрики"}finally{U.value=!1}},J=()=>{I.value=!0,B.value=JSON.parse(JSON.stringify(N.value.metrics))},Z=()=>{N.value.metrics=JSON.parse(JSON.stringify(B.value)),I.value=!1,E.value=null},T=async()=>{L.value=!0,E.value=null;try{const p=[];for(const[r,S]of Object.entries(N.value.metrics))if(S!=null&&S!==""){const V=Et(S);V!==null&&p.push({metric_def_id:r,value:V,source:"MANUAL",notes:null})}if(p.length===0){A.warning("Не введено ни одного значения метрики"),L.value=!1;return}await Ce.bulkCreateExtractedMetrics(i.reportId,p),A.success(`Успешно сохранено ${p.length} метрик`),I.value=!1,await q(),R("metrics-updated")}catch(p){console.error("Failed to save metrics:",p);let r="Не удалось сохранить метрики";p.response?.data?.detail&&(typeof p.response.data.detail=="string"?r=p.response.data.detail:Array.isArray(p.response.data.detail)&&(r=p.response.data.detail.map(S=>S.msg||S.message).join(", "))),E.value=r,A.error(r)}finally{L.value=!1}},o=p=>{switch(p){case"OCR":return"info";case"LLM":return"warning";case"MANUAL":return"success";default:return""}},l=p=>{switch(p){case"OCR":return"OCR";case"LLM":return"Gemini Vision";case"MANUAL":return"Ручной ввод";default:return p}},y=p=>new Date(p).toLocaleString("ru-RU",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});return Se(async()=>{await G(),await q()}),ge(()=>i.reportId,async p=>{p&&await q()}),(p,r)=>{const S=v("el-button"),V=v("el-alert"),ee=v("el-form-item"),K=v("el-col"),ne=v("el-row"),se=v("el-form"),le=v("el-divider"),oe=v("el-tag"),H=v("el-card");return s(),f(H,{class:"metrics-editor"},{header:e(()=>[m("div",Mt,[r[4]||(r[4]=m("span",null,"Ручной ввод метрик",-1)),I.value?(s(),C("div",xt,[t(S,{size:"small",onClick:Z},{default:e(()=>[...r[2]||(r[2]=[_(" Отмена ",-1)])]),_:1}),t(S,{type:"primary",size:"small",loading:L.value,onClick:T},{default:e(()=>[...r[3]||(r[3]=[_(" Сохранить ",-1)])]),_:1},8,["loading"])])):(s(),f(S,{key:0,type:"primary",size:"small",onClick:J},{default:e(()=>[...r[1]||(r[1]=[_(" Редактировать ",-1)])]),_:1}))])]),default:e(()=>[E.value?(s(),f(V,{key:0,type:"error",title:E.value,closable:"",style:{"margin-bottom":"16px"},onClose:r[0]||(r[0]=x=>E.value=null)},null,8,["title"])):D("",!0),!h.value||h.value.length===0?(s(),f(V,{key:1,type:"info",closable:!1,style:{"margin-bottom":"16px"}},{default:e(()=>[...r[5]||(r[5]=[_(" Метрики для этого отчёта ещё не извлечены. Вы можете ввести их вручную. ",-1)])]),_:1})):D("",!0),t(se,{ref:"formRef",model:N.value,"label-position":"top",disabled:!I.value},{default:e(()=>[t(ne,{gutter:20},{default:e(()=>[(s(!0),C(W,null,Q(M.value,x=>(s(),f(K,{key:x.id,xs:24,sm:12,md:8,lg:6},{default:e(()=>[t(ee,{label:`${x.name} ${x.unit?"("+x.unit+")":""}`,prop:`metrics.${x.id}`},{default:e(()=>[t(Dt,{modelValue:N.value.metrics[x.id],"onUpdate:modelValue":d=>N.value.metrics[x.id]=d,min:x.min_value||1,max:x.max_value||10,precision:1,step:.1,disabled:!I.value,"show-controls":!0,placeholder:"Введите значение (например: 7,5)"},null,8,["modelValue","onUpdate:modelValue","min","max","disabled"]),x.description?(s(),C("div",Lt,g(x.description),1)):D("",!0)]),_:2},1032,["label","prop"])]),_:2},1024))),128))]),_:1})]),_:1},8,["model","disabled"]),h.value&&h.value.length>0?(s(),C("div",Nt,[t(le),m("div",Vt,[r[6]||(r[6]=m("span",{class:"info-label"},"Источник данных:",-1)),(s(!0),C(W,null,Q(F.value,x=>(s(),f(oe,{key:x,type:o(x),size:"small",style:{"margin-left":"8px"}},{default:e(()=>[_(g(l(x)),1)]),_:2},1032,["type"]))),128))]),j.value?(s(),C("div",Ot,[r[7]||(r[7]=m("span",{class:"info-label"},"Последнее обновление:",-1)),m("span",null,g(y(j.value)),1)])):D("",!0)])):D("",!0)]),_:1})}}},Ut=we(It,[["__scopeId","data-v-bb0e5e9d"]]),Tt={class:"report-list"},Ft={class:"report-list__controls"},zt={class:"controls-left"},Pt={class:"controls-right"},Bt={class:"filename"},jt={class:"status-cell"},qt={key:1,class:"report-list__cards"},Jt={class:"report-card__header"},Xt={class:"report-card__status"},Gt={class:"report-card__body"},Ht={class:"report-card__field"},Wt={class:"field-value"},Kt={class:"report-card__field"},Qt={class:"field-value"},Yt={class:"report-card__actions"},Zt={__name:"ReportList",props:{reports:{type:Array,required:!0,default:()=>[]},loading:{type:Boolean,default:!1}},emits:["view","edit","extract","download","delete","upload"],setup(u,{emit:k}){const i=u,R=k,U=ze(),L=Pe(),I=w(window.innerWidth<=768),E=()=>{I.value=window.innerWidth<=768};Se(()=>{window.addEventListener("resize",E),U.query.status&&(M.value=U.query.status),U.query.sort&&(h.value=U.query.sort)}),Be(()=>{window.removeEventListener("resize",E)});const M=w(""),h=w("desc"),N=[{label:"Загружен",value:"UPLOADED"},{label:"Извлечение метрик...",value:"PROCESSING"},{label:"Метрики извлечены",value:"EXTRACTED"},{label:"Ошибка",value:"FAILED"}];ge([M,h],([o,l])=>{const y={...U.query};o?y.status=o:delete y.status,l?y.sort=l:delete y.sort,L.replace({query:y})});const B=()=>{},F=()=>{h.value=h.value==="desc"?"asc":"desc"},j=Y(()=>{let o=[...i.reports];return M.value&&(o=o.filter(l=>l.status===M.value)),o.sort((l,y)=>{const p=new Date(l.uploaded_at),r=new Date(y.uploaded_at);return h.value==="desc"?r-p:p-r}),o}),G=Y(()=>M.value?"Нет отчётов с выбранным статусом":"Нет загруженных отчётов"),q=o=>{if(!o)return"—";const l=new Date(o);return Number.isNaN(l.getTime())?"—":l.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},J=o=>({UPLOADED:"Загружен",PROCESSING:"Извлечение метрик...",EXTRACTED:"Метрики извлечены",FAILED:"Ошибка"})[o]||o,Z=o=>({UPLOADED:"info",PROCESSING:"warning",EXTRACTED:"success",FAILED:"danger"})[o]||"info",T=async({action:o,report:l})=>{switch(o){case"view":R("view",l.id);break;case"edit":R("edit",l.id);break;case"extract":R("extract",l.id);break;case"download":R("download",l.id);break;case"delete":try{await vt.confirm("Вы уверены, что хотите удалить этот отчёт?","Подтверждение удаления",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"warning"}),R("delete",l.id)}catch{}break}};return(o,l)=>{const y=v("el-option"),p=v("el-select"),r=v("el-icon"),S=v("el-button"),V=v("el-table-column"),ee=v("el-tag"),K=v("el-dropdown-item"),ne=v("el-dropdown-menu"),se=v("el-dropdown"),le=v("el-table"),oe=v("el-card"),H=v("el-empty"),x=je("loading");return s(),C("div",Tt,[m("div",Ft,[m("div",zt,[t(p,{modelValue:M.value,"onUpdate:modelValue":l[0]||(l[0]=d=>M.value=d),placeholder:"Все статусы",clearable:"",style:{width:"200px"},onChange:B},{default:e(()=>[t(y,{label:"Все статусы",value:""}),(s(),C(W,null,Q(N,d=>t(y,{key:d.value,label:d.label,value:d.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),m("div",Pt,[t(S,{type:h.value==="desc"?"primary":"default",size:"small",onClick:F},{default:e(()=>[t(r,null,{default:e(()=>[t(b(ft))]),_:1}),_(" "+g(h.value==="desc"?"Новые сверху":"Старые сверху"),1)]),_:1},8,["type"])])]),I.value?me((s(),C("div",qt,[(s(!0),C(W,null,Q(j.value,d=>(s(),f(oe,{key:d.id,class:"report-card",shadow:"hover"},{header:e(()=>[m("div",Jt,[m("div",Xt,[d.status==="PROCESSING"?(s(),f(r,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(b(Me))]),_:1})):d.status==="EXTRACTED"?(s(),f(r,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(b(xe))]),_:1})):d.status==="FAILED"?(s(),f(r,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(b(Le))]),_:1})):(s(),f(r,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(b(Ne))]),_:1})),t(ee,{type:Z(d.status),size:"small"},{default:e(()=>[_(g(J(d.status)),1)]),_:2},1032,["type"])])])]),footer:e(()=>[m("div",Yt,[d.status==="EXTRACTED"?(s(),f(S,{key:0,type:"success",size:"small",onClick:te=>T({action:"edit",report:d})},{default:e(()=>[t(r,null,{default:e(()=>[t(b(Ve))]),_:1}),l[10]||(l[10]=_(" Редактировать ",-1))]),_:1},8,["onClick"])):D("",!0),d.status==="PROCESSING"||d.status==="EXTRACTED"?(s(),f(S,{key:1,type:"info",size:"small",onClick:te=>T({action:"view",report:d})},{default:e(()=>[t(r,null,{default:e(()=>[t(b(Oe))]),_:1}),l[11]||(l[11]=_(" Просмотр ",-1))]),_:1},8,["onClick"])):D("",!0),d.status==="UPLOADED"||d.status==="FAILED"?(s(),f(S,{key:2,type:"primary",size:"small",loading:d.status==="PROCESSING",onClick:te=>T({action:"extract",report:d})},{default:e(()=>[t(r,null,{default:e(()=>[t(b(Ie))]),_:1}),_(" "+g(d.status==="FAILED"?"Повторить":"Извлечь"),1)]),_:2},1032,["loading","onClick"])):D("",!0),t(S,{size:"small",onClick:te=>T({action:"download",report:d})},{default:e(()=>[t(r,null,{default:e(()=>[t(b(Re))]),_:1}),l[12]||(l[12]=_(" Скачать ",-1))]),_:1},8,["onClick"]),t(S,{type:"danger",size:"small",onClick:te=>T({action:"delete",report:d})},{default:e(()=>[t(r,null,{default:e(()=>[t(b(Ue))]),_:1})]),_:1},8,["onClick"])])]),default:e(()=>[m("div",Gt,[m("div",Ht,[l[8]||(l[8]=m("span",{class:"field-label"},"Файл:",-1)),m("span",Wt,g(d.file_ref?.filename||"Без названия"),1)]),m("div",Kt,[l[9]||(l[9]=m("span",{class:"field-label"},"Дата загрузки:",-1)),m("span",Qt,g(q(d.uploaded_at)),1)])])]),_:2},1024))),128)),!j.value.length&&!u.loading?(s(),f(H,{key:0,description:G.value,"image-size":120},{default:e(()=>[M.value?D("",!0):(s(),f(S,{key:0,type:"primary",onClick:l[1]||(l[1]=d=>o.$emit("upload"))},{default:e(()=>[...l[13]||(l[13]=[_(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):D("",!0)])),[[x,u.loading]]):me((s(),f(le,{key:0,data:j.value,class:"report-list__table",stripe:"","empty-text":G.value},{default:e(()=>[t(V,{prop:"file_ref.filename",label:"Название файла","min-width":"200"},{default:e(({row:d})=>[m("span",Bt,g(d.file_ref?.filename||"Без названия"),1)]),_:1}),t(V,{prop:"status",label:"Статус",width:"200"},{default:e(({row:d})=>[m("div",jt,[d.status==="PROCESSING"?(s(),f(r,{key:0,class:"status-icon status-icon--spinning"},{default:e(()=>[t(b(Me))]),_:1})):d.status==="EXTRACTED"?(s(),f(r,{key:1,class:"status-icon status-icon--success"},{default:e(()=>[t(b(xe))]),_:1})):d.status==="FAILED"?(s(),f(r,{key:2,class:"status-icon status-icon--error"},{default:e(()=>[t(b(Le))]),_:1})):(s(),f(r,{key:3,class:"status-icon status-icon--info"},{default:e(()=>[t(b(Ne))]),_:1})),t(ee,{type:Z(d.status),size:"default"},{default:e(()=>[_(g(J(d.status)),1)]),_:2},1032,["type"])])]),_:1}),t(V,{prop:"uploaded_at",label:"Дата загрузки",width:"180",sortable:""},{default:e(({row:d})=>[_(g(q(d.uploaded_at)),1)]),_:1}),t(V,{label:"Действия",width:"200",fixed:"right",align:"right"},{default:e(({row:d})=>[t(se,{trigger:"click",onCommand:T},{dropdown:e(()=>[t(ne,null,{default:e(()=>[d.status==="EXTRACTED"?(s(),f(K,{key:0,command:{action:"edit",report:d}},{default:e(()=>[t(r,null,{default:e(()=>[t(b(Ve))]),_:1}),l[4]||(l[4]=_(" Редактировать метрики ",-1))]),_:1},8,["command"])):D("",!0),d.status==="PROCESSING"||d.status==="EXTRACTED"?(s(),f(K,{key:1,command:{action:"view",report:d}},{default:e(()=>[t(r,null,{default:e(()=>[t(b(Oe))]),_:1}),l[5]||(l[5]=_(" Просмотр метрик ",-1))]),_:1},8,["command"])):D("",!0),d.status==="UPLOADED"||d.status==="FAILED"?(s(),f(K,{key:2,command:{action:"extract",report:d}},{default:e(()=>[t(r,null,{default:e(()=>[t(b(Ie))]),_:1}),_(" "+g(d.status==="FAILED"?"Повторить извлечение":"Извлечь метрики"),1)]),_:2},1032,["command"])):D("",!0),t(K,{divided:"",command:{action:"download",report:d}},{default:e(()=>[t(r,null,{default:e(()=>[t(b(Re))]),_:1}),l[6]||(l[6]=_(" Скачать ",-1))]),_:1},8,["command"]),t(K,{command:{action:"delete",report:d},class:"dropdown-item--danger"},{default:e(()=>[t(r,null,{default:e(()=>[t(b(Ue))]),_:1}),l[7]||(l[7]=_(" Удалить ",-1))]),_:1},8,["command"])]),_:2},1024)]),default:e(()=>[t(S,{type:"primary",size:"small"},{default:e(()=>[l[3]||(l[3]=_(" Действия ",-1)),t(r,{class:"el-icon--right"},{default:e(()=>[t(b(_t))]),_:1})]),_:1})]),_:2},1024)]),_:1})]),_:1},8,["data","empty-text"])),[[x,u.loading]]),!j.value.length&&!u.loading&&!I.value?(s(),f(H,{key:2,description:G.value,"image-size":120},{default:e(()=>[M.value?D("",!0):(s(),f(S,{key:0,type:"primary",onClick:l[2]||(l[2]=d=>o.$emit("upload"))},{default:e(()=>[...l[14]||(l[14]=[_(" Загрузить отчёт ",-1)])]),_:1}))]),_:1},8,["description"])):D("",!0)])}}},ea=we(Zt,[["__scopeId","data-v-2d471c96"]]),ta={class:"participant-detail"},aa={class:"card-header"},na={class:"header-actions"},sa={class:"section-header"},la={class:"section-header"},oa={key:1},ra={key:1},ia={class:"scoring-result"},ua={class:"score-value"},da={class:"score-number"},ca={class:"score-details"},pa={class:"score-section"},ma={key:0},fa={class:"score-section"},_a={key:0},va={class:"score-section"},ya={key:0},ga=["href"],wa={key:1,class:"recommendation-priority"},ba={key:0,class:"final-report-actions"},ka={style:{float:"right",color:"#8492a6","font-size":"13px"}},ha={__name:"ParticipantDetailView",setup(u){const k=Pe(),i=ze(),R=St(),U=w(!1),L=w(!1),I=w(!1),E=w(!1),M=w(!1),h=w(!1),N=Y(()=>R.currentParticipant),B=w([]),F=w([]),j=w([]),G=w([]);w([]);const q=w(null),J=w(null),Z=Y(()=>B.value.some(a=>a.status==="PROCESSING")),T=w(!1),o=w(!1),l=w(!1),y=w(null),p=w([]),r=Te({file:null}),S={file:[{required:!0,message:"Выберите файл",trigger:"change"}]},V=Te({activityCode:""}),ee=a=>{if(!a)return"—";const n=new Date(a);return Number.isNaN(n.getTime())?"—":n.toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},K=a=>a>=80?"success":a>=60?"":"warning",ne=a=>({pending:"Формируются",ready:"Готовы",error:"Ошибка",disabled:"Отключены"})[a]||a,se=a=>({pending:"info",ready:"success",error:"danger",disabled:"warning"})[a]||"info",le=a=>a>=.8?"#67C23A":a>=.6?"#E6A23C":"#F56C6C",oe=async()=>{U.value=!0;try{await R.getParticipant(i.params.id)}catch{A.error("Участник не найден"),k.push("/participants")}finally{U.value=!1}},H=async()=>{L.value=!0;try{const a=await Fe.getReports(i.params.id);B.value=a.items||[]}catch(a){console.error("Error loading reports:",a),A.error("Ошибка загрузки списка отчётов")}finally{L.value=!1}},x=a=>{if(!a)return a;const n=Array.isArray(a.recommendations)?a.recommendations:[];let $=a.recommendations_status||a.recommendationsStatus||null;$||($=n.length>0?"ready":"pending");const O=Number(a.score_pct),z=Number.isNaN(O)?a.score_pct:O;return{...a,score_pct:z,recommendations:n,recommendations_status:$,recommendations_error:a.recommendations_error||a.recommendationsError||null}},d=async()=>{try{const a=await ve.getHistory(i.params.id),n=Array.isArray(a.items)?a.items:[];F.value=n.map(x)}catch(a){console.error("Error loading scoring results:",a)}},te=async()=>{I.value=!0;try{const a=await Rt.list();j.value=a||[]}catch{A.error("Ошибка загрузки профессиональных областей")}finally{I.value=!1}},re=async()=>{E.value=!0;try{const a=await Fe.getMetrics(i.params.id);G.value=a.metrics||[]}catch(a){console.error("Error loading participant metrics:",a),A.error("Ошибка загрузки метрик участника")}finally{E.value=!1}},qe=a=>{r.file=a.raw,p.value=[a]},Je=async()=>{y.value&&await y.value.validate(async a=>{if(a){if(!r.file){A.error("Выберите файл");return}M.value=!0;try{await _e.upload(i.params.id,r.file),A.success("Отчёт загружен успешно"),T.value=!1,r.file=null,p.value=[],await H(),await re()}catch{A.error("Ошибка загрузки отчёта")}finally{M.value=!1}}})},Xe=async a=>{try{const n=await _e.download(a),$=window.URL.createObjectURL(new Blob([n.data])),O=document.createElement("a");O.href=$,O.setAttribute("download",`report_${a}.docx`),document.body.appendChild(O),O.click(),O.remove(),window.URL.revokeObjectURL($),A.success("Отчёт скачан")}catch{A.error("Ошибка скачивания отчёта")}},Ge=async a=>{try{await _e.extract(a),A.success("Извлечение метрик запущено"),await H()}catch{A.error("Ошибка запуска извлечения метрик")}},He=()=>{J.value||(J.value=setInterval(async()=>{try{await H(),await re()}catch(a){console.error("Auto-refresh error:",a)}},3e3))},Ee=()=>{J.value&&(clearInterval(J.value),J.value=null)};ge(Z,a=>{a?He():Ee()});const $e=async a=>{q.value=a,await ht(),l.value=!0},We=async()=>{A.success("Метрики обновлены"),await re()},Ke=async a=>{try{await _e.delete(a),A.success("Отчёт удалён"),await H()}catch{A.error("Ошибка удаления отчёта")}},Qe=async()=>{if(!V.activityCode){A.warning("Выберите профессиональную область");return}h.value=!0;try{const a=await ve.calculate(i.params.id,V.activityCode),n=x({id:a.scoring_result_id,participant_id:i.params.id,prof_activity_code:a.prof_activity_code||V.activityCode,prof_activity_name:a.prof_activity_name,score_pct:parseFloat(a.score_pct),strengths:a.strengths||[],dev_areas:a.dev_areas||[],recommendations:a.recommendations||[],recommendations_status:a.recommendations_status||((a.recommendations||[]).length>0?"ready":"pending"),recommendations_error:a.recommendations_error||null,created_at:new Date().toISOString()});F.value.unshift(n),A.success("Расчёт пригодности выполнен"),o.value=!1,V.activityCode=""}catch(a){console.error("Scoring calculation error:",a);const n=a.response?.data?.detail||"Ошибка расчёта пригодности";A.error(n)}finally{h.value=!1}},Ye=async a=>{if(!a.prof_activity_code){A.warning("Код профессиональной деятельности не найден");return}try{const n=await ve.getFinalReport(i.params.id,a.prof_activity_code,"json"),$=JSON.stringify(n,null,2),O=new Blob([$],{type:"application/json"}),z=window.URL.createObjectURL(O);window.open(z,"_blank"),window.URL.revokeObjectURL(z),A.success("Отчёт JSON открыт в новой вкладке")}catch(n){console.error("Error viewing final report JSON:",n);const $=n.response?.data?.detail||"Ошибка загрузки финального отчёта";A.error($)}},Ze=async a=>{if(!a.prof_activity_code){A.warning("Код профессиональной деятельности не найден");return}try{const n=await ve.getFinalReport(i.params.id,a.prof_activity_code,"html"),$=new Blob([n],{type:"text/html"}),O=window.URL.createObjectURL($),z=document.createElement("a");z.href=O,z.setAttribute("download",`final_report_${a.prof_activity_code}_${new Date().toISOString().split("T")[0]}.html`),document.body.appendChild(z),z.click(),z.remove(),window.URL.revokeObjectURL(O),A.success("Отчёт HTML скачан")}catch(n){console.error("Error downloading final report HTML:",n);const $=n.response?.data?.detail||"Ошибка загрузки финального отчёта";A.error($)}},et=a=>a?.recommendations_status==="ready"&&Array.isArray(a?.recommendations)&&a.recommendations.length>0,tt=a=>a?.recommendations_error?`Ошибка генерации: ${a.recommendations_error}`:"Не удалось получить рекомендации";return Se(async()=>{await oe(),await H(),await d(),await te(),await re()}),Be(()=>{Ee()}),(a,n)=>{const $=v("el-button"),O=v("el-icon"),z=v("el-descriptions-item"),at=v("el-descriptions"),ie=v("el-card"),ue=v("el-table-column"),be=v("el-tag"),nt=v("el-table"),fe=v("el-empty"),st=v("el-progress"),de=v("el-alert"),lt=v("el-timeline-item"),ot=v("el-timeline"),rt=v("el-upload"),Ae=v("el-form-item"),De=v("el-form"),ke=v("el-dialog"),it=v("el-option"),ut=v("el-select"),he=je("loading");return s(),f(Ct,null,{default:e(()=>[me((s(),C("div",ta,[N.value?(s(),f(ie,{key:0,class:"detail-card"},{header:e(()=>[m("div",aa,[m("h2",null,g(N.value.full_name),1),m("div",na,[t($,{onClick:n[0]||(n[0]=c=>b(k).back())},{default:e(()=>[...n[10]||(n[10]=[_(" Назад ",-1)])]),_:1}),t($,{type:"primary",onClick:n[1]||(n[1]=c=>o.value=!0)},{default:e(()=>[t(O,null,{default:e(()=>[t(b(yt))]),_:1}),n[11]||(n[11]=_(" Рассчитать пригодность ",-1))]),_:1})])])]),default:e(()=>[t(at,{column:2,border:""},{default:e(()=>[t(z,{label:"ФИО"},{default:e(()=>[_(g(N.value.full_name),1)]),_:1}),t(z,{label:"Дата рождения"},{default:e(()=>[_(g(N.value.birth_date||"Не указана"),1)]),_:1}),t(z,{label:"Внешний ID"},{default:e(()=>[_(g(N.value.external_id||"Не указан"),1)]),_:1}),t(z,{label:"Дата создания"},{default:e(()=>[_(g(ee(N.value.created_at)),1)]),_:1})]),_:1})]),_:1})):D("",!0),t(ie,{class:"section-card"},{header:e(()=>[m("div",sa,[n[13]||(n[13]=m("h3",null,"Отчёты",-1)),t($,{type:"primary",onClick:n[2]||(n[2]=c=>T.value=!0)},{default:e(()=>[t(O,null,{default:e(()=>[t(b(gt))]),_:1}),n[12]||(n[12]=_(" Загрузить отчёт ",-1))]),_:1})])]),default:e(()=>[t(ea,{reports:B.value,loading:L.value,onView:$e,onEdit:$e,onExtract:Ge,onDownload:Xe,onDelete:Ke,onUpload:n[3]||(n[3]=c=>T.value=!0)},null,8,["reports","loading"])]),_:1}),t(ie,{class:"section-card"},{header:e(()=>[m("div",la,[n[15]||(n[15]=m("h3",null,"Актуальные метрики участника",-1)),t($,{type:"primary",size:"small",onClick:re},{default:e(()=>[t(O,null,{default:e(()=>[t(b(bt))]),_:1}),n[14]||(n[14]=_(" Обновить ",-1))]),_:1})])]),default:e(()=>[me((s(),f(nt,{data:G.value,stripe:""},{default:e(()=>[t(ue,{prop:"metric_code",label:"Код метрики",width:"200"}),t(ue,{prop:"value",label:"Значение",width:"120"},{default:e(({row:c})=>[t(be,{type:"success"},{default:e(()=>[_(g(b(pe)(c.value)),1)]),_:2},1024)]),_:1}),t(ue,{prop:"confidence",label:"Уверенность",width:"150"},{default:e(({row:c})=>[c.confidence!==null?(s(),C("span",{key:0,style:wt({color:le(c.confidence)})},g((c.confidence*100).toFixed(0))+"% ",5)):(s(),C("span",oa,"—"))]),_:1}),t(ue,{prop:"updated_at",label:"Обновлено",width:"180"},{default:e(({row:c})=>[_(g(ee(c.updated_at)),1)]),_:1}),t(ue,{prop:"last_source_report_id",label:"Источник"},{default:e(({row:c})=>[c.last_source_report_id?(s(),f(be,{key:0,size:"small"},{default:e(()=>[...n[16]||(n[16]=[_(" Из отчёта ",-1)])]),_:1})):(s(),C("span",ra,"—"))]),_:1})]),_:1},8,["data"])),[[he,E.value]]),!G.value.length&&!E.value?(s(),f(fe,{key:0,description:"Метрики ещё не извлечены. Загрузите и обработайте отчёты."})):D("",!0)]),_:1}),F.value.length>0?(s(),f(ie,{key:1,class:"section-card"},{header:e(()=>[...n[17]||(n[17]=[m("h3",null,"История оценок пригодности",-1)])]),default:e(()=>[t(ot,null,{default:e(()=>[(s(!0),C(W,null,Q(F.value,c=>(s(),f(lt,{key:c.id,timestamp:ee(c.created_at),placement:"top"},{default:e(()=>[t(ie,null,{default:e(()=>[m("h4",null,g(c.prof_activity_name),1),m("div",ia,[m("div",ua,[m("span",da,g(c.score_pct)+"%",1),t(st,{percentage:c.score_pct,status:K(c.score_pct)},null,8,["percentage","status"])]),m("div",ca,[m("div",pa,[n[18]||(n[18]=m("h5",null,"Сильные стороны:",-1)),c.strengths&&c.strengths.length?(s(),C("ul",ma,[(s(!0),C(W,null,Q(c.strengths,(P,ce)=>(s(),C("li",{key:ce},[m("strong",null,g(P.metric_name),1),_(" — "+g(b(pe)(P.value))+" (вес "+g(b(pe)(P.weight,2))+") ",1)]))),128))])):(s(),f(fe,{key:1,description:"Нет данных","image-size":60}))]),m("div",fa,[n[19]||(n[19]=m("h5",null,"Зоны развития:",-1)),c.dev_areas&&c.dev_areas.length?(s(),C("ul",_a,[(s(!0),C(W,null,Q(c.dev_areas,(P,ce)=>(s(),C("li",{key:ce},[m("strong",null,g(P.metric_name),1),_(" — "+g(b(pe)(P.value))+" (вес "+g(b(pe)(P.weight,2))+") ",1)]))),128))])):(s(),f(fe,{key:1,description:"Нет данных","image-size":60}))]),m("div",va,[m("h5",null,[n[20]||(n[20]=_(" Рекомендации: ",-1)),c.recommendations_status?(s(),f(be,{key:0,type:se(c.recommendations_status),size:"small",class:"recommendation-status-tag"},{default:e(()=>[_(g(ne(c.recommendations_status)),1)]),_:2},1032,["type"])):D("",!0)]),et(c)?(s(),C("ul",ya,[(s(!0),C(W,null,Q(c.recommendations,(P,ce)=>(s(),C("li",{key:ce},[m("strong",null,g(P.title),1),P.link_url?(s(),C("a",{key:0,href:P.link_url,target:"_blank",class:"recommendation-link"}," (перейти к курсу) ",8,ga)):D("",!0),P.priority?(s(),C("span",wa," [Приоритет: "+g(P.priority)+"] ",1)):D("",!0)]))),128))])):c.recommendations_status==="pending"?(s(),f(de,{key:1,title:"Рекомендации формируются. Обновите страницу через пару минут.",type:"info",closable:!1,"show-icon":""})):c.recommendations_status==="error"?(s(),f(de,{key:2,title:tt(c),type:"error",closable:!1,"show-icon":""},null,8,["title"])):c.recommendations_status==="disabled"?(s(),f(de,{key:3,title:"Генерация рекомендаций отключена для данного окружения.",type:"warning",closable:!1,"show-icon":""})):(s(),f(fe,{key:4,description:"Нет данных","image-size":60}))])]),c.prof_activity_code?(s(),C("div",ba,[t($,{type:"info",size:"small",onClick:P=>Ye(c)},{default:e(()=>[t(O,null,{default:e(()=>[t(b(kt))]),_:1}),n[21]||(n[21]=_(" Просмотреть JSON ",-1))]),_:1},8,["onClick"]),t($,{type:"primary",size:"small",onClick:P=>Ze(c)},{default:e(()=>[t(O,null,{default:e(()=>[t(b(Re))]),_:1}),n[22]||(n[22]=_(" Скачать HTML ",-1))]),_:1},8,["onClick"])])):D("",!0)])]),_:2},1024)]),_:2},1032,["timestamp"]))),128))]),_:1})]),_:1})):D("",!0),t(ke,{modelValue:T.value,"onUpdate:modelValue":n[5]||(n[5]=c=>T.value=c),title:"Загрузить отчёт",width:"500px"},{footer:e(()=>[t($,{onClick:n[4]||(n[4]=c=>T.value=!1)},{default:e(()=>[...n[25]||(n[25]=[_(" Отмена ",-1)])]),_:1}),t($,{type:"primary",loading:M.value,onClick:Je},{default:e(()=>[...n[26]||(n[26]=[_(" Загрузить ",-1)])]),_:1},8,["loading"])]),default:e(()=>[t(De,{ref_key:"uploadFormRef",ref:y,model:r,rules:S,"label-position":"top"},{default:e(()=>[t(Ae,{label:"Файл (DOCX)",prop:"file"},{default:e(()=>[t(rt,{ref:"uploadRef","auto-upload":!1,limit:1,accept:".docx","on-change":qe,"file-list":p.value},{tip:e(()=>[...n[24]||(n[24]=[m("div",{class:"el-upload__tip"}," Только файлы DOCX, максимум 20 МБ ",-1)])]),default:e(()=>[t($,{type:"primary"},{default:e(()=>[...n[23]||(n[23]=[_(" Выбрать файл ",-1)])]),_:1})]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(ke,{modelValue:o.value,"onUpdate:modelValue":n[8]||(n[8]=c=>o.value=c),title:"Рассчитать профессиональную пригодность",width:"500px"},{footer:e(()=>[t($,{onClick:n[7]||(n[7]=c=>o.value=!1)},{default:e(()=>[...n[27]||(n[27]=[_(" Отмена ",-1)])]),_:1}),t($,{type:"primary",loading:h.value,disabled:!V.activityCode||B.value.length===0,onClick:Qe},{default:e(()=>[...n[28]||(n[28]=[_(" Рассчитать ",-1)])]),_:1},8,["loading","disabled"])]),default:e(()=>[t(De,{model:V,"label-position":"top"},{default:e(()=>[t(Ae,{label:"Профессиональная область",required:""},{default:e(()=>[me((s(),f(ut,{modelValue:V.activityCode,"onUpdate:modelValue":n[6]||(n[6]=c=>V.activityCode=c),placeholder:"Выберите область",style:{width:"100%"}},{default:e(()=>[(s(!0),C(W,null,Q(j.value,c=>(s(),f(it,{key:c.code,label:c.name,value:c.code},{default:e(()=>[m("span",null,g(c.name),1),m("span",ka,g(c.code),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])),[[he,I.value]])]),_:1}),t(de,{title:"Убедитесь, что у участника загружены и обработаны отчёты с метриками",type:"info",closable:!1,"show-icon":""}),B.value.length===0?(s(),f(de,{key:0,title:"У участника нет загруженных отчётов",type:"warning",closable:!1,"show-icon":"",style:{"margin-top":"12px"}})):D("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(ke,{modelValue:l.value,"onUpdate:modelValue":n[9]||(n[9]=c=>l.value=c),title:"Метрики отчёта",width:"90%",top:"5vh"},{default:e(()=>[q.value?(s(),f(Ut,{key:0,"report-id":q.value,onMetricsUpdated:We},null,8,["report-id"])):D("",!0)]),_:1},8,["modelValue"])])),[[he,U.value]])]),_:1})}}},Aa=we(ha,[["__scopeId","data-v-5f9578f8"]]);export{Aa as default};
