import{G as K,m,H as M,z as Ee,q as z,w as l,E as _,r as c,A as Le,o as d,a as r,d as e,B as Pe,f as n,u as v,a2 as ce,D as Ne,c as f,a3 as Re,N as R,O as Y,C as pe,M as p,V as ve,U as Z,v as S,a4 as ee,X as Ge,F as He}from"./index-DqXGjsgl.js";import{A as Ie}from"./AppLayout-DfwcIS6-.js";import{c as G,m as Oe,a as me}from"./numberFormat-GvvEZKcK.js";import{_ as Qe}from"./_plugin-vue_export-helper-DlAUqK2U.js";const te={async upload(F){return(await K.post("/admin/weights/upload",F)).data},async update(F,h){return(await K.put(`/admin/weights/${F}`,h)).data},async list(F=null){const h=F?{prof_activity_code:F}:{};return(await K.get("/admin/weights",{params:h})).data}},Xe={class:"admin-weights-view"},je={class:"header-content"},Je={class:"header-buttons"},Ke={class:"areas-container"},Ye={key:2,class:"areas-grid"},Ze={class:"area-header"},et={class:"area-title"},tt={key:0,class:"area-description"},lt={key:0,class:"no-table"},at={key:1,class:"table-info"},ot={class:"table-stats"},it={class:"stat-item"},st={class:"stat-item"},nt={class:"stat-item"},rt={class:"table-actions"},dt={class:"selected-area"},ut={class:"area-name"},ct={class:"selected-area"},pt={class:"area-name"},vt={class:"weights-editor"},mt={key:0},_t={key:1},ft={key:0},gt={class:"metric-cell"},yt={key:0,style:{"margin-top":"20px"}},wt={__name:"AdminWeightsView",setup(F){const h=m(!1),k=m(!1),q=m(""),V=m(null),le=m([]),H=m([]),I=m([]),$=m(!1),E=m(!1),T=m(!1),y=m(null),A=m(null),w=m(null),_e=m(null),u=m({prof_activity_code:"",weights:[],metadata:{description:""}}),g=m({code:"",name:"",description:""}),ae=M(()=>{const a=H.value.map(s=>{const i=le.value.find(b=>b.prof_activity_code===s.code);return{...s,weightTable:i||null}});if(!q.value)return a;const t=q.value.toLowerCase();return a.filter(s=>s.name.toLowerCase().includes(t)||s.description&&s.description.toLowerCase().includes(t))}),L=M(()=>{const a=H.value.find(t=>t.code===u.value.prof_activity_code);return a?a.name:""}),fe=M(()=>A.value?`Редактировать весовую таблицу: ${L.value}`:`Создать весовую таблицу: ${L.value}`),x=M(()=>u.value.weights.reduce((a,t)=>a+(parseFloat(t.weight)||0),0)),ge=M(()=>Math.abs(x.value-1)<1e-4&&u.value.weights.length>0),ye=M(()=>Math.abs(x.value-1)<1e-4?"success":x.value<1?"warning":"error"),O=async()=>{try{const a=await te.list();le.value=a}catch(a){throw console.error("Failed to load weight tables:",a),V.value="Ошибка загрузки весовых таблиц",_.error("Ошибка загрузки весовых таблиц"),a}},we=a=>{A.value=null,u.value={prof_activity_code:a.code,weights:[],metadata:{description:""}},$.value=!0},Q=async()=>{try{const a=await G.list();H.value=a}catch(a){throw console.error("Failed to load prof activities:",a),V.value="Ошибка загрузки профессиональных областей",_.error("Ошибка загрузки профессиональных областей"),a}},he=async()=>{try{const a=await Oe.listMetricDefs(!0);I.value=a.items||[]}catch(a){throw console.error("Failed to load metrics:",a),V.value="Ошибка загрузки метрик",_.error("Ошибка загрузки метрик"),a}},oe=a=>{A.value=a,u.value={prof_activity_code:a.prof_activity_code,weights:a.weights.map(t=>({metric_code:t.metric_code,weight:parseFloat(t.weight)})),metadata:a.metadata||{description:""}},$.value=!0},be=()=>{u.value.weights.push({metric_code:"",weight:0})},ke=a=>{u.value.weights.splice(a,1)},Ve=async()=>{try{if(k.value=!0,!u.value.prof_activity_code){_.warning("Выберите профессиональную область");return}if(u.value.weights.length===0){_.warning("Добавьте хотя бы одну компетенцию");return}const a=u.value.weights.map(i=>i.metric_code);if(new Set(a.filter(i=>i)).size!==u.value.weights.length){_.warning("Компетенции должны быть уникальными");return}if(u.value.weights.some(i=>!i.metric_code)){_.warning("Все компетенции должны быть заполнены");return}const s={prof_activity_code:u.value.prof_activity_code,weights:u.value.weights.map(i=>({metric_code:i.metric_code,weight:parseFloat(i.weight)})),metadata:u.value.metadata.description?u.value.metadata:null};A.value?(await te.update(A.value.id,s),_.success("Изменения применены")):(await te.upload(s),_.success("Таблица создана")),$.value=!1,await O()}catch(a){console.error("Failed to save weight table:",a),_.error(a.response?.data?.detail||"Ошибка сохранения таблицы")}finally{k.value=!1}},xe=a=>{y.value=a,E.value=!0},ie=()=>{w.value=null,g.value={code:"",name:"",description:""},T.value=!0},Ce=a=>{w.value=a,g.value={code:a.code,name:a.name,description:a.description||""},T.value=!0},Fe=async()=>{try{if(k.value=!0,!g.value.code||!g.value.name){_.warning("Заполните обязательные поля");return}w.value?(await G.update(w.value.id,{name:g.value.name,description:g.value.description}),_.success("Область обновлена")):(await G.create(g.value),_.success("Область создана")),T.value=!1,await Q()}catch(a){console.error("Failed to save prof activity:",a),_.error(a.response?.data?.detail||"Ошибка сохранения области")}finally{k.value=!1}},Te=async()=>{try{await He.confirm(`Удалить профессиональную область "${w.value.name}"? Это действие нельзя отменить.`,"Предупреждение",{confirmButtonText:"Удалить",cancelButtonText:"Отмена",type:"error"}),await G.delete(w.value.id),_.success("Область удалена"),T.value=!1,await Q(),await O()}catch(a){a!=="cancel"&&(console.error("Failed to delete prof activity:",a),_.error(a.response?.data?.detail||"Ошибка удаления области"))}},X=a=>a.weights.reduce((t,s)=>t+parseFloat(s.weight),0),se=a=>{const t=X(a);return Math.abs(t-1)<1e-4?"success":"danger"},Ae=a=>a.map(t=>{const s=I.value.find(i=>i.code===t.metric_code);return{...t,metric_name:s?.name||t.metric_code,metric_code:t.metric_code}}),ne=a=>new Date(a).toLocaleString("ru-RU"),re=async()=>{h.value=!0,V.value=null;try{await Promise.all([O(),Q(),he()])}catch(a){console.error("Failed to load data:",a),V.value||(V.value="Не удалось загрузить данные")}finally{h.value=!1}};return Ee(async()=>{await re()}),(a,t)=>{const s=c("el-icon"),i=c("el-button"),b=c("el-card"),W=c("el-input"),ze=c("el-result"),de=c("el-empty"),B=c("el-tag"),$e=c("el-text"),U=c("el-form-item"),P=c("el-divider"),Ue=c("el-alert"),De=c("el-option"),Me=c("el-select"),We=c("el-input-number"),ue=c("el-form"),j=c("el-dialog"),J=c("el-descriptions-item"),Be=c("el-descriptions"),N=c("el-table-column"),Se=c("el-table"),qe=Le("loading");return d(),z(Ie,null,{default:l(()=>[r("div",Xe,[e(b,{class:"header-card"},{default:l(()=>[r("div",je,[t[13]||(t[13]=r("div",null,[r("h1",null,"Управление весовыми таблицами"),r("p",null,"Каждая профессиональная область имеет свою уникальную весовую таблицу")],-1)),r("div",Je,[e(i,{onClick:ie,size:"large",type:"primary"},{default:l(()=>[e(s,null,{default:l(()=>[e(v(ce))]),_:1}),t[12]||(t[12]=n(" Новая область ",-1))]),_:1})])])]),_:1}),e(b,{class:"search-card"},{default:l(()=>[e(W,{modelValue:q.value,"onUpdate:modelValue":t[0]||(t[0]=o=>q.value=o),placeholder:"Поиск по названию профессиональной области...","prefix-icon":v(Ne),size:"large",clearable:""},null,8,["modelValue","prefix-icon"])]),_:1}),Pe((d(),f("div",Ke,[V.value?(d(),z(ze,{key:0,icon:"error",title:"Ошибка загрузки","sub-title":V.value},{extra:l(()=>[e(i,{type:"primary",onClick:re},{default:l(()=>[e(s,null,{default:l(()=>[e(v(Re))]),_:1}),t[14]||(t[14]=n(" Повторить ",-1))]),_:1})]),_:1},8,["sub-title"])):ae.value.length===0&&!h.value?(d(),z(de,{key:1,description:"Нет профессиональных областей"},{default:l(()=>[e(i,{type:"primary",onClick:ie},{default:l(()=>[e(s,null,{default:l(()=>[e(v(ce))]),_:1}),t[15]||(t[15]=n(" Создать первую область ",-1))]),_:1})]),_:1})):(d(),f("div",Ye,[(d(!0),f(R,null,Y(ae.value,o=>(d(),f("div",{key:o.id,class:"area-card-wrapper"},[e(b,{class:"area-card",shadow:"hover"},{header:l(()=>[r("div",Ze,[r("div",et,[e(s,{size:24,color:"#409EFF"},{default:l(()=>[e(v(ee))]),_:1}),r("h3",null,p(o.name),1)]),e(i,{size:"small",onClick:D=>Ce(o),circle:""},{default:l(()=>[e(s,null,{default:l(()=>[e(v(Z))]),_:1})]),_:1},8,["onClick"])]),o.description?(d(),f("div",tt,p(o.description),1)):S("",!0)]),default:l(()=>[o.weightTable?(d(),f("div",at,[r("div",ot,[r("div",it,[t[17]||(t[17]=r("span",{class:"stat-label"},"Компетенций:",-1)),e(B,{size:"large"},{default:l(()=>[n(p(o.weightTable.weights.length),1)]),_:2},1024)]),r("div",st,[t[18]||(t[18]=r("span",{class:"stat-label"},"Сумма весов:",-1)),e(B,{type:se(o.weightTable),size:"large"},{default:l(()=>[n(p(X(o.weightTable).toFixed(4)),1)]),_:2},1032,["type"])]),r("div",nt,[t[19]||(t[19]=r("span",{class:"stat-label"},"Обновлена:",-1)),e($e,{type:"info"},{default:l(()=>[n(p(ne(o.weightTable.created_at)),1)]),_:2},1024)])]),r("div",rt,[e(i,{onClick:D=>xe(o.weightTable),type:"info"},{default:l(()=>[e(s,null,{default:l(()=>[e(v(ve))]),_:1}),t[20]||(t[20]=n(" Просмотр ",-1))]),_:1},8,["onClick"]),e(i,{onClick:D=>oe(o.weightTable),type:"primary"},{default:l(()=>[e(s,null,{default:l(()=>[e(v(Z))]),_:1}),t[21]||(t[21]=n(" Редактировать ",-1))]),_:1},8,["onClick"])])])):(d(),f("div",lt,[e(de,{description:"Весовая таблица не создана","image-size":80},{default:l(()=>[e(i,{type:"primary",onClick:D=>we(o)},{default:l(()=>[e(s,null,{default:l(()=>[e(v(pe))]),_:1}),t[16]||(t[16]=n(" Создать таблицу ",-1))]),_:1},8,["onClick"])]),_:2},1024)]))]),_:2},1024)]))),128))]))])),[[qe,h.value]])]),e(j,{modelValue:$.value,"onUpdate:modelValue":t[3]||(t[3]=o=>$.value=o),title:fe.value,width:"900px","close-on-click-modal":!1,"align-center":""},{footer:l(()=>[e(i,{onClick:t[2]||(t[2]=o=>$.value=!1)},{default:l(()=>[...t[24]||(t[24]=[n("Отмена",-1)])]),_:1}),e(i,{type:"primary",onClick:Ve,loading:k.value,disabled:!ge.value},{default:l(()=>[n(p(A.value?"Сохранить":"Создать"),1)]),_:1},8,["loading","disabled"])]),default:l(()=>[e(ue,{model:u.value,"label-width":"200px",ref_key:"formRef",ref:_e,"label-position":"top"},{default:l(()=>[A.value?(d(),z(U,{key:1,label:"Профессиональная область"},{default:l(()=>[e(b,{shadow:"never",class:"area-display-card"},{default:l(()=>[r("div",ct,[e(s,{size:20,color:"#409EFF"},{default:l(()=>[e(v(ee))]),_:1}),r("span",pt,p(L.value),1)])]),_:1})]),_:1})):(d(),z(U,{key:0,label:"Профессиональная область",required:""},{default:l(()=>[e(b,{shadow:"never",class:"area-display-card"},{default:l(()=>[r("div",dt,[e(s,{size:20,color:"#409EFF"},{default:l(()=>[e(v(ee))]),_:1}),r("span",ut,p(L.value),1)])]),_:1})]),_:1})),e(P,{"content-position":"left"},{default:l(()=>[...t[22]||(t[22]=[n("Компетенции и веса",-1)])]),_:1}),r("div",vt,[e(Ue,{type:ye.value,title:`Сумма весов: ${x.value.toFixed(4)} (требуется: 1.0000)`,closable:!1,"show-icon":"",style:{"margin-bottom":"16px"}},{default:l(()=>[x.value!==1?(d(),f(R,{key:0},[x.value<1?(d(),f("span",mt," Осталось распределить: "+p((1-x.value).toFixed(4)),1)):(d(),f("span",_t," Превышение: "+p((x.value-1).toFixed(4)),1))],64)):S("",!0)]),_:1},8,["type","title"]),(d(!0),f(R,null,Y(u.value.weights,(o,D)=>(d(),f("div",{key:D,class:"weight-row"},[e(Me,{modelValue:o.metric_code,"onUpdate:modelValue":C=>o.metric_code=C,placeholder:"Выберите метрику",filterable:"",style:{width:"420px"}},{default:l(()=>[(d(!0),f(R,null,Y(I.value,C=>(d(),z(De,{key:C.code,label:v(me)(C),value:C.code},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue"]),e(We,{modelValue:o.weight,"onUpdate:modelValue":C=>o.weight=C,min:0,max:1,step:.01,precision:4,placeholder:"Вес",style:{width:"180px"}},null,8,["modelValue","onUpdate:modelValue"]),e(i,{type:"danger",size:"small",icon:v(Ge),circle:"",onClick:C=>ke(D)},null,8,["icon","onClick"])]))),128)),e(i,{type:"primary",plain:"",onClick:be,icon:v(pe),style:{"margin-top":"16px"}},{default:l(()=>[...t[23]||(t[23]=[n(" Добавить компетенцию ",-1)])]),_:1},8,["icon"])]),e(P),e(U,{label:"Метаданные (опционально)"},{default:l(()=>[e(W,{modelValue:u.value.metadata.description,"onUpdate:modelValue":t[1]||(t[1]=o=>u.value.metadata.description=o),type:"textarea",rows:3,placeholder:"Описание версии таблицы, примечания и т.д."},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),e(j,{modelValue:E.value,"onUpdate:modelValue":t[6]||(t[6]=o=>E.value=o),title:`Весовая таблица: ${y.value?.prof_activity_name}`,width:"900px","align-center":""},{footer:l(()=>[e(i,{onClick:t[4]||(t[4]=o=>E.value=!1),size:"large"},{default:l(()=>[...t[26]||(t[26]=[n("Закрыть",-1)])]),_:1}),e(i,{type:"primary",onClick:t[5]||(t[5]=o=>oe(y.value)),size:"large"},{default:l(()=>[e(s,null,{default:l(()=>[e(v(Z))]),_:1}),t[27]||(t[27]=n(" Редактировать ",-1))]),_:1})]),default:l(()=>[y.value?(d(),f("div",ft,[e(b,{shadow:"never",class:"table-summary-card"},{default:l(()=>[e(Be,{column:2,border:""},{default:l(()=>[e(J,{label:"Профессиональная область",span:2},{default:l(()=>[n(p(y.value.prof_activity_name),1)]),_:1}),e(J,{label:"Создана"},{default:l(()=>[n(p(ne(y.value.created_at)),1)]),_:1}),e(J,{label:"Сумма весов"},{default:l(()=>[e(B,{type:se(y.value),size:"large"},{default:l(()=>[n(p(X(y.value).toFixed(4)),1)]),_:1},8,["type"])]),_:1})]),_:1})]),_:1}),e(P,{"content-position":"left"},{default:l(()=>[e(s,null,{default:l(()=>[e(v(ve))]),_:1}),n(" Компетенции ("+p(y.value.weights.length)+") ",1)]),_:1}),e(Se,{data:Ae(y.value.weights),stripe:"","max-height":"500",size:"large"},{default:l(()=>[e(N,{type:"index",label:"#",width:"60",align:"center"}),e(N,{label:"Метрика","min-width":"300"},{default:l(({row:o})=>[r("div",gt,[r("strong",null,p(v(me)({name:o.metric_name,code:o.metric_code})),1)])]),_:1}),e(N,{prop:"weight",label:"Вес",width:"140",align:"center"},{default:l(({row:o})=>[e(B,{size:"large"},{default:l(()=>[n(p(parseFloat(o.weight).toFixed(4)),1)]),_:2},1024)]),_:1}),e(N,{label:"Процент",width:"140",align:"center"},{default:l(({row:o})=>[e(B,{type:"info",size:"large"},{default:l(()=>[n(p((parseFloat(o.weight)*100).toFixed(2))+"% ",1)]),_:2},1024)]),_:1})]),_:1},8,["data"]),y.value.metadata&&y.value.metadata.description?(d(),f("div",yt,[e(P,{"content-position":"left"},{default:l(()=>[...t[25]||(t[25]=[n("Описание",-1)])]),_:1}),e(b,{shadow:"never",class:"metadata-card"},{default:l(()=>[n(p(y.value.metadata.description),1)]),_:1})])):S("",!0)])):S("",!0)]),_:1},8,["modelValue","title"]),e(j,{modelValue:T.value,"onUpdate:modelValue":t[11]||(t[11]=o=>T.value=o),title:w.value?"Редактировать область":"Создать область",width:"600px"},{footer:l(()=>[e(i,{onClick:t[10]||(t[10]=o=>T.value=!1)},{default:l(()=>[...t[28]||(t[28]=[n("Отмена",-1)])]),_:1}),w.value?(d(),z(i,{key:0,type:"danger",onClick:Te},{default:l(()=>[...t[29]||(t[29]=[n(" Удалить ",-1)])]),_:1})):S("",!0),e(i,{type:"primary",onClick:Fe,loading:k.value},{default:l(()=>[n(p(w.value?"Сохранить":"Создать"),1)]),_:1},8,["loading"])]),default:l(()=>[e(ue,{model:g.value,"label-width":"120px"},{default:l(()=>[e(U,{label:"Код",required:""},{default:l(()=>[e(W,{modelValue:g.value.code,"onUpdate:modelValue":t[7]||(t[7]=o=>g.value.code=o),disabled:!!w.value,placeholder:"meeting_facilitation"},null,8,["modelValue","disabled"])]),_:1}),e(U,{label:"Название",required:""},{default:l(()=>[e(W,{modelValue:g.value.name,"onUpdate:modelValue":t[8]||(t[8]=o=>g.value.name=o),placeholder:"Проведение совещаний"},null,8,["modelValue"])]),_:1}),e(U,{label:"Описание"},{default:l(()=>[e(W,{modelValue:g.value.description,"onUpdate:modelValue":t[9]||(t[9]=o=>g.value.description=o),type:"textarea",rows:3,placeholder:"Описание профессиональной области"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])]),_:1})}}},xt=Qe(wt,[["__scopeId","data-v-ec63e74e"]]);export{xt as default};
